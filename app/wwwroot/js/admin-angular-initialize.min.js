(function(n){"use strict";n.controller("adminInitializeCtrl",["$scope","adminInitializeService","$mdSidenav","$timeout",function(n,t,i,r){var u=this;this.actionHistory=[];this.toggleLeft=function(){i("left").toggle()};this.tabs=t.getOrCreateTabs();this.activateInProgress=!1;this.activate=function(n,i){u.activateInProgress=!0;var r=Date.now();t.activate(n,i,function(n,t,f){if(f){u.activateInProgress=!1;return}var o=n,s=Date.now(),e={name:i.Name,time:s,delay:s-r,sucsess:!o};o&&console.log(i.Name+"__tId:"+e.time,{errorAnswer:t,logItem:e,item:i," $self.actionHistory":u.actionHistory});u.actionHistory.unshift(e);u.activateInProgress=!1})};this.vars=t.getVars();this.refresh=t.refreshAppVars;this.goToGame=function(){window.open(Utils.GetUrl("game"),"_blank")};n.$on("appVarsSerivce:update",function(n,i){r(function(){u.vars=t.getVars(i.appVars)})})}]);n.service("adminInitializeService",["$mdDialog","$q","appVarsSerivce",function(n,t,i){function u(n,t,i){this.TabId=Utils.Guid.CreateGuid();this.LabelData=n;this.BodyData=t;this.HasTabDescription=!!i;this.TabDescription=i}function o(n){n({notPermitted:"need add to log"})}function r(n,t,i,r,u){this.Name=n;this.Description=t;this.ViewName=_.kebabCase(n);this.ControllerName=i;this.$url="/api/"+i+"/"+n+"/";this.$params=r;this.$canBeRunRemoute=!!u}function f(n,t){return new r("InitApiTest","Подтверждает что соединиение установленно, зависимости проинициализированны , и можно запускать основной метод котроллера в случае успеха вернет <b class=warn>'Ok'<\/b>",n,null,t)}function s(n){var t="MainInitializer";n.push(new u({Name:"Event-Runner"},[f(t,!0),new r("Start","Создает и запускает сервис кешей приложения, фоновые задачи наблюдения и  синхронизации",t,null,!0),new r("Stop","Останавливает синхронизаторы и очищает кеши приложения",t,null,!0),new r("StartDemons","Запускает задачи синхронизации на сервере",t,null,!0),new r("StopDemons","Останавливает синхронизацию",t,null,!0),],"Методы этого раздела обеспечивают запуск и остановку приложения, перед заходом в раздел гейм необходимо инициализировать службу отсюда"))}function h(n){var t="MainInitializer";n.push(new u({Name:"Main-Initializer"},[f(t),new r("DeleteAll","Метод полностью удаляет всю информацию связанную c игровым миром и пользователем. <br>Используется для перегенерации мира. <br> Удаляет пользователей - в том числе нпс, все модули альянса, весь игровой мир <br> (галлактики,сектора, звезды, планеты, луны, и соотв весь прогресс пользователя),<br> модуль офицеров,<br> игровых сообшений и вообще всего что связанно с игрой. Очистка производится как в базе данных так и локальных кешах",t),new r("CreateAll","Метод генерации игрового мира и базового оружения, создает мир, модификаторы, имена игровых объектов, базовые типы планет звезд и пр,  базовые роли, НПС <br>  перед запуском необходим запуск метода  <b>'DeleteAll'<\/b>",t),new r("CreateMainRoles","Создает корневые роли для всего приложения, такие как user, admin, guest, и пр. Для верной работы, требует предварительной очистки приложения от связанных данных",t),new r("CreateFakeAuthUsers","Создает ботов пользователей, боты не являются авторизированными пользователями - только игровыми, из под учетнойзаписи бота войти в игру нельзя.",t),new r("DeleteFakeUsers","Находит всех созданных ботов среди юзеров и удаляет все связанные с ними данные",t),new r("AddUserToRole","Назначает переданному пользователю  переданную корневую роль, требуемые аргументы  AuthId, имя создаваемой роли.<br><b class=warn>Примечание: todo - сделать форму передачи аргументов<\/b>",t)],"Это самые основые команды для приложения. Их использование всегда влечет за собой полную перестройку приложения."))}function c(n){var t="AllianceG";n.push(new u({Name:"Alliance-Initializer"},[f(t),new r("Init","Действие не имеет четкого определения и  изменяет свое назначение в зависимости от текущих требований, возможные действия необходимо раскоментить в этом методе, перекомпелировать приложение и запустить. Действе по умолчанию <b>DeleteAll<\/b>",t),new r("CreateAllianceRating","Тестовый метод для заполнения поля ПВП в информации о альянсе. Делает выбрку по существующим альянсам,  получает всех активных пользователей альянса, и считывает их пвп очки,  просумировав ПВП записывает данные в информацию о альянсе.",t),new r("AddUserRole","Тестовый метод для базовой генерации ролей. Получает всех пользователей всех альянсов,  упорядочивает их по UserId,  первым 10 пользователя назначает роль Creator(1)  остальным Recrut(2).<br><b class=warn>Не ркомендуется запускать без  явной необходимости.<\/b><br> В обыном порядке роли создаются сами, при создании альянса или добавлении пользователя к альянсу. То же касается и фейк альянсов.",t),new r("SetUserPlanet","Тестовый метод Устанавливает всем планетам какой то альянс для связывания, после - планета принаджедит пользователю и альянсу.",t),new r("DeleteAll","Удаляет все альянсы, включае нпс, метоед неободим для перегенерации мира. <br><b class=warn>Ручтоной вызов метода не рекомендуется<\/b> (за его вызов отвечает отдельный модуль - <b class=warn>'MAIN-INITIALIZER.DeleteAll'<\/b>, который  осуществляет вызов в нужной последовательности) ",t)],"Изначально методы этой группы создавались для переинциализации модуля альянса, но с ростом приложения и связей   стала очевидна  невозможность их использования без перинициалтзации  юзера, мира и других модулей. Тем не менее в некторых случаях, при определенной подготовке исходного кода, их можно использвоать"))}function l(n){var t="MapG";n.push(new u({Name:"Map-Initializer"},[f(t),new r("Init","action Description",t),new r("CreateAll","action Description",t),new r("DeleteAll","action Description",t),new r("CreateMoon","action Description",t),new r("UpdateSectorsToArchForm","action Description",t),new r("UpdateStarEnergyBonus","action Description",t),new r("CreateSectors","action Description",t),new r("CreateSystemGeometry","action Description",t),],"Методы этой группы отсносятся к игровому миру и  являются вспомогательными, по большей части они предназначены для проверки запуска самой генерации, или фиксации данных после генерации, для корректной проверки восновном требуется предварительная очитка всего приложения."))}function a(n){var t="UsersG";n.push(new u({Name:"User-Initializer"},[f(t),new r("Init","action Description",t),new r("CreateMainRoles","action Description",t),new r("GenerateFakeAuthUsers","action Description",t),new r("UpdateSecurityStamp","action Description",t),new r("UpdateAllUsersRating","action Description",t),new r("GroupInitizlize","action Description",t),new r("UpdateUserImg","action Description",t),new r("DeleteAll","action Description",t)],"Базовые методы с данными пользователя"))}var e=this;this.$tabs=null;this.getVars=function(n){var r=n||i.getVars(),t=[];return _.forEach(r,function(n,i){t.push(Utils.ModelFactory.KeyVal(i,n))}),console.log("vars",{vars:t,v:r}),this._vars=t};this.refreshAppVars=function(){$.ajax({url:"/api/MainInitializer/refreshAppData/",method:"POST",type:"json",headers:Utils.XSRF.HeadersGetApiTokenObj()}).then(function(n){i.update(n)},function(n){console.log("refreshAppVars : error",{errorAnswer:n})})};this.activate=function(r,u,f){var e=t.defer(),s;u.$canBeRunRemoute||window.location.hostname==="localhost"?(s=n.confirm().ariaLabel("ariaLabel").title("Confirm").htmlContent("Вы активируете действие <b class=warn>"+u.Name+"<\/b> контроллера <b class=warn>"+u.ControllerName+"<\/b><br> Подтвердить?").ok("Confirm").cancel("Cancel").targetEvent(r),n.show(s).then(function(){$.ajax({url:u.$url,method:"POST",type:"json",headers:Utils.XSRF.HeadersGetApiTokenObj(),data:u.$params}).then(e.resolve,e.reject)},function(){e.reject("cancel")})):e.reject("!isLocalHost");e.promise.then(function(n){n&&typeof n=="object"&&n.hasOwnProperty("CacheInitialized")&&(console.log("answer",{answer:n}),i.update(n));f(!1,n)},function(t){if(t==="!isLocalHost")o(function(n){f(!0,n)});else{if(t==="cancel"){f(null,null,!0);return}n.show(n.alert().title("GG - ERROR").targetEvent(r).htmlContent("<h3 class=warn><b>Поздравляю! Вы создали ошибку!<\/b><\/h3><p>Открывайте консоль(F12)  и ищите дополнительную информацию о ошибке<br>Открывайте солюшен, и идите в метод <b class=warn>/app/Api/InicializeData/"+u.ControllerName+"Controller.cs<\/b><br>найдите там метод <b class=warn>"+u.Name+"<\/b>, eсли не найдете - посмотрите в базовом классе (<b class=warn>/app/Api/InitApiController.cs<\/b>).<br> Переходите в глубь сервисов (CTRL+LMC по имени метода или сервиса)<br>чтобы выяснить какие части были затронуты.<br>Определите какие были использованны таблицы данных, и проверьте их содержимое <br>в обозревателе обектов sql server (ВИД=>обозреватель объектов SQL SERVER) <br>=> server=> Базы данных=>  база данных к которой подключенны итп... <\/p>").ariaLabel(" ").clickOutsideToClose(!0).ok("Ok!"));f(!0,t)}})};this.getOrCreateTabs=function(){if(!e.$tabs){var n=[];return s(n),h(n),c(n),l(n),a(n),{selectedIndex:0,data:n}}return e.$tabs}}])})(Utils.CoreApp.adminApp);