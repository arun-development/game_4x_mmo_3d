(function(n){"use strict";n.controller("storeAdminCtrl",["$scope","storeRepo",function(n,t){var i=this;this.products=[];this.saveInitData=function(n){t.saveInitProducts(n);i.products=t.getProductList();angular.element("#admin-store-init-data").remove()};this.createItem=t.openDialogCreateItem;this.deleteItem=function(n,i){console.log("deleteItem",{productItem:i,$event:n});t.requestRemoveItem(i)};this.updateItem=function(n,i){t.openDialogUpdateItem(n,i)}}]);n.service("storeRepo",["$mdDialog","$filter","$q",function(n,t,i){function f(){}function u(){this.Id=0;this.NativeName="";this.ProductType=null;this.Currency=null;this.Price=0;this.L10N=Utils.L10N();this.Active=!1;this.DateCreate="";this.$dateCreateView="";this.Base64Images=null;this.Duration=null;this.Properties=null;this.$properties=[];this.ImagePath=null;this.$setCurrencyList();this.$setDurations();this.$setProductTypeList()}var r=this,o=Utils.ModelFactory,e;this._durationList=null;this._currencyList=null;this.$products=null;this._premiumMods=null;f.prototype.toArray=function(){return[this.Account,this.Premium,this.Booster,this.Skins,this.Cc]};f.prototype.creteNewFromThis=function(){return _.cloneDeep(this)};f.prototype.cloneAsArray=function(){return _.cloneDeep(this.toArray())};f.prototype.setByServerData=function(n){_.extend(this,n);var t=this;_.forEach(this,function(n,i){Object.freeze(t[i])});Object.freeze(this)};this.productTypes=new f;u.prototype.$setDateCreate=function(){this.$dateCreateView=t("date")(this.DateCreate,"yy.MM.dd HH:mm")};u.prototype.$showDuration=!1;u.prototype.$durations=null;u.prototype.$setDurations=function(){this.__proto__.$durations=_.cloneDeep(r._durationList)};u.prototype.$setShowDuration=function(){this.$showDuration||this.Duration&&this.ProductType&&(this.ProductType.Id===2||this.ProductType.Id===3)&&(this.__proto__.$showDuration=!0)};u.prototype.$productTypeList=null;u.prototype.$setProductTypeList=function(){this.$productTypeList||(this.__proto__.$productTypeList=r.productTypes.cloneAsArray())};u.prototype.$setProductType=function(n){this.ProductType=_.find(this.$productTypeList,function(t){return t.Id===n})};u.prototype.$currencyList=null;u.prototype.$setCurrencyList=function(){this.__proto__.$currencyList=_.cloneDeep(r._currencyList)};u.prototype.$setCurrency=function(){this.Currency=this.ProductType.Id===5?this.$currencyList[1]:this.$currencyList[0]};u.prototype.$propertyToDic=function(){if(this.Properties){var n=this;_.forEach(this.Properties,function(t,i){t&&typeof t=="object"?console.log("prop is object cant be set",{val:t,key:i}):t&&n.$properties.push(new o.KeyVal(i,t))})}};u.prototype.$setFromOther=function(n){this.Id=n.Id;this.NativeName=n.NativeName;this.$setProductType(n.ProductType.Id);this.Price=n.Price;this.L10N=Utils.L10N();this.L10N.updateFromOther(n.L10N);this.Active=n.Active;this.DateCreate=n.DateCreate;this.Base64Images=n.Base64Images;this.Duration=n.Duration;this.Properties=n.Properties;this.ImagePath=n.ImagePath;this.$setCurrency();this.$setDateCreate();this.$propertyToDic()};this.saveInitProducts=function(n){r._durationList=n.DurationList;r._currencyList=n.CurrencyList;Utils.FreezeDeep(r._durationList);Utils.FreezeDeep(r._currencyList);r._premiumMods=n.PremiumBaseProperty;Utils.FreezeDeep(r._premiumMods);r.$products||(r.$products=[]);r.productTypes.setByServerData(n.ProductTypes);_.forEach(n.ProductItems,function(n){r.addItemToLocal(r.createLocalItem(n))});console.log("productModel",{productModel:n,$self:r})};this.getProductList=function(){return r.$products};this.removeItemFromLocal=function(n){_.remove(r.$products,function(t){return t.Id===n.Id})};this.requestRemoveItem=function(n){var t=i.defer();try{$.ajax({url:"/AdminStore/DeleteProductItem/",method:"DELETE",data:Utils.XSRF.MakeIPostXsrf("productStoreId",n.Id),type:"json"}).then(t.resolve,t.reject)}catch(u){t.reject(u)}t.promise.then(function(i){i?r.removeItemFromLocal(n):t.reject("not deleted")},function(n){console.log("errorAnswer",{errorAnswer:n})})};this.createLocalItem=function(n){var t=new u;return t.$setFromOther(n),t};this.addItemToLocal=function(n){return r.$products.push(n),n};this.updateLocalItem=function(n){var t=r.createLocalItem(n),i=_.find(r.$products,function(t){return t.Id===n.Id});_.isEqual(t,i)||Utils.UpdateObjFromOther(i,t)};e=!1;this.openDialogCreateItem=function(t){n.show({templateUrl:"create-store-admin-item-dialog.tmpl",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!1,fullscreen:!0,controller:"createStoreAdminItemDialogCtrl",controllerAs:"csCtrl"}).then(function(n){n.$destroy();e=!1},function(n){n.$destroy();e=!1})};this.openDialogUpdateItem=function(t,i){n.show({templateUrl:"update-store-admin-item-dialog.tmpl",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!1,fullscreen:!0,locals:{modelStoreItem:i},controller:"updateStoreAdminItemDialogCtrl",controllerAs:"usCtrl"}).then(function(n){n.$destroy();e=!1},function(n){n.$destroy();e=!1})};this.setItemProperty=function(n,t){if(t.Id===1)n.__proto__.$showDuration=!1;else if(t.Id===2)n.__proto__.$showDuration=!0,n.Properties=_.cloneDeep(r._premiumMods);else if(t.Id===3){if(n.__proto__.$showDuration=!0,!n.Properties||!n.Properties.hasOwnProperty("Hp")){var i=o.IBattleStats();i.Duration=0;n.Properties=i}}else t.Id===4?n.__proto__.$showDuration=!1:t.Id===5&&(n.__proto__.$showDuration=!1)};this.createProductModel=function(){return new u};this.sendNewProductItem=function(n){console.log("newProductItem",{newProductItem:n});var t=i.defer();try{$.ajax({url:"/AdminStore/CreateNewProductItem/",method:"POST",data:Utils.XSRF.MakeIPostXsrf("newProductItem",n),type:"json"}).then(t.resolve,t.reject)}catch(r){t.reject(r)}return t.promise};this.requestUpdateProductItem=function(n){console.log("prouctItem",{productItem:n});var t=i.defer();try{$.ajax({url:"/AdminStore/UpdateProductItem/",method:"POST",data:Utils.XSRF.MakeIPostXsrf("productItem",n),type:"json"}).then(t.resolve,t.reject)}catch(r){t.reject(r)}return t.promise}}]);n.controller("createStoreAdminItemDialogCtrl",["$scope","$mdDialog","storeRepo",function(n,t,i){var r=this,u;this.model=i.createProductModel();this.model.Active=!0;this.langKeys=this.model.L10N.getKeys();this.productTypes=i.productTypes.cloneAsArray();this.onProductTypeSelected=function(n){i.setItemProperty(r.model,n);r.model.$setCurrency();console.log({selectedType:n})};this.files=null;u=!1;this.send=function(){function f(){var f={};Utils.UpdateObjData(f,r.model);f.Properties=JSON.stringify(f.Properties);i.sendNewProductItem(f).finally(function(){u=!1}).then(function(r){var u=i.addItemToLocal(i.createLocalItem(r));console.log("answer",{answer:r,newItem:u});t.hide(n)},function(i){console.log("errorAnswer",{errorAnswer:i});t.hide(n)})}if(!u){u=!0;try{r.model.Base64Images=[];_.forEach(r.files,function(n){Utils.File.blobToBase64(n.lfFile,function(n){r.model.Base64Images.push(n);r.model.Base64Images.length===r.files.length&&f()})})}catch(e){u=!1}}};this.cancel=function(){console.log("createStoreAdminItemDialogCtrl.$scope",{$scope:n});t.cancel(n)}}]);n.controller("updateStoreAdminItemDialogCtrl",["$scope","$mdDialog","storeRepo","modelStoreItem",function(n,t,i,r){var u=this,f;r.$setShowDuration();this.model=r;console.log("updateStoreItemDialogCtrl",{$scope:n,modelStoreItem:r});this.langKeys=this.model.L10N.getKeys();this.productTypes=i.productTypes.cloneAsArray();this.updateImage=!1;this.files=null;f=!1;this.updateDuration=!1;this.$properties=_.cloneDeep(r.Properties);this.send=function(){function r(){var r={};Utils.UpdateObjData(r,u.model);i.requestUpdateProductItem(r).finally(function(){f=!1}).then(function(u){i.updateLocalItem(u);console.log("answer",{answer:u,newItem:r});t.hide(n)},function(i){console.log("errorAnswer",{errorAnswer:i});t.hide(n)})}f||(f=!0,_.isEqual(u.$properties,u.model.Properties)||(u.model.Properties=u.$properties),u.model.Properties=JSON.stringify(u.model.Properties),u.updateImage?(u.model.Base64Images=[],_.forEach(u.files,function(n){Utils.File.blobToBase64(n.lfFile,function(n){u.model.Base64Images.push(n);u.model.Base64Images.length===u.files.length&&r()})})):r())};this.cancel=function(){console.log("updateStoreItemDialogCtrl.$scope",{$scope:n});t.cancel(n)}}])})(Utils.CoreApp.adminApp);