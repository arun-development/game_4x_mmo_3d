(function(n,t){n.createMainGameHub=function(i){i||(i=n.LogLevel.Information);var r=(new n.HubConnectionBuilder).withUrl("/hub/MainGameHub".toLowerCase()).configureLogging(i).build();return r.server={},r.client={},r.server.requestAllianceFromAllianceManageAddMessage=function(){return r.invoke.apply(r,t.merge(["RequestAllianceFromAllianceManageAddMessage"],t.makeArray(arguments)))},r.server.requestAllianceFromMyAllianceAddMessage=function(){return r.invoke.apply(r,t.merge(["RequestAllianceFromMyAllianceAddMessage"],t.makeArray(arguments)))},r.server.requestAllianceConfirmAcceptFromAllianceManage=function(){return r.invoke.apply(r,t.merge(["RequestAllianceConfirmAcceptFromAllianceManage"],t.makeArray(arguments)))},r.server.requestAllianceDeleteRequestForUserToAlliance=function(){return r.invoke.apply(r,t.merge(["RequestAllianceDeleteRequestForUserToAlliance"],t.makeArray(arguments)))},r.server.requestAllianceRejectRequestToAlliance=function(){return r.invoke.apply(r,t.merge(["RequestAllianceRejectRequestToAlliance"],t.makeArray(arguments)))},r.server.requestAllianceAcceptJoinUserToAlliance=function(){return r.invoke.apply(r,t.merge(["RequestAllianceAcceptJoinUserToAlliance"],t.makeArray(arguments)))},r.server.userChannelsGetPlanshet=function(){return r.invoke.apply(r,t.merge(["UserChannelsGetPlanshet"],t.makeArray(arguments)))},r.server.userChannelsSendMessage=function(){return r.invoke.apply(r,t.merge(["UserChannelsSendMessage"],t.makeArray(arguments)))},r.server.userChannelsGetNextMessagesPage=function(){return r.invoke.apply(r,t.merge(["UserChannelsGetNextMessagesPage"],t.makeArray(arguments)))},r.server.userChannelsCreatePrivateChannel=function(){return r.invoke.apply(r,t.merge(["UserChannelsCreatePrivateChannel"],t.makeArray(arguments)))},r.server.userChannelsClosePrivateChannel=function(){return r.invoke.apply(r,t.merge(["UserChannelsClosePrivateChannel"],t.makeArray(arguments)))},r.server.userChannelsIsAvailableChannelName=function(){return r.invoke.apply(r,t.merge(["UserChannelsIsAvailableChannelName"],t.makeArray(arguments)))},r.server.userChannelsCreateGroupChannel=function(){return r.invoke.apply(r,t.merge(["UserChannelsCreateGroupChannel"],t.makeArray(arguments)))},r.server.userChannelsDeleteGroupChannelByOwner=function(){return r.invoke.apply(r,t.merge(["UserChannelsDeleteGroupChannelByOwner"],t.makeArray(arguments)))},r.server.userChannelsUpdatePassword=function(){return r.invoke.apply(r,t.merge(["UserChannelsUpdatePassword"],t.makeArray(arguments)))},r.server.userChannelsSerchGroupChannelNames=function(){return r.invoke.apply(r,t.merge(["UserChannelsSerchGroupChannelNames"],t.makeArray(arguments)))},r.server.userChannelsJoinToGroupChannel=function(){return r.invoke.apply(r,t.merge(["UserChannelsJoinToGroupChannel"],t.makeArray(arguments)))},r.server.userChannelsUnsubscribeUserFromGroupChannel=function(){return r.invoke.apply(r,t.merge(["UserChannelsUnsubscribeUserFromGroupChannel"],t.makeArray(arguments)))},r.server.userChannelsDeepDeleteOtherGroupChannels=function(){return r.invoke.apply(r,t.merge(["UserChannelsDeepDeleteOtherGroupChannels"],t.makeArray(arguments)))},r.server.userChannelsGroupUpdateUser=function(){return r.invoke.apply(r,t.merge(["UserChannelsGroupUpdateUser"],t.makeArray(arguments)))},r.server.userChannelsGroupUploadIcon=function(){return r.invoke.apply(r,t.merge(["UserChannelsGroupUploadIcon"],t.makeArray(arguments)))},r.server.worldGetSectors=function(){return r.invoke.apply(r,t.merge(["WorldGetSectors"],t.makeArray(arguments)))},r.server.worldGetSystems=function(){return r.invoke.apply(r,t.merge(["WorldGetSystems"],t.makeArray(arguments)))},r.server.worldGetSystemGeometry=function(){return r.invoke.apply(r,t.merge(["WorldGetSystemGeometry"],t.makeArray(arguments)))},r.server.worldGetGalaxyInfo=function(){return r.invoke.apply(r,t.merge(["WorldGetGalaxyInfo"],t.makeArray(arguments)))},r.server.worldGetSectorInfo=function(){return r.invoke.apply(r,t.merge(["WorldGetSectorInfo"],t.makeArray(arguments)))},r.server.worldGetStarInfo=function(){return r.invoke.apply(r,t.merge(["WorldGetStarInfo"],t.makeArray(arguments)))},r.server.worldGetPlanetInfo=function(){return r.invoke.apply(r,t.merge(["WorldGetPlanetInfo"],t.makeArray(arguments)))},r.server.worldGetMoonInfo=function(){return r.invoke.apply(r,t.merge(["WorldGetMoonInfo"],t.makeArray(arguments)))},r.server.worldSerchPlanetNames=function(){return r.invoke.apply(r,t.merge(["WorldSerchPlanetNames"],t.makeArray(arguments)))},r.server.allianceLeaveFromUserAlliance=function(){return r.invoke.apply(r,t.merge(["AllianceLeaveFromUserAlliance"],t.makeArray(arguments)))},r.server.allianceDropUserFromAlliance=function(){return r.invoke.apply(r,t.merge(["AllianceDropUserFromAlliance"],t.makeArray(arguments)))},r.server.allianceDisbandAlliance=function(){return r.invoke.apply(r,t.merge(["AllianceDisbandAlliance"],t.makeArray(arguments)))},r.server.allianceCreateAlliance=function(){return r.invoke.apply(r,t.merge(["AllianceCreateAlliance"],t.makeArray(arguments)))},r.server.allianceCheckAllianceNameIsUnic=function(){return r.invoke.apply(r,t.merge(["AllianceCheckAllianceNameIsUnic"],t.makeArray(arguments)))},r.server.allianceGetAllActiveAllianceNames=function(){return r.invoke.apply(r,t.merge(["AllianceGetAllActiveAllianceNames"],t.makeArray(arguments)))},r.server.allianceGetAllianceNamesByPartName=function(){return r.invoke.apply(r,t.merge(["AllianceGetAllianceNamesByPartName"],t.makeArray(arguments)))},r.server.allianceGetAllianceItemById=function(){return r.invoke.apply(r,t.merge(["AllianceGetAllianceItemById"],t.makeArray(arguments)))},r.server.allianceGetAllianceItemByMinRating=function(){return r.invoke.apply(r,t.merge(["AllianceGetAllianceItemByMinRating"],t.makeArray(arguments)))},r.server.allianceUpdateUserRole=function(){return r.invoke.apply(r,t.merge(["AllianceUpdateUserRole"],t.makeArray(arguments)))},r.server.allianceInfoUpdateLabel=function(){return r.invoke.apply(r,t.merge(["AllianceInfoUpdateLabel"],t.makeArray(arguments)))},r.server.allianceInfoUpdateDescription=function(){return r.invoke.apply(r,t.merge(["AllianceInfoUpdateDescription"],t.makeArray(arguments)))},r.server.allianceInfoUpdateTax=function(){return r.invoke.apply(r,t.merge(["AllianceInfoUpdateTax"],t.makeArray(arguments)))},r.server.allianceUpdateAllianceTech=function(){return r.invoke.apply(r,t.merge(["AllianceUpdateAllianceTech"],t.makeArray(arguments)))},r.server.bookmarkGetPlanshet=function(){return r.invoke.apply(r,t.merge(["BookmarkGetPlanshet"],t.makeArray(arguments)))},r.server.bookmarkAddBookmark=function(){return r.invoke.apply(r,t.merge(["BookmarkAddBookmark"],t.makeArray(arguments)))},r.server.bookmarkDeleteItem=function(){return r.invoke.apply(r,t.merge(["BookmarkDeleteItem"],t.makeArray(arguments)))},r.server.buildGetIndustrialComplex=function(){return r.invoke.apply(r,t.merge(["BuildGetIndustrialComplex"],t.makeArray(arguments)))},r.server.buildGetCommandCenter=function(){return r.invoke.apply(r,t.merge(["BuildGetCommandCenter"],t.makeArray(arguments)))},r.server.buildGetSpaceShipyard=function(){return r.invoke.apply(r,t.merge(["BuildGetSpaceShipyard"],t.makeArray(arguments)))},r.server.buildGetMotherIndustrialComplex=function(){return r.invoke.apply(r,t.merge(["BuildGetMotherIndustrialComplex"],t.makeArray(arguments)))},r.server.buildGetMotherSpaceShipyard=function(){return r.invoke.apply(r,t.merge(["BuildGetMotherSpaceShipyard"],t.makeArray(arguments)))},r.server.buildGetMotherLaboratory=function(){return r.invoke.apply(r,t.merge(["BuildGetMotherLaboratory"],t.makeArray(arguments)))},r.server.buildItemUpgrade=function(){return r.invoke.apply(r,t.merge(["BuildItemUpgrade"],t.makeArray(arguments)))},r.server.buildItemUpgraded=function(){return r.invoke.apply(r,t.merge(["BuildItemUpgraded"],t.makeArray(arguments)))},r.server.buildEnergyConverterExchangeResource=function(){return r.invoke.apply(r,t.merge(["BuildEnergyConverterExchangeResource"],t.makeArray(arguments)))},r.server.buildExtractionModuleChangeProportion=function(){return r.invoke.apply(r,t.merge(["BuildExtractionModuleChangeProportion"],t.makeArray(arguments)))},r.server.buildExtractionModuleStopProduction=function(){return r.invoke.apply(r,t.merge(["BuildExtractionModuleStopProduction"],t.makeArray(arguments)))},r.server.buildExtractionModuleStartProduction=function(){return r.invoke.apply(r,t.merge(["BuildExtractionModuleStartProduction"],t.makeArray(arguments)))},r.server.buildSpaceShipyardFixUnitTurn=function(){return r.invoke.apply(r,t.merge(["BuildSpaceShipyardFixUnitTurn"],t.makeArray(arguments)))},r.server.buildSpaceShipyardSetUnitTurn=function(){return r.invoke.apply(r,t.merge(["BuildSpaceShipyardSetUnitTurn"],t.makeArray(arguments)))},r.server.buildStorageGetResourcesView=function(){return r.invoke.apply(r,t.merge(["BuildStorageGetResourcesView"],t.makeArray(arguments)))},r.server.buildStorageGetStorageResources=function(){return r.invoke.apply(r,t.merge(["BuildStorageGetStorageResources"],t.makeArray(arguments)))},r.server.buildStorageDoTransfer=function(){return r.invoke.apply(r,t.merge(["BuildStorageDoTransfer"],t.makeArray(arguments)))},r.server.techItemUpgraded=function(){return r.invoke.apply(r,t.merge(["TechItemUpgraded"],t.makeArray(arguments)))},r.server.buildLaboratorySetTechTurn=function(){return r.invoke.apply(r,t.merge(["BuildLaboratorySetTechTurn"],t.makeArray(arguments)))},r.server.confederationGetPlanshet=function(){return r.invoke.apply(r,t.merge(["ConfederationGetPlanshet"],t.makeArray(arguments)))},r.server.confederationAddNewOfficer=function(){return r.invoke.apply(r,t.merge(["ConfederationAddNewOfficer"],t.makeArray(arguments)))},r.server.confederationRatingGetNextPage=function(){return r.invoke.apply(r,t.merge(["ConfederationRatingGetNextPage"],t.makeArray(arguments)))},r.server.confederationRatingGetUser=function(){return r.invoke.apply(r,t.merge(["ConfederationRatingGetUser"],t.makeArray(arguments)))},r.server.confederationAddVote=function(){return r.invoke.apply(r,t.merge(["ConfederationAddVote"],t.makeArray(arguments)))},r.server.confederationRegistrateCandidate=function(){return r.invoke.apply(r,t.merge(["ConfederationRegistrateCandidate"],t.makeArray(arguments)))},r.server.onDisconnectedAsync=function(){return r.invoke.apply(r,t.merge(["OnDisconnectedAsync"],t.makeArray(arguments)))},r.server.onReconnected=function(){return r.invoke.apply(r,t.merge(["OnReconnected"],t.makeArray(arguments)))},r.server.init=function(){return r.invoke.apply(r,t.merge(["Init"],t.makeArray(arguments)))},r.server.ping=function(){return r.invoke.apply(r,t.merge(["Ping"],t.makeArray(arguments)))},r.server.estateGetHangar=function(){return r.invoke.apply(r,t.merge(["EstateGetHangar"],t.makeArray(arguments)))},r.server.estateGetEstateList=function(){return r.invoke.apply(r,t.merge(["EstateGetEstateList"],t.makeArray(arguments)))},r.server.estateGetEstateItemByPlanetId=function(){return r.invoke.apply(r,t.merge(["EstateGetEstateItemByPlanetId"],t.makeArray(arguments)))},r.server.estateGetFullEstate=function(){return r.invoke.apply(r,t.merge(["EstateGetFullEstate"],t.makeArray(arguments)))},r.server.journalInitialPlanshet=function(){return r.invoke.apply(r,t.merge(["JournalInitialPlanshet"],t.makeArray(arguments)))},r.server.journalCreateTaskItem=function(){return r.invoke.apply(r,t.merge(["JournalCreateTaskItem"],t.makeArray(arguments)))},r.server.journalGetTaskTime=function(){return r.invoke.apply(r,t.merge(["JournalGetTaskTime"],t.makeArray(arguments)))},r.server.journalTaskTimeIsOver=function(){return r.invoke.apply(r,t.merge(["JournalTaskTimeIsOver"],t.makeArray(arguments)))},r.server.journalGetReportItemByTaskId=function(){return r.invoke.apply(r,t.merge(["JournalGetReportItemByTaskId"],t.makeArray(arguments)))},r.server.journalCreateReportItem=function(){return r.invoke.apply(r,t.merge(["JournalCreateReportItem"],t.makeArray(arguments)))},r.server.journalGetReportItems=function(){return r.invoke.apply(r,t.merge(["JournalGetReportItems"],t.makeArray(arguments)))},r.server.journalDeleteReportItem=function(){return r.invoke.apply(r,t.merge(["JournalDeleteReportItem"],t.makeArray(arguments)))},r.server.journalGetSpyItems=function(){return r.invoke.apply(r,t.merge(["JournalGetSpyItems"],t.makeArray(arguments)))},r.server.journalCreateSpyItemByPlanetId=function(){return r.invoke.apply(r,t.merge(["JournalCreateSpyItemByPlanetId"],t.makeArray(arguments)))},r.server.journalCreateSpyItemByPlanetName=function(){return r.invoke.apply(r,t.merge(["JournalCreateSpyItemByPlanetName"],t.makeArray(arguments)))},r.server.journalDeleteSpyItem=function(){return r.invoke.apply(r,t.merge(["JournalDeleteSpyItem"],t.makeArray(arguments)))},r.server.journalGetMotherJumpTime=function(){return r.invoke.apply(r,t.merge(["JournalGetMotherJumpTime"],t.makeArray(arguments)))},r.server.journalAddTaskMotherJump=function(){return r.invoke.apply(r,t.merge(["JournalAddTaskMotherJump"],t.makeArray(arguments)))},r.server.journalCancelMotherJump=function(){return r.invoke.apply(r,t.merge(["JournalCancelMotherJump"],t.makeArray(arguments)))},r.server.journalInstMotherJump=function(){return r.invoke.apply(r,t.merge(["JournalInstMotherJump"],t.makeArray(arguments)))},r.server.journalIsMotherJumpTimeDone=function(){return r.invoke.apply(r,t.merge(["JournalIsMotherJumpTimeDone"],t.makeArray(arguments)))},r.server.journalRemoveGuid=function(){return r.invoke.apply(r,t.merge(["JournalRemoveGuid"],t.makeArray(arguments)))},r.server.sercherGetUserNames=function(){return r.invoke.apply(r,t.merge(["SercherGetUserNames"],t.makeArray(arguments)))},r.server.testApiCall=function(){return r.invoke.apply(r,t.merge(["TestApiCall"],t.makeArray(arguments)))},r.server.personalInfoUpdateAvatar=function(){return r.invoke.apply(r,t.merge(["PersonalInfoUpdateAvatar"],t.makeArray(arguments)))},r.server.personalInfoUpdateUserDescription=function(){return r.invoke.apply(r,t.merge(["PersonalInfoUpdateUserDescription"],t.makeArray(arguments)))},r.server.personalInfoGetProfileByUserName=function(){return r.invoke.apply(r,t.merge(["PersonalInfoGetProfileByUserName"],t.makeArray(arguments)))},r.server.personalInfoGetProfileByUserId=function(){return r.invoke.apply(r,t.merge(["PersonalInfoGetProfileByUserId"],t.makeArray(arguments)))},r}})(signalR,jQuery);$("html").unbind("contextmenu").bind("contextmenu",function(n){return console.log("html.oncontextmenu",{e:n}),!1}).bind("dblclick",function(){return!1});var EM={SubscribeName:"EM",Observer:null,EstateContainerId:"#estate",CanvasId:"estateCanvas",Engine:null,Scene:null,CreateScene:null,StartRender:null,StopRender:null,GetMotherMesh:null,ShowDebug:function(n){if(n){this.Scene.debugLayer.show();setTimeout(function(){$(".insp-right-panel").css("z-index",5)},100);return}this.Scene.debugLayer.hide()},StarLight:{States:{Other:1,InPlanet:2,InSystem:3,InCamera:4},ActiveState:null,SetInSystem:null,SetInPlanet:null,SetOther:null,SetState:null,SetInCamera:null},_helpers:null,$hub:null,Audio:{GameSounds:{},InitGame:angular.noop}};(function(){var r,t,n,u=!1,i;EM.Observer=Utils.PatternFactory.Observer(EM.SubscribeName);EM.CreateScene=function(i,f){function e(n,t){if(u){var i="EM.CreateScene";n&&(i=i+"__{"+n+"}__Ok__");t?console.log(i,{data:t}):console.log(i)}}function o(){var n={};n.Update=function(t){t===EM.MapBuilder.Sectors.SubscribeName&&(EM.MapBuilder.Sectors.Observer.Unsubscribe(n),EM.Observer.NotifyAll(),n=null,e("createWorld.Update name",t),EM.Particle.GetOrCreateSectorParticles())};EM.MapBuilder.Sectors.Observer.Subscribe(n);e(" EM.MapBuilder.Sectors.Observer.Subscribe(tmp)");EM.MapBuilder.Sectors.Build(i[EM.MapGeometry.MapTypes.Sector]);e(" EM.MapBuilder.Sectors.Build(initserverData[EM.MapGeometry.MapTypes.Sector]);");EM.MapData.GetSystem.InitSystemData(i.SystemGeometry);e("MapData.GetSystem.InitSystemData(initserverData.SystemGeometry)")}function s(){function y(t,r,u){function b(){c&&(clearInterval(c),c=null)}function y(){b();e._light&&(e._light.dispose(),e._light=null)}function k(){var t=Math.PI*2,i=.4,r=t/a,n;for(f=[],o=0,n=0;n<t;n+=r){var u=l/4*Math.sin(n)*Math.cos(i),e=l/4*Math.cos(n),s=l*Math.sin(n)*Math.sin(i);f.push(new BABYLON.Vector3(_.round(u,5),_.round(s,5),_.round(e,5)))}f.push(f[0]);v=f.length-1}var e=this,a=t||360,f=[],o=0,v=0,h=!1,l=u||s,c=null,p=Utils.Time.ONE_DAY,w=_.floor(p/a);this.Position=new BABYLON.Vector3(0,140,0);this._light=null;this.Update=function(){h&&(o>v&&(o=0),this._light.position=f[o],o++)};this.SetTrack=!1;this.LightName="PlanetPointLight1";this.Start=function(){y();this._light=new BABYLON.PointLight(this.LightName,this.Position,n);this._light.intensity=.9;this._light.specular.b=.7;this._light.intensity=1;i.intensity=0;h=!0;this.SetTrack&&(f||k(),e.Update(),c=setInterval(function(){e.Update()},w))};this.Stop=function(){y();h=!1};this.IsRunned=function(){return h}}function f(n){EM.StarLight.ActiveState=n}function h(n){u.Stop();i.intensity=n||.6;i.position=EM.GameCamera.Camera.position;f(EM.StarLight.States.InCamera)}function c(n){n?(u.Start(),f(n)):r(t.InPlanet)}function o(n){n?(i.intensity=v,i.position=a,f(n)):r(t.Other)}function l(u){if(!u){r(t.InSystem);return}i.intensity=.8;var h=EM.EstateData.GetCurrentSpaceLocation(),c=EM.MapGeometry.System.GetStarMeshIdByUniqueId(h.SystemId),s=null;c&&(s=n.getMeshByID(c));e(".setInSystem",{csl:h,curStar:s});s?(i.position=s.getAbsolutePosition().clone(),f(u)):o(t.Other)}var i=new BABYLON.PointLight("StarLight",new BABYLON.Vector3.Zero,n),t=EM.StarLight.States,a=new BABYLON.Vector3(0,1e6,0),v=.2,s=800,p=new BABYLON.Vector3(0,s/2,0),u=new y,r=null;r=function(n){n&&n!==EM.StarLight.ActiveState&&typeof n=="number"&&(u.IsRunned()&&n!==t.InPlanet&&u.Stop(),n===t.InSystem?l(t.InSystem):n===t.InPlanet?c(t.InPlanet):n===t.InCamera?h():n===t.Other&&o(t.Other))};EM.StarLight.SetOther=o;EM.StarLight.SetInPlanet=c;EM.StarLight.SetInSystem=l;EM.StarLight.SetState=r;EM.StarLight.SetInCamera=h}function h(){EM.GameCamera.CreateCamera(n,r,EM.GameCamera.Keys.SystemSelected)}function c(){window.addEventListener("resize",function(){t&&t.resize()},!1)}return EM.Canvas=r=document.getElementById(EM.CanvasId),EM.Engine=t=new BABYLON.Engine(r,!0,{stencil:!0}),EM._helpers=new EM.IHelper(new BABYLON.Scene(t),f),EM.SetHelpersToObject(EM),EM.Scene.exclusiveDoubleMode=!0,n=EM.Scene,EM.Audio.InitGame(n),s(),e("createLight"),h(),e("createCamera"),c(),e("regisertResizer"),EM.AssetRepository.Init(n,function(){o();e("createWorld")}),n};EM.StartRender=function(){t.runRenderLoop(function(){n.render()})};EM.StopRender=function(){t.stopRenderLoop()};EM.GetMotherMesh=function(){return n.getMeshByID(EM.EstateGeometry.MotherModules.EstateMotherGroupId)};EM.GetPointerCoordinate=function(){return new BABYLON.Vector2(EM.Scene.pointerX,EM.Scene.pointerY)};EM.IHelper=function(n,t){function r(n,t,i,r){function u(n,t){n.isVisible=t;i||n.isPickable===t||(n.isPickable=t)}if((n.isVisible!==t||!i&&n.isPickable!==t)&&(u(n,t),!r)){var f=n.getChildMeshes();return f&&_.forEach(f,function(n){u(n,t)}),n}}var i=this;return i.Scene=n,i.$hub=t,i.GetMesh=function(t){return n.getMeshByID(t)},i.GetMaterial=function(t){return n.getMaterialByID(t)},i.CreateTexture=function(n){return new BABYLON.Texture(n,EM.Scene)},i.CreateBaseMaterial=function(n,t){var i=new BABYLON.StandardMaterial(n,EM.Scene);return t instanceof Function&&t(i),i},i.SetVisibleByMesh=function(n,t,i,u){return t=!!t,n&&r(n,t,i,u),n},i.SetVisible=function(n,t,r,u){return i.SetVisibleByMesh(i.GetMesh(n),t,r,u)},i.SetVisibleGroupByMeshes=function(n,t,r,u){_.forEach(n,function(n){i.SetVisibleByMesh(n,t,r,u)})},i.SetVisibleGroupByIds=function(n,t,r,u){_.forEach(n,function(n){i.SetVisible(n,!1,t,r,u)})},i.CreateVec3Scale=function(n){return new BABYLON.Vector3(n,n,n)},i.SetScaleToMesh=function(n,t){var f={mesh:n,scale:t},r,u;if(!n)throw Errors.ClientNullReferenceException(f,"mesh","EM.setScaleToMesh");if(typeof t=="object")return n.scaling=t,n;if(r=null,t)if(typeof t=="number")r=t;else if(Utils.IsNumeric(t))u=_.toNumber(t),u&&(r=u);else throw Errors.ClientTypeErrorException(f,t,"object||BABYLON.Vector3||number||string","EM.setScaleToMesh");else r=1;return n.scaling=i.CreateVec3Scale(r),n},i};i=1e7;EM.HIDDEN_POSITION=new BABYLON.Vector3(i,i,i);EM.GetHelpers=function(){if(!EM._helpers)throw Errors.ClientNotImplementedException({EM:EM},"scene not exist");return EM._helpers};EM.SetHelpersToObject=function(n){return n instanceof Object?_.extend(n,EM.GetHelpers()):!1}})(),function(){EM.EstateBuilder={UpdatePlanet:function(){var n=new EM.SpaceState.SpacePosition;n.clickByUserPlanet()},UpdateMother:function(){EM.EstateEvents.MotherCapsuleClick()},UserPlanetBuilder:{SetPlanetEnv:function(n){n}}}}();EM.SpriteManager={},function(n){n.init=function(){function f(){return u}function t(n){return i.hasOwnProperty(n)?i[n]:!1}function r(n){return!!t(n)}function e(n){var f=n.name,u;return r(f)?(SHOW_DEBUG&&console.log("spriteExist"),t(f)):(u=new BABYLON.Texture(n.url,EM.Scene,!0,!1,BABYLON.Texture.NEAREST_SAMPLINGMODE),u.hasAlpha=!0,u.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,u.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE,i[f]=u)}function o(n,r){var u=t(t);u.onDispose(function(){delete i[n];r()});u.dispose()}function s(n,t,i){return Utils.CdnManager.GetBjsSprite(n+(t?t:".png"),i)}function h(n,t,i,r,u,f){return f||(f=u),{name:n,url:s(n),cellSize:t,scale:i,sellInRow:r,imageSize:new BABYLON.Vector2(u,f)}}var u=[],i={},c={starSprite:h("starSprite",260,.15,8,2080)};n.getRegistratedSpriteNames=f;n.getSpriteByName=t;n.addOrGetSpriteTexture=e;n.checkSpriteExist=r;n.disposeByName=o;n.spriteMeta=c}}(EM.SpriteManager),function(n){var t="/content/audio/game/",r=t+"background/",i;n.background={};i=t+"test/";n.systemVoiceListUrls={};n.InitGame=function(t){function u(r,u,f,e){var o=(e&&e.dir?e.dir:i)+u;n.systemVoiceListUrls[r]=o;n.GameSounds[r]=new BABYLON.Sound(r,o,t,f,e)}u("onGameStart","SE_LoadingLogo1.wav",function(){n.GameSounds.onGameStart.play()},{volume:.5});u("mainFone","main-fone.mp3",null,{dir:r,loop:!0,volume:.5});u("onSpaceObjectHoveredIn","SE_HoverBodyIn.wav");u("onControlDiscShow","UI_DiscToggleActivate.wav");u("onSpaceJumpToSystemStart","SE_EnterStarSystemStart.wav");u("onMoveToPlanetoid","SE_ShowOrbitals.wav");u("onSpaceMoveToSystemPoint","SE_SelectNothing.wav");u("onSpaceRotate","CAM_FastMove_LOOP.wav");u("onSpaceScroll","CAM_Dolly_LOOP.wav");u("defaultButtonClick","UI_DiscClick.wav");u("defaultButtonClose","UI_DiscClose.wav");u("defaultHover","SE_HoverBodyIn.wav");u("dialogOpen","SE_ShowHeatmap.wav");u("dialogClose","SE_HideHeatmap.wav");u("dropableOpen","SE_ShowHeatmap.wav");u("planshetOpen","SE_ShowHeatmap.wav");u("planshetClose","SE_HideHeatmap.wav");u("planshetTabActivate","SE_UpdateHeatmap.wav");u("contollPannelToggle","UI_DiscClose.wav");u("onSelectPlanetOpen","SE_ShowHeatmap.wav");u("onSelectPlanetClose","SE_HideHeatmap.wav")}}(EM.Audio);EM.Particle={},function(n){n.GetByParticleById=function(n){return EM.Scene.getParticleSystemByID(n)};n._checkParticleInScene=function(t){return!!n.GetByParticleById(t)}}(EM.Particle),function(n){function i(){n._sectorParticle.observer||(n._sectorParticle.observer=EM.Scene.onBeforeRenderObservable.add(function(){n._sectorParticle.sps.setParticles()}))}function r(){n._sectorParticle.observer&&(EM.Scene.onBeforeRenderObservable.remove(n._sectorParticle.observer),n._sectorParticle.observer=null)}function u(){function o(){return BABYLON.Color3.White()}var r=1e3,e=2*r,u=500*r,s=function(n){n.position.x=(Math.random()-.5)*u;n.position.y=(Math.random()-.5)*u;n.position.z=(Math.random()-.5)*u;n.rotation.z=Math.random()*3.15;n.color=o()},f=BABYLON.Mesh.CreatePlane("fake_star_particle_model",.2*r,EM.Scene),i=new BABYLON.SolidParticleSystem("fake_star_particle_system",EM.Scene,{updatable:!1}),t;return i.addShape(f,e,{positionFunction:s}),t=i.buildMesh(),t.material=new BABYLON.StandardMaterial("fake_star_particle_material",EM.Scene),t.material.disableLighting=!0,t.material.backFaceCulling=!1,t.isVisible=!1,t.material.emissiveTexture=EM.CreateTexture(n.$getLaserFireTextureUrl()),t.material.emissiveTexture.level=50,t.material.alphaMode=BABYLON.Engine.ALPHA_ADD,t.material.alpha=.8,t.freezeWorldMatrix(),t.isPickable=!1,i.billboard=!0,f.dispose(),n._sectorParticle.sps=i,n._sectorParticle.sps}n._sectorParticle={sps:null,observer:null};n.ShowOrHideSectorParticles=function(t){var u=n.GetOrCreateSectorParticles();u.mesh.isVisible=t;t?i():r()};n.GetOrCreateSectorParticles=function(){return n._sectorParticle.sps?n._sectorParticle.sps:u()};var t=null;n.$getLaserFireTextureUrl=function(){return t||(t=Utils.CdnManager.GetCommonTextureUrl("laser_fire.jpg",!0)),t}}(EM.Particle),function(n){function f(){var t="/content/babylon-assets/babylon_materiales/",u=t+"rockn.png",r=t+"rock.png",n=new BABYLON.StandardMaterial(i,EM.Scene);return n.emissiveColor=new BABYLON.Color3(0,.15,.3),n.emissiveTexture=new BABYLON.Texture(r,EM.Scene),n.emissiveTexture.level=1.5,n.backFaceCulling=!1,n.disableLighting=!0,n.useLogarithmicDepth=!0,n}function e(){var n=EM.GetMaterial(i);return n?n:f()}function o(n,t){n.scaling=new BABYLON.Vector3(t,t,t)}function r(n){return s+n}function u(t){n.GetByParticleById(r(t))}function h(n,t,i){function d(n,t){var i=1,r=.6;t.x*=_.random(r,i,!0);t.y*=_.random(r,i,!0);t.z*=_.random(r,i,!0)}function g(n,t){var i=_.random(c,b)*Math.sin(k*t),r=_.random(c,b)*Math.cos(k*t);n.position=new BABYLON.Vector3(i,_.random(-h,h),r);n.scale=new BABYLON.Vector3(_.random(l,a,!0),_.random(l,a,!0),_.random(l,a,!0));n.rotation=new BABYLON.Vector3(Math.random()*s,Math.random()*s,Math.random()*s)}function nt(n){function t(n,t,r){var u=a.clone(n);return u.rotation.y=i*s/64*_.random(-1,1),t&&o(u,t),r&&(u.position.y+=r),i++,u.visibility=_.random(.5,1),u}var a=f.mesh,i=0,r=t("firstRing",.7),u=t("middleUp",1.4,-n),e=t("middleDowun",1.9,n),h=n*.3,c=t("lastRingUp",2.5,h),l=t("lastRingDown",3,-h);f.vars.startRingRotation=function(){f.vars.rY=0;var n=EM.Scene.onBeforeRenderObservable.add(function(){var n=f.vars.rY;a.rotation.y=n;u.rotation.y=-n/2;e.rotation.y=n/3;r.rotation.y=-n*3;c.rotation.y=-1.5*n;l.rotation.y=.8*n;f.vars.rY+=.0001;f.vars.rY>=p&&(f.vars.rY=0)});f.mesh.parent.onDisposeObservable.add(function(){EM.Scene.onBeforeRenderObservable.remove(n);i=0;h=0;r.dispose();r=null;u.dispose();u=null;e.dispose();e=null;c.dispose();c=null;l.dispose();l=null;f.dispose();f=null})}}var f=u(n.id),v;if(f)return f;var y=i?i:500,s=_.round(Math.PI,2),p=s*2,w=n.id;var h=t/20,c=1.05*t,b=1.13*c,k=p/y,l=.001,a=.015;return v=BABYLON.MeshBuilder.CreateSphere(w,{segments:1,diameter:t},EM.Scene),f=new BABYLON.SolidParticleSystem(r(w),EM.Scene,{updatable:!1,boundingSphereOnly:!0}),f.addShape(v,y,{positionFunction:g,vertexFunction:d}),f.buildMesh(),v.dispose(),f.mesh.parent=n,f.mesh.material=e(),f.mesh.material.useAlphaFromDiffuseTexture=!0,f.mesh.rotation.y=90,nt(h),f}var t={},i="rock_material",s="sps_";t.createRings=h;t.getSpsByParentId=u;n.SaturnRings=t}(EM.Particle);EM.AssetRepository={TypeList:{lavaMat:function(){"use strict";var t=Utils.CdnManager.GetBabylonMaterialesCatalog("lava"),n=new BABYLON.LavaMaterial(t,EM.Scene);return n.noiseTexture=new BABYLON.Texture(t+"cloud.png",EM.Scene),n.diffuseTexture=new BABYLON.Texture(t+"lavatile.jpg",EM.Scene),n.speed=.01,this._groundMaterial=n,this._groundMaterial},whaterMat:function(n,t){"use strict";if(!n)throw Utils.Console.Error("AssetRepository.TypeList.whaterMat ground mesh not exsit");var r=Utils.CdnManager.GetBabylonMaterialesCatalog(),u=r+"waterbump.png",i=new BABYLON.WaterMaterial("whaterMat",EM.Scene);return i.bumpTexture=new BABYLON.Texture(u,EM.Scene),i.windForce=10,i.waveHeight=.1,i.bumpHeight=1,i.windDirection=new BABYLON.Vector2(1,1),i.waterColor=new BABYLON.Color3(.1,.2,.2),i.colorBlendFactor=4,i.waveLength=.1,t||(t=EM.GetMesh(EM.AssetRepository.NUBULA_BOX_MESH_ID)),i.addToRenderList(t),i.addToRenderList(n),this._groundMaterial=i,this._groundMaterial}},MAP_TYPE_KEY:"_mapTypeInfo",MESH_CONTAINER_KEY:"_meshContainer",TEXTURE_TYPE_ID_KEY:"_textureTypeId",SERVER_DATA_KEY:"_serverData",MESH_LOCALS_KEY:"_localData",MESH_INFO_KEY:"_meshInfo",MAP_ITEM_KEY:"_mapItem",MATERIALES_KEY:"_materiales",BEFORE_RENDER_SPACE_PLANET_ACTION_KEY:"space_planet",NUBULA_BOX_MESH_ID:null},function(n){"use strict";function i(n,i,r){if(n.hasOwnProperty(t)){var u=n[t];return i?u.hasOwnProperty(i)?u[i]:r?u:null:u}return null}function r(n,i,r){n[t]||(n[t]={});n[t][i]=r}function u(t,i,r){var u=n.MESH_LOCALS_KEY;return t?_.isEmpty(t[u])?!1:i?!r&&t[u].hasOwnProperty(i)?!0:!_.isEmpty(t[u][i]):!0:!1}function f(n,t,f){return u(n,t)||r(n,t,f),i(n,t)}var t=n.MESH_LOCALS_KEY;n.GetLocalsFromMesh=i;n.AddLocalsToMesh=r;n.HasLocalsInMesh=u;n.GetOrAddLoacalsInMesh=f}(EM.AssetRepository),function(n){"use strict";function t(n,t,r){if(i)var u={disposeType:n,oldId:t,advancedData:r}}var i=!0;n.BindDisposeMaterial=function(n){if(n){var r=n.id;t("BindDisposeMaterial REGISTER",r);n.onDisposeObservable.add(function(u,f){var e=Object.keys(n);t("DisposeMaterial",r,[u,f,e]);_.forEach(e,function(i){n[i]&&n[i].dispose&&!_.startsWith(i,"_")&&_.endsWith(i,"Texture")&&(n[i].dispose(),t("____Texture_____",r,[u,f,n[i]],i))});i&&setTimeout(function(){t("HAS MATERIAL IN SCENE",EM.GetMaterial(r))},5)})}};n.BindDisposeFullMesh=function(r,u,f){if(r){var e=r.id;t("BindDisposeFullMesh REGISTER",e);n.BindDisposeMaterial(r.material);r.onDisposeObservable.add(function(){u instanceof Function&&u(r);r&&r.material&&r.material.dispose(!0,!0);f instanceof Function&&f(e);i&&setTimeout(function(){t("DisposeFullMesh HAS MESH IN SCENE",e)},5);r.onDisposeObservable.remove(this)})}}}(EM.AssetRepository),function(n){"use strict";function i(n){if(this.IsMesh=!1,this.IsMeshId=!1,this.IsUniqueId=!1,this.IsString=!1,this.IsEmptyString=!1,this.IsEmptyObject=!1,this.IsObject=!1,this.IsNumber=!1,this.Undefined=!1,this._isCorrectMesh=function(t){return t&&typeof t=="object"&&!_.isEmpty(t)&&n.hasOwnProperty("_scene")},this._isCorrectMeshId=function(n){return Utils.IsNotEmptyString(n)},this.IsCorrectMesh=function(){return this.IsMesh},this.IsCorrectMeshId=function(){return this.IsString&&!this.IsEmptyString},!n)return this.Undefined=!0,this;if(typeof n=="object"){if(this.IsObject=!0,this.IsEmptyObject=_.isEmpty(n),this.IsEmptyObject)return this;if(n.hasOwnProperty("id")&&n.hasOwnProperty("_scene"))return this.IsMesh=!0,this}return typeof n=="string"?(this.IsString=!0,this.IsEmptyString=Utils.IsNotEmptyString(n),!this.IsEmptyString)?(this.IsMeshId=!0,this):this:typeof n=="number"?(this.IsUniqueId=!0,this):this}function r(t,i,r,u,f,e){var o=this;this.TextureTypeId=t;this.LayerName=i;this.SubTypeMeshName=r;this.HasParent=f;this.ParentName=e;this.UniqueId=u;this.HasUniqueId=!!u;this.MapTypeItem=null;this.GetMeshContainer=function(){return n.GetMeshContainer(t,i,r)};this.GetMapType=function(){if(o.MapTypeItem)return o.MapTypeItem;var i=n.MapTypeContainer.Get(t);return i?o.MapTypeItem=i:null}}var u=n.MESH_LOCALS_KEY,t=n.MESH_INFO_KEY;n.GetMeshInfoByMeshId=function(i){var e;if(!Utils.IsNotEmptyString(i))throw Errors.ClientNullReferenceException({meshId:i},"meshId","AssetRepository.GetMeshInfoByMeshId");e=EM.GetMesh(i);e&&n.HasLocalsInMesh(e,t,!0)&&n.GetLocalsFromMesh(e,t);var f=_.split(i,"."),h=!1,c="",o="";if(f.length>2)throw Errors.ClientNotImplementedException({meshId:i,parts:f},"AssetRepository.GetMeshInfoByMeshId");f.length===2?(h=!0,c=f[1],o=f[0]):o=f;var u=_.split(o,"_"),a=_.toNumber(u[0]),v=u[1],l="",s=null;return u.length===4&&Utils.IsNumeric(u[3])?(s=_.toNumber(u[3]),l=u[2]):u.length===3&&Utils.IsNumeric(u[2])?s=_.toNumber(u[2]):u.length!==2&&console.log("данные не соответствуют шаблону, данные не полные"),new r(a,v,l,s,h,c)};n.GetMeshInfoFromMeshOrMeshId=function(i){if(!i)throw Errors.ClientNullReferenceException({meshOrMeshId:i},"meshOrMeshId","EM.MapGeometry.GetMeshInfoFromMeshOrMeshId");if(Utils.IsNotEmptyString(i))return n.GetMeshInfoByMeshId(i);if(typeof i=="object"&&!_.isEmpty(i)){if(!i.hasOwnProperty("id"))throw Errors.ClientNullReferenceException({meshOrMeshId:i},"meshOrMeshId","AssetRepository.GetMeshInfoFromMeshOrMeshId");if(n.HasLocalsInMesh(i,t,!0))return n.GetLocalsFromMesh(i,t);var r=n.GetMeshInfoByMeshId(i.id);return n.AddLocalsToMesh(i,t,r),r}throw Errors.ClientNotImplementedException({meshOrMeshId:i},"AssetRepository.GetMeshInfoFromMeshOrMeshId");};n.CreateMeshArgumentType=function(n){return new i(n)}}(EM.AssetRepository),function(n){"use strict";function r(t,i){var r=n._endsStartWithSeparator(t,!1,!1,n.SEPARATOR);return n.JoinNames([r,i,u])}function f(n,t,i){var u=this;this.BaseMaterialId=n;this.CloneMaterialId=t||r(n,i);this._getMaterial=EM.GetMaterial;this.GetBaseMaterial=function(){return u._getMaterial(n)};this.GetCloneMaterial=function(){return u._getMaterial(t)}}function e(n,r){n[t]||(n[t]={});n[t][i]||(n[t][i]={});n[t][i][r.CloneMaterialId]=r}var t=n.MESH_LOCALS_KEY,i=n.MATERIALES_KEY,u=n.CLONE_MATERIAL_POSTFIX="cloneMaterial";n.GetMaterialInfoFromMesh=function(t,r){var u=n.GetLocalsFromMesh(t,i);return u?u[r]:null};n.CloneMaterial=function(t,i,u){var s=i.id,o=r(s,u),h;if(n.GetMaterialInfoFromMesh(t,o))throw Errors.ClientNotImplementedException({mesh:t,storedMaterial:i},"AssetRepository.ClonetMaterial: clone material exist in mesh");return h=i.clone(o),e(t,new f(s,o,u)),h}}(EM.AssetRepository),function(n){"use strict";function r(n,t,i,r){this.Base=n;this.Env=t;this.Ground=i;this.PlanetId=r;this.IsVisible=null}function u(t,i,u,f,e,o){var s=this,h=n.HIDDEN_POSITION.clone(),c=BABYLON.Vector3.Zero();this.TextureTypeId=f;this.GroundMeshId=i.id;this.SkyBoxMaterialId=u.material.id;this._emptySkayBoxMaterialId=t.material.id;this._skyBoxMesh=t;this._groundMesh=i;this._skyBoxMaterialMesh=u;this._isVisible=!1;this._setVisible=function(n,t){s._isVisible=n;var i=[t.Base,t.Ground,t.Env];EM.SetVisibleGroupByMeshes(i,n,!0);n?(s._setToPosition(c,t.Base),s.OnShow(t)):(s._setToPosition(h,t.Base),s.OnHilde(t))};this._setToPosition=function(n,r){return t.position=i.position=r.position=n.clone(),t.position};this.GetEnverotment=function(n,i,u){t.material.id!==s.SkyBoxMaterialId&&(s._skyBoxMesh.material=s._skyBoxMaterialMesh.material);var f=new r(n,s._skyBoxMesh,s._groundMesh,u);return Object.defineProperty(f,"IsVisible",{get:function(){return s._isVisible},set:function(n){s._setVisible(n,f)}}),f.IsVisible=i,f};this.OnShow=function(n){e instanceof Function&&e(n,s)};this.OnHilde=function(n){o instanceof Function&&o(n,s)}}var t=n.IPLANET_ENVEROTMENT_KEY="_iPlanetEnverotment",i=n.PLANET_ENV_MESH_ID="skybox_planet";n.CreateIPlanetEnverotment=function(n,t,r,f,e){var o=EM.GetMesh(i);return new u(o,n,t,r,f,e)};n.GetIPlanetEnverotment=function(i){var u=n.GetTypeItem(i),r;return u?(r=u.GetMeshContainer(n.LAYER_NAMES.ground),!r)?null:r.hasOwnProperty(t)?r[t]:null:null}}(EM.AssetRepository),function(n){"use strict";n._initBase=function(t,i,r){function ct(n,t,i,r,u,f,e){this.mother=n;this.universe=t;this.galaxy=i;this.sector=r;this.star=u;this.planet=f;this.moon=e}function o(n,t,i){return Utils.Parce.EndsWithSeparatorAndReplace(n,t,i||ut)}function c(n,t,i){return Utils.Parce.StartsWithSeparatorAndReplace(n,t,i||ut)}function lt(n){return Utils.Parce.GetUrlInfo(n)}function ot(n,t){var i=o(n,!0,"/"),r=c(o(t,!0,"/"),!1);return i+r}function d(n){return ot(ri,n)}function p(n){return Utils.IsNotEmptyString(n)}function g(n,t){return t||(t=ut),n.join(t)}function ui(n,t){return t?g([n,t]):n}function fi(n,t,i,r){var u=o(c(n,!1),!0),f=o(c(t,!1),!0),e=o(c(i,!1),!1),s=o(c(r,!0,"."),!1);return u+f+e+s}function it(n,t,i){var r=[n.toString(),t];return p(i)&&i!==h.regular&&r.push(i),g(r)}function at(n,t,i){if(!t&&!i)return n;if(t&&!i)return g([n,t.toString()]);if(i)return(i=o(c(i,!0,"."),!1,"."),!t)?n+i:g([n,t.toString()+i]);throw Errors.ClientNotImplementedException({orignMeshId:n,uniqueId:t,parentMeshId:i},"AssetRepository._initBase._combineMeshIds");}function ei(n,t,i,r,u){var f=it(n,t,i);return at(f,r,u)}function vt(n,t,i){var r=[n.toString(),t];return p(i)&&r.push(i),g(r)}function oi(n){return p(n)?o(n,!0,"."):""}function v(n,t,i){return this.Name=n,this.From=t,this.To=i,this}function yt(n,t){return n>=t.From&&n<=t.To}function si(n){function t(t){return yt(n,t)}return t(u.Mother)?u.Mother.Name:t(u.Galaxy)?u.Galaxy.Name:t(u.Sector)?u.Sector.Name:t(u.Star)?u.Star.Name:t(u.Earth)?u.Earth.Name:t(u.Gas)?u.Gas.Name:t(u.IceGas)?u.IceGas.Name:t(u.Moon)?u.Moon.Name:t(u.Universe)?u.Universe.Name:!1}function pt(n){function t(t){return yt(n,t)}var i=null;if(typeof n=="number"?i=n:typeof n=="string"&&(i=+n),!i)throw new Error("arg --textureTypeId-- is not convertable to numeric type");if(t(u.Mother))return r;if(t(u.Earth)||t(u.Gas)||t(u.IceGas))return l.planet;if(t(u.Moon))return l.moon;if(t(u.Star))return l.star;if(t(u.Sector))return l.sector;if(t(u.Galaxy))return l.galaxy;if(t(u.Universe))return l.universe;throw new Errors.ClientNotImplementedException({argTextureTypeId:n,GAME_TEXTURE_ID_RANGES:u},"Catalog by textyreId:{"+n+"} not exist");}function y(t){return n.TypeList.hasOwnProperty(t)?n.TypeList[t]:null}function wt(n){var t=y(n);return t?y(n).Css:null}function hi(n){var t=wt(n);return t?t.IconSelect:null}function ci(n,t,i,r,u){var f=y(n);return f?f.Pub.GetMeshId(t,i,r,u):null}function bt(n,t,i){var r=y(n);return r?r.Pub.GetMeshContainer(t,i):null}function li(n,t,i){var r=y(n);return r?r.Pub.GetMaterial(t,i):null}function ai(n,t,i){var r=y(n);return r?r.Pub.GetMaterialId(t,i):null}function w(n,t,i,r){return _.upperFirst(n)+_.upperFirst(t)+_.upperFirst(i)+_.upperFirst(r)}function nt(t,i){n[w("Get",t,i,"MeshContainer")]=function(n){return bt(n,t,i)};n[w("Get",t,i,"MeshId")]=function(n,r,u){return ci(n,t,i,r,u)};n[w("Create",t,i,"MeshId")]=function(n,r,u){return ei(n,t,i,r,u)};n[w("Get",t,i,"Mesh")]=function(n,r,u){var f=y(n);return f?f.Pub.GetMesh(t,i,r,u):null}}function rt(t,i){n[w("Get",t,i,"Material")]=function(n){return li(n,t,i)};n[w("Get",t,i,"MaterialId")]=function(n){return ai(n,t,i)};n[w("Create",t,i,"MaterialId")]=function(n){return vt(n,t,i)}}function kt(n,t,i){this.TextureTypeId=n;this._mapType=null;this.MapType=null;this.MapTypeLower=null;this._subMapType=null;this.SubMapType=null;this.SubMapTypeLower=null;this._setSub=function(n){this._subMapType=n||"";this.SubMapType=_.upperFirst(this._subMapType);this.SubMapTypeLower=this._subMapType.toLowerCase()};this._setMapType=function(n){this._mapType=n||"";this.MapType=_.upperFirst(this._mapType);this.MapTypeLower=this._mapType.toLowerCase()};this._setMapType(t);this.hasSubType=function(){return p(this._subMapType)};i&&this._setSub(i)}function vi(){var n=this;this.GetOrAdd=function(t,i,r){return n._collection[t]||(n._collection[t]=new kt(t,i,r)),n._collection[t]};this._collection={};this.AddCollection=function(t,i,r){_.forEach(t,function(t){n._collection[t]=new kt(t,i,r)})};this.UpdateItem=function(t){var i="MapTypeContainer.UpdateItem";if(!t)throw Errors.ClientNullReferenceException(t,"iMapTypeItem",i);if(typeof t!="object")throw Errors.ClientTypeErrorException(t,t,"object/IMapTypeItem",i);if(!t.TextureTypeId)throw Errors.ClientInvalidDataException(t,"MapTypeContainer.UpdateItem",i);return n._collection[t.TextureTypeId]?Utils.UpdateObjData(n._collection[t.TextureTypeId],t):n._collection[t.TextureTypeId]=t,n._collection[t.TextureTypeId]};this.Get=function(t){return n._collection[t]}}function yi(n,t){var i=this;return(this._textureId=n,this.CatalogUrl=pt(n),this.InnerCatalogUrl=null,this.InnerCatalogName=null,this.CreateSubDirUrl=function(n,t){if(!n&&!i.InnerCatalogName)return null;var r=n?n:i.InnerCatalogName,u=t?t:this.CatalogUrl;return ot(u,r)},p(t))?(i.InnerCatalogName=o(c(t,!1,"/"),!1),this.InnerCatalogUrl=this.CreateSubDirUrl()):this}function pi(n,t,i){var r=_.extend(this,dt);return r._textureTypeId=n,r._mapTypeName=t,r._mapTypeLowerName=t.toLowerCase(),r.IconSelect="",r.TextureCss=null,r.Sprite=null,r._spriteCatalogUrl=i,r.GroupName=null,r.DetailCss=null,r.MediumCss=null,r.SmallCss=null,r.CreateSelectors=null,r.InitCss=function(){function u(n){return i+" "+t+" "+f+" "+n}var f=r._textureCssPrefix+r._textureTypeId,t="",n=r._mapTypeLowerName,i;t=n==="earth"||n==="gas"||n==="icegas"?r._planetPrefix+n:n;i=r._spriteMapPrefix+t;n==="mother"&&(i="sprite_control_icons",t="map-object",f="jumptomother");r.TextureCss=f;r.Sprite=i;r.GroupName=t;r.DetailCss=u(r.xl);r.MediumCss=u(r.m);r.SmallCss=u(r.s);r.СreateSelectors=u;r.IconSelect=r.SmallCss;r.SetIconSelect=function(n){r.IconSelect=n}},r}function gt(n,t,i){this.LayerName=t;this.TextureTypeId=n;this._advancedName="";i||(i=ft.regular);this.AdvancedName=i;i!==ft.regular&&(this._advancedName=i);this.ObjectName=ui(this.LayerName,this._advancedName)}function st(t,i,r,u){function h(){i&&t&&r&&(f.TextureTypeId=i.TextureTypeId,f.TextureTypeName=r,f.ObjectName=i.ObjectName,f.LayerName=i.LayerName,f.Ext=u?u:et.jpg,f.FileName=fi(f.TextureTypeId,f.ObjectName,f.TextureTypeName,f.Ext),f.Catalog=t,f.Url=f.Catalog+f.FileName)}var o=!1,f=this;return f.LayerName=null,f.TextureTypeId=null,f.ObjectName=null,f._texture=null,f.TextureTypeName=null,f.Ext=null,f.FileName=null,f.CubeNames=null,f.Catalog=null,f.Url=null,f.Created=!1,f._externalTextureType=null,f.ExternalTextureHasCorrectInfo=!1,h(),f.GetOrCreateTexture=function(n){if(f.Created)return f._texture;if(n){var t=lt(n);f.Url=t.Url;f.FileName=t.FileName;f.Catalog=t.Catalog;console.log("GetOrCreateTexture",{_self:f})}return f._texture=tt.CreateTexture(f.Url),f.Created=!0,f._texture},f.GetOrCreateCubeTexture=function(t,i){return f.Created?f._texture:(i&&(f.Url=null,f.Catalog=i),f.CubeNames=t?t:n.SKYBOXE_NAMES,f._texture=new BABYLON.CubeTexture(f.Catalog,EM.Scene,f.CubeNames),f.Created=!0,f._texture)},f.GetOrCreateHdrTexture=function(t,i){if(f.Created)return f._texture;i&&(f.Url=null,f.Catalog=i);var r=i+t+n.EXTENTIONS.hdr;return f._texture=new BABYLON.HDRCubeTexture(r,EM.Scene,512),f.Created=!0,f._texture},f.GetOrCreateCubeTextureFromOneFile=function(n,t){if(f.Created)return f._texture;var i=!1;return t&&(f.Catalog=t,i=!0),n&&(f.FileName=n,f.Ext=f.FileName.substring(f.FileName.length-4),i=!0),i&&(f.Url=f.Catalog+f.FileName),f.CubeNames=[f.FileName,f.FileName,f.FileName,f.FileName,f.FileName,f.FileName],f._texture=new BABYLON.CubeTexture(f.Catalog,EM.Scene,f.CubeNames),f.Created=!0,f._texture},f.SetExternalTexture=function(n,t){var r,i,c,h,u;if(!t)throw Errors.ClientNullReferenceException({ITextureItem:f,babylonTexture:t},"babylonTexture","ITextureItem.SetExternalTexture");if(f.TextureTypeName=n,f.Url=t.url,f._texture=t,f.Created=!0,r=lt(f.Url),f.Catalog=r.Catalog,f.FileName=null,f.Ext=null,f.TextureTypeId=null,f.LayerName=null,r.IsFile()){if(f.FileName=r.FileName,f.Ext=r.Ext,i=_.split(f.FileName,"_"),c=_.toInteger(i[0]),!c)return f.ObjectName=f.FileName.substr(0,f.FileName.lastIndexOf(".")),f;f.TextureTypeId=c;h=i[i.length-1];h.length>4&&(u=h.substr(0,h.lastIndexOf(".")),s.hasOwnProperty(_.upperFirst(u))&&(f._externalTextureType=u),u===f.TextureTypeName?f.ExternalTextureHasCorrectInfo=!0:(f.IsLinkToOtherTexture=!0,o&&console.log("external texture type inccorect",{babylonTexture:t,_externalTextureType:u,currentTextureType:f.TextureTypeName,ITextureItem:f})));e.hasOwnProperty(i[1])&&(f.LayerName=i[1]);f.LayerName&&f._externalTextureType&&(f.ObjectName=_.join(_.dropRight(_.drop(i,1),1),"_"))}return f},f}function ni(n,t,i){var r=this;return r.LayerName=n.LayerName,r.TextureTypeId=n.TextureTypeId,r.AdvancedName=n.AdvancedName,r.ObjectName=n.ObjectName,r.SubtypeMaterialName=i,r._subtypeMaterialName=null,r._subtypeMaterialName=r.SubtypeMaterialName===f.regular?"":i,r.CatalogUrl=t.CatalogUrl,r.InnerCatalogUrl=t.InnerCatalogUrl,r.CreateSubDirUrl=t.CreateSubDirUrl,r._activeCatalogUrl=r.InnerCatalogUrl?r.InnerCatalogUrl:r.CatalogUrl,r.UpdateActiveCatalogUrl=function(n){r._activeCatalogUrl=n},r.diffuse=null,r.bump=null,r.specular=null,r.ambient=null,r.emissive=null,r.opacity=null,r.reflection=null,r.refraction=null,r.light=null,r.MaterialId=null,r.ImportSceneName=null,r.ScenePrefix="",r.SetScenePrefix=function(n){return n||Errors.ClientNullReferenceException({sceneName:n,IMaterialContainer:ni},"sceneName","IMaterialContainer.SetScenePrefix"),r.ImportSceneName=n,r.ScenePrefix=oi(n),r},r.GetOrCreateTextureItem=function(t,i,u,f){return r[t]?r[t]:!f&&!u?(r[t]=new st(r._activeCatalogUrl,n,t,i),r[t]):(f?r.UpdateActiveCatalogUrl(f):u&&r.InnerCatalogUrl&&r._activeCatalogUrl!==r.CatalogUrl&&r.UpdateActiveCatalogUrl(r.CatalogUrl),r[t]=new st(r._activeCatalogUrl,n,t,i),r[t])},r.GetOrCreateTexture=function(n,t,i,u){if(r.ExistTexture(n))return r.GetTexture(n);var f=r.GetOrCreateTextureItem(n,t,i,u);return f.GetOrCreateTexture()},r.ExistTexture=function(n){return!!r[n]},r.GetTextureObj=function(n){return r.ExistTexture(n)?r[n]:null},r.GetTexture=function(n){return r.ExistTexture(n)?r[n].GetOrCreateTexture():null},r.GetTextureUrl=function(n){return r.ExistTexture(n)?r[n].Url:null},r.SetExternalTexture=function(n,t){if(r.ExistTexture(n)){var i=r.GetTextureObj(n);return i.SetExternalTexture(n,t)}return r[n]=new st,r[n].SetExternalTexture(n,t)},r._createMaterialId=function(){return r.ScenePrefix+vt(r.TextureTypeId,r.LayerName,r._subtypeMaterialName)},r.GetOrCreateMaterialId=function(){return r.MaterialId||(r.MaterialId=r._createMaterialId()),r.MaterialId},r._setMaterialProperty=null,r.GetOrCreateMaterial=function(n){var i=r.GetOrCreateMaterialId(),t=tt.GetMaterial(i),u=!!t;return!n&&u?t:(n instanceof Function&&!r._setMaterialProperty&&(r._setMaterialProperty=n),t=tt.CreateBaseMaterial(i,function(n){return r._setMaterialProperty instanceof Function?r._setMaterialProperty(n,r,i,u):n}),t||(r._setMaterialProperty=null,Errors.ClientNotImplementedException("material not exist",{IMaterialContainer:r,setMaterialProperty:n,matId:i})),t)},r.SetExternalMaterial=function(n,t,i){var f,e,u;if(!n)throw Errors.ClientNullReferenceException({babylonMaterial:n,IMaterialContainer:r},"babylonMaterial","IMaterialContainer.SetExternalMaterial");return f=r._createMaterialId(),r.MaterialId&&(e=EM.GetMaterial(r.MaterialId),e&&Utils.Console.Warn("IMaterialContainer.SetExternalMaterial в текущей сцене уже есть связанным и назначенный материал",{IMaterialContainer:r,oldMaterial:e,babylonMaterial:n,babylonMaterialId:n.id,templateMaterialId:f})),r.MaterialId=n.id,f!==n.id&&Utils.Console.Warn("Material is not equal with template",{"babylonMaterial.id":n.id,templateMaterialId:f,IMaterialContainer:r}),t||(u=r.SetExternalTexture,n.diffuseTexture&&u(s.Dffuse,n.diffuseTexture),n.bumpTexture&&u(s.Bump,n.bumpTexture),n.specularTexture&&u(s.Specular,n.specularTexture),n.ambientTexture&&u(s.Ambient,n.ambientTexture),n.emissiveTexture&&u(s.Emissive,n.emissiveTexture),n.opacityTexture&&u(s.Opacity,n.opacityTexture),n.reflectionTexture&&u(s.Reflection,n.reflectionTexture),n.lightmapTexture&&u(s.Light,n.lightmapTexture),n.refractionTexture&&u(s.Refraction,n.refractionTexture),i&&!_.isEmpty(i)&&_.forEach(i,function(n,t){r.ExistTexture(t)?console.log("texture type is wrong",{advancedTextureNames:i,texture:n,textureKey:t,IMaterialContainer:r}):u(t,n)})),r},r.GetMaterial=function(){return r.GetOrCreateMaterial()},r}function wi(){var n=this,t={},i={};return this.StartOnBeforeRender=function(r,u,f){if(!r||!p(u)||!f||typeof f!="object")throw Errors.ClientTypeErrorException({IRenderOption:n},f,"object","IRenderOption.StartOnBeforeRenderObservable");var e=i[u];if(!(e instanceof Function))throw Errors.ClientNullReferenceException({IRenderOption:n},"_callbaks[key]","IRenderOption.StartOnBeforeRenderObservable");return t[r]=EM.Scene.onBeforeRenderObservable.add(function(t,i){e(t,i,f,n)||n.StopBeforeRender(r)}),n},this.StopBeforeRender=function(n){EM.Scene.onBeforeRenderObservable.remove(t[n]);t[n]=null;delete t[n]},this.AddFunction=function(n,t){i[n]=t},this}function ht(n){if(!(n instanceof Function))throw Utils.Console.Error("IMeshContainer - param createMeshId is requred  mesh id factory");var t=this;return this._meshId=null,this._createMeshId=n,this.GetMeshId=function(n,t){return this._meshId||(this._meshId=this._createMeshId()),at(this._meshId,n,t)},this.AdvPropNames={},this.GetMesh=function(n,i){return tt.GetMesh(t.GetMeshId(n,i))},this._addProp=function(n,i){this[n]=i;_.startsWith(n,"_")||console.log("IMeshContainer.AddProp: Local property must be start with '_' ",{IMeshContainer:t});this.AdvPropNames[n]=n},this}function bi(n){var t=this;return t.LayerName=n.LayerName,t.TextureTypeId=n.TextureTypeId,t.AdvancedName=n.AdvancedName,t.ObjectName=n.ObjectName,t.materiales={},t.materiales[f.regular]=null,t.materiales[f.cloud]=null,t.materiales[f.ring]=null,t.materiales[f.click]=null,t.materiales[f.hover]=null,t.meshes={},t.meshes[h.regular]=null,t.meshes[h.cloud]=null,t.meshes[h.ring]=null,t.GetMeshContainer=function(n){return n?t.meshes[n]:t.meshes.regular},t.GetMesh=function(n,i,r){var u=t.GetMeshContainer(n);if(!u)return null;if(typeof u=="object")return u.GetMesh(i,r);throw Errors.ClientTypeErrorException({subTypeMeshName:n,ILayerContainer:t,meshSection:u},u,"object/IMeshContainer","ILayerContainer.GetMesh");},t.GetMeshId=function(n,i,r){var u=t.GetMeshContainer(n);if(!u)return null;if(typeof u=="object")return u.GetMeshId(i,r);throw Errors.ClientTypeErrorException({subTypeMeshName:n,ILayerContainer:t,meshSection:u},u,"object/IMeshContainer","ILayerContainer.GetMeshId");},t.AddMeshContainer=function(n,i){var r=n||"";return n||(n=k.regular),n!==k.regular&&(r=n),t.meshes[n]=new ht(i||function(){return it(t.TextureTypeId,t.LayerName,r)}),t.meshes[n]},t.AddMeshContainerFromExternalMesh=function(n,i){var r=i||"",u,f;if(i===k.regular&&(r=""),i||(i=k.regular),u=it(t.TextureTypeId,t.LayerName,r),u!==n.id)throw Errors.ClientNotEqualException({advName:r,externalMesh:n,subTypeMeshName:i,templateName:u},"ILayerContainer.AddMeshContainerFromExternalMesh");return f=n.id,t.meshes[i]=new ht(function(){return f}),t.meshes[i]},t._getIMaterialContainer=function(n){return n&&f.hasOwnProperty(n)?t.materiales[n]:t.materiales[f.regular]?t.materiales[f.regular]:null},t.AddIMaterialContainer=function(n,i){if(!n)throw Errors.ClientNullReferenceException({subtypeMaterialName:i,iMaterial:n},"iMaterialContainer","ILayerContainer.AddIMaterialContainer");if(typeof n!="object")throw Errors.ClientTypeErrorException({subtypeMaterialName:i,iMaterial:n},n,"object/IMaterialContainer","ILayerContainer.AddIMaterialContainer");if(!i&&!t.materiales[f.regular])return t.materiales[f.regular]=n;if(t.materiales[i])return t.materiales[i];if(f.hasOwnProperty(i))return t.materiales[i]=n,t.materiales[i];throw Errors.ClientNotImplementedException({subtypeMaterialName:i,iMaterialContainer:n,ILayerContainer:t},"ILayerContainer.AddIMaterialContainer");},t.GetIMaterialContainer=function(n,i){var r=t._getIMaterialContainer(n);if(!r&&!i)throw Errors.ClientNullReferenceException({IMaterialContainer:r,ILayerContainer:t},"iMat","ILayerContainer.GetIMaterialContainer");return r},t.HasIMaterialContainer=function(n){return!!t._getIMaterialContainer(n)},t.RenderOption=null,t.GetOrCreateRenderOptions=function(){return t.RenderOption?t.RenderOption:t.RenderOption=new wi},t}var ut,l,tt,a,u,dt;n.SKYBOXE_NAMES=["back.jpg","top.jpg","right.jpg","front.jpg","bottom.jpg","left.jpg"];var ki=n.HIDDEN_POSITION=EM.HIDDEN_POSITION,ti=n.GAME_OBJECTS_VERSION=t,ii=n.USE_FROM_LOCAL=i,ri=n.GAME_OBJECTCS_CATALOG=Utils.CdnManager.GetGameObjectsCatalog(ti,ii),s=n.TEXTURE_TYPES={Dffuse:"diffuse",Bump:"bump",Specular:"specular",Ambient:"ambient",Emissive:"emissive",Opacity:"opacity",Reflection:"reflection",Light:"light",Height:"height",Refraction:"refraction"};var b=n.GO_TYPE_NAMES=new ct("mother","universe","galaxy","sector","star","planet","moon"),e=n.LAYER_NAMES={space:"space",ground:"ground",env:"env"},k=n.BASE_SUB_NAMES={regular:"regular",cloud:"cloud",ring:"ring"},ft=n.ADVANCED_NAMES=_.extend({sprite:"sprite",material:"material"},k),h=n.SUBTYPE_MESH_NAMES=_.extend({empty:"empty"},ft),f=n.SUBTYPE_MATERIAL_NAMES=_.extend({click:"click",hover:"hover"},k),et={jpg:".jpg",png:".png",babylon:".babylon",hdr:".hdr"};et.cleanPoint=function(n){return _.startsWith(n,".")?n.substring(1):n};n.EXTENTIONS=et;ut=n.SEPARATOR="_";l=n.GO_CATALOG_URLS=new ct(r,d(b.universe),d(b.galaxy),d(b.sector),d(b.star),d(b.planet),d(b.moon));tt=EM.GetHelpers();n.GetMeshIdByMeta=function(n,t,i){function r(){return it(n.TextureTypeId,n.LayerName,n._advancedName)}var u=new ht(r);return u.GetMeshId(t,i)};n.GetPlanetCatalog=function(n){var t=l.planet;return n?ot(t,n.toString()):t};n.JoinNames=g;n._endsStartWithSeparator=function(n,t,i,r){return o(c(n,t,r),i,r)};n._createOriginalMeshIdTemplate=it;a=n.MapTypes=EM.MapGeometry.MapTypes;u=n.GAME_TEXTURE_ID_RANGES={Galaxy:new v(a.Galaxy.toLowerCase(),1,100),Sector:new v(a.Sector.toLowerCase(),201,300),Star:new v(a.Star.toLowerCase(),301,400),Earth:new v(a.Earth.toLowerCase(),401,500),Gas:new v(a.Gas.toLowerCase(),501,600),IceGas:new v(a.IceGas.toLowerCase(),601,700),Moon:new v(a.Moon.toLowerCase(),901,1e3),Mother:new v(a.Mother.toLowerCase(),2e3,2e3),Universe:new v(a.Universe.toLowerCase(),4001,4100)};n._initGroup=function(n,t,i){i?n():_.forEach(t,function(t){n(t)})};n.GetGroupTypeName=si;n.MapTextureIdToCatalogUrl=pt;n.GetTypeItem=function(n){var t=y(n);return t?t.Pub:null};n.GetCss=wt;n.GetIconSelectCss=hi;n.GetSpaceRegularMeshContainer=null;n.GetSpaceCloudMeshContainer=null;n.GetSpaceRingMeshContainer=null;n.GetSpaceMaterialMeshContainer=null;n.GetSpaceEmptyMeshContainer=null;n.GetSpaceSpriteMeshContainer=null;n.GetSpaceRegularMesh=null;n.GetSpaceCloudMesh=null;n.GetSpaceRingMesh=null;n.GetSpaceMaterialMesh=null;n.GetSpaceEmptyMesh=null;n.GetSpaceSpriteMesh=null;n.GetSpaceRegularMeshId=null;n.GetSpaceCloudMeshId=null;n.GetSpaceRingMeshId=null;n.GetSpaceMaterialMeshId=null;n.GetSpaceEmptyMeshId=null;n.GetSpaceSpriteMeshId=null;n.CreateSpaceRegularMeshId=null;n.CreateSpaceCloudMeshId=null;n.CreateSpaceRingMeshId=null;n.CreateSpaceMaterialMeshId=null;n.CreateSpaceEmptyMeshId=null;n.CreateSpaceSpriteMeshId=null;nt(e.space,h.regular);nt(e.space,h.cloud);nt(e.space,h.ring);nt(e.space,h.material);nt(e.space,h.empty);nt(e.space,h.sprite);n.GetMeshContainer=bt;n.GetSpaceRegularMaterial=null;n.GetSpaceClickMaterial=null;n.GetSpaceHoverMaterial=null;n.GetSpaceCloudMaterial=null;n.GetSpaceRingMaterial=null;n.GetSpaceRegularMaterialId=null;n.GetSpaceClickMaterialId=null;n.GetSpaceHoverMaterialId=null;n.GetSpaceCloudMaterialId=null;n.GetSpaceRingMaterialId=null;n.CreateSpaceRegularMaterialId=null;n.CreateSpaceClickMaterialId=null;n.CreateSpaceHoverMaterialId=null;n.CreateSpaceCloudMaterialId=null;n.CreateSpaceRingMaterialId=null;rt(e.space,f.regular);rt(e.space,f.click);rt(e.space,f.hover);rt(e.space,f.cloud);rt(e.space,f.ring);n.MapTypeContainer=new vi;dt={_spriteMapPrefix:"sprite_map_",_textureCssPrefix:"texture_",_planetPrefix:"planet_",_separator:"_",xl:"xl",m:"m",ms:"ms",s:"s",sx:"sx",xs:"xs",_cleanSeparator:function(n){return p(n)?this.startsWithSeparator(this.endsWithSeparator(n,!1),!1):""},startsWithSeparator:function(n,t){return c(n,t,this._separator)},endsWithSeparator:function(n,t){return o(n,t,this._separator)},convertCssNameToClass:function(n){return c(n,!0,".")}};n.ITypeItem=function(n,t,i,r,u,e){function o(){var o=_.extend(this,u||new yi(n,i));return o._sceneName=r,o._getLayer=function(n,t){if(o.hasOwnProperty(n)){var i=o[n];if(!i&&t||typeof i=="object")return i;throw Errors.ClientTypeErrorException({layerName:n},"ITypeItem._getLayer",n,"object/ILayerContainer");}else{if(t)return null;throw Errors.ClientNullReferenceException({layerName:n,notThrowIfNull:t},"ITypeItem[layerName]","ITypeItem._getLayer");}},o._getLayerElseIf=function(n,t,i,r){if(r)return r;if(t)return o.GetOrCreateLayer(t);if(n)return o._getLayer(n);throw Errors.ClientNotImplementedException({ITypeItem:o,layerName:n,gameObjectMeta:t,notThrowIfNull:i,_layer:r});},o.GetOrCreateLayer=function(n){o._isValidObjectMeta(n);var t=n.LayerName;if(!t)throw Errors.ClientNullReferenceException({layerName:t,iGameObjectMeta:n},"ITypeItem.GetOrCreateLayer");return o[t]?o[t]:o[t]=new bi(n)},o.GetMeshId=function(n,t,i,r,u,f){var e=o._getLayerElseIf(n,i,!1,f);if(e)return e.GetMeshId(t,r,u);throw Errors.ClientNullReferenceException({layerName:n,subTypeMeshName:t,ITypeItem:o},"layer","ITypeItem.GetMeshId");},o.GetMesh=function(n,t,i,r,u,f){var e=o._getLayerElseIf(n,u,!1,f);return e.GetMesh(t,i,r)},o.AddMeshContainer=function(n,t,i,r,u){var f=o._getLayerElseIf(i,n,u);return f.AddMeshContainer(r,t)},o.AddMeshContainerFromExternalMesh=function(n,t,i,r,u){var f=o._getLayerElseIf(r,t,u);return f.AddMeshContainerFromExternalMesh(n,i)},o.GetIMaterialContainer=function(n,t,i,r){var u=o._getLayerElseIf(n,null,i,r);return u?u.GetIMaterialContainer(t,i):null},o.CreateIMaterialContainer=function(t,i,r,u){var e=o._getLayerElseIf(null,t,!1,u),s,h,c;return(i||(i=f.regular),e.HasIMaterialContainer(i))?(s=e.GetIMaterialContainer(i),r||Utils.Console.Warn("ITypeItem.CreateIMaterialContainer - IMaterialContainer exist, return old IMaterialContainer",{subtypeMaterialName:i,layer:e,mat:s}),s):(h=new gt(n,e.LayerName,i),c=new ni(h,o,i),e.AddIMaterialContainer(c,i))},o.AddIMaterialContainer=function(n,t,i,r){var u=o._getLayerElseIf(n,null,!1,r),f;return u.HasIMaterialContainer(i)?(f=u.GetIMaterialContainer(i),Utils.Console.Warn("ITypeItem.AddIMaterialContainer - IMaterialContainer exist, return old IMaterialContainer",{layerName:n,subtypeMaterialName:i,existIMaterial:f,paramIMaterial:t}),f):u.AddIMaterialContainer(t,i)},o.GetOrCreateIMaterial=function(n,t,i){var r=o._getLayerElseIf(null,n,!1,i),u=o.GetIMaterialContainer(r.LayerName,t,!0,r);return u||(u=o.CreateIMaterialContainer(n,t,!1,r)),u},o.GetOrCreateMaterial=function(n,t,i){i||(i=f.regular);var r=o.GetOrCreateIMaterial(n,i);return r.GetOrCreateMaterial(t)},o.GetMaterial=function(n,t,i){var u=o._getLayerElseIf(n,null,!0,i),r;return u?(t||(t=f.regular),r=u.GetIMaterialContainer(t,!0),!r)?null:r.GetMaterial():null},o._isValidObjectMeta=function(n){if(!n)throw Errors.ClientNullReferenceException(null,"gameObjectMeta","ITypeItem._checkObjectMeta");if(typeof n!="object")throw Errors.ClientTypeErrorException({gameObjectMeta:n},n,"object/IGameObjectMeta","ITypeItem._isValidObjectMeta");return!0},o.CreateGameObjectMeta=function(t,i){return t||Errors.ClientNullReferenceException({layerName:t,baseSubName:i},"layerName","ITypeItem.CreateGameObjectMeta"),new gt(n,t,i)},e||(o.Css=new pi(n,t,o.CatalogUrl),o.Css.InitCss()),o.GetOrCreateRenderOptions=function(n,t,i){var r=o._getLayerElseIf(n,t,!1,i);return r.GetOrCreateRenderOptions()},o.Pub={},o.Pub.GetLayer=function(n){return o._getLayer(n,!0)},o.Pub.GetMeshContainer=function(n,t){var i=o.Pub.GetLayer(n);return i?i.GetMeshContainer(t):null},o.Pub.GetMeshId=function(n,t,i,r){var u=o.Pub.GetLayer(n);return u?u.GetMeshId(t,i,r):null},o.Pub.GetMesh=function(n,t,i,r){var u=o.Pub.GetLayer(n);return u?u.GetMeshId(t,i,r):null},o.Pub.GetIMaterialContainer=function(n,t){var i=o.Pub.GetLayer(n);return i?i.GetIMaterialContainer(t,!0):null},o.Pub.GetMaterialId=function(n,t){var i=o.Pub.GetIMaterialContainer(n,t);return i?i.GetOrCreateMaterialId():null},o.Pub.GetMaterial=function(n,t){var i=o.Pub.GetIMaterialContainer(n,t);return i?i.GetMaterial():null},o.Pub.GetTexture=function(n,t,i){var r=o.Pub.GetIMaterialContainer(n,t);return r?r.GetTexture(i):null},o.Pub.GetTextureUrl=function(n,t,i){var r=o.Pub.GetIMaterialContainer(n,t);return r?r.GetTextureUrl(i):null},o.GetTextureContainer=function(n,t,i){var r=o.Pub.GetIMaterialContainer(n,t);return r?r.GetTextureObj(i):null},o}return new o};n.SetTypeItem=function(t,i){n.TypeList[t]=i}}}(EM.AssetRepository),function(n){"use strict";n._initMother=function(){function r(){var r=n.ITypeItem(t,i.Name);return r.Css.SetIconSelect(r.Css.MediumCss),n.SetTypeItem(t,r),r}var t=2e3,i;n.A_MOTHER_IDS=[t];i=n.GAME_TEXTURE_ID_RANGES.Mother;n.MapTypeContainer.GetOrAdd(t,n.MapTypes.Mother);n._initGroup(r,null,!0)}}(EM.AssetRepository),function(n){"use strict";n._initGalaxies=function(){function o(t,r,u,f){var o,s,e;return f?(console.log("createGalaxyMaterial.materialIsExist",{material:t,iMaterial:r,matId:u}),t):(o=r.GetOrCreateTextureItem(i.Emissive),s=r.GetOrCreateTextureItem(i.Bump,n.EXTENTIONS.png),t.emissiveTexture=o.GetOrCreateTexture(),t.emissiveTexture.level=3,t.backFaceCulling=!1,t.disableLighting=!0,t.useEmissiveAsIllumination=!0,t.alpha=.999,t.alphaMode=BABYLON.Engine.ALPHA_ADD,e=new BABYLON.FresnelParameters,e.bias=.1268,e.power=10,e.leftColor=new BABYLON.Color3(.6,.85,.97),e.rightColor=new BABYLON.Color3(.36,.67,.93),t.emissiveFresnelParameters=e,t.bumpTexture=s.GetOrCreateTexture(),t.bumpTexture.level=3,t.useParallax=!0,t.useParallaxOcclusion=!1,t.parallaxScaleBias=.015,t)}function s(){var s=1,l,a;n.A_GALAXY_IDS.push(s);var v=n.MapTypeContainer.GetOrAdd(s,n.MapTypes.Galaxy,n.MapTypes.Spirale),i=n.ITypeItem(s,r.Name),h=i.CreateGameObjectMeta(t.space,f.regular),c=i.AddMeshContainer(h);return c._addProp(n.MAP_TYPE_KEY,v),l=i.GetOrCreateMaterial(h,o,u.regular),a=i.GetMeshId(t.space),e&&console.log("createGalaxy1",{galaxyItem:i,meta:h,material:l,meshId:a,meshContainer:c}),n.SetTypeItem(s,i),i}n.A_GALAXY_IDS=[];var r=n.GAME_TEXTURE_ID_RANGES.Galaxy,t=n.LAYER_NAMES,i=n.TEXTURE_TYPES,u=n.SUBTYPE_MATERIAL_NAMES,f=n.BASE_SUB_NAMES,e=!1;s()}}(EM.AssetRepository),function(n){"use strict";n._initSectors=function(){function i(n,t,i,r,u){return t?n:(i=BABYLON.Color3.FromInts(i.r,i.g,i.b),r?(n.emissiveColor=i,n.alpha=u||1,n.disableLighting=!0):(n.diffuseColor=i,n.emissiveColor=i),n)}function e(){var o=201,h;n.A_SECTOR_IDS.push(o);var c=n.MapTypeContainer.GetOrAdd(o,n.MapTypes.Sector),e=n.ITypeItem(o,u.Name),s=e.CreateGameObjectMeta(r.space),l=e.AddMeshContainer(s);l._addProp(n.MAP_TYPE_KEY,c);h=e.GetMeshId(r.space);e.GetOrCreateMaterial(s,function(n,t,r,u){return i(n,u,new BABYLON.Color3(230,204,255),!0,.4)},t.regular);e.GetOrCreateMaterial(s,function(n,t,r,u){return i(n,u,new BABYLON.Color3(255,0,0))},t.click);e.GetOrCreateMaterial(s,function(n,t,r,u){return i(n,u,new BABYLON.Color3(25,229,225))},t.hover);n.SetTypeItem(o,e);f&&console.log("createSector201",{meshId:h,item:e})}n.A_SECTOR_IDS=[];var u=n.GAME_TEXTURE_ID_RANGES.Sector,r=n.LAYER_NAMES,t=n.SUBTYPE_MATERIAL_NAMES,f=!1;e()}}(EM.AssetRepository),function(n){"use strict";n._initStars=function(){function t(t,o,s){var l=n.MapTypeContainer.GetOrAdd(t,n.MapTypes.Star,o),c=n.ITypeItem(t,u.Name),a=c.CreateGameObjectMeta(i.space),v=c.AddMeshContainer(a),y,h,p,w;c.GetMeshId(i.space);y=c.CreateGameObjectMeta(i.space,r.sprite);h=c.AddMeshContainer(y,null,i.space,r.sprite);h._addProp("_parentName",EM.MapGeometry.SYSTEM_PROTO_NAME);h._addProp(n.MAP_TYPE_KEY,l);h._addProp("_spriteIndex",s);h._addProp("_getFullSpriteId",function(n){return h.GetMeshId(n,h._parentName)});h._addProp("_getBaseSpriteId",function(n){return h.GetMeshId(n)});v._addProp(n.MAP_TYPE_KEY,l);v._addProp("_getFullSpriteId",function(n){return h._getFullSpriteId(n)});c.GetOrCreateMaterial(a,function(n,t,i,r){if(r)return n;var u=t.GetOrCreateTextureItem(f.Emissive);return n.emissiveTexture=u.GetOrCreateTexture(),n.emissiveTexture.level=.5,n.disableLighting=!0,n},e.regular);p=c.Pub.GetMeshContainer(i.space,r.sprite);w=p.GetMeshId();n.SetTypeItem(t,c)}var o=n.A_STAR_IDS=[301,302,303,304,305,306,307,308],u=n.GAME_TEXTURE_ID_RANGES.Star,i=n.LAYER_NAMES,f=n.TEXTURE_TYPES,e=n.BASE_SUB_NAMES,r=n.SUBTYPE_MESH_NAMES;t(301,n.MapTypes.A,0);t(302,n.MapTypes.B,1);t(303,n.MapTypes.F,2);t(304,n.MapTypes.G,3);t(305,n.MapTypes.K,4);t(306,n.MapTypes.L,5);t(307,n.MapTypes.M,6);t(308,n.MapTypes.O,7)}}(EM.AssetRepository),function(n){"use strict";n._initPlanets=function(t,i){function it(n,t,i,r,u){Errors.ClientNotImplementedException({material:n,iMaterial:t,spaceLayer:i,materialType:r},u)}function rt(n,t){this.OnShow=n;this.OnHide=t}function ot(n,t){return Utils.GetColor3FromInts(n,t||ft)}function e(n,t,i,r){var u=new BABYLON.FresnelParameters;return n&&(u.bias=n),t&&(u.power=t),i&&(u.leftColor=i.clone()),r&&(u.rightColor=r.clone()),u}function y(n,t,i,r){var u,f,e;tt&&(u={},u[n]=t,f="item",r&&(f=r),e=f+".__{"+i+"}__",console.log(e,u))}function st(t){var r=n.GetMeshIdByMeta(t),i;return r?(i=EM.GetMesh(r),!i)?(y("mesh",{mesh:i,meta:t},t.TextureTypeId,"tryGetMesh"),null):i:null}function p(n,t,i,r,u){var f={loadedMesh:null,meshLoaded:!1,meshContainer:null,meshId:null},e;return n&&(e=u||st(i),e?(f.meshContainer=t.AddMeshContainerFromExternalMesh(e,i,r),f.meshLoaded=!0,f.loadedMesh=e):y("mesh",{tryLoadMeshFromFile:n,iTypeItem:t,gameObjectMeta:i,result:f},i.TextureTypeId,"_addMeshContainer.mesh.notFiended")),f.meshLoaded||(f.meshContainer=t.AddMeshContainer(i,null,null,r)),f.meshId=f.meshContainer.GetMeshId(),f}function g(n,t,i,r){return i?n:s[t.TextureTypeId]?s[t.TextureTypeId](n,t,r):s.standard(n,t,r)}function w(n,t,u,f,e){function c(n,t){y(n,t,v,"createOrUpdateMaterial.materialType_{"+u+"}_")}var v=n.TextureTypeId,s=null,a=!!f,o,h,l;if(c("loadExternalMaterial",{loadExternalMaterial:a,loadedMesh:f,"!!loadedMesh":!!f}),o=t.GetOrCreateLayer(n),c("layer",o),h=t.GetOrCreateIMaterial(n,u,o),o.LayerName===r.space){if(f)throw new Error("в сцене существует меш с именем спейс или спейс клауд");if(!e)throw new Error("_meshId not exit",{_meshId:e,meta:n,typeItem:t});l=BABYLON.Mesh.CreateSphere(e,12,1,EM.Scene);l.isVisible=!1;l.isPickable=!1;l.material=s=h.GetOrCreateMaterial(function(n,t,i,r){return g(n,t,r,o)});c("loadExternalMaterial layer.LayerName === ln.space, material",s)}else a?(h.SetScenePrefix(i),h.SetExternalMaterial(f.material),s=g(f.material,h,!1,o),c("updatedMaterialFromLoadData",s)):s=h.GetOrCreateMaterial(function(n,t,i,r){return g(n,t,r,o)});return{iMaterialContainer:h,material:s,layer:o,matId:s.id,loadExternalMaterial:a}}function ht(t,i,f,e){function s(n,i){y(n,i,t,"createItem")}var o=n.ITypeItem(t,i,t.toString()),ct,nt,k,yt,d,ft,lt,at,tt,ot,h,pt,st,rt,ut;n.A_PLANET_IDS.push(t);var b=n.MapTypeContainer.GetOrAdd(t,n.MapTypes.Planet,i),ht=o.CreateGameObjectMeta(r.space,l.regular),g=p(e,o,ht,c.regular);if(g.meshContainer._addProp(a,b),s("spRegularMeshInfo",g),ct=w(ht,o,u.regular,null,g.meshId),s("spRegular",ct),nt=o.CreateGameObjectMeta(r.space,l.cloud),s("spCloudMeta",nt),k=p(e,o,nt,c.cloud),s("spCloudMeshInfo",k),yt=w(nt,o,u.cloud,null,k.meshId),k.meshContainer._addProp("_cloudScaling",et),k.meshContainer._addProp(a,b),f&&(d=o.CreateGameObjectMeta(r.space,l.ring),s("spRingMeta",d),ft=p(e,o,d,c.ring),s("spRingMeshInfo",ft),ft.meshContainer._addProp(a,b),lt=w(d,o,u.ring,d.loadedMesh),s("spRing",lt)),at=n._createOriginalMeshIdTemplate(t,r.env,c.material),tt=EM.GetMesh(at),!tt){s("!envMeshMaterial",{envMeshMaterial:tt});throw new Error("envMeshMaterial  NOT EXIST IN LOADED FILES");}ot=o.CreateGameObjectMeta(r.env,l.regular);h=p(!0,o,ot,c.material,tt);h.meshContainer._addProp(a,b);var wt=w(ot,o,u.regular,h.loadedMesh),vt=o.CreateGameObjectMeta(r.ground,l.regular),it=p(!0,o,vt,c.regular);if(h.meshContainer._addProp(a,b),pt=w(vt,o,u.regular,it.loadedMesh),it.meshLoaded&&h.meshLoaded)st=v[t]?v[t]():v.standard(),rt=n.CreateIPlanetEnverotment(it.loadedMesh,h.loadedMesh,t,st.OnShow,st.OnHide),ut=n.IPLANET_ENVEROTMENT_KEY,g.meshContainer._addProp(ut,rt),h.meshContainer._addProp(ut,rt),it.meshContainer._addProp(ut,rt);else throw new Error("ENVEROTMENT NOT EXIST IN LOADED FILES");n.SetTypeItem(t,o)}function nt(t,i,r,u){n._initGroup(function(n){ht(n,i,r,u)},t)}var s,b;n.A_PLANET_IDS=[];var tt=!1;tt&&console.log("_initPlanets.newMeshes",t);var lt=n.GAME_TEXTURE_ID_RANGES,r=n.LAYER_NAMES,f=n.TEXTURE_TYPES,u=n.SUBTYPE_MATERIAL_NAMES,c=n.SUBTYPE_MESH_NAMES,at=n.GO_TYPE_NAMES,l=n.BASE_SUB_NAMES,ut=n.EXTENTIONS,o=BABYLON.Color3.Black(),a=n.MAP_TYPE_KEY,h=Math.PI*2;var v={_fogEvent:function(n){function e(){r=t.fogColor.clone();u=t.fogMode;f=t.fogDensity;t.fogMode=n.fogMode;t.fogColor=n.fogColor;t.fogDensity=.0001;var e=n.max||1.566,s=n.min||e-n.dev,o=_.round(_.random(e,s),3),h=n.step;n.onBeforeShow&&n.onBeforeShow();i=t.onBeforeRenderObservable.add(function(){var n=Math.abs(o);(n>e||n<s)&&(h*=-1);o+=h;t.fogDensity=Math.cos(o)})}function o(e,o){n.onHide&&n.onHide();t.onBeforeRenderObservable.remove(i);t.fogMode=u;t.fogDensity=f;t.fogColor=r;u=null;f=null;r=null;i=null;console.log("IEnverotmenEvent onHide",{iPlanetEnverotmentItem:e,iPlanetEnverotment:o})}var i,t=EM.Scene,r,u,f;return new rt(e,o)},401:function(){return v._fogEvent({dev:.008,step:1e-6,fogColor:BABYLON.Color3.FromInts(75,66,66),fogMode:BABYLON.Scene.FOGMODE_EXP2})},403:function(){var n={step:1e-6,fogColor:BABYLON.Color3.FromInts(125,125,140),fogMode:BABYLON.Scene.FOGMODE_EXP,max:Math.PI/2,min:1.55,onBeforeShow:function(){},onHide:function(){}};return v._fogEvent(n)},standard:function(){return new rt(function(n,t){console.log("IEnverotmenEvent onShow",{iPlanetEnverotmentItem:n,iPlanetEnverotment:t})},function(n,t){console.log("IEnverotmenEvent onHide",{iPlanetEnverotmentItem:n,iPlanetEnverotment:t})})}},k=new BABYLON.Color3(197,172,163),ft=BABYLON.Color3.FromInts(k.r,k.g,k.b),et=1.03,d=100;s={401:function(t,i,c){var y,p,w,l,b,v;if(c.LayerName===r.ground)return s.standartGround(t,i,c);if(c.LayerName===r.env)return s.standartEnv(t,i,c);if(c.LayerName===r.space){if(i.SubtypeMaterialName===u.regular){y=i.GetOrCreateTexture(f.Dffuse);t.diffuseTexture=y;t.diffuseTexture.level=2;p=i.GetOrCreateTexture(f.Bump);t.bumpTexture=p;t.bumpTexture.level=1;w=i.GetOrCreateTexture(f.Light);t.lightmapTexture=w;t.lightmapTexture.level=.5;l=BABYLON.Color3.FromInts(197,172,163);t.emissiveColor=l.clone();t.useEmissiveAsIllumination=!0;t.emissiveFresnelParameters=e(.5,2,l,o);b=i.GetOrCreateTexture(f.Specular);t.specularTexture=b;t.specularPower=d;var a=1,k=.005,g=c.GetOrCreateRenderOptions(),nt=n.BEFORE_RENDER_SPACE_PLANET_ACTION_KEY;function tt(n,t,i){try{i.cloud.rotation.y+=.0003;i.planet.rotation.y-=.0003;i.cloud.rotation.y>h&&(i.cloud.rotation.y-=h);i.planet.rotation.y<h&&(i.planet.rotation.y+=h);var r=i.planet.material.lightmapTexture,u=i.cloud.material.emissiveTexture;return(r.level>2||r.level<.5)&&(a=-a),r.level+=k*a,!0}catch(f){return console.log("onBeforeRenderSpace401 STOP"),!1}}return g.AddFunction(nt,tt),t}if(i.SubtypeMaterialName===u.cloud)return v=s.standard(t,i,c),v.specularColor=new BABYLON.Color3(0,0,0),v}else return t},402:function(t,i,c){var a,v,l,y,p;if(c.LayerName===r.ground)return t.diffuseTexture.uScale=t.diffuseTexture.vScale=2,t.diffuseTexture.level=.75,t.diffuseColor.r=.7,t.diffuseColor.b=.5,t.diffuseFresnelParameters=e(.9,13,o,new BABYLON.Color3(1,1,1)),t.emissiveFresnelParameters=e(.1,.6,new BABYLON.Color3(1,1,1),o),t.emissiveColor=new BABYLON.Color3(1,.9,.9),s.standartGround(t,i,c);if(c.LayerName===r.env)return t.emissiveTexture=t.diffuseTexture,t.emissiveTexture.level=.75,t;if(c.LayerName===r.space){if(i.SubtypeMaterialName===u.regular){t.specularColor=new BABYLON.Color3(0,0,0);a=i.GetOrCreateTexture(f.Dffuse);t.diffuseTexture=a;t.diffuseTexture.level=1.1;v=i.GetOrCreateTexture(f.Bump);t.bumpTexture=v;t.bumpTexture.level=1;l=BABYLON.Color3.FromInts(88,54,30);t.diffuseColor=BABYLON.Color3.White();t.diffuseFresnelParameters=e(.6,50,l.clone(),BABYLON.Color3.White());t.specularColor=l.clone();t.specularPower=2;t.emissiveColor=BABYLON.Color3.FromInts(164,122,70);t.useEmissiveAsIllumination=!0;t.emissiveFresnelParameters=e(.5,2,BABYLON.Color3.White(),o);y=c.GetOrCreateRenderOptions();p=n.BEFORE_RENDER_SPACE_PLANET_ACTION_KEY;function w(n,t,i){try{return i.planet.rotation.y-=.0003,i.planet.rotation.y<h&&(i.planet.rotation.y+=h),!0}catch(r){return console.log("onBeforeRenderSpace402 STOP",{e:r}),!1}}return y.AddFunction(p,w),t}if(i.SubtypeMaterialName===u.cloud)return t.alphaMode=BABYLON.Engine.ALPHA_SUBTRACT,t.alpha=.9,t.diffuseColor=new BABYLON.Color3(.4,.4,.4),t.specularColor=o.clone(),t}else return t},403:function(t,i,c){var a,v,y,l;if(c.LayerName===r.ground)return t.diffuseFresnelParameters=e(.7,5,new BABYLON.Color3(.7,.7,.7),new BABYLON.Color3(1,1,1)),t.emissiveFresnelParameters=e(.95,20,new BABYLON.Color3(1,1,1),o),t.emissiveColor=new BABYLON.Color3(.5,.5,.5),t.specularColor=new BABYLON.Color3(.15,.15,.1),t.specularPower=200,t.bumpTexture&&(Utils.Console.Warn("ground.403 material.bumpTexture - exist and will be disposed",{material:t,iMaterial:i}),t.bumpTexture.dispose(),delete t.bumpTexture),t.bumpTexture=i.GetOrCreateTexture(f.Bump,ut.png),t.useParallax=!0,t.useParallaxOcclusion=!0,t.parallaxScaleBias=.002,s.standartGround(t,i,c);if(c.LayerName===r.env)return t.emissiveTexture=t.diffuseTexture,t.emissiveTexture.level=.85,t;if(c.LayerName===r.space){if(i.SubtypeMaterialName===u.regular)return t.specularColor=new BABYLON.Color3(0,0,0),a=i.GetOrCreateTexture(f.Dffuse),t.diffuseTexture=a,t.diffuseTexture.level=1.1,t.invertNormalMapY=t.invertNormalMapX=!0,t.specularPower=20,v=i.GetOrCreateTexture(f.Bump),t.bumpTexture=v,t.bumpTexture.anisotropicFilteringLevel=3,t.bumpTexture.level=5,t.diffuseFresnelParameters=e(.2,3.4,o.clone(),BABYLON.Color3.White()),y=c.GetOrCreateRenderOptions(),y.AddFunction(n.BEFORE_RENDER_SPACE_PLANET_ACTION_KEY,function(n,t,i){try{return i.planet.rotation.y+=.0005,i.cloud.rotation.y+=.0007,i.planet.rotation.y>h&&(i.planet.rotation.y-=h),i.cloud.rotation.y>h&&(i.planet.rotation.y-=h),!0}catch(r){return console.log("onBeforeRenderSpace403 STOP",{e:r}),!1}}),t;if(i.SubtypeMaterialName===u.cloud)return t.alphaMode=BABYLON.Engine.ALPHA_MAXIMIZED,t.alpha=.99,l=i.GetOrCreateTexture(f.Emissive),l.level=5,t.emissiveTexture=l,t.disableLighting=!0,t.emissiveColor=new BABYLON.Color3(.63,.67,.77),t.emissiveFresnelParameters=e(0,.2,BABYLON.Color3.White(),o),t}else return t},standard:function(n,t,i,h,c,l){function tt(n,r){y(n,r,i.TextureTypeId,"mats.standart{"+t.SubtypeMaterialName+"}")}var a,b,k,g,ut,nt,v,p,w;if(tt("standart.material",n),i.LayerName===r.env)return s.standartEnv(n,t,i,h);if(i.LayerName===r.ground)return s.standartGround(n,t,i,h);if(i.LayerName===r.space){a=ot(c);function rt(t){t&&n.alphaMode!==BABYLON.Engine.ALPHA_ADD&&(n.alphaMode=BABYLON.Engine.ALPHA_ADD,n.alpha===1&&(n.alpha=.999))}if(l&&rt(!0),t.SubtypeMaterialName===u.regular)return(tt("iMaterial.SubtypeMaterialName === sbMn.regular  !material.diffuseTexture",!n.diffuseTexture),n.diffuseTexture||(b=t.GetOrCreateTexture(f.Dffuse),b&&(n.diffuseTexture=b,n.diffuseTexture.level=1)),n.bumpTexture||!1&&(n.bumpTexture=bump,n.bumpTexture.anisotropicFilteringLevel=3,n.bumpTexture.level=1),n.lightmapTexture||(k=t.GetOrCreateTexture(f.Light),k&&(n.lightmapTexture=k,n.lightmapTexture.level=.5)),a&&!n.emissiveFresnelParameters&&(n.emissiveColor=a.clone(),n.useEmissiveAsIllumination=!0,n.emissiveFresnelParameters=e(.5,2,a,o)),n.specularTexture||(g=t.GetOrCreateTexture(f.Specular),g&&(n.specularTexture=g,n.specularPower=d)),h instanceof Function)?h(n,t,i,u.regular):n;if(t.SubtypeMaterialName===u.cloud){if(ut=i.GetIMaterialContainer(u.regular),nt=ut.GetMaterial(),!nt)throw new Error("базовый метериал небыл создан");if(!n.emissiveTexture&&(v=t.GetOrCreateTexture(f.Emissive),v)){if(n.emissiveColor=a.clone(),n.emissiveTexture=v,n.emissiveTexture.level=1,n.disableLighting=!0,n.diffuseTexture||(p=v.clone(),p.level=2,t.SetExternalTexture(f.Dffuse,p),n.diffuseTexture=p),!n.specularTexture){if(w=nt.specularTexture.clone(),!w)throw new Error("specular not exist");t.SetExternalTexture(f.Specular,w);n.specularTexture=w;n.specularPower=d}n.opacityFresnelParameters||(n.opacityFresnelParameters=e(.9,10,a,o));n.emissiveFresnelParameters||(n.emissiveFresnelParameters=e(.1,1,o,a));rt(!0);n.alpha=.9}return h instanceof Function?h(n,t,i,u.cloud):n}if(t.SubtypeMaterialName===u.ring)throw it(n,t,i,u.ring,"materialType === stMn.ring");}else throw it(n,t,i,t.SubtypeMaterialName,"Material type is wrong");},standartEnv:function(n,t,i,r){return r instanceof Function?r(n,t,i):n},standartGround:function(n,t,i,r){return r instanceof Function?r(n,t,i,r):n}};b=t&&t.length>0&&i&&typeof i=="string"&&i.length>0;nt([401,402,403,404,405,406],n.MapTypes.Earth,!1,b?!0:!1);nt([501,502,503,504,505],n.MapTypes.Gas,!1,b?!0:!1);nt([601,602],n.MapTypes.IceGas,!1,b?!0:!1)}}(EM.AssetRepository),function(n){"use strict";n._initMoons=function(){function e(i){var e=n.ITypeItem(i,r.Name),o=e.CreateGameObjectMeta(t.space),s=n.MapTypeContainer.GetOrAdd(i,n.MapTypes.Satellite,n.MapTypes.Moon),h=e.AddMeshContainer(o);return h._addProp(n.MAP_TYPE_KEY,s),e.GetMeshId(t.space),e.GetOrCreateMaterial(o,function(n,t,i,r){if(r)return n;var f=t.GetOrCreateTextureItem(u.Dffuse);return n.diffuseTexture=f.GetOrCreateTexture(),n.diffuseTexture.level=1,n},f.regular),n.SetTypeItem(i,e),e}var i=n.A_MOON_IDS=[901,902,903,904,905,906],r=n.GAME_TEXTURE_ID_RANGES.Sector,t=n.LAYER_NAMES,u=n.TEXTURE_TYPES,f=n.BASE_SUB_NAMES;n._initGroup(e,i)}}(EM.AssetRepository),function(n){"use strict";n._initUniverse=function(t){function e(n,t,i,r){return n.backFaceCulling=!1,n.reflectionTexture=t,n.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE,n.disableLighting=!0,n.reflectionTexture.level=typeof r=="number"?r:2,n.alpha=i||1,n.alpha!==1&&(n.alphaMode=BABYLON.Engine.ALPHA_ADD),n}function tt(){var i=BABYLON.Mesh.CreateSphere(l,32,18e5,t);return n.UNIVERSE_SKY_BOX_MESH_ID=i.id,i.material=nt,i.setEnabled(1),i}function y(n){n.diffuseColor=new BABYLON.Color3(0,0,0);n.specularColor=new BABYLON.Color3(0,0,0)}function ut(n,t,i){var r=i.GetOrCreateCubeTexture();return e(t,r,.9999,1.2),y(t),t}function ft(){var n=BABYLON.Mesh.CreateSphere(v,32,13e5,t);return n.rotation.z=Math.PI/4,n.rotation.x=Math.PI/6,n.material=p,n}function et(){var t=it.clone(w),i=.3,n;t.scaling=new BABYLON.Vector3(i,i,i);n=-1;t.rotation=new BABYLON.Vector3(n,n,n);EM.MapEvent.InitSceneEvents(t)}var r=4001,p,s,w;n.A_UNIVERSE_IDS=[r];n.MapTypeContainer.AddCollection(n.A_UNIVERSE_IDS,n.MapTypes.Universe);var b=n.GAME_TEXTURE_ID_RANGES.Sector,u=n.LAYER_NAMES,f=n.TEXTURE_TYPES,h=n.SUBTYPE_MATERIAL_NAMES,c=n.SUBTYPE_MESH_NAMES,k=n.BASE_SUB_NAMES,d=new BABYLON.Color3.Black;t.clearColor=d;var i=n.ITypeItem(r,b.Name),o=i.CreateGameObjectMeta(u.env),g=i.AddMeshContainer(o),l=g.GetMeshId(),nt=i.GetOrCreateMaterial(o,function(n,t,i,r){if(r)return n;var o=t.GetOrCreateTextureItem(f.Emissive),s=o.FileName,h=t.GetOrCreateTextureItem(f.Reflection),c=h.GetOrCreateCubeTextureFromOneFile(s),u=e(n,c,.999999,2);return u.emissiveTexture=o.GetOrCreateTexture(),u.emissiveTexture.level=1.5,u.emissiveTexture.useEmissiveAsIllumination=!0,u.material=u,u},h.regular);var it=tt(),a=i.CreateGameObjectMeta(u.env,k.cloud),rt=i.AddMeshContainer(a,null,null,c.cloud),v=rt.GetMeshId();n.NUBULA_BOX_MESH_ID=v;p=i.GetOrCreateMaterial(a,function(n,t,i,r){if(r)return n;var u=t.CreateSubDirUrl("nibulabox"),e=t.GetOrCreateTextureItem(f.Reflection,!1,!1,u);return ut(u,n,e),n},h.cloud);ft();s=i.AddMeshContainer(o,null,u.env,c.empty);w=s.GetMeshId();n.ACTIVE_WORLD_MESH_ID=s.GetMeshId(null,l);et();n.SetTypeItem(r,i)}}(EM.AssetRepository),function(n){"use strict";n.Init=function(t,i){function nt(){i();n.Init=null;delete n.Init}function u(){o||f&&y&&e&&p&&w&&b&&k&&(o=!0,EM.Scene.resetCachedMaterial(),nt(),EM.GameLoader.Update("LoadMeshes"),r&&console.log("assets loaded 2"))}function tt(){n._initUniverse(t);n._initUniverse=null;delete n._initUniverse;k=!0;r&&console.log("universeInitialized");u()}function it(t){EM.SetVisibleGroupByMeshes(t,!1);n._initPlanets(t,a);n._initPlanets=null;delete n._initPlanets;r&&console.log("planetInitialized");e=!0;u()}function rt(t){n._initMother();n._initMother=null;delete n._initMother;EM.EstateGeometry.GameModelsInit(t);f=!0;r&&console.log("motherInitialized");u()}function ut(){n._initMoons();n._initMoons=null;delete n._initMoons;y=!0;u()}function ft(){n._initStars();n._initStars=null;delete n._initStars;p=!0;r&&console.log("starsInitialized");u()}function et(){n._initSectors();n._initSectors=null;delete n._initSectors;w=!0;r&&console.log("sectorsInitialized");u()}function ot(){n._initGalaxies();n._initGalaxies=null;b=!0;delete n._initGalaxies;r&&console.log("galaxiesInitialized");u()}function d(){e&&f&&(tt(),ut(),ft(),et(),ot())}var s=!0,r=!1,h=Utils.CdnManager.GetGameModelsCatalog("1.0.0",s),o;n._initBase("v.1.403.dist",s,h);n._initBase=null;delete n._initBase;var c=n.EXTENTIONS,l=n.GetPlanetCatalog(),a="planets",v=a+c.babylon,st=l+v,g="game_models"+c.babylon,f=!1,y=!1,e=!1,p=!1,w=!1,b=!1,k=!1;o=!1;BABYLON.SceneLoader.ImportMesh("",l,v,t,function(n){r&&console.log("BABYLON.SceneLoader.ImportMesh.planetBabylon",{loadedMeshesGroup:n});it(n);d()});BABYLON.SceneLoader.ImportMesh("",h,g,t,function(n){r&&console.log("BABYLON.SceneLoader.ImportMesh.motherBabylon",{loadedMeshesGroup:n});rt(n);d()})}}(EM.AssetRepository);EM.VideoTextures={},function(n){function r(n){return document.getElementById(n)}var t="vidio-container";n.GetVideoTag=r}(EM.VideoTextures),function(n){"use_strict";function r(){return t.Texture=new BABYLON.VideoTexture(i,n.GetVideoTag(i),EM.Scene,!0),t.Play=function(n){t.Texture.video.playbackRate=n||1;t.Texture.video.play()},t.Stop=function(){t.Texture.video.pause()},t.Stop(),t.Texture}function u(){return t.Texture?t.Texture:r()}var t={Texture:null,Play:null,Stop:null,GetTexture:null},i="video-sector-jump";t.GetTexture=u;n.SectorJump=t}(EM.VideoTextures);EM.GameCamera={Name:"GameCamera",Id:null,Camera:null,Keys:{Galaxy:"Galaxy",Systems:"Systems",SystemSelected:"SystemSelected",ArroundSystem:"ArroundSystem",MotherSelected:"MotherSelected",UserPlanet:"UserPlanet",Planetoid:"Planetoid"}},function(n){function s(n,t,i,r,u,f,e,o){var h=1,s={target:null,radius:r||10,minZ:i||0,maxZ:3e6,wheelPrecision:u||.01,alpha:.4,beta:1.2,lowerBetaLimit:f||y,upperBetaLimit:e||v,upperRadiusLimit:n||0,lowerRadiusLimit:t||1,lowerAlphaLimit:0,upperAlphaLimit:0,lockedTarget:null,zoomOnFactor:1,position:null,fov:o||1,speed:100,panningSensibility:0,keysLeft:[39,68],keysDown:[40,83],keysRight:[37,65],keysUp:[38,87],angularSensibilityX:h,angularSensibilityY:h};return s.setTarget=function(n){n&&n.clone?s.target=n.clone():(SHOW_DEBUG&&console.log("target not set, seted default"),s.target=c.clone())},s.setPosition=function(n){s.position=n&&n.clone?n.clone():null},s}function h(t,i,r){i.target&&!_.isEqual(t.target,i.target)&&t.setTarget(i.target.clone());t.alpha!==i.alpha&&(t.alpha=i.alpha);t.beta!==i.beta&&(t.beta=i.beta);t.lowerRadiusLimit!==i.lowerRadiusLimit&&(t.lowerRadiusLimit=i.lowerRadiusLimit);t.upperRadiusLimit!==i.upperRadiusLimit&&(t.upperRadiusLimit=i.upperRadiusLimit);t.radius!==i.radius&&(i.radius>i.upperRadiusLimit?i.radius=i.upperRadiusLimit:i.radius<i.lowerRadiusLimit&&(i.radius=i.lowerRadiusLimit),t.radius=i.radius);t.minZ!==i.minZ&&(t.minZ=i.minZ);t.maxZ!==i.maxZ&&(t.maxZ=i.maxZ);t.wheelPrecision!==i.wheelPrecision&&(t.wheelPrecision=i.wheelPrecision);t.fov!==i.fov&&(t.fov=i.fov);t.lowerBetaLimit!==i.lowerBetaLimit&&(t.lowerBetaLimit=i.lowerBetaLimit);t.upperBetaLimit!==i.upperBetaLimit&&(t.upperBetaLimit=i.upperBetaLimit);t.lowerAlphaLimit!==i.lowerAlphaLimit&&(t.lowerAlphaLimit=i.lowerAlphaLimit);t.upperAlphaLimit!==i.upperAlphaLimit&&(t.upperAlphaLimit=i.upperAlphaLimit);t.lockedTarget!==i.lockedTarget&&(t.lockedTarget=i.lockedTarget);t.zoomOnFactor!==i.zoomOnFactor&&(t.zoomOnFactor=i.zoomOnFactor);i.position&&(console.log("configCamera.position",{position:i.position.clone()}),t.position=i.position.clone());n.$activeState=r}function o(n){return n===i.Galaxy?e:n===i.Systems?u:n===i.ArroundSystem?l:n===i.SystemSelected?t:n===i.MotherSelected?r:n===i.UserPlanet?f:(console.log("error state not configured for this type"),s())}function p(t){if(!n.$activeState||n.$activeState!==i.Galaxy){var r=o(i.Galaxy);r.setTarget(EM.MapGeometry.Galaxies.GetGalaxy(t).position);h(n.Camera,r,i.Galaxy)}}function w(){if(!n.$activeState||n.$activeState!==i.Systems){var t=o(i.Systems);h(n.Camera,t,i.Systems)}}function b(t){if(!n.$activeState||n.$activeState!==i.ArroundSystem){var r=o(i.ArroundSystem);r.setTarget(t);h(n.Camera,r,i.ArroundSystem)}}function k(r,u,f){if(u!=="PlanetoidSelectedState"&&(!n.$activeState||n.$activeState!==i.SystemSelected||t.$newSystemId!==f)){t.$setOnEndAnimationParams();var e=o(i.SystemSelected);e.setTarget(r);h(n.Camera,e,i.SystemSelected);t.$newSystemId=f}}function d(u){var s=EM.EstateData.GetCurrentSpaceLocation(),e=EM.EstateData.GetMotherLocation(),f;if(!u){if(s.SystemId===e.SystemId){n.Camera.upperRadiusLimit=r.upperRadiusLimit;n.Camera.lowerRadiusLimit=r.lowerRadiusLimit;n.Camera.maxZ=r.maxZ;r.$setABToCamera();console.log("setMotherSelected csl.SystemId === motherLocation.SystemId");return}if(n.$activeState&&n.$activeState===i.MotherSelected)return}t.$newSystemId=e.SystemId;f=o(i.MotherSelected);r.$setABToCamera();f.setTarget(EM.GetMotherMesh().getAbsolutePosition());h(n.Camera,f,i.MotherSelected)}function g(){if(!n.$activeState||n.$activeState!==i.UserPlanet){var t=o(i.UserPlanet);h(n.Camera,t,i.UserPlanet)}}function nt(t,i,r,u){var f=o(r),e;u!=null&&(f.target=u);f.target==null&&(f.target=c.clone());e=new BABYLON.ArcRotateCamera(n.Name,f.alpha,f.beta,f.radius,f.target,t);e.attachControl(i,!0,!1);n.Id=e.id;n.Camera=e;h(e,f)}var c=new BABYLON.Vector3.Zero,i=n.Keys,a=_.round(Math.PI,4),v=3,y=.1,tt=a*2,e,u,l,t,r,f;n.$activeState=null;e=s();e.upperRadiusLimit=5e4;e.lowerRadiusLimit=14e3;e.minZ=1e3;e.radius=1e4;e.wheelPrecision=.01;e.lowerBetaLimit=.1;e.upperBetaLimit=1;u=s();u.upperRadiusLimit=2e5;u.lowerRadiusLimit=4e4;u.minZ=3;u.radius=7e4;u.wheelPrecision=.01;u.lowerBetaLimit=0;u.upperBetaLimit=a;u.setTarget(c.clone());l=s(u.upperRadiusLimit,u.lowerRadiusLimit,u.minZ,u.wheelPrecision);l.radius=5e4;Object.freeze(l);t=s();t.upperRadiusLimit=900;t.lowerRadiusLimit=8;t.minZ=1;t.radius=t.lowerRadiusLimit*2;t.wheelPrecision=10;t.speed=1;t.lowerBetaLimit=y;t.upperBetaLimit=v;t.fov=1;t.$endAnimationRadius=100;t.$newSystemId=null;t.$setOnBeforeAnimationParams=function(){return t.radius=t.$endAnimationRadius,t.radius};t.$setOnEndAnimationParams=function(i){t.alpha=n.Camera.alpha;t.beta=n.Camera.beta;i&&n.SetAndGetNewLowerRadiusLimit(i)};r=s();r.upperRadiusLimit=1e3;r.lowerRadiusLimit=14;r.minZ=1;r.radius=15;r.wheelPrecision=50;r.speed=1;r.$alpha=2.2;r.$beta=1.2;Object.defineProperty(r,"alpha",{get:function(){return n.Camera.alpha}});Object.defineProperty(r,"beta",{get:function(){return n.Camera.beta}});r.$setABToCamera=function(){n.Camera.alpha=r.$alpha;n.Camera.beta=r.$beta};f=s();f.upperRadiusLimit=20;f.lowerRadiusLimit=10;f.minZ=1;f.maxZ=300;f.radius=15;f.wheelPrecision=200;f.lowerBetaLimit=.1;f.upperBetaLimit=1.3;f.fov=1;f.setTarget(c.clone());n.Galaxy=e;n.Systems=u;n.ArroundSystem=l;n.System=t;n.Mother=r;n.InUserPlanet=f;n.DefaultTarget=c;n.CreateCamera=nt;n.GetConfig=o;n.SetGalaxy=p;n.SetSystems=w;n.SetArroundSystem=b;n.SetSystemSelected=k;n.SetMotherSelected=d;n.SetInUserPlanet=g;n.SetAndGetNewLowerRadiusLimit=function(t){var i=t;return t<n.Camera.minZ&&(i=_.ceil(n.Camera.minZ)+1),i!==n.Camera.lowerRadiusLimit&&(n.Camera.lowerRadiusLimit=i),i}}(EM.GameCamera);EM.MapData={SystemKeys:{Name:"Name",NativeName:"NativeName",Planetoids:"Planetoids",Stars:"Stars",Planets:"Planets",Moons:"Moons",Coords:"Coords",GroupType:"GameTypeId",Texture:"Texture",TextureMap:"TextureMap",TextureColor:"TextureColor",Url:"Url",DiffuseMap:"DiffuseMap",HeightMap:"HeightMap",NormalMap:"NormalMap",SpecularMap:"SpecularMap",StencilMap:"StencilMap",DiffuseColor:"DiffuseColor",EmissiveColor:"EmissiveColor",HoverColor:"HoverColor",SpecularColor:"SpecularColor",Power:"Power",Radius:"Radius",Parent:"Parent",Rings:"Rings",Width:"Width",MaxRadius:"MaxRadius",Atmosphere:"Atmosphere",Opacity:"Opacity",AxisAngle:"AxisAngle",OrbitAngle:"OrbitAngle",Orbit:"Orbit",OrbitPosition:"OrbitPosition",TypeId:"TypeId"}};Object.freeze(EM.MapData.SystemKeys),function(n,t){function i(n){var t={SubscribeName:n,GetData:null,Observer:Utils.PatternFactory.Observer(n),Update:null};return Object.defineProperty(t,"$hub",{get:function(){return EM.$hub}}),t}n.Sectors=null;n.Systems=null;n.System=null;n._actionNames={worldGetSectors:"worldGetSectors",worldGetSystems:"worldGetSystems",worldGetSystemGeometry:"worldGetSystemGeometry",worldGetGalaxyInfo:"worldGetGalaxyInfo",worldGetSectorInfo:"worldGetSectorInfo",worldGetStarInfo:"worldGetStarInfo",worldGetPlanetInfo:"worldGetPlanetInfo",worldGetMoonInfo:"worldGetMoonInfo",worldSerchPlanetNames:"worldSerchPlanetNames"};Object.freeze(n._actionNames);n._getHubAction=function(n){return EM.$hub[n]};n._createStorageKey=function(n,t){var i;if(n)i=n;else if(typeof n=="number"&&n===0)throw new Error("id  не может быть 0");else i="_id_";return _.snakeCase(t+"_"+i)};n.GetSectors=i("MapData.Sectors");n.GetSystems=i("MapData.Systems");n.GetSystem=i("MapData.System");n._request=function(i,r,u,f,e){var o=n._createStorageKey(u,i),s=t.GetFromStorage(o);if(s){r(s);return}n._getHubAction(i)(u).then(function(n){t.SaveInStorage(o,n,f,e);r(n)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({key:o,id:u,resultData:s,msg:t,expires:e,notSetCookie:f,errorAnswer:n,LocalStorageData:s},o);})}}(EM.MapData,Utils.LocalStorage),function(n,t){function r(t){EM.MapGeometry.Galaxies.SaveSectorsFromServer(t);n.Sectors=t;n.GetSectors.Observer.NotifyAll()}var i=n._actionNames.worldGetSectors;n.GetSectors.GetData=function(){n._request(i,r,null,!0,null)};n.GetSectors.InitSectorData=function(u){var f=n._createStorageKey(null,i);t.SaveInStorage(f,u,!0,null);n._request(i,r,null,!0,null)}}(EM.MapData,Utils.LocalStorage),function(n){var t=n._actionNames.worldGetSystems;n.GetSystems.DataSectorId=null;n.GetSystems.GetData=function(i){function r(t){n.Systems=t;n.GetSystems.DataSectorId=i;n.GetSystems.Observer.NotifyAll()}if(typeof i=="number"&&i===n.GetSystems.DataSectorId){n.GetSystems.Observer.NotifyAll();return}n._request(t,r,i,!0,null)}}(EM.MapData),function(n,t){function r(t,i){n.System=t;n.GetSystem.Observer.NotifyAll();i&&i(n.System)}var i=n._actionNames.worldGetSystemGeometry;n.GetSystem.GetData=function(t,u){n._request(i,function(n){return r(n,u)},t,!0,null)};n.GetSystem.InitSystemData=function(r){var u=0,f;return _.forEach(r.Stars,function(n){return u=n.Id,!1}),f=n._createStorageKey(u,i),t.SaveInStorage(f,r,!0,null),u}}(EM.MapData,Utils.LocalStorage);EM.MapGeometry={SYSTEM_PROTO_NAME:"starSystemProto",SYSTEM_REAL_PROTONAME:".starSystemProto",SECTOR_PROTO_NAME:"sectorProto",SECTOR_REAL_PROTONAME:".sectorProto",Scale:10,MapTypes:{Mother:"Mother",Universe:"Universe",Galaxy:"Galaxy",Sector:"Sector",Star:"Star",Satellite:"Satellite",Planet:"Planet",Moon:"Moon",Bookmark:"Bookmark",Earth:"Earth",Gas:"Gas",IceGas:"IceGas",Asteroid:"Asteroid",Nibula:"Nibula",Spirale:"Spirale",A:"A",B:"B",F:"F",G:"G",K:"K",L:"L",M:"M",O:"O"},_chekAndGetMeshInScene:function(n){"use strict";var t=EM.GetMesh(n);return t?t:!1},Lang:appL10n.getL10NCurrentLanguage,Galaxies:null,Sectors:null,Systems:null,System:null,Effects:{},IGeometryMapItemFactory:null,IGeometryMaperFactory:null,GetUniqueIdFromAny:null},function(n){"use strict";n.IGeometryMapItemFactory=function(n,t,i,r){function u(){var u,f=this;if(u=r instanceof Function?r(t,n):EM.AssetRepository.GetSpaceRegularMeshContainer(t),!u)throw Errors.ClientNullReferenceException({uniqueId:n,textureId:t,meshContainer:u});return this.UniqueId=n,this.TextureId=t,this.ParentMeshName=i,this._baseMeshId=u.GetMeshId(),this.FullMeshId=u.GetMeshId(n,i),this.BasePartMeshId=u.GetMeshId(n),this[EM.AssetRepository.MESH_CONTAINER_KEY]=u,this.AdvPropNames={},this.AddProp=function(n,t){this.AdvPropNames[n]=n;this[n]=t},this.GetMesh=function(){return f.GetMeshById(f.FullMeshId)},this._getMeshByOtherParams=function(n,t){return u.GetMesh(n,t)},this.GetMeshById=function(n){return EM.GetMesh(n)},this.GetMeshContainer=function(){return u},this}return new u};n.IGeometryMaperFactory=function(t,i,r,u,f){function e(){var e=this;return this._mapperName=t,this._initialized=!1,this._init=r,this._parentMeshName=u,this._collection={},this.Count=0,this.GetMapItem=function(n,t){if(!e._initialized)return e._init(e),e._initialized=!0,e._init=null,delete e._init,e.GetMapItem=function(n,t){return n&&t?e.GetOrAdd(n,t):e._collection[n]},e.GetMapItem(n,t)},this.GetOrAdd=function(t,r){if(e._collection[t])return e._collection[t];var o=new n.IGeometryMapItemFactory(t,r,u,f);return o=i(o),e._collection[t]=o,this.Count++,e._collection[t]},this.GetTextureId=function(n){var t=e.GetMapItem(n);return t?t.TextureId:null},this._getFullMeshId=function(n,t){var i=e.GetMapItem(n,t);return i?i.FullMeshId:null},this._addAdvPropToItem=function(n,t,i,r){var u=e.GetMapItem(n,t);return u?(u.AddProp(i,r),u):null},this._getItemAdvPropNames=function(n,t){var i=e.GetMapItem(n,t);return i?i.AdvPropNames:null},this.HasItem=function(n){return!!this.GetMapItem(n)},this.GetMeshContainer=function(n,t){var i=e.GetMapItem(n,t);return i?i.GetMeshContainer():null},this.GetMesh=function(n,t){var i=e.GetMapItem(n,t);return i?i.GetMesh():null},this.GetMeshById=function(n){return EM.GetMesh(n)},this._reset=function(){this._collection={};this.Count=0},this._cleanPerItem=function(n,t){n instanceof Function?t instanceof Function?_.forEach(e._collection,function(i,r){t(i,r)&&(n(i,r),e.Count--)}):_.forEach(e._collection,function(t,i){n(t,i);e._collection[i]=null;delete e._collection[i];e.Count--}):this._clean()},this._getAll=function(){return this._collection},e}return r instanceof Function||(r=angular.noop),new e};n.GetUniqueIdFromAny=function(n,t){var i=null;if(t){if(!n)return null;i=n[t]}else{if(typeof n=="number")return n;if(n)typeof n=="string"?i=n:typeof n=="object"&&(n.hasOwnProperty("id")?i=n.id:n.hasOwnProperty("Id")?i=n.Id:n.hasOwnProperty("uniqueId")?i=n.uniqueId:n.hasOwnProperty("UniqueId")&&(i=n.UniqueId));else return null}return i?_.isNumber(i)?i:Utils.IsNumeric(i)?_.toNumber(i):i:null};n.GetUniqueIdFromMeshId=function(t){var i,r;if(!t)throw Errors.ClientNullReferenceException({meshId:t},"meshId","MapGeometry.GetUniqueIdFromMeshId");if(i=n.GetUniqueIdFromAny(t),typeof i=="number")return i;if(!i)throw Errors.ClientNullReferenceException({meshId:t,_id:i},"_id","MapGeometry.GetUniqueIdFromMeshId");if(typeof i!="string")throw Errors.ClientTypeErrorException({meshId:t,_id:i},i,"string","MapGeometry.GetUniqueIdFromMeshId");return r=ar.GetMeshInfoByMeshId(i),r||Errors.ClientNullReferenceException({meshId:t,_id:i,meshInfo:r},"meshInfo","MapGeometry.GetUniqueIdFromMeshId"),i=r.UniqueId,i||Errors.ClientNullReferenceException({meshId:t,_id:i,meshInfo:r,"meshInfo.UniqueId":r.UniqueId},"meshInfo","MapGeometry.GetUniqueIdFromMeshId"),i}}(EM.MapGeometry),function(n){"use strict";n._baseObject=function(n,t,i,r){return{Generate:n,Destroy:t,SetVisible:i,Mapper:r}}}(EM.MapGeometry),function(n){"use strict";function c(n){function t(){var t=_.extend(this,n);return t.Sectors=null,t}return new t}function l(n){n.GetOrAdd(1,1)}function a(n){_.forEach(n,function(i){var r=t.GetMapItem(i.GalaxyId);if(!r)throw Errors.ClientNullReferenceException({answer:n,galaxyMapper:t,item:r},"item","galaxies.saveSectorsFromServer");r.Sectors?r.Sectors[i.Id]||(r.Sectors[i.Id]=i):(r.AddProp("Sectors",{}),r.Sectors[i.Id]=i,t._hasSectors[i.GalaxyId]=!0)})}function v(i){var e=t.GetMapItem(i),u=e.FullMeshId,f=t.GetMeshById(u),r;return f?f:(n.Sectors.Generate(i),r=t.GetMeshById(u),r)?r:(console.log("galaxy__"+i+"__not exist"),null)}function y(n){_.forEach(t.GetGalaxyes(),function(i){EM.SetVisibleByMesh(t.GetMeshById(i.FullMeshId),n)})}function u(n){var v=3e3,k={width:16*v,height:16*v},u=n||t.GetMapItem(1),y=u.TextureId,p=u.FullMeshId,w=u.GetMeshById(p),r,c,l,b,a;return w?w:(r=BABYLON.MeshBuilder.CreateGround(p,k,EM.Scene),r.material=i.GetSpaceRegularMaterial(y),i.AddLocalsToMesh(r,e,y),c=i.GetMeshInfoByMeshId(r.id),i.AddLocalsToMesh(r,o,c.GetMapType()),i.AddLocalsToMesh(r,h,c.GetMeshContainer()),i.AddLocalsToMesh(r,s,c),i.AddLocalsToMesh(r,f,u),l=!1,a=EM.GetMesh(i.NUBULA_BOX_MESH_ID),Object.defineProperty(r,"isVisible",{get:function(){return l},set:function(n){n?b=EM.Scene.onBeforeRenderObservable.add(function(){a.isVisible=!1;r.rotation.y-=6e-5}):(EM.Scene.onBeforeRenderObservable.remove(b),a.isVisible=!0);l=n}}),EM.MapEvent.AddExecuteCodeAction(r,BABYLON.ActionManager.OnPickTrigger,function(){EM.MapEvent.HideContextMenu()}),r)}function p(){var r=1;if(!t.GalaxyInitialized(r)&&t.HasSectorsInGalaxy(r)){var i=t.GetMapItem(1),f=u(i),e=i.Sectors;n.Sectors.Generate(f,!0,e);i._gInitialized=!0}}function w(n){return Utils.ConvertToInt(n)===1?u():!1}var i=EM.AssetRepository,f=i.MAP_ITEM_KEY,e=i.TEXTURE_TYPE_ID_KEY,o=i.MAP_TYPE_KEY,s=i.MESH_INFO_KEY,h=i.MESH_CONTAINER_KEY,b=i.SERVER_DATA_KEY,t=n.IGeometryMaperFactory("GalaxyMapper",c,l),r;t._hasSectors={};t.HasSectorsInGalaxy=function(n){return t._hasSectors[n]};t.GetSectors=function(n){if(!t.HasSectorsInGalaxy(n))return null;var i=t.GetMapItem(n);return i.Sectors};t.GalaxyInitialized=function(n){var i=t.GetMapItem(n);return i?i._gInitialized:!1};t.GetGalaxyes=function(){return t._collection};r=n._baseObject(null,null,null,t);r.CreateGalaxyById=w;r.Generate=p;r.SetVisible=y;r.SaveSectorsFromServer=a;r.GetGalaxy=v;r.GetSectorsByGalaxyId=t.GetSectors;r.GetGalaxyIdFromMesh=function(t){var r=n.GetUniqueIdFromAny(t),u;if(!r)return null;if(_.isNumber(r))return _.toInteger(r);if(u=i.GetMeshInfoByMeshId(r),u)return u.UniqueId;throw Errors.ClientNotImplementedException({meshId:t,_id:r},"MapGeometry.GetGalaxyIdFromMesh");};r.GalaxyInitialized=t.GalaxyInitialized;r.HasSectorsInGalaxy=t.HasSectorsInGalaxy;n.Galaxies=r}(EM.MapGeometry),function(n){"use strict";function v(n){function t(){return _.extend(this,n)}return new t}function y(u,f,v){var y,w,b,p;if(f)y=u;else{if(!r.HasSectorsInGalaxy(u)||r.GalaxyInitialized(u))return;y=r.CreateGalaxyById(u)}if(!y)throw Errors.ClientNullReferenceException({galaxyId:u,isGalaxyMesh:f,_sectors:v,galaxy:y},"galaxy","MapGeometry.Sectors.Generate (generateSectors(galaxyId, isGalaxyMesh, _sectors))");w=v?v:r.GetSectorsByGalaxyId(u);b=25*e;p=BABYLON.MeshBuilder.CreateDisc(n.SECTOR_PROTO_NAME,{radius:b,tessellation:32,updatable:!1,sideOrientation:1},EM.Scene);p.rotation.x=-Math.PI/2;_.forEach(w,function(r){var f=i.GetOrAdd(r.Id,r.TextureTypeId),v=i.GetMeshById(f.BasePartMeshId),u,b,e;if(v){console.log("Old sector extist",{sMapedData:f,oldSector:v,sector:r,sectors:w,galaxy:y});return}u=p.clone(f.BasePartMeshId);u.material=n.Sectors.Materials.GetRegular(r.TextureTypeId);b=Utils.ObjectToVector3(r.Position);u.position=b;u.position.y+=10;u.parent=y;t.AddLocalsToMesh(u,s,r.TextureTypeId);e=t.GetMeshInfoByMeshId(u.id);t.AddLocalsToMesh(u,h,e.GetMapType());t.AddLocalsToMesh(u,l,e.GetMeshContainer());t.AddLocalsToMesh(u,c,e);t.AddLocalsToMesh(u,o,f);t.AddLocalsToMesh(u,a,r);EM.MapEvent.RegisterSectorActions(u)});p.dispose();EM.SetVisibleByMesh(y,!1)}function f(n){var t=i.GetMapItem(n,u);return t?t.FullMeshId:null}function p(n){return console.log("getMeshBySectorNumId",{sectorMapper:i,sectorNumId:n}),i.GetMeshById(f(n))}function w(){var i=EM.EstateData.GetCurrentSpaceLocation(),u=r.GetSectorsByGalaxyId(i.GalaxyId),t=n.Sectors.Materials.GetRegular();_.forEach(u,function(n){var u=n.Id,r=f(u),i;r&&(i=EM.GetMesh(r),i&&i.material&&i.material.id!==t.id&&(i.material=t))})}var e=n.Scale,r=n.Galaxies,t=EM.AssetRepository,o=t.MAP_ITEM_KEY,s=t.TEXTURE_TYPE_ID_KEY,h=t.MAP_TYPE_KEY,c=t.MESH_INFO_KEY,l=t.MESH_CONTAINER_KEY,a=t.SERVER_DATA_KEY,u=201,i=n.IGeometryMaperFactory("SectorMapper",v,null,n.SECTOR_REAL_PROTONAME);n.Sectors=n._baseObject(y,null,null,i);n.Sectors.SetUnselected=w;n.Sectors.GetMeshIdBySectorNumId=f;n.Sectors.GetMeshBySectorNumId=p;n.Sectors.Materials={GetRegular:function(){return EM.AssetRepository.GetSpaceRegularMaterial(u)},GetHover:function(){return EM.AssetRepository.GetSpaceHoverMaterial(u)},GetClick:function(){return EM.AssetRepository.GetSpaceClickMaterial(u)}}}(EM.MapGeometry),function(n){"use strict";function y(){this._coords=null;this.Coords=null;this.Id=null;this.NativeName=null;this.TextureTypeId=null;this.GameTypeId=null;this.GalaxyId=null;this.SectorId=null;this._setData=function(n){return this._coords=n.Coords,this.Coords=Utils.ObjectToVector3(n.Coords),this.Id=n.Id,this.NativeName=n.NativeName,this.TextureTypeId=n.TextureTypeId,this.GameTypeId=n.GameTypeId,this.GalaxyId=n.GalaxyId,this.SectorId=n.SectorId,this}}function p(n,i,r,u){var e=new BABYLON.GUI.StackPanel("text_panel_"+i),f,o;e.width=t.textW;e.isVertical=!0;e.height=t.height;e.fontFamily="Electrolize sans-serif";f=new BABYLON.GUI.TextBlock("text_block_name"+i,u);f.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;f.textVerticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;f.height="50%";f.color=t.nameColor;f.fontSize="89px";e.addControl(f);o=new BABYLON.GUI.TextBlock("text_block_type"+i,r);o.textHorizontalAlignment=f.textHorizontalAlignment;o.textVerticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;o.height="30%";o.color=t.typeColor;o.fontSize="60px";e.addControl(o);n.addControl(e)}function w(n,i,r){var f=BABYLON.GUI.Button.CreateImageOnlyButton("btn_"+i,t.url),u;f.thickness=0;f.width=t.imgW;f.height=t.height;u=f.children[0];u.stretch=BABYLON.GUI.Image.STRETCH_NONE;u.sourceWidth=t.itemSize;u.sourceHeight=t.itemSize;u.sourceLeft=t.getOffset(r);u.sourceTop=0;u.width=u.height=t.height;u.scaleY=1.4;u.scaleX=1;u.left="-10%";n.addControl(f)}function b(n,i,r,u,f){var e=new BABYLON.GUI.StackPanel("container_"+n);e.isVertical=!1;e.thickness=0;e.width=t.width;e.height=t.height;p(e,n,i,r);w(e,n,u);f.addControl(e)}function k(n){function r(){var r=_.extend(this,n);return r._serverSystemData=new y,r._nodeSpriteMeshId=null,r._spriteCreated=!1,r._sectorId=null,r._systemId=null,r._advancedTexture=null,r.CreateSprite=function(n,u){var o,e,p,w,k;if(r._spriteCreated){if(o=r.GetMeshById(r._nodeSpriteMeshId),o)return o;throw console.log("_self._spriteCreated, but mesh not exist");}e=r._serverSystemData._setData(n);r._sectorId=e.SectorId;r._systemId=e.Id;var y=r[EM.AssetRepository.MESH_CONTAINER_KEY],d=y._getBaseSpriteId(e.Id),f=u.clone(d);return f.position=e.Coords,f.scalingDeterminant=3e3,r._nodeSpriteMeshId=f.id,p=r._advancedTexture=BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(f,t.w,t.h,!1),b(f.id,"SYSTEM",e.NativeName,y._spriteIndex,p),f.onDisposeObservable.add(function(){f.material&&(f.material.dispose(!0,!0),f.material=null,delete f.material,console.log(" mesh.material"),p.dispose())}),i.AddLocalsToMesh(f,h,e.TextureTypeId),w=i.GetMeshInfoByMeshId(f.id),k=w.GetMapType(),i.AddLocalsToMesh(f,c,k),i.AddLocalsToMesh(f,a,y),i.AddLocalsToMesh(f,l,w),i.AddLocalsToMesh(f,s,r),i.AddLocalsToMesh(f,v,r._serverSystemData),f.material&&f.material.emissiveTexture&&(f.material.emissiveTexture.level=.95),EM.MapEvent.RegisterSystemsActions(f),r._spriteCreated=!0,f},r.GetSpriteNodeMesh=function(){return r._nodeSpriteMeshId?r.GetMeshById(r._nodeSpriteMeshId):null},r._dispose=function(){var n=r.GetMeshById(r._nodeSpriteMeshId);n&&n.dispose()},r.setVisible=function(n){EM.SetVisible(r._nodeSpriteMeshId,n)},r}return new r}function e(n){n._dispose()}function o(n){EM.Particle.ShowOrHideSectorParticles(n);_.forEach(r._collection,function(t){t.setVisible(n)})}function d(){var n=r.GetMeshById(f);return n||(n=BABYLON.MeshBuilder.CreatePlane(f,{width:t.pW,height:t.pH},EM.Scene),n.isVisible=!1,n.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL,n.updatable=!0),n}function g(n){var t=EM.MapData.Systems,i=d();_.forEach(t,function(n){var t=r.GetOrAdd(n.Id,n.TextureTypeId);t.CreateSprite(n,i)});o(!1);n instanceof Function&&n()}var i=EM.AssetRepository,s=i.MAP_ITEM_KEY,h=i.TEXTURE_TYPE_ID_KEY,c=i.MAP_TYPE_KEY,l=i.MESH_INFO_KEY,a=i.MESH_CONTAINER_KEY,v=i.SERVER_DATA_KEY,f=n.SYSTEM_PROTO_NAME,nt=EM.MapData.SystemKeys.TypeId,t=function(){var n={url:Utils.CdnManager.GetBjsSprite("starSprite.png",!0),items:8,originalWidth:2080,itemSize:0,nameColor:"#0065f0",typeColor:"#005cc5",_offsets:[]},t;for(n.itemSize=n.originalWidth/n.items,n.getOffset=function(t){return n._offsets[t]},t=0;t<n.items;t++)n._offsets.push(t*n.itemSize);return n.pW=2.9,n.pH=1,n.ratio=n.pW/n.pH,n.h=n.itemSize,n.w=n.h*n.ratio,n.width=n.w+"px",n.height=n.h+"px",n.textW=n.w*.5+"px",n.imgW=n.itemSize+"px",n}(),r=n.IGeometryMaperFactory("SystemSpriteMapper",k,null,f,function(n){return i.GetSpaceSpriteMeshContainer(n)}),u;r.Destroy=function(n){r.Count&&(n?r._cleanPerItem(e,function(t){return t._sectorId===n}):r._cleanPerItem(e))};u=n._baseObject(g,r.Destroy,o);u.NeedNewSystems=function(){if(!r.Count)return!0;var n=EM.EstateData.GetCurrentSpaceLocation();return console.log("needNewSystems",{"MapData.GetSystems.DataSectorId":EM.MapData.GetSystems.DataSectorId,"csl.SectorId":n.SectorId}),EM.MapData.GetSystems.DataSectorId===n.SectorId?!1:!0};u.GetSpriteMeshByStarId=function(n){var t=_.find(r._getAll(),function(t){return t._systemId===n});return t?t.GetSpriteNodeMesh():null};n.Systems=u}(EM.MapGeometry),function(n){"use strict";function c(n,t,i){y&&console.log("__system.generate__"+i+"__"+n+"__   ",{data:t})}function p(n,t){var r=Utils.ObjectToColor3(t),i=Utils.Color3IntToDecimal(r,.2);return i.r+=n.r,i.g+=n.g,i.b+=n.b,i.r=i.r>1?1:i.r,i.g=i.g>1?1:i.g,i.b=i.b>1?1:i.b,i}function l(n,i){return t.CreateSpaceRegularMeshId(n,i)}function a(n,t){return EM.SetScaleToMesh(n,t)}function w(){function w(n,t){n._localData._serverData.Children[t.Id]=t}function ht(n,i,r,f){var o,e,s;t.AddLocalsToMesh(n,rt,r.TextureTypeId);o=t.GetMeshInfoByMeshId(n.id);t.GetOrAddLoacalsInMesh(n,ut,o.GetMapType());t.AddLocalsToMesh(n,et,i);t.AddLocalsToMesh(n,ft,o);t.AddLocalsToMesh(n,ot,r);e=f*3*u;s=EM.GameCamera.System.lowerRadiusLimit;s>e&&(e=s);t.AddLocalsToMesh(n,h,e)}function b(n){EM.MapEvent.RegisterPlanetoidActions(n)}function l(n,i,r){var u=t.CloneMaterial(n,i,r);return n.material,n.material=u,u}function k(n,t){var i=n.GetMesh(),r,u;if(!i)throw Errors.ClientNullReferenceException({meshContainer:n,baseMesh:i});return r=n.GetMeshId(t),u=i.clone(r),u}function d(n,t,i,r){return i.Children||(i.Children={}),ht(n,t,i,r),EM.AssetRepository.BindDisposeFullMesh(n),n}function g(n,t,i){for(var u,o=n[r.Orbit]*i,h=n[r.NativeName],c="orbit_"+h,s=Math.PI*2,l=s/89,f=[],e=0;e<s;e+=l){var a=o*Math.cos(e),v=o*Math.sin(e);f.push(new BABYLON.Vector3(a,0,v))}return f.push(f[0]),u=BABYLON.MeshBuilder.CreateLines(c,{points:f},EM.Scene),u.rotation=Utils.ObjectToVector3(n[r.OrbitAngle]),u.isEnabled(1),u.isPickable=!1,u.color=BABYLON.Color3.White(),u.alpha=.05,u.parent=t,{coord:f,orbit:u}}function nt(n,t){if(n<0)throw new Error("_getOrbitPosition dataOrbitPosition< 0");return t[n]?t[n].clone():nt(n-1,t)}function tt(n,t,i){var e=_.join(["axis",i.toLowerCase(),t.orbit.id],"_"),o=Utils.ObjectToVector3(n.AxisAngle),f=_.round(n[r.Radius]*1.5,4),s=[new BABYLON.Vector3(0,-f,0),new BABYLON.Vector3(0,f,0)],u=BABYLON.MeshBuilder.CreateLines(e,{points:s},EM.Scene),h=n[r.OrbitPosition];return u.position=nt(h,t.coord),u.rotation=o,u.isPickable=!1,u.isVisible=!1,u.parent=t.orbit,u}function ct(n,i,r,u){var e=r.GetMeshId(u),f=BABYLON.Mesh.CreateSphere(e,16,i,EM.Scene);return l(f,t.GetSpaceRegularMaterial(n),u),f}function it(u,e){var h=u.TextureTypeId,s=u[r.Radius],l=s*2,c=t.GetSpaceRegularMeshContainer(h),o=ct(h,l,c,u.Id);return e===f.Star&&(i.StarRadius=s,o.position=Utils.ObjectToVector3(u[r.Coords]),n.Effects.Scattering.SetStar(o),EM.SpaceState.LastActiveStarSystem=o.id),o.isVisible=!0,o.isPickable=!0,d(o,c,u,s),b(o),o}function lt(n,i){var f=i.TextureTypeId,u=i.Id,r=k(n,u);return l(r,t.GetSpaceCloudMaterial(f),u),r.isVisible=!0,r}function at(n,t){_.forEach(n,function(n){var i=n.Id,u=g(n,t,2),e=tt(n,u,f.Moon),r=it(n,f.Moon);r.parent=e;w(t,n);s[i]||(s[i]=r.id)})}function vt(n,t){var o=t.Radius,s=n.id+"_label",h=o*2,c=h/4,r=BABYLON.MeshBuilder.CreatePlane(s,{width:h*u,height:c*u},EM.Scene),f,e,i;r.position.y+=o*1.5;r.position.x=r.position.z=0;f=BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(r);e=256;f.idealWidth=e*5;i=new BABYLON.GUI.TextBlock;i.text=t.NativeName;i.color="#0065f0";i.fontSize=e*1.7;i.fontFamily="Electrolize  sans-serif bold";i.scaleY=4;i.resizeToFit=!0;i.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;f.addControl(i);r.parent=n;r.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;EM.AssetRepository.BindDisposeFullMesh(r,function(){f.removeControl(i);f.dispose()},function(){console.log("after dispose",{plane:EM.GetMesh(s),label:i})})}function yt(n){var i=EM.MapData.System[r.Planets],u=EM.MapData.System[r.Moons];_.forEach(i,function(i){var s=i.Id,ut=i.TextureTypeId,c=i[r.Radius]*1,kt=c*2,yt=g(i,n,1),v=tt(i,yt,f.Planet),pt=t.GetTypeItem(ut),nt=pt.GetLayer(st.space),ft=nt.GetMeshContainer(y.regular),e=k(ft,s),it=l(e,t.GetSpaceRegularMaterial(ut),s),et=p(it.emissiveColor,i.Color),ht,ct,vt,rt;it.emissiveColor=et.clone();it.emissiveFresnelParameters&&(it.emissiveFresnelParameters.leftColor=et.clone());e.isVisible=!0;e.isPickable=!0;e.parent=v;e.rotation=new BABYLON.Vector3.Zero;w(n,i);d(e,ft,i,c);a(e,c);b(e);var ot=nt.GetMeshContainer(y.cloud),wt=ot._cloudScaling,bt=wt*c,h=lt(ot,i);a(h,bt);h.isPickable=!1;h.parent=v;EM.AssetRepository.BindDisposeFullMesh(h);nt.RenderOption&&(ht=t.BEFORE_RENDER_SPACE_PLANET_ACTION_KEY,ct=nt.RenderOption.StartOnBeforeRender(s,ht,{cloud:h,planet:e}),n.onDisposeObservable.add(function(){ct.StopBeforeRender(s)}));i.Rings&&(vt=EM.Particle.SaturnRings.createRings(v,i.Radius,400),vt.vars.startRingRotation());EM.AssetRepository.BindDisposeFullMesh(v);rt=_.filter(u,["Parent",s]);rt.length&&at(rt,e);o[s]||(o[s]=e.id)})}function pt(){var u=EM.MapData.System[r.Stars],t=null,o=Object.keys(u),i=o.length,s,n;return i?(i>1||i===1&&(s=o[0],n=u[s],t=it(n,f.Star),e[n.Id]||(e[n.Id]=t.id),vt(t,n)),t):(console.log("star not exist!!!"),null)}var rt=t.TEXTURE_TYPE_ID_KEY,ut=t.MAP_TYPE_KEY,ft=t.MESH_INFO_KEY,et=t.MESH_CONTAINER_KEY,ot=t.SERVER_DATA_KEY,st=t.LAYER_NAMES,y=t.SUBTYPE_MESH_NAMES,v;return EM.MapData.System?(v=pt(),yt(v),v.scaling=new BABYLON.Vector3(u,u,u),i.CallBack instanceof Function&&(c("system.CallBack instanceof Function",i.CallBack,"generate"),i.CallBack(),i.CallBack=null),c("GENERATE","DONE","generate"),!0):!1}function b(){if(EM.SpaceState.LastActiveStarSystem){var n=EM.GetMesh(EM.SpaceState.LastActiveStarSystem);n&&(n.dispose(),EM.SpaceState.LastActiveStarSystem=null,EM.Scene.resetCachedMaterial(),n=null)}}function v(n,t,i){var r=e[n];return r||(r=l(t,n),r&&t&&i&&(e[n]=r)),r}function k(t,r){var f,u;return(f=r?v(t,r):i.GetStarMeshIdByUniqueId(t),u=n._chekAndGetMeshInScene(f),u)?u.isVisible:!1}var i=n._baseObject(),t=EM.AssetRepository,u;i.CallBack=null;i.StarRadius=null;var r=EM.MapData.SystemKeys,f=n.MapTypes,h=i.PLANETOID_MIN_CAMERA_RADIUS_KEY="_minCameraRadius",y=!1;var e={},o={},s={};i.getMinCameraRadiusByMesh=function(n){var i=t.GetLocalsFromMesh(n,h)};u=15;i.CreatePlanetoidMeshId=l;i.Generate=w;i.Destroy=b;i.GetStarStatus=k;i.GetOrCreateStarMeshId=v;i.GetPlanetMeshIdByUniqueId=function(n){return o[n]};i.GetMoonMeshIdByUniqueId=function(n){return s[n]};i.GetStarMeshIdByUniqueId=function(n){return e[n]};i.GetOrCreatePlanetMeshId=function(n,r,u){var f=i.GetPlanetMeshIdByUniqueId(),e,s;return!f&&r&&(e=t.GetSpaceRegularMeshContainer(r),s=e.GetMeshId(),f=e.GetMeshId(n,s),f&&u&&(o[n]=f)),f};n.System=i;n.GetSystemIdFromAny=function(i){var r=n.GetUniqueIdFromAny(i),u;if(typeof r=="number")return r;if(typeof r=="string"&&r.length>=5&&(u=t.GetMeshInfoByMeshId(r),u.UniqueId))return u.UniqueId;throw Errors.ClientNotImplementedException({_id:r,anySystem:i},"_id");}}(EM.MapGeometry),function(n){"use strict";function r(n){return EM.GetMesh(n)}function f(n,i){t.HighlightLayer.blurHorizontalSize=n;t.HighlightLayer.blurVerticalSize=i?i:n}function o(n,r){i||(t.HighlightLayer=new BABYLON.HighlightLayer(t._name,EM.Scene),t.HighlightLayer.innerGlow=!0,f(n?n:1,r?r:.5),i=!0)}function e(n,i){t.HighlightLayer._meshes[n].color=BABYLON.Color4.FromInts(i.r,i.g,i.b,255)}function s(n){var i=t.HighlightLayer._meshes;return i.hasOwnProperty(n.id)&&i[n.id]}function u(n,i){if(s(u)&&i)console.log("exist!!"),e(n.id,i);else{var r=n.onDisposeObservable.add(function(i){i.id===n.id&&(t.HighlightLayer.removeMesh(n),i.onBeforeRenderObservable.remove(r))});t.HighlightLayer.addMesh(n,i?BABYLON.Color4.FromInts(i.r,i.g,i.b,255):new BABYLON.Color4(1,1,1,1))}}function h(n,t){u(r(n),t)}function c(){_.forEach(t.HighlightLayer._meshes,function(n,i){t.HighlightLayer.removeMesh(r(i))})}function l(n){_.forEach(n,function(n){t.HighlightLayer.removeMesh(r(n))})}var t={},i;t._name="hl1";t.HighlightLayer=null;i=!1;t.SetBlur=f;t.Create=o;t.AddMesh=u;t.AddMeshById=h;t.RemoveByListNames=l;t.CleanAll=c;t.UpdateMeshColor=e;n.Effects.Hl=t}(EM.MapGeometry),function(n){"use strict";var t,i={SetStar:function(n){t?t.mesh=n:t=new BABYLON.VolumetricLightScatteringPostProcess("godrays",1,EM.GameCamera.Camera,n,100,BABYLON.Texture.BILINEAR_SAMPLINGMODE,EM.Engine,!1)}};n.Effects.Scattering=i}(EM.MapGeometry);EM.MapBuilder={},function(n){function t(n){this.SubscribeName=n;this.Observer=Utils.PatternFactory.Observer(n);this.Build=null;this.Update=null}n._createMapBuildItem=function(n){return new t(n)}}(EM.MapBuilder),function(n){var t=n._createMapBuildItem("MapBuilder.Sectors");t.Build=function(t){EM.MapData.GetSectors.Observer.Subscribe(n.Sectors);t!=null?EM.MapData.GetSectors.InitSectorData(t):EM.MapData.GetSectors.GetData()};t.Update=function(t){EM.MapData.GetSectors.SubscribeName===t&&(EM.MapData.GetSectors.Observer.Unsubscribe(n.Sectors),EM.MapGeometry.Galaxies.Generate(),n.Sectors.Observer.NotifyAll())};n.Sectors=t}(EM.MapBuilder),function(n){var t=n._createMapBuildItem("MapBuilder.Systems"),r=!1,i=!1;t.Build=function(){r||(r=!0,EM.MapGeometry.Systems.NeedNewSystems()?(EM.MapGeometry.Systems.Destroy(),i=!1):(EM.MapGeometry.Systems.SetVisible(!1),i=!0),EM.MapData.GetSystems.Observer.Subscribe(t),EM.MapData.GetSystems.GetData(EM.SpaceState.CurrentActiveSector))};t.Update=function(n){if(EM.MapData.GetSystems.SubscribeName===n){EM.MapData.GetSystems.Observer.Unsubscribe(t);function u(n){n instanceof Function&&n();t.Observer.NotifyAll();r=!1}if(i){i=!1;u(function(){EM.MapGeometry.Systems.SetVisible(!0)});return}EM.MapGeometry.Systems.Generate(u)}};n.Systems=t}(EM.MapBuilder),function(n){var t=n._createMapBuildItem("MapBuilder.System");t.Callback=null;t.Build=function(n){var i=0;if(i=n!=null?EM.MapData.GetSectors.InitSectorData(n):EM.MapGeometry.GetSystemIdFromAny(EM.SpaceState.CurrentActiveSystem),i===0){console.log("Error system is incorrect");return}EM.MapData.GetSystem.Observer.Subscribe(t);EM.MapData.GetSystem.GetData(i)};t.Update=function(n){EM.MapData.GetSystem.SubscribeName===n&&(EM.MapData.GetSystem.Observer.Unsubscribe(t),EM.MapGeometry.System.Generate(),null!==t.Callback&&(t.Callback(),t.Callback=null))};n.System=t}(EM.MapBuilder);EM.MapAnimation={},function(n){function e(n){return{SubscribeName:n,SubscribeNames:{BaseName:n,Stop:n+".Stop",Start:n+".Start"},Observer:Utils.PatternFactory.Observer(n),Stack:Utils.PatternFactory.StackCommands(),Play:null,Stop:null}}function o(n){var i;return(n||(n=t.easeInOut),n===t.easeInOut)?(i=new BABYLON.CubicEase,i.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),i):n===t.linear?null:n===t.easeIn?(i=new BABYLON.CubicEase,i.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),i):null}function u(n,t,i,u,f){var e=new BABYLON.Animation(r.CameraChangeTarget,"target",f,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),o=[{frame:0,value:n},{frame:u,value:t}];return e.setKeys(o),i&&e.setEasingFunction(i),EM.GameCamera.Camera.animations.push(e),e}function f(n,t,i,u){var e=EM.GameCamera.Camera.radius,f=new BABYLON.Animation(r.CameraChangeRadius,"radius",u,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),o=[{frame:0,value:e},{frame:i,value:n}];return f.setKeys(o),t&&f.setEasingFunction(t),EM.GameCamera.Camera.animations.push(f),f}function s(n){console.log("zoomToPlanetoid",{planetoid:n});EM.GameCamera.Camera.zoomOn([n],!0)}function i(n,t,i,r,e){function w(){_.remove(EM.GameCamera.Camera.animations,function(n){return n===h||n===c});h=null;c=null;i()}var c;i instanceof Function||(i=function(){});var l=EM.GameCamera.Camera.target.clone(),a=n.getAbsolutePivotPoint(),h,v=o(e),s=30,p=r||1.5,y=s/p;Utils.CheckNullDistanceVector3(l,a)||(h=u(l.clone(),a.clone(),v,s,y));c=f(t,v,s,y);EM.Scene.beginAnimation(EM.GameCamera.Camera,0,s,!1,1,w)}function h(n,r,u){i(n,r,u,.5,t.linear)}function c(n,t,r){if(!EM.GameLoader)i(n,t,r,.5);else{function u(){r();EM.GameLoader.Update("MotherJumped")}i(n,t,u)}}var r={CameraChangeTarget:"CameraChangeTarget",CameraChangeRadius:"CameraChangeRadius"},t={linear:1,easeIn:2,easeInOut:3};n.SectorStarInfo={};n.MoveToPlanetoid=h;n.ZoomToPlanetoid=s;n.MoveToMother=c;n.MoveToMesh=i;n.AnimationCameraTarget=u;n.AnimationCameraRadius=f;n._IAnimation=e;n.EasingTypes=t}(EM.MapAnimation);EM.SpaceState={CurrentActiveSector:null,CurrentActiveSystem:null,LastActiveStarSystem:null,NewTargetFlag:!1,SetNewCoord:function(n,t){EM.SpaceState.CurrentActiveSector=n;EM.SpaceState.CurrentActiveSystem=t},SpacePosition:null},function(n){function i(){var i;return function r(){function o(){return EM.SpacePositionBlocked}function s(n,t){EM.SpacePositionBlocked=t?!1:n}function b(n,t){function i(){s(!1)}(!o()||t)&&(s(!0,t),GameServices.planshetService.close(),n instanceof Function?n(i):i())}function e(n,t){o()||(c.setTarget(t),n())}if(i)return i;var c=this,h=new n.GalaxyState(this),l=new n.SectorState(this),a=new n.ArroundSystemState(this),v=new n.SystemSelectedState(this),y=new n.PlanetoidSelectedState(this),p=new n.UserPlanetState(this),w=new n.MotherState(this),u=h,f=EM.MapGeometry.MapTypes.Galaxy;return this.setState=function(i){var l=EM.EstateGeometry.MotherModules.GetMotherGroupMesh(),o=EM.EstateData.GetCurrentSpaceLocation(),a=EM.MapGeometry.Galaxies.GetGalaxy(o.GalaxyId),s=i instanceof n.GalaxyState,r=i instanceof n.MotherState,f=i instanceof n.PlanetoidSelectedState,e=i instanceof n.SystemSelectedState,h=i instanceof n.UserPlanetState,c=i instanceof n.SectorState;r?EM.EstateGeometry.MotherModules.InMother():f||e?(GameServices.controlPanelSwicherHelper.setMap(),EM.MapGeometry.GetUniqueIdFromAny(EM.SpaceState.CurrentActiveSystem)===EM.EstateData.GetMotherLocation().SystemId?EM.EstateGeometry.MotherModules.ArroundMother():EM.EstateGeometry.MotherModules.HideMother()):s?EM.MapGeometry.Galaxies.SetVisible(!0):c&&(t.sectorsIsvisible=!0);h?(t.userPlanetState=!0,EM.EstateGeometry.PlanetModules.InPlanet(),EM.StarLight.SetInPlanet()):r||f||e?(EM.GameCamera.System.$newSystemId=o.SystemId,EM.StarLight.SetInSystem()):EM.StarLight.SetOther();l.isVisible&&(r||f||e||EM.EstateGeometry.MotherModules.HideMother());t.userPlanetState&&!h&&(EM.EstateGeometry.PlanetModules.HidePlanet(),t.userPlanetState=!1);a.isVisible&&!s&&EM.MapGeometry.Galaxies.SetVisible(!1);t.sectorsIsvisible&&!c&&(EM.MapGeometry.Systems.SetVisible(!1),t.sectorsIsvisible=!1);GameServices.controlDiskHelper.hide&&GameServices.controlDiskHelper.hide();u=i},this.setTarget=function(n){EM.SpaceState.NewTargetFlag=n===f?!1:!0;f=n},this.stateChanger=b,this.setBlockedState=s,this.getBlockedState=o,this.isNewTarget=function(){return EM.SpaceState.NewTargetFlag},this.getCurrentState=function(){return u},this.getMesh=function(){var n=null;if(f)if(typeof f=="object"){if(f.hasOwnProperty("_scene"))return f;f.hasOwnProperty("id")&&(n=f.id)}else if(typeof f=="string")n=f;else return console.log("SpacePositionPrototype.getMesh mesh type not impl",{currTarget:f}),null;else return null;return Utils.IsNotEmptyString(n)?EM.GetMesh(n):null},this.getGalaxyState=function(){return h},this.getSectorState=function(){return l},this.getArroundSystemState=function(){return a},this.getSystemSelectedState=function(){return v},this.getPlanetoidSelectedState=function(){return y},this.getUserPlanetState=function(){return p},this.getMotherState=function(){return w},this.clickByBtnGalaxy=function(n,t){e(function(){u.clickByBtnGalaxy(t)},n)},this.clickByBtnSystem=function(n,t){e(function(){u.clickByBtnSystem(t)},n)},this.clickBySpace=function(n){o()||e(function(){u.clickBySpace()},n)},this.clickBySector=function(n){e(function(){u.clickBySector()},n)},this.clickBySystem=function(n){e(function(){u.clickBySystem()},n)},this.clickByPlanetoid=function(n){e(function(){u.clickByPlanetoid()},n)},this.clickByUserPlanet=function(){u.clickByUserPlanet()},this.clickByBtnMapToggle=function(n){e(function(){u.clickByBtnMapToggle()},n)},this.clickByMother=function(n){e(function(){u.clickByMother()},n)},this.disposeLastSystem=function(){EM.MapGeometry.System.Destroy()},this.constructor===r?i=this:(console.log("new SpacePositionPrototype"),new r)}}var t={};t.sectorsIsvisible=!1;t.userPlanetState=!1;n.SpacePosition=i()}(EM.SpaceState),function(n){function t(n){this._director=n}t.prototype.clickByBtnGalaxy=function(n){var t=this._director;t.stateChanger(function(i){function f(){EM.MapGeometry.System.Destroy();EM.SpaceState.CurrentActiveSystem=null;EM.SpaceState.NewTargetFlag=!1}EM.Audio.GameSounds.onMoveToPlanetoid.play();EM.MapGeometry.Sectors.SetUnselected();EM.GameCamera.SetGalaxy(n);f();GameServices.mapControlHelper.setState("GalaxyState");t.setState(t.getGalaxyState());var e=EM.EstateData.GetCurrentSpaceLocation(),u=e.SectorId,r=EM.MapGeometry.Sectors.GetMeshBySectorNumId(u);console.log("activeMesh",{activeMesh:r,activeMeshId:r.id,sectorId:u});r&&EM.MapEvent.SectorLeftClick(r);EM.Audio.GameSounds.onMoveToPlanetoid.play();i()})};t.prototype.clickByBtnSystem=function(){var n=this._director,t=this;n.stateChanger(function(i){t.setSystemsVisible(!1);n.setState(n.getSystemSelectedState());var r=n.getMesh();EM.GameCamera.SetSystemSelected(r.position);i()})};t.prototype.clickBySpace=function(){var n=this._director;n.stateChanger(function(n){n()})};t.prototype.clickBySector=function(){var t=this,n=this._director;n.stateChanger(function(i){function u(u){u===EM.MapBuilder.Systems.SubscribeName&&(EM.MapBuilder.Systems.Observer.Unsubscribe(r),t.setSystemsVisible(!0),n.disposeLastSystem(),EM.GameCamera.SetSystems(),GameServices.mapControlHelper.setSectorState(),i())}var r={};r.Update=u;EM.MapBuilder.Systems.Observer.Subscribe(r);EM.MapBuilder.Systems.Build();n.setState(n.getSectorState())})};t.prototype.clickBySystem=function(){var n=this._director;n.stateChanger(function(n){n()})};t.prototype.clickByPlanetoid=function(){var r=this,t=r._director,i=EM.AssetRepository;t.stateChanger(function(r){var u=t.getMesh(),a,s,e,f,l,tt;if(t.isNewTarget()){if(a=i.MESH_INFO_KEY,s=i.MESH_LOCALS_KEY,!u.hasOwnProperty(s))throw Errors.ClientNullReferenceException({target:u},"target<mesh>");if(e=u[s],f=e[a],!f.HasUniqueId)throw Errors.ClientNullReferenceException({meshInfo:f,target:u},"meshInfo.HasUniqueId","ISpacePositionState.prototype.clickByPlanetoid");var h=f.UniqueId,v=f.GetMapType(),o=v.MapType,y=e._serverData.SystemId,p=!1;o===EM.MapGeometry.MapTypes.Star?(p=!0,EM.EstateData.SetSpaceLocationFromSystemId(h),GameServices.mapControlHelper.setStarState()):o===EM.MapGeometry.MapTypes.Planet?(EM.EstateData.SetSpaceLocationFromPlanetId(h),GameServices.mapControlHelper.setPlanetoidState()):o===EM.MapGeometry.MapTypes.Satellite&&v.SubMapType===EM.MapGeometry.MapTypes.Moon&&(EM.EstateData.SetSpaceLocationFromMoonId(h),GameServices.mapControlHelper.setPlanetoidState());var b=EM.MapGeometry.System.PLANETOID_MIN_CAMERA_RADIUS_KEY,k=e[b],c=EM.GameCamera.SetAndGetNewLowerRadiusLimit(_.ceil(k));if(EM.GameCamera.System.lowerRadiusLimit=c,l=null,p)c=EM.GameCamera.System.$setOnBeforeAnimationParams();else{var d=EM.EstateData.GetCurrentSpaceLocation(),g=d.SystemId===y,w=t.getCurrentState(),nt=w instanceof n.PlanetoidSelectedState;g&&nt?l="PlanetoidSelectedState":tt=w instanceof n.GalaxyState}EM.MapAnimation.MoveToPlanetoid(u,c,function(){t.setState(t.getPlanetoidSelectedState());o===EM.MapGeometry.MapTypes.Star?t.setState(t.getSystemSelectedState()):t.setState(t.getPlanetoidSelectedState());EM.GameCamera.SetSystemSelected(u.getAbsolutePosition(),l,y);r()})}r()})};t.prototype.clickByUserPlanet=function(){var t=this,n=t._director;n.stateChanger(function(i){EM.MapGeometry.Systems.Destroy();EM.EstateBuilder.UserPlanetBuilder.SetPlanetEnv();EM.GameCamera.SetInUserPlanet();GameServices.mapControlHelper.setUserPlanetState();t.setSystemsVisible(!1);n.setState(n.getUserPlanetState());GameServices.estateService.getFullEstate(EM.EstateData.GetPlanetLocation().PlanetId);GameServices.controlPanelSwicherHelper.setHangar();i()})};t.prototype.clickByMother=function(){var i=this,t=i._director;t.stateChanger(function(r){EM.Audio.GameSounds.onMoveToPlanetoid.play();var u=t.getCurrentState();if(u instanceof n.MotherState){r();return}(u instanceof n.SectorState||u instanceof n.ArroundSystemState)&&i.setSystemsVisible(!1);t.setState(t.getMotherState());GameServices.estateService.getFullEstate(0);GameServices.mapControlHelper.setMotherState();GameServices.controlPanelSwicherHelper.setHangar();u instanceof n.UserPlanetState?(EM.GameCamera.SetMotherSelected(!0),r()):EM.MapAnimation.MoveToMother(EM.GetMotherMesh(),EM.GameCamera.Mother.radius,function(){EM.GameCamera.SetMotherSelected(!0);r()})})};t.prototype.clickByBtnMapToggle=function(){var n=this._director;n.stateChanger(function(n){n()})};t.prototype.Update=function(){var n=this._director;n.stateChanger(function(n){n()})};t.prototype.setSystemsVisible=EM.MapGeometry.Systems.SetVisible;EM.SpaceState.ISpacePositionState=t}(EM.SpaceState),function(n){function i(){t.apply(this,arguments)}function r(){function u(t){var u=n.getMesh(),e=r.GetLocalsFromMesh(u,r.SERVER_DATA_KEY),f=e.Id;EM.SpaceState.CurrentActiveSystem=f;EM.EstateData.SetSpaceLocationFromSystemId(f);GameServices.mapControlHelper.setSystemState();EM.MapBuilder.System.Build();EM.MapGeometry.Systems.SetVisible(!1);EM.GameCamera.System.$setOnBeforeAnimationParams();EM.MapAnimation.MoveToMesh(u,EM.GameCamera.System.radius,function(){EM.GameCamera.System.$setOnEndAnimationParams();n.setState(n.getSystemSelectedState());EM.GameCamera.SetSystemSelected(n.getMesh().position);i.setSystemsVisible(!1);t()})}var r=EM.AssetRepository,i,n;t.apply(this,arguments);i=this;n=i._director;this.clickBySystem=function(){n.stateChanger(u)}}function u(){function r(t){console.log("ArroundSystemState.clickBySpace");n.disposeLastSystem();n.setState(n.getSectorState());EM.GameCamera.SetSystems();t()}function u(t){console.log("ArroundSystemState.clickBySystem");var r=n.getMesh();EM.SpaceState.CurrentActiveSystem=r.id;EM.MapBuilder.System.Build();EM.MapAnimation.MoveToMesh(n.getMesh(),EM.GameCamera.System.radius,function(){n.setState(n.getSystemSelectedState());EM.GameCamera.SetSystemSelected(n.getMesh().position);i.setSystemsVisible(!1);t()})}t.apply(this,arguments);var i=this,n=i._director;this.clickBySpace=function(){n.stateChanger(r)};this.clickBySystem=function(){n.stateChanger(u)}}function f(){function r(t){var r={Update:function(u){var e,f;EM.Audio.GameSounds.onSpaceMoveToSystemPoint.play();u===EM.MapBuilder.Systems.SubscribeName&&(e=EM.EstateData.GetCurrentSpaceLocation(),EM.EstateData.SetSpaceLocationFromSectorId(e.SectorId),EM.MapBuilder.Systems.Observer.Unsubscribe(r),f=EM.MapGeometry.Systems.GetSpriteMeshByStarId(EM.SpaceState.CurrentActiveSystem),GameServices.mapControlHelper.setSectorState(),EM.GameCamera.SetSystems(),EM.MapAnimation.MoveToMesh(f,EM.GameCamera.Systems.radius,function(){n.setBlockedState(!1);n.setState(n.getSectorState());n.setBlockedState(!0);i.setSystemsVisible(!0);n.setTarget(f.id);n.disposeLastSystem();EM.GameCamera.System.$newSystemId=null;t()}))}};EM.MapBuilder.Systems.Observer.Subscribe(r);EM.MapBuilder.Systems.Build()}t.apply(this,arguments);var i=this,n=this._director;this.clickBySpace=function(){n.stateChanger(r)}}function e(){function i(t){var i,r;EM.Audio.GameSounds.onMoveToPlanetoid.play();i=EM.EstateData.GetCurrentSpaceLocation();EM.EstateData.SetSpaceLocationFromSystemId(i.SystemId);n.setState(n.getSystemSelectedState());GameServices.mapControlHelper.setSystemState();r=EM.GetMesh(EM.SpaceState.LastActiveStarSystem);GameServices.controlPanelSwicherHelper.setMap();EM.GameCamera.System.$setOnBeforeAnimationParams();EM.MapAnimation.MoveToPlanetoid(r,EM.GameCamera.System.radius,function(){EM.GameCamera.System.$setOnEndAnimationParams();EM.GameCamera.SetSystemSelected(r.position,"PlanetoidSelectedState",i.SystemId);t()})}t.apply(this,arguments);var n=this._director;this.clickBySpace=function(){n.stateChanger(i)}}function o(){function i(n){n()}t.apply(this,arguments);var n=this._director;this.clickBySpace=function(){n.stateChanger(i)}}function s(){function u(t){var o;EM.Audio.GameSounds.onMoveToPlanetoid.play();var u=EM.GetMesh(EM.SpaceState.LastActiveStarSystem),f=i.GetLocalsFromMesh(u,r),e=EM.EstateData.GetCurrentSpaceLocation();EM.EstateData.SetSpaceLocationFromSystemId(e.SystemId);n.setState(n.getSystemSelectedState());GameServices.mapControlHelper.setSystemState();GameServices.controlPanelSwicherHelper.setMap();EM.GameCamera.SetAndGetNewLowerRadiusLimit(f);o=u.getAbsolutePosition().clone();EM.GameCamera.System.$setOnBeforeAnimationParams();EM.MapAnimation.MoveToPlanetoid(u,EM.GameCamera.System.radius,function(){EM.GameCamera.System.$setOnEndAnimationParams(f);EM.GameCamera.SetSystemSelected(o,null,e.SystemId);t()})}t.apply(this,arguments);var n=this._director,i=EM.AssetRepository,r=EM.MapGeometry.System.PLANETOID_MIN_CAMERA_RADIUS_KEY;this.clickBySpace=function(){n.stateChanger(u)}}var t=n.ISpacePositionState;i.prototype=Object.create(n.ISpacePositionState.prototype);i.prototype.constructor=i;n.GalaxyState=i;r.prototype=Object.create(t.prototype);r.prototype.constructor=r;n.SectorState=r;u.prototype=Object.create(t.prototype);u.prototype.constructor=u;n.ArroundSystemState=u;f.prototype=Object.create(t.prototype);f.prototype.constructor=f;n.SystemSelectedState=f;e.prototype=Object.create(t.prototype);e.prototype.constructor=e;n.PlanetoidSelectedState=e;o.prototype=Object.create(t.prototype);o.prototype.constructor=o;n.UserPlanetState=o;s.prototype=Object.create(t.prototype);s.prototype.constructor=s;n.MotherState=s}(EM.SpaceState);EM.MapEvent={},function(n){function e(n){var t=i.CreateMeshArgumentType(n);if(t.IsMesh)t=null;else throw Errors.ClientTypeErrorException({event:event,asNew:asNew,meshType:t},n,"object||BABYLON.Mesh","!MapEvent.sectorClick.meshType.IsMesh");}var r,u,o;n.HoveredPlanetoid=null;var i=EM.AssetRepository,s=i.MAP_ITEM_KEY,h=i.TEXTURE_TYPE_ID_KEY,f=i.SERVER_DATA_KEY,t=EM.Audio.GameSounds;n.HideContextMenu=function(){GameServices.controlDiskHelper.hide()};n.ShowContextMenu=function(t){n.HideContextMenu();GameServices.controlDiskHelper.show(t)};n.SectorLeftClick=function(n){var t,u,s,o;n&&(e(n),t=EM.MapGeometry.Sectors.Materials.GetClick(),r&&n.id!==r&&(u=EM.GetMesh(r),s=i.GetLocalsFromMesh(u,f),s&&(o=EM.MapGeometry.Sectors.Materials.GetRegular(),o.id!==n.material.id&&(u.material=o))),r=n.id,t.id!==n.material.id&&(n.material=t))};n.SectorDoubleClick=function(t){e(t);console.log("sectorClick",t);var u=i.GetLocalsFromMesh(t,f),o=u.SectorId;n.SectorProgrammClick(o);r=null;return};n.RegisterSectorActions=function(i){var u=n.IMapEventItemOption(i);u.rightClick=function(t,i){n.ShowContextMenu(i)};u.leftClick=n.SectorLeftClick;u.doubleClick=n.SectorDoubleClick;u.hovered=function(n){if(n){t.onSpaceObjectHoveredIn.play();var i=EM.MapGeometry.Sectors.Materials.GetHover();n.material.id!==i.id&&(n.material=i)}};u.unHovered=function(t){if(t){var i=EM.MapGeometry.Sectors.Materials.GetRegular(),u=EM.MapGeometry.Sectors.Materials.GetClick();r?t.id===r?t.material=u:t.material&&t.material.id!==i.id&&(t.material=i):t.material=i;n.HideContextMenu()}};n.RegisterFactoryAction(u)};n.SectorProgrammClick=function(n){EM.SpaceState.CurrentActiveSector=n;EM.Audio.GameSounds.onSpaceMoveToSystemPoint.play();EM.EstateData.SetSpaceLocationFromSectorId(n);GameServices.mapControlHelper.jumpToSector()};u={};n.SystemsLeftClick=function(i){var u,f,r;!EM.SpacePositionBlocked&&i&&i.getAbsolutePosition&&((u=EM.GameCamera.Camera.target,f=i.getAbsolutePosition(),u.equals(f))||(n._systemsHover(i),o=i.id,r=new EM.SpaceState.SpacePosition,r.setBlockedState(!0),t.onSpaceMoveToSystemPoint.play(),EM.MapAnimation.MoveToMesh(i,EM.GameCamera.ArroundSystem.radius,function(){r.setBlockedState(!1)},.5,EM.MapAnimation.EasingTypes.linear)))};n.SystemsDoubleClick=function(r){var u;t.onSpaceMoveToSystemPoint.stop();t.onSpaceJumpToSystemStart.play();var o=r.id,f=i.GetLocalsFromMesh(r,i.SERVER_DATA_KEY),e=f.Id;EM.SpaceState.CurrentActiveSystem=e;u=new EM.SpaceState.SpacePosition;u.clickBySystem(r);n.HideContextMenu()};n._systemsHover=function(i){t.onSpaceObjectHoveredIn.play();_.forEach(u,function(t){n._systemsOut(t,null)});i.material&&i.material.emissiveTexture&&(i.material.emissiveTexture.level=1.3);u[i.id]=i};n._systemsOut=function(n){n.id!==o&&(n.material&&n.material.emissiveTexture&&(n.material.emissiveTexture.level=.95),u[n.id]&&delete u[n.id])};n.RegisterSystemsActions=function(t){var i=n.IMapEventItemOption(t);i.leftClick=n.SystemsLeftClick;i.rightClick=function(t,i){n.ShowContextMenu(i)};i.doubleClick=n.SystemsDoubleClick;i.hovered=n._systemsHover;i.unHovered=n._systemsOut;n.RegisterFactoryAction(i)};n.PlanetoidDubleClick=function(i,r,u){var f,e;(f=u?i:i.id,f)&&(n.HideContextMenu(),e=new EM.SpaceState.SpacePosition,e.clickByPlanetoid(f),t.onMoveToPlanetoid.play())};n.RegisterPlanetoidActions=function(i){var r=n.IMapEventItemOption(i);r.hovered=function(){t.onSpaceObjectHoveredIn.play()};r.rightClick=function(t,i){n.ShowContextMenu(i)};r.doubleClick=n.PlanetoidDubleClick;n.RegisterFactoryAction(r)};n.InitSceneEvents=function(i){function s(n,i){r.beginRotate=!0;r.beginAlpha=n;r.beginBeta=i;t.onSpaceRotate.isPlaying||(t.onSpaceRotate.loop=r.loop,t.onSpaceRotate.play())}function e(){clearTimeout(r.$timeout);r.beginRotate=!1;setTimeout(function(){t.onSpaceRotate.stop()},100)}function o(){return console.log("onStopZoomTimer",{onSpaceScroll:EM.Audio.GameSounds.onSpaceScroll}),u.timer=null,t.onSpaceScroll.stop(),u.inProgress=!1,console.log("onStopZoomTimer"),!1}function h(){var n=Date.now();u.timer?n-f>20&&u.timer&&u.timer&&(clearTimeout(u.timer),f=n,u.timer=setTimeout(o,300)):(f=n,u.timer=setTimeout(o,300))}function c(){u.inProgress=!0;t.onSpaceScroll.loop!==r.loop&&(t.onSpaceScroll.loop=r.loop);t.onSpaceScroll.isPlaying?h():t.onSpaceScroll.play()}var r,u,f;EM.Scene.hoverCursor=" default ";n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPickTrigger,function(){n.HideContextMenu()});r={beginRotate:!1,beginAlpha:0,beginBeta:0,$timeout:null,loop:!0};n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPickDownTrigger,function(){if(EM.EstateData.GetCurrentEstate().EstateType){r.$timeout&&e();return}r.beginBeta=EM.GameCamera.Camera.beta;r.beginAlpha=EM.GameCamera.Camera.alpha;r.beginRotate||(r.$timeout=setTimeout(function(){(r.beginRotate||r.beginAlpha===EM.GameCamera.Camera.alpha)&&r.beginBeta===EM.GameCamera.Camera.beta||s(EM.GameCamera.Camera.alpha,EM.GameCamera.Camera.beta)},150))});n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPickUpTrigger,function(){r.$timeout&&e()});n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnDoublePickTrigger,function(){n.HideContextMenu();EM.Scene.hoverCursor=" default ";var t=new EM.SpaceState.SpacePosition;t.clickBySpace(i.id)});u={timer:null,inProgress:!1,loop:!0};f=0;EM.Scene.onPrePointerObservable.add(function(){return},BABYLON.PointerEventTypes.POINTERWHEEL,!1);n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPointerOutTrigger,function(){e()});n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPointerOverTrigger,function(){})};n.IMapEventItemOption=function(n){function t(){this.mesh=n;this.leftClick=null;this.rightClick=null;this.doubleClick=null;this.hovered=null;this.unHovered=null}return new t};n.RegisterFactoryAction=function(t){if(!t)throw new Error("MapEvent.RegisterFactoryAction: iMapEventItemOption not exist");if(!t.mesh)throw new Error("MapEvent.RegisterFactoryAction: mesh not exist");var i=t.mesh;i.actionManager&&i.actionManager.dispose();t.leftClick&&n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnLeftPickTrigger,t.leftClick);t.rightClick&&n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnRightPickTrigger,t.rightClick);t.doubleClick&&n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnDoublePickTrigger,t.doubleClick);t.hovered&&n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPointerOverTrigger,t.hovered);t.unHovered&&n.AddExecuteCodeAction(i,BABYLON.ActionManager.OnPointerOutTrigger,t.unHovered)};n.RemoveActionFromMesh=function(){return EM.EstateEvents.RemoveActionFromMesh.apply(EM.EstateEvents,arguments)};n.GetOrCreateActionManagerFromMesh=function(){return EM.EstateEvents.GetOrCreateActionManagerFromMesh.apply(EM.EstateEvents,arguments)};n.AddExecuteCodeAction=function(){return EM.EstateEvents.AddExecuteCodeAction.apply(EM.EstateEvents,arguments)}}(EM.MapEvent);EM.EstateGeometry={IModules:function(){return{Modules:null,RegistrEvents:null,GetMesh:function(n){return EM.GetMesh(n)},SetVisible:function(n,t){return EM.SetVisible(n,t)},States:{In:1,Arround:2,Hide:3}}},PlanetModules:null,MotherModules:null,MotherElements:[],PlanetGroundsMeshes:[],GameModelsInit:null},function(n){function i(n){return t.GetMesh(n)}function a(n,i){return t.SetVisible(n,i)}function v(){EM.EstateEvents.RegisterMotherIndustrialComplex(i(u));EM.EstateEvents.RegisterMotherSpaceShipyard(i(f));EM.EstateEvents.RegisterMotherResearch(i(e));EM.EstateEvents.RegisterMotherCapsule(i(o))}function l(n,t){var r=n?1:0;n?t===u?i(t).visibility=r:t===f?i(t).visibility=r:t===e&&(i(t).visibility=r):_.forEach(s,function(n){i(n).visibility=r})}function h(n){return a(o,n)}function c(n){function t(n,t){n&&(n.isPickable=t)}n===r.In?t(h(!0),!1):n===r.Arround?t(h(!0),!0):n===r.Hide&&t(h(!1),!0);l(!1)}var t=EM.EstateGeometry.IModules(),u="mother_industrial_complex",f="mother_space_shipyard",e="mother_research",o="mother_parent",s=[u,f,e],r=t.States;t.MotherIndustrialComplex=u;t.MotherSpaceShipyard=f;t.MotherResearch=e;t.SetMotherModulesVisible=l;t.LoadedMotherId="mother";t.EstateMotherGroupId=o;t.MotherCoreId="mother_core";t.Modules=s;Object.defineProperty(t,"Modules",{get:function(){return s}});t.RegistrEvents=v;t.GetMotherGroupMesh=function(){return i(o)};t.InMother=function(){c(r.In)};t.ArroundMother=function(){c(r.Arround)};t.HideMother=function(){c(r.Hide)};Object.defineProperty(n,"MotherModules",{get:function(){return t}})}(EM.EstateGeometry),function(n){function s(n){return t.GetMesh(n)}function p(n,t,i){throw Errors.ClientNullReferenceException(n,t,"EstateGeometry.PlanetModules."+i);}function w(n,t){var i,r,u;if(!n)throw p({planetId:n},"planetId","getPlanetEnverotment");if(i=EM.EstateData.GetPlanetLocation(),!i.TextureTypeId)throw p({pl:i},"pl.TextureTypeId","getPlanetEnverotment");return r=b.GetIPlanetEnverotment(i.TextureTypeId),u=r.GetEnverotment(y,t,n),u}function h(n,t){var i=n?1:0;if(n&&t){t===f?u.industrialComplex.visibility=i:t===e?u.spaceShipyard.visibility=i:t===o&&(u.comandCenter.visibility=i);return}_.forEach(v,function(n){var t=s(n);t.visibility=i})}function c(n,t){if(!i){try{var r=w(n,t);r&&(i=r)}catch(u){console.log("setPlanetEnverotment",{e:u});return}return}if(typeof n=="number"&&(i.PlanetId!==n||i.IsVisible!==t)){if(i.PlanetId===n&&i.IsVisible){i.IsVisible=!1;return}i.PlanetId!==n&&i.IsVisible&&(i.IsVisible=!1);i=w(n,t)}}function l(n){var u,t;if(i)u=EM.EstateData.GetCurrentEstate(),t=u.EstateId,t||(n=r.Hide),n===r.In?c(t,!0):n===r.Arround||n===r.Hide&&c(i.PlanetId,!1);else{n===r.In&&(u=EM.EstateData.GetCurrentEstate(),t=u.EstateId,t||(n=r.Hide),c(t,!0));n===r.Hide&&EM.SetVisible(a,!1,!0);h(!1);return}h(!1)}var b=EM.AssetRepository,t=n.IModules(),f="base_industrial_complex",e="base_space_shipyard",o="base_comand_center",a="base_parent",v=[f,e,o],y,u={industrialComplex:null,spaceShipyard:null,comandCenter:null},i,r=t.States;t.IndustrialComplex=f;t.SpaceShipyard=e;t.ComandCenter=o;t.BaseModulesVisible=h;t.BaseParentId=a;t.Modules=v;t.InPlanet=function(){l(r.In)};t.ArroundPlanet=function(){l(r.Arround)};t.HidePlanet=function(){l(r.Hide)};t.BaseVisibleObserverable=null;t.RegistrEvents=function(n){var i=Utils.IPropertyObserverable(n,"isVisible","VisibleObserverable");t.BaseVisibleObserverable=n[i.ObserverablePropertyName];Object.defineProperty(t,"BaseVisibleObserverable",{get:function(){return n[i.ObserverablePropertyName]}});y=i._rootObject;u.industrialComplex=s(f);u.spaceShipyard=s(e);u.comandCenter=s(o);EM.EstateEvents.RegisterBaseIndustrialComplex(u.industrialComplex);EM.EstateEvents.RegisterBaseSpaceShipyard(u.spaceShipyard);EM.EstateEvents.RegisterBaseCommandCenter(u.comandCenter);delete t.RegistrEvents};Object.defineProperty(n,"PlanetModules",{get:function(){return t}})}(EM.EstateGeometry),function(n){function i(n,t){if(f){var i="EstateGeometry.GameModelsInit__{"+n+"}__";t?console.log(i,t):console.log(i)}}function t(n){return u+"."+n}function e(n){return EM.GetMaterial(n)}function r(n,t,i){var u=BABYLON.Mesh.CreateBox(n,.01,EM.Scene),r;return u.isVisible=!1,u.position=i||BABYLON.Vector3.Zero(),r=new BABYLON.ParticleSystem(t,20,EM.Scene),r.particleTexture=EM.CreateTexture(EM.Particle.$getLaserFireTextureUrl()),r.minAngularSpeed=-6,r.maxAngularSpeed=6,r.minSize=1,r.maxSize=1.1,r.minLifeTime=1,r.maxLifeTime=2,r.minEmitPower=0,r.maxEmitPower=0,r.emitter=u,r.minEmitBox=BABYLON.Vector3.Zero(),r.maxEmitBox=BABYLON.Vector3.Zero(),r.gravity=BABYLON.Vector3.Zero(),r.updateSpeed=.02,r.emitRate=10,r.direction1=BABYLON.Vector3.Zero(),r.direction2=BABYLON.Vector3.Zero(),r.color1=new BABYLON.Color3(.1,.7,1),r.color2=new BABYLON.Color3(.1,0,1),r}function o(){function c(n){var i=[],u=6.28,t=1,f=.2,e=16,o=40,r=1.76,s=1*r,h=3*r;return _.forEach(n,function(n){var r;t=t*-1;var a=n.name+".rotation.x",c=_.floor(_.random(0,3,!0),2),l=c*t,v=(u+c)*t;n.scaling.z=n.scaling.y=f;n.rotation.x=l;r=BABYLON.Animation.CreateAndStartAnimation(a,n,"rotation.x",e,o,l,v,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);r.speedRatio=_.random(s,h,!0);i.push(r)}),i}function o(n){n.opacityTexture=n.diffuseTexture;n.opacityTexture.getAlphaFromRGB=!0;n.useSpecularOverAlpha=!1}function l(){function o(n){r.uScale=r.vScale=t.uScale=t.vScale=n}var i={parallaxScaleBias:.1,renderMode:"Bump",bumpLevel:2,specularPower:30,uvScale:10,specularScale:1,bumpTexuteUrl:""},e=u.GetMesh(h),n=e.material,r=n.diffuseTexture,t=n.bumpTexture,f;t.getAlphaFromRGB=!0;t.level=i.bumpLevel;f=r.clone("specular");n.specularTexture=f;n.specularPower=i.specularPower;o(i.uvScale);i.bumpTexuteUrl=t.url}function a(n){n.backFaceCulling=!1;o(n);n.diffuseTexture.level=1.5}function v(n,t){function r(){i.diffuseTexture.uOffset+=.01;i.diffuseTexture.uOffset>=1&&(i.diffuseTexture.uOffset=0)}var i=n.material;i.backFaceCulling=!1;o(i);i.diffuseTexture.level=1;t&&_scene.registerBeforeRender(r)}function y(){function i(t){n.push(r+t+"_cyl_1");n.push(r+t+"_cyl_2");n.push(r+t+"_cyl_3")}var f=u.GetMesh(s),o=[],n=[],r="base_fence_";i("top");i("right");i("down");i("left");_.forEach(n,function(n){o.push(u.GetMesh(n))});a(e(t("base_fence_cyl")));v(f);c(o,f)}function p(){var t=BABYLON.Mesh.CreateBox("base_laser_emmiter",.01,EM.Scene),n;t.position=new BABYLON.Vector3(-4.75,2.5,6.1);t.isVisible=!1;n=new BABYLON.ParticleSystem("base_laser_particle",200,EM.Scene);n.particleTexture=EM.CreateTexture(EM.Particle.$getLaserFireTextureUrl(),EM.Scene);n.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE;n.minAngularSpeed=-1;n.maxAngularSpeed=1;n.minSize=1;n.maxSize=1;n.minLifeTime=5;n.maxLifeTime=5;n.minEmitPower=.01;n.maxEmitPower=.01;n.emitter=t;n.minEmitBox=BABYLON.Vector3.Zero();n.maxEmitBox=BABYLON.Vector3.Zero();n.gravity=BABYLON.Vector3.Zero();n.gravity.y=1;n.updateSpeed=.05;n.emitRate=40;n.direction1=BABYLON.Vector3.Zero();n.direction2=BABYLON.Vector3.Zero();n.color1=new BABYLON.Color3(.1,.1,1);n.color2=new BABYLON.Color3(.2,.1,1);EM.EstateGeometry.PlanetModules.BaseVisibleObserverable.add(function(t){t.PropertyInfo.NewValue?n.start():n.stop()})}function w(){var n=r("base_core_emmiter","base_core_parricle",new BABYLON.Vector3(.05,2.4,3.65));EM.EstateGeometry.PlanetModules.BaseVisibleObserverable.add(function(t){t.PropertyInfo.NewValue?n.start():n.stop()})}var s="base_fence_body",h="base_floor_gexa",u=n.PlanetModules,f=u.GetMesh(u.BaseParentId);f.isPickable=!1;EM.SetVisibleByMesh(f,!1,!0);u.RegistrEvents(f);l();y();p();w();i("planetFactory done")}function s(){var l=BABYLON.Vector3.One().scale(6),u=n.MotherModules,f=u.GetMesh(u.EstateMotherGroupId),h=u.GetMesh(u.MotherCoreId),e,c,s,o;h&&h.dispose();e=r(u.MotherCoreId,"mother_core_particle",new BABYLON.Vector3(0,-.13,.46));e.emitter.parent=f;Object.defineProperty(e.emitter,"isVisible",{value:!1,enumerable:!0,configurable:!1,writable:!1});e.maxSize=1.4;e.emitRate=15;c=[t("mother_windows"),t("mother_detail_3"),t("mother_detail_2"),t("mother_detail_1"),t("mother_hull_5")];_.forEach(c,function(n){var t=EM.Scene.getMaterialByID(n);t.emissiveTexture.level=3;t.emissiveTexture.useEmissiveAsIllumination=!0});f.scaling=l;u.RegistrEvents();s=Utils.IPropertyObserverable(f,"isVisible","VisibleObserverable");f.VisibleObserverable=f[s.ObserverablePropertyName];Object.defineProperty(u,"MotherVisibleObserverable",{get:function(){return f[s.ObserverablePropertyName]}});o=new BABYLON.PointLight("MotherLight",new BABYLON.Vector3.Zero,EM.Scene);o.position=new BABYLON.Vector3.Zero;o.position.y=5;o.parent=f;o.intensity=.5;e.start();f.VisibleObserverable.add(function(n){n.PropertyInfo.NewValue?(o.intensity=.5,e.start()):(o.intensity=0,e.stop())});i("mother done")}function h(t){!1&&i("showMeshNames",{loadedMeshesGroup:t});o();s();delete n.GameModelsInit}var u="game_models",f=!1;Object.defineProperty(n,"GameModelsInit",{get:function(){return h}})}(EM.EstateGeometry);EM.EstateEvents={},function(n){!0&&(n.InitSceneEvents=function(){EM.Scene.onPointerUp||(EM.Scene.onPointerUp=function(n,t){var i=t.pickedMesh.id;console.log("EM.Scene.onPointerUp",{targetName:i,evt:n});EM.SceneIsMoved=!1},EM.Scene.onPointerDown=function(n,t){EM.SceneIsMoved=!1;var i=t.pickedMesh.id;console.log("EM.Scene.onPointerDown",{targetName:i,evt:n})},EM.Scene.onPointerMove=function(n,t){t.pickedMesh==null&&(EM.SceneIsMoved=!1);EM.SceneIsMoved=!0})})}(EM.EstateEvents),function(n){function t(n,t){t()}function i(n,t,i,r,u){if(!n)throw new Error("registerFactoryAction: mesh not exist");n.actionManager&&n.actionManager.dispose();n.actionManager=new BABYLON.ActionManager(EM.Scene);t&&n.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,t.bind(n.actionManager,n)));u&&n.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnDoublePickTrigger,u.bind(n.actionManager,n)));i&&n.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,i.bind(n.actionManager,n)));r&&n.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger,r.bind(n.actionManager,n)))}n.MeshClick=t;n.RegisterFactoryAction=i;n.RemoveActionFromMesh=function(n,t){n&&!n.actionManager&&n.actionManager.actions.length&&_.remove(n.actionManager.actions,function(n){return n.trigger===t})};n.GetOrCreateActionManagerFromMesh=function(n){if(!n)throw new Error("registerFactoryAction: mesh not exist");return n.actionManager||(n.actionManager=new BABYLON.ActionManager(EM.Scene)),n.actionManager};n.AddExecuteCodeAction=function(t,i,r){var u=n.GetOrCreateActionManagerFromMesh(t);n.RemoveActionFromMesh(t,i);u.registerAction(new BABYLON.ExecuteCodeAction(i,r.bind(t.actionManager,t)))}}(EM.EstateEvents),function(n){function f(){r("MotherIndustrialComplexClick",GameServices.buildReqHelper.getMotherIndustrialComplexList)}function e(){t.SetMotherModulesVisible(!0,t.MotherIndustrialComplex)}function o(){r("MotherLaboratoryClick",GameServices.buildReqHelper.getMotherLaboratoryList)}function s(){t.SetMotherModulesVisible(!0,t.MotherResearch)}function h(){r("MotherSpaceShipyardClick",GameServices.buildReqHelper.getMotherSpaceShipyardList)}function c(){t.SetMotherModulesVisible(!0,t.MotherSpaceShipyard)}function i(){t.SetMotherModulesVisible(!1)}function l(){var n=new EM.SpaceState.SpacePosition;n.clickByMother(EM.EstateGeometry.MotherModules.EstateMotherGroupId)}function a(n){u(n,f,e,i)}function v(n){u(n,o,s,i)}function y(n){u(n,h,c,i)}function p(t){var i=n.GetOrCreateActionManagerFromMesh(t);i.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,n.MotherCapsuleClick.bind(t.actionManager,t)))}var r=n.MeshClick,u=n.RegisterFactoryAction,t=EM.EstateGeometry.MotherModules;n.MotherIndustrialComplexClick=f;n.MotherIndustrialComplexHovered=e;n.MotherLaboratoryClick=o;n.MotherLaboratoryHovered=s;n.MotherSpaceShipyardClick=h;n.MotherSpaceShipyardHovered=c;n.MotherModulesUnHovered=i;n.MotherCapsuleClick=l;n.RegisterMotherIndustrialComplex=a;n.RegisterMotherResearch=v;n.RegisterMotherSpaceShipyard=y;n.RegisterMotherCapsule=p}(EM.EstateEvents),function(n){function f(){r("buildIcc",GameServices.buildReqHelper.getIndustrialComplexList)}function e(){t.BaseModulesVisible(!0,t.IndustrialComplex)}function o(){r("buildSpaceShipyard",GameServices.buildReqHelper.getSpaceShipyardList)}function s(){t.BaseModulesVisible(!0,t.SpaceShipyard)}function h(){r("buildCommandCenter",GameServices.buildReqHelper.getCommandCenterList)}function c(){t.BaseModulesVisible(!0,t.ComandCenter)}function i(){t.BaseModulesVisible(!1)}function l(n){u(n,f,e,i)}function a(n){u(n,o,s,i)}function v(n){u(n,h,c,i)}var r=n.MeshClick,u=n.RegisterFactoryAction,t=EM.EstateGeometry.PlanetModules;n.BaseIndustrialComplexClick=f;n.BaseIndustrialComplexHovered=e;n.BaseSpaceShipyardClick=o;n.BaseSpaceShipyardHovered=s;n.BaseCommandCenterClick=h;n.BaseCommandCenterHovered=c;n.BaseModulesUnHovered=i;n.RegisterBaseIndustrialComplex=l;n.RegisterBaseSpaceShipyard=a;n.RegisterBaseCommandCenter=v}(EM.EstateEvents);EM.EstateData={IndustrialComplex:null,SpaceShipyard:null,Laboratory:null,CommandCenter:null,GetCurrentEstate:null,GetCurrentSpaceLocation:null,GetMotherLocation:null,GetPlanetLocation:null,SaveCurrentEstateByEsateType:null,SavePlanetLocationFromData:null,SaveMotherLocationFromData:null,SaveCurrentSpaceLocation:null,UpdateCurrentFromSource:null,SetSpaceLocationFromGalaxyId:null,SetSpaceLocationFromSectorId:null,SetSpaceLocationFromSystemId:null,SetSpaceLocationFromPlanetId:null,SetSpaceLocationFromMoonId:null},function(n,t){function v(n,t,i,r){return{GalaxyId:typeof n=="number"?n:null,SectorId:typeof t=="number"?t:null,SystemId:typeof i=="number"?i:null,TextureTypeId:typeof r=="number"?r:null}}function k(n,t,i,r,u,f){var e=v(n,t,i,r);return e.EstateType=typeof u=="boolean"?u:null,e.EstateId=typeof f=="number"?f:null,e}function h(n,t,i,r,u,f){var e=v(n,t,i,r);return e.SpaceObjectId=typeof u=="number"?u:null,e.MapTypeName=typeof f=="string"?f:null,e}function y(n,t,i,r,u,f,e){var o=v(n,t,i,r);return o.StartTime=typeof f=="number"?f:null,o.EndTime=typeof e=="number"?e:null,o.IsMoving=u&&e?!0:!1,o.TargetSystemId=u,o}function d(n,t,i,r,u){var f=v(n,t,i,r);return f.PlanetId=typeof u=="number"?u:null,f}function rt(){return e}function ut(){return f}function ft(){return r}function et(){return u}function p(n,t,i,r,u,f){e.GalaxyId=n;e.SectorId=t;e.SystemId=i;e.EstateType=u;e.EstateId=f;e.TextureTypeId=r}function ot(n){u=n}function g(n){r=n}function st(n){e=n}function l(n){f=n}function c(n,t,i,r,u,e){f.GalaxyId=n;f.SectorId=t;f.SystemId=i;f.SpaceObjectId=r;f.TextureTypeId=u;f.MapTypeName=e}function nt(n){var t=n[i.Galaxy],r=n[i.Sector],u=n[i.System],f=n[i.TextureTypeId],e=n[i.OwnId];ot(d(t,r,u,f,e));p(t,r,u,f,w,e);c(t,r,u,e,f,EM.MapGeometry.MapTypes.Planet)}function ht(n,t,i){g(y(r.GalaxyId,r.SectorId,r.SystemId,o,n,t,i))}function b(n,t,r,u){var f=n[i.Galaxy],e=n[i.Sector],o=n[i.System],s=n[i.TextureTypeId];g(y(f,e,o,s,t,r,u))}function tt(n,t,r,u){var f=n[i.Galaxy],e=n[i.Sector],h=n[i.System],l=n[i.TextureTypeId];b(n,t,r,u);p(f,e,h,l,a,s);c(f,e,h,s,o,EM.MapGeometry.MapTypes.Mother)}function ct(n){n?(p(u.GalaxyId,u.SectorId,u.SystemId,u.TextureTypeId,w,planetId),c(u.GalaxyId,u.SectorId,u.SystemId,u.PlanetId,u.TextureTypeId,EM.MapGeometry.MapTypes.Planet)):(p(r.GalaxyId,r.SectorId,r.SystemId,r.TextureTypeId,a,s),c(r.GalaxyId,r.SectorId,r.SystemId,s,o,EM.MapGeometry.MapTypes.Mother))}function lt(n,t,i){var r=GameServices.estateService.getEstateItem(0);r.Galaxy=n;r.Sector=t;r.System=i;GameServices.estateService.addEstateItem(r);b(r);e.EstateType===a&&c(n,t,i,s,o,EM.MapGeometry.MapTypes.Mother);f.SystemId!==i||typeof f.SpaceObjectId=="number"||c(n,t,i,s,o,EM.MapGeometry.MapTypes.Mother)}function at(n,t,i,r,u){n?nt(GameServices.estateService.getEstateItem(t)):tt(GameServices.estateService.getEstateItem(t||0),i,r,u)}function vt(t){var i=null,r;return n.Sectors&&(r=t-1,i=n.Sectors[r],i.Id!==t&&(i=_.find(n.Sectors,function(n){return n.Id===t}))),i}function it(t){var i=null;return n.System&&n.System.Stars&&n.System.Stars[t]?n.System.Stars[t]:(n.Systems&&(i=_.find(n.Systems,function(n){return n.Id===t})),i)}function yt(t){var i=null;return n.System&&n.System.Planets&&(i=_.find(n.System.Planets,function(n){return n.Id===t})),i}function pt(t){var i=null;return n.System&&n.System.Moons&&(i=_.find(n.System.Moons,function(n){return n.Id===t})),i}function wt(n){var t=n,i=h(n,null,null,t,n,EM.MapGeometry.MapTypes.Galaxy);l(i)}function bt(n){var t=vt(n),i;t?(i=h(t.GalaxyId,n,null,t.TextureTypeId,n,EM.MapGeometry.MapTypes.Sector),l(i)):console.log("setSpaceLocationFromSectorId data not exist")}function kt(n){var t=it(n),i;t?(i=h(t.GalaxyId,t.SectorId,n,t.TextureTypeId,n,EM.MapGeometry.MapTypes.Star),l(i)):console.log("setSpaceLocationFromSystemId data not exist")}function dt(n){var t=yt(n),i;t?(i=h(t.GalaxyId,t.SectorId,t.SystemId,t.TextureTypeId,n,EM.MapGeometry.MapTypes.Planet),l(i)):console.log("setSpaceLocationFromSystemId data not exist")}function gt(n){var t=pt(n),i;t?(i=h(t.GalaxyId,t.SectorId,t.SystemId,t.TextureTypeId,n,EM.MapGeometry.MapTypes.Moon),l(i)):console.log("setSpaceLocationFromSystemId data not exist")}var i=Utils.RepoKeys.EstateListKeys,o=2e3,s=0,a=!1,w=!0;t.CreateBaseLocationModel=v;t.CreateCurrentEstateModel=k;t.CreateCurrentSpaceLocationModel=h;t.CreateMotherLocationModel=y;var e=k(null,null,null,o,a,s),f=h(null,null,null,o,EM.MapGeometry.MapTypes.Mother),r=y(),u=d();t.GetCurrentEstate=rt;t.GetCurrentSpaceLocation=ut;t.GetMotherLocation=ft;t.GetPlanetLocation=et;t.SetCurrentEstateFromModel=st;t.SetCurrentLocationFromModel=l;t.SaveCurrentSpaceLocation=c;t.SavePlanetLocationFromData=nt;t.SaveMotherLocationFromData=tt;t.SaveMotherSpaceLocationFromData=b;t.SetMotherJump=ht;t.UpdateMotherDataLocation=lt;t.UpdateCurrentFromSource=ct;t.SaveCurrentEstateByEsateType=at;t.SetSpaceLocationFromGalaxyId=wt;t.SetSpaceLocationFromSectorId=bt;t.SetSpaceLocationFromSystemId=kt;t.SetSpaceLocationFromPlanetId=dt;t.SetSpaceLocationFromMoonId=gt;t.GetLocalDataSystem=it;t.PlanetEstateType=w;t.MotherEstateType=a}(EM.MapData,EM.EstateData);EM.GameLoader={},function(n){function e(){"use strict";function s(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}function r(n,t){return(t||0)+(Math.random()-.5)*n*2}function v(n,t){var u=document.createElement("canvas"),f=u.getContext("2d"),i;u.width=n;u.height=t;var e=f.getImageData(0,0,n,t),r=e.data,o=r.length;for(i=0;i<o;i+=4)r[i]=Math.random()*255,r[i+1]=Math.random()*255,r[i+2]=Math.random()*255,r[i+3]=255;return f.putImageData(e,0,0),u}function y(n,t,i){var f=document.createElement("canvas"),r=f.getContext("2d"),u,e;for(f.width=n,f.height=t,r.fillStyle="black",r.fillRect(0,0,n,t),r.globalAlpha=1/i,r.globalCompositeOperation="lighter",u=0;u<i;u++)e=v(n>>u,t>>u),r.drawImage(e,0,0,n,t);return f}var t={},c=$("#scene-loader-progress"),o=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),i=_,h=i.random,k=i.range,f=i.times,l=i.assign,a=window.Float32Array||Array,n={maxAge:20,exposure:.1,damping:.1,noise:1,fuzz:5,intensity:2,vx:10,vy:10,spawn:5,octaves:7,color:{r:25,g:100,b:75},width:window.innerWidth,height:window.innerHeight,sppedX:12,x:0,y:0};n.x=n.width*.5;n.y=n.height*.5;var p=function(){function t(i){var r=this;s(this,t);l(this,n,i);this.canvas=document.createElement("canvas");this.canvas.width=this.width;this.canvas.height=this.height;this.ctx=this.canvas.getContext("2d");this.noiseData=this.noiseCanvas.getContext("2d").getImageData(0,0,this.width,this.height).data;this.particles=[];this.ctx.fillStyle="black";this.ctx.fillRect(0,0,this.width,this.height);this.imgdata=this.ctx.getImageData(0,0,this.width,this.height);this.data=this.imgdata.data;this.ctx.clearRect(0,0,this.width,this.height);this.hdrdata=new a(this.data.length);f(this.noiseData.length,function(n){r.hdrdata[n]=0});this.velocity={x:h(-.5,.5,!0),y:h(-.5,.5,!0)};this.update=this.update.bind(this)}return o(t,[{key:"tonemap",value:function(n){return(1-Math.pow(2,-n*.005*this.exposure))*255}},{key:"getNoise",value:function(n,t,i){return this.noiseData[(~~n+~~t*this.width)*4+i]/127-1}},{key:"update",value:function(){var n=this,u;if(!(this.x<0)&&!(this.x>this.width)&&!(this.y<0)&&!(this.y>this.height)){this.x+=this.velocity.x;this.y+=this.velocity.y;var h=this.x,c=this.y,l=this.vx,a=this.vy,v=this.width,d=this.height,t=this.color,y=this.maxAge,e=this.damping,o=this.noise,s=this.fuzz,i=this.intensity,p=this.spawn,w=t.r,b=t.g,k=t.b;f(p,function(){n.particles.push({vx:r(l),vy:r(a),x:h,y:c,age:0})});u=[];this.particles.forEach(function(t){t.vx=t.vx*e+n.getNoise(t.x,t.y,0)*4*o+r(.1)*s;t.vy=t.vy*e+n.getNoise(t.x,t.y,1)*4*o+r(.1)*s;t.age++;f(10,function(){t.x+=t.vx*.1;t.y+=t.vy*.1;var r=(~~t.x+~~t.y*v)*4;n.data[r]=n.tonemap(n.hdrdata[r]+=w*i);n.data[r+1]=n.tonemap(n.hdrdata[r+1]+=b*i);n.data[r+2]=n.tonemap(n.hdrdata[r+2]+=k*i)});t.age<y&&u.push(t)});this.ctx.putImageData(this.imgdata,0,0);this.particles=u}}}]),t}(),e=void 0,w=function(){function t(i){s(this,t);var r=i,f=n.width,e=n.height;r.width=f;r.height=e;var o=r.getContext("2d"),h=r.height*.5,c=y(f,e,n.octaves),u=new p({name:"left",maxAge:100,width:r.width,height:r.height,damping:.75,exposure:.05,intensity:n.intensity,noiseCanvas:c});u.x=0;u.y=h;u.velocity.x=n.sppedX;u.velocity.y=0;this.canvas=r;this.ctx=o;this.emitters=[u];this.update=this.update.bind(this);this.loop=this.loop.bind(this);this.loop()}return o(t,[{key:"update",value:function(){var i=this,n=this.ctx,t=this.canvas;n.globalCompositeOperation="normal";n.fillStyle="rgba(5, 15, 16, 1.00)";n.fillRect(0,0,t.width,t.height);this.emitters.forEach(function(n){n.update();i.ctx.drawImage(n.canvas,0,0);n.ctx.restore()})}},{key:"loop",value:function(){this.update();e=requestAnimationFrame(this.loop)}},{key:"stop",value:function(){e&&(window.cancelAnimationFrame(e),this.ctx.restore(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height))}}]),t}();u=new w(document.getElementById("demo"))}function o(){$(EM.EstateContainerId).prepend(EM.Canvas);EM.Engine.resize();var n=$(f);n.css("opacity",0);setTimeout(function(){u.stop();n.addClass("display-none");$("#scene-loader").remove();EM.GameLoader=null;delete EM.GameLoader},2e3)}function s(u){EM.SubscribeName===u&&(t=!0);t&&(t=!1,EM.Observer.Unsubscribe(n));"LoadMeshes"===u&&(i=!0);i&&r&&(EM.StartRender(),GameServices.mapControlHelper.jumpToMother(null,null,null,null,!0),i=!1,r=!1);"MotherJumped"===u&&o()}var f="#scene-loader",t=!1,i=!1,r=!0,u;n.Update=s;n.Load=function(t){var i=angular.element("#Game").scope();i.gameCtrl.loadGame(t);EM.Observer.Subscribe(n);EM.CreateScene(t,GameServices.mainGameHubService)};n.loadAnimation=e}(EM.GameLoader);