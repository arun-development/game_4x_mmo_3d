(function(n){"use strict";n.directive("jsonCombiner",[function(){return{restrict:"A",scope:{saveData:"=",jsonCombiner:"@"},link:function(n){n.saveData(JSON.parse(n.jsonCombiner))}}}]);n.service("compileHelper",["$compile","$rootScope",function(n,t){this.$compileItem=function(i){return n(i)(t.$new())};this.$appendHtml=function(n,t){$(n).append(this.$compileItem(t))};this.$replaceWith=function(n,t){$(n).replaceWith(this.$compileItem(t))}}]);n.service("chestService",["$q",function(n){function i(){this.Account=null;this.Premium=null;this.Booster=null;this.Skins=null;this.Cc=null}var t=this;this.CHEST_KEY="UserChest";this.$userChestData=null;this.getProductType=function(){};this.$defaultError=function(n){var t=Errors.GetMessage(n);console.log("errorAnswer",{errorAnswer:n,msg:t})};this.updateChestFromServer=function(i){var r=n.defer();$.ajax({url:"/api/userChest/init/",headers:Utils.XSRF.HeadersGetApiTokenObj(),method:"GET",type:"json"}).then(r.resolve,r.reject);r.promise.then(function(n){t.$setInitChestData(n);i instanceof Function&&i(t.$userChestData)},t.$defaultError)};this.$rebuildChestData=function(n){return t.$userChestData?Utils.UpdateObjData(t.$userChestData,n):t.$userChestData=n,t.$userChestData};this.cleanChestData=function(){t.$userChestData=null};this.getUserChestData=function(){return t.$userChestData||console.log("!$self.$userChestData chest data nit exist",{$self:t}),t.$userChestData};i.prototype.getKeys=function(){return Object.keys(this)};this.ProductTypes=function(){function f(n,t,i){this.LangSimpleProps=i;_.extend(this,Utils.ModelFactory.INameIdModel(n,t))}function e(){}function s(n,t,i){var r=this;this.NativeName=n;this.LangSimple=t;this.setKVConverter(function(n){var t=i?i(n):n;return Utils.ModelFactory.KeyVal(r.LangSimple.getCurrent(),t)})}function n(n,t,i,r){n[t]=new s(t,i,r)}var r,o,h,c;f.prototype.convertToKv=function(n){return this.LangSimpleProps&&this.LangSimpleProps.convertToKv?this.LangSimpleProps.convertToKv(n):[]};e.prototype.convertToKv=function(n){var t=[];return n?(_.forEach(this,function(i,r){console.log("IPropertyes",{val:i,nativeName:r,properties:n,"properties[nativeName]":n[r],"val.convertToKv":i.convertToKv,"val.convertToKv(properties[nativeName])":i.convertToKv(n[r]),"typeof properties[nativeName]":typeof n[r]});i.convertToKv&&n[r]&&typeof n[r]!="object"&&t.push(i.convertToKv(n[r]))}),t):t};s.prototype.setKVConverter=function(n){this.convertToKv=n};var t=Utils.LangSimple,u=new i,l=new e;return u.Account=new f(1,"Account",l),r=new e,n(r,"Duration",t("EN Duration","ES Duration","RU Duration"),Utils.Time.Seconds2Time),n(r,"PremiumBookmarkMod",t("EN PremiumBookmarkMod","ES PremiumBookmarkMod","RU PremiumBookmarkMod"),function(n){return n}),n(r,"PremiumNavigationMod",t("EN PremiumBookmarkMod","ES PremiumBookmarkMod","RU PremiumBookmarkMod"),function(n){return n}),n(r,"ResourseMaxStorable",t("EN ResourseMaxStorable","ES ResourseMaxStorable","RU ResourseMaxStorable"),function(n){return n}),n(r,"ResourseProduction",t("EN ResourseProduction","ES ResourseProduction","RU ResourseProduction"),function(n){return n}),n(r,"TimeBuildUpdate",t("EN TimeBuildUpdate","ES TimeBuildUpdate","RU TimeBuildUpdate"),function(n){return n}),n(r,"TimeUnitProduction",t("EN TimeUnitProduction","ES TimeUnitProduction","RU TimeUnitProduction"),function(n){return n}),u.Premium=new f(2,"Premium",r,function(n){return n}),o=new e,n(o,"Duration",t("EN Duration","ES Duration","RU Duration"),Utils.Time.Seconds2Time),n(o,"Attack",t("EN Attack","ES Attack","RU Attack"),function(n){return n}),n(o,"Hp",t("EN Hp","ES Hp","RU Hp"),function(n){return n}),u.Booster=new f(3,"Booster",o),h=new e,u.Skins=new f(4,"Skins",h),c=new e,u.Cc=new f(5,"Cc",c),Utils.FreezeDeep(u),u}();this.$getTypeByTypeId=function(n){return _.find(t.ProductTypes,function(t){return t.Id===n})};this.createChestItemKVPropertiesView=function(n){var i=t.$getTypeByTypeId(n.ProductTypeId);return i&&i.convertToKv?i.convertToKv(n.ProductItemProperty.Property):[]};this.getActiveDataByTypeId=function(n){var i=t.getUserChestData();return!i||!i.ActivatedItemsView?null:_.find(i.ActivatedItemsView,function(t){return t.ProductTypeId===n})};this.getBalanceCcModel=function(){var n=t.getActiveDataByTypeId(t.ProductTypes.Cc.Id);return!n||!n.Data?null:n.Data.BalanceCc};this.getPremiumModel=function(){var n=t.getActiveDataByTypeId(t.ProductTypes.Premium.Id);return!n||!n.Data?null:n.Data.Premium}}]);n.service("pageHelper",[function(){console.log("pageHelper",this);this.pageName=$("body").data("page-name");this.pageNames={home:"start-page",store:"store-page",account:"account-page",manage:"manage-page",adminStore:"admin-store-page"};this.isPage=function(n){return this.pageName?this.pageName===n:!1};this.$homeInitialized=!1;this.initHome=function(){!this.$homeInitialized&&this.isPage(this.pageNames.home)&&(HomeScroller.Init(),HomeResaizer(),Utils.Response.HomeVideo.Init(),HomeCarousel(),$("iframe").youtubeControl(),this.$homeInitialized=!0)};this.isOtherPage=function(){var i=this.pageNames,t=this.pageName,n;return t?(n=!0,_.forEach(i,function(i){if(i===t)return n=!1,!1}),n):!0};this.isPage(this.pageNames.home)&&this.initHome()}]);n.service("appVarsSerivce",["$rootScope",function(n){this._data=null;this.save=function(n){return this._data=this._data!==null?_.extend(this._data,n):n,this};this.getVars=function(){var n=this._data;return console.log("getVars",{data:n}),this._data};this.add=function(n,t){return n?(this._data===null&&(this._data={}),this._data[n]=t,this):this};this.remove=function(n){if(this._data&&this._data[n])return this._data[n]=null,delete this._data[n],this};this.update=function(t){return Utils.UpdateObjData(this._data,t),n.$broadcast("appVarsSerivce:update",{appVars:this._data}),this}}]);n.directive("appVars",["appVarsSerivce",function(n){return{restrict:"A",scope:{appVars:"@"},link:function(t,i){n.save(JSON.parse(t.appVars));i.remove();console.log("appVars saved",{$scope:t})}}}])})(angular.module("angularAppCommon",[]));angular.module("angular-medium-editor",[]).directive("mediumEditor",function(){"use strict";function t(n){var t=document.createElement("div"),i;return t.innerHTML=n,i=t.textContent||"",i.trim()}function n(n,t,i,r){angular.element(t).addClass("angular-medium-editor");r.editor=new MediumEditor(t,n.bindOptions);r.$render=function(){r.editor.setContent(r.$viewValue||"");var n=r.editor.getExtensionByName("placeholder");n&&n.updatePlaceholder(t[0])};r.editor.subscribe("editableInput",function(n,t){r.$setViewValue(t.innerHTML.trim())})}return{require:"ngModel",restrict:"AE",scope:{bindOptions:"="},link:function(i,r,u,f){n(i,r,u,f);f.$isEmpty=function(n){return/[<>]/.test(n)?t(n).length===0:n?n.length===0:!0};i.$on("mediumEditor:update-option",function(t,e){f.editor.destroy();i.bindOptions=e;n(i,r,u,f)});i.$watch("bindOptions",function(n){f.editor.init(r,n)});i.$on("$destroy",function(){f.editor.destroy()})}}});Utils.CoreApp.gameAppExtensions={HubAlliance:null,HubBookmark:null,HubPersonalInfo:null,HubWorld:null,HubEstate:null,HubJournal:null,HubUserChannels:null,HubConfederation:null,ConfederationOfficers:null,ConfederationElection:null,ConfederationRating:null,UserChannelsAlliance:null,UserChannelsGroup:null,UserChannelsPrivate:null};Utils.CoreApp.gameAppExtensions.HubAlliance=function(n,t,i,r,u){n.requestAllianceFromAllianceManageAddMessage=function(n){return i.requestAllianceFromAllianceManageAddMessage(n)};t.requestAllianceAddMessageToAllianceManage=function(t){n._checkCurrentUser();r.addNewRequetToAllianceManage(t);console.log("otherOnRequestAllianceManageAddMessage",t)};n.requestAllianceFromMyAllianceAddMessage=function(n){return i.requestAllianceFromMyAllianceAddMessage(n)};t.requestAllianceAddMessageToMyAlliance=function(t){n._checkCurrentUser();r.addNewRequetToMyAlliance(t);console.log("requestAllianceAddMessageToMyAlliance",t)};n.requestAllianceDeleteRequestForUserToAlliance=function(n){return i.requestAllianceDeleteRequestForUserToAlliance(n)};t.onRequestAllianceDeleteRequestForUserToAlliance=function(t){n._checkCurrentUser();r.deleteRequestHistoryFromAllianceManage(t)};n.requestAllianceConfirmAcceptFromAllianceManage=function(n){return i.requestAllianceConfirmAcceptFromAllianceManage(n)};t.onRequestAllianceConfirmAcceptFromAllianceManage=function(t,i){n._checkCurrentUser();r.onRequestAllianceConfirmAcceptFromAllianceManage(t,i)};t.onDeleteAllianceRequestsByManager=function(t,i){n._checkCurrentUser();r.onDeleteAllianceRequestsByManager(t,i)};n.requestAllianceRejectRequestToAlliance=function(n){return console.log("rejectRequestToAlliance",n),i.requestAllianceRejectRequestToAlliance(n)};t.onRequestAllianceRejectRequestToAlliance=function(t,i,u){n._checkCurrentUser();r.onRequestAllianceRejectRequestToAlliance(t,i,u)};n.requestAllianceAcceptJoinUserToAlliance=function(n){return i.requestAllianceAcceptJoinUserToAlliance(n)};t.allianceAddNewUserToAlliane=function(t){n._checkCurrentUser();r.allianceAddNewUserToAlliane(t,u)};t.allianceAddNewUsersToAlliane=function(t){n._checkCurrentUser();r.allianceAddNewUsersToAlliane(t,u)};n.allianceLeaveFromUserAlliance=function(){return i.allianceLeaveFromUserAlliance()};t.onAllianceUserLeftAlliance=function(t,i){n._checkCurrentUser();r.onAllianceUserLeftAlliance(t,i,u)};n.allianceDisbandAlliance=function(){return i.allianceDisbandAlliance()};t.onAllianceDisbanded=function(t,i,u){if(n._checkCurrentUser(),i)if(console.log("client.onAllianceDisbanded.is newConnectionUser"),n._currentUser.UserId===i.UserId){n._updateCurrentUser(i);console.log("client.onAllianceDisbanded.allianceService",r);r.onAllianceDisbanded(t,n._currentUser,u)}else throw new Error("mainGameHubService.client.onAllianceDisbanded.isAllianceGroup");else{console.log("client.onAllianceDisbanded is other newConnectionUser");r.onAllianceDisbanded(t)}};n.allianceCheckAllianceNameIsUnic=function(n){return i.allianceCheckAllianceNameIsUnic(n)};n.allianceCreateAlliance=function(n){return i.allianceCreateAlliance(n)};t.onAllianceCreateAlliance=function(t,i){n._checkCurrentUser();r.addAllianceNameToLocal({Id:t,Name:i})};n.allianceGetAllActiveAllianceNames=function(){return i.allianceGetAllActiveAllianceNames()};n.allianceGetAllianceNamesByPartName=function(n){return i.allianceGetAllianceNamesByPartName(n)};n.allianceGetAllianceItemById=function(n,t){return i.allianceGetAllianceItemById(n,t)};n.allianceGetAllianceItemByMinRating=function(n,t){return i.allianceGetAllianceItemByMinRating(n,t)};n.allianceInfoUpdateLabel=function(n){return i.allianceInfoUpdateLabel(n)};t.onAllianceInfoUpdateLabel=function(n,t){r.onAllianceInfoUpdateLabel(n,t)};n.allianceInfoUpdateDescription=function(n){return i.allianceInfoUpdateDescription(n)};t.onAllianceInfoUpdateDescription=function(n,t){r.onAllianceInfoUpdateDescription(n,t)};n.allianceInfoUpdateTax=function(n){return i.allianceInfoUpdateTax(n)};t.onAllianceInfoUpdateTax=function(n,t){r.onAllianceInfoUpdateTax(n,t)};n.allianceDropUserFromAlliance=function(n){return i.allianceDropUserFromAlliance(n)};t.onAllianceUserDroped=function(t,i,u,f,e){if(n._checkCurrentUser(),i){n._updateCurrentUser(i);r.onAllianceUserDroped(t,n._currentUser,u);n.$onUserChannelsUserChangeAlliance(f,e)}else throw Errors.ClientNotImplementedException({args:arguments,"hubService._currentUser":n._currentUser},"mainGameHubService.client.onAllianceUserDroped");};n.allianceUpdateUserRole=function(n,t,r){return i.allianceUpdateUserRole(n,t,r)};t.onAllianceUpdateUserRole=function(t){n._checkCurrentUser();t.$$RootScope=u;t.IsCurrentUser&&n._updateCurrentUser(t.NewCurrentConnectionUser);r.Role.onAllianceUserUpdateRole(t)};n.allianceUpdateAllianceTech=function(n){return i.allianceUpdateAllianceTech(n)};t.onAllianceTechUpdated=function(t,i){n._checkCurrentUser();r.onAllianceTechUpdated(t,i,u)}};Utils.CoreApp.gameAppExtensions.HubBookmark=function(n,t,i){n.bookmarkGetPlanshet=function(){return i.bookmarkGetPlanshet()};n.bookmarkAddBookmark=function(n){return i.bookmarkAddBookmark(n)};n.bookmarkDeleteItem=function(n){return i.bookmarkDeleteItem(n)}};Utils.CoreApp.gameAppExtensions.HubBuild=function(n,t,i){n.buildGetIndustrialComplex=function(n){return i.buildGetIndustrialComplex(n)};n.buildGetCommandCenter=function(n){return i.buildGetCommandCenter(n)};n.buildGetSpaceShipyard=function(n){return i.buildGetSpaceShipyard(n)};n.buildGetMotherIndustrialComplex=function(){return i.buildGetMotherIndustrialComplex()};n.buildGetMotherSpaceShipyard=function(){return i.buildGetMotherSpaceShipyard()};n.buildGetMotherLaboratory=function(){return console.log("hubService.buildGetMotherLaboratory"),i.buildGetMotherLaboratory()};n.buildItemUpgrade=function(n,t){return i.buildItemUpgrade(n,t)};n.buildItemUpgraded=function(n,t){return i.buildItemUpgraded(n,t)};n.buildEnergyConverterExchangeResource=function(n){return i.buildEnergyConverterExchangeResource(n)};n.buildExtractionModuleChangeProportion=function(n){return i.buildExtractionModuleChangeProportion(n)};n.buildExtractionModuleStopProduction=function(n){return i.buildExtractionModuleStopProduction(n)};n.buildExtractionModuleStartProduction=function(n){return i.buildExtractionModuleStartProduction(n)};n.buildSpaceShipyardFixUnitTurn=function(n,t){return i.buildSpaceShipyardFixUnitTurn(n,t)};n.buildSpaceShipyardSetUnitTurn=function(n){return i.buildSpaceShipyardSetUnitTurn(n)};n.buildStorageGetResourcesView=function(n){return i.buildStorageGetResourcesView(n)};n.buildStorageGetStorageResources=function(n){return i.buildStorageGetStorageResources(n)};n.buildStorageDoTransfer=function(n){return i.buildStorageDoTransfer(n)};n.buildLaboratorySetTechTurn=function(n){return i.buildLaboratorySetTechTurn(n)};n.techItemUpgraded=function(n){return i.techItemUpgraded(n)}};Utils.CoreApp.gameAppExtensions.HubConfederation=function(n,t,i,r,u){n.confederationGetPlanshet=function(){return i.confederationGetPlanshet()};t.onConfederationVoitingStarted=function(t){try{n._checkCurrentUser();r.updateCandidates(t,!1,u);console.log("onConfederationVoitingStarted",{activeCandidatesOutList:t})}catch(i){return}};t.onConfederationVoitingFinalized=function(t,i){try{n._checkCurrentUser();r.onVoteFinalize(t,i)}catch(u){return}};n.confederationAddNewOfficer=function(t,r,u){return n._checkCurrentUser(),i.confederationAddNewOfficer(t,r,u)};t.confederationAddOrUpdateOfficer=function(t){try{n._checkCurrentUser();r.addOrUpdateOfficer(t,u)}catch(i){return}};n.confederationRatingGetNextPage=function(n){return i.confederationRatingGetNextPage(n)};n.confederationRatingGetUser=function(n){return i.confederationRatingGetUser(n)};n.confederationAddVote=function(n){return i.confederationAddVote(n)};t.onConfederationCandidatesUpdated=function(t,i){try{n._checkCurrentUser();r.updateCandidates(t,i,u)}catch(f){return}};n.confederationRegistrateCandidate=function(){return i.confederationRegistrateCandidate()}};Utils.CoreApp.gameAppExtensions.HubEstate=function(n,t,i){n.estateGetHangar=function(n){return i.estateGetHangar(n)};n.estateGetEstateList=function(){return i.estateGetEstateList()};n.estateGetEstateItemByPlanetId=function(n){return i.estateGetEstateItemByPlanetId(n)};n.estateGetFullEstate=function(n){return i.estateGetFullEstate(n)}};Utils.CoreApp.gameAppExtensions.HubJournal=function(n,t,i,r){n.journalInitialPlanshet=function(){return i.journalInitialPlanshet()};n.journalCreateTaskItem=function(n){return i.journalCreateTaskItem(n)};t.journalOnTaskCreated=function(t){console.log("journalOnTaskCreated",{newTaskItem:t});try{n._checkCurrentUser();r.onTaskCreated(t)}catch(i){console.log({e:i});return}};t.journalOnTaskFinished=function(t){console.log("journalOnTaskFinished",{notyfyData:t});try{n._checkCurrentUser();r.onTaskFinished(t)}catch(i){console.log({e:i});return}};n.journalGetTaskTime=function(n,t,r){return i.journalGetTaskTime(n,t,r)};n.journalTaskTimeIsOver=function(n){return i.journalTaskTimeIsOver(n)};n.journalGetReportItemByTaskId=function(n){return i.journalGetReportItemByTaskId(n)};n.journalCreateReportItem=function(n){return i.journalCreateReportItem(n)};n.journalGetReportItems=function(n){return i.journalGetReportItems(n)};n.journalDeleteReportItem=function(n){return i.journalDeleteReportItem(n)};n.journalGetSpyItems=function(n){return i.journalGetSpyItems(n)};n.journalCreateSpyItemByPlanetId=function(n){return i.journalCreateSpyItemByPlanetId(n)};n.journalCreateSpyItemByPlanetName=function(n){return i.journalCreateSpyItemByPlanetName(n)};n.journalDeleteSpyItem=function(n){return i.journalDeleteSpyItem(n)};n.journalGetMotherJumpTime=function(n,t){return i.journalGetMotherJumpTime(n,t)};n.journalAddTaskMotherJump=function(n){return i.journalAddTaskMotherJump(n)};n.journalCancelMotherJump=function(n){return i.journalCancelMotherJump(n)};n.journalInstMotherJump=function(n){return i.journalInstMotherJump(n)};n.journalIsMotherJumpTimeDone=function(){return i.journalIsMotherJumpTimeDone()};n.journalRemoveGuid=function(n){return i.journalRemoveGuid(n)}};Utils.CoreApp.gameAppExtensions.HubUserChannels=function(n,t,i,r,u){n.userChannelsGetPlanshet=function(){return i.userChannelsGetPlanshet()};n.userChannelsSendMessage=function(n){return i.userChannelsSendMessage(n)};t.onUserChannelsSended=function(t){n._checkCurrentUser();r.onMessageSended(t,u)};n.userChannelsGetNextMessagesPage=function(n,t,r){return i.userChannelsGetNextMessagesPage(n,t,r)};n.userChannelsCreatePrivateChannel=function(n){return i.userChannelsCreatePrivateChannel(n)};t.onUserChannelsCreatedPrivateChannel=function(t,i){n._checkCurrentUser();i&&n._addHubGroupForCr(i);r.onPrivateChannelCreated(t,u)};n.userChannelsClosePrivateChannel=function(n,t){return i.userChannelsClosePrivateChannel(n,t)};n.userChannelsIsAvailableChannelName=function(n){return i.userChannelsIsAvailableChannelName(n)};n.userChannelsCreateGroupChannel=function(n){return i.userChannelsCreateGroupChannel(n)};n.userChannelsDeleteGroupChannelByOwner=function(n){return i.userChannelsDeleteGroupChannelByOwner(n)};t.userChannelsGroupDropChannel=function(t,i,u){n._checkCurrentUser();u&&n._removeHubGroupForCr(u);r.deleteGroupChannelFromLoclal(t,i)};t.userChannelsRemoveGroupSerchChannelItem=function(t){n._checkCurrentUser();r.removeGroupSerchChannelItem(t)};t.userChannelsAddOrUpdateGroupSerchChannelItem=function(t,i,u){n._checkCurrentUser();r.addOrUpdateGroupSerchChannelItem(t,i,u)};n.userChannelsSerchGroupChannelNames=function(n){return i.userChannelsSerchGroupChannelNames(n)};n.userChannelsJoinToGroupChannel=function(n,t){return i.userChannelsJoinToGroupChannel(n,t)};n.userChannelsUpdatePassword=function(n,t){return i.userChannelsUpdatePassword(n,t)};n.userChannelsUnsubscribeUserFromGroupChannel=function(n){return i.userChannelsUnsubscribeUserFromGroupChannel(n)};t.onUserChannelsGroupUserUnsubscribe=function(t,i){n._checkCurrentUser();r.onGroupUserUnsubscribe(t,i,u)};t.onUserChannelsGroupUserSubscribe=function(t,i){n._checkCurrentUser();r.onGroupUserSubscribe(t,i,u)};n.userChannelsDeepDeleteOtherGroupChannels=function(){return i.userChannelsDeepDeleteOtherGroupChannels()};t.userChannelsAddOrUpdateGroupChannel=function(t,i){n._checkCurrentUser();i&&n._addHubGroupForCr(i);r.addOrReplaceGroupChannelLocal(t)};n.userChannelsGroupUpdateUser=function(n,t,r){return i.userChannelsGroupUpdateUser(n,t,r)};t.onUserChannelsCrUserGroupUpdatedPermition=function(t){if(n._checkCurrentUser(),n._currentUser.UserId===t.UserId)r.onCrUserGroupUpdatedPermition(t,u)};n.userChannelsGroupUploadIcon=function(n,t){return i.userChannelsGroupUploadIcon(n,t)};t.onUserChannelsGroupIconUploaded=function(t,i){n._checkCurrentUser();r.onGroupIconUploaded(t,i,u)};n.$onUserChannelsUserChangeAlliance=function(n,t){r.onUserChangeAlliance(n,t,u)};t.onUserChannelsUserChangeAlliance=function(t,i,r){n._checkCurrentUser();r&&n._updateCurrentUser(r);n.$onUserChannelsUserChangeAlliance(t,i)}};Utils.CoreApp.gameAppExtensions.HubPersonalInfo=function(n,t,i,r,u){n.personalInfoUpdateAvatar=function(n){return i.personalInfoUpdateAvatar(n)};t.onPersonalInfoUserUpdateAvatar=function(n,t,i){r.onUserUpdateAvatar(n,t,i);u.onUserUpdateAvatar(n,t,i);console.log("onPersonalInfoUserUpdateAvatar.data",{newUserImageModel:n,userId:t,allianceId:i})};n.personalInfoUpdateUserDescription=function(n){return i.personalInfoUpdateUserDescription(n)};n.personalInfoGetProfileByUserName=function(n){return i.personalInfoGetProfileByUserName(n)};n.personalInfoGetProfileByUserId=function(n){return i.personalInfoGetProfileByUserId(n)}};Utils.CoreApp.gameAppExtensions.HubWorld=function(n,t,i){n.worldGetSectors=function(){return i.worldGetSectors()};n.worldGetSystems=function(n){return i.worldGetSystems(n)};n.worldGetSystemGeometry=function(n){return i.worldGetSystemGeometry(n)};n.worldGetGalaxyInfo=function(n){return i.worldGetGalaxyInfo(n)};n.worldGetSectorInfo=function(n){return i.worldGetSectorInfo(n)};n.worldGetStarInfo=function(n){return i.worldGetStarInfo(n)};n.worldGetPlanetInfo=function(n){return i.worldGetPlanetInfo(n)};n.worldGetMoonInfo=function(n){return i.worldGetMoonInfo(n)};n.worldSerchPlanetNames=function(n,t){return i.worldSerchPlanetNames(n,t)}};Utils.CoreApp.gameAppExtensions.UserChannelsAlliance=function(n){n.onUserChangeAlliance=function(t,i){n.deleteLocalChannelItem(n.ChannelTypes.Alliance,t);n.addOrReplaceLocalChannelItem(i);console.log("UserChannelsAlliance.onUserChangeAlliance",{service:n})}};Utils.CoreApp.gameAppExtensions.UserChannelsGroup=function(n){function s(n,t){var i=n.toLowerCase();return _.filter(t,function(n){return n.Name.toLowerCase().indexOf(i)!==-1})}function f(n,t,i){var r=n.toLowerCase();return _.filter(t,function(n){return n.IsPublic===i&&n.Name.toLowerCase().indexOf(r)!==-1})}function e(t,r){return t.length===0?i:r===n.ChannelSerchTypes.OnlyPublic?f(t,i,!0):r===n.ChannelSerchTypes.OnlyPrivate?f(t,i,!1):s(t,i)}function h(t){_.forEach(t,function(t){n.addOrUpdateGroupSerchChannelItem(t.Id,t.Name,t.IsPublic)})}function o(){var i=n.$currentUserInfo,t=n.getCollectionByChannelType(n.ChannelTypes.Group);return t?_.find(t,{CreatorId:i.userId}):!1}function u(){var i=0,t=n.Group;return t.Collection&&(i=_.size(t.Collection)),{count:i,max:t.MaxChannelsLimit}}var i={},t=!1,r;n.getGroupLimitModel=u;n.createGroupChannelControls=function(i){var e=n.$btnHelper.ButtonsView(),r,f;return e.ConstructorSizeBtn(3,!0,"Create",function(r,f,e,s,h){var l,c,a;t||(t=!0,l=o(),l?n.$ucdH.openDialogUserHasChannel(h,l.ChannelName).finally(function(){t=!1}):(c=u(),c.count+1>c.max?(a=n.getTabTranslateNameByChannelType(n.bodyIdx.Group),n.$ucdH.openDialogChannelMaxLimit(h,a,c.max).finally(function(){t=!1})):(n.$ucdH.$mdDialog.show({templateUrl:"dialog-channels-group-create-channel.tmpl",parent:angular.element(document.body),targetEvent:h,clickOutsideToClose:!1,fullscreen:!0,controller:"dialogCreateGroupChannelCtrl",controllerAs:"dcgmCtrl"}).then(function(n){n.$destroy();t=!1},function(n){n.$destroy();t=!1}),console.log("createGroupChannelControls.click",{params:r,$scope:s,channelItem:i}))))}),r=n.$btnHelper.ButtonsView(),r.ConstructorSizeBtn(3,!0,"Join",function(i,r,f,e,o){var s,h;t||(t=!0,s=u(),s.count+1>s.max?(h=n.getTabTranslateNameByChannelType(n.bodyIdx.Group),n.$ucdH.openDialogChannelMaxLimit(o,h,s.max).finally(function(){t=!1})):n.$ucdH.$mdDialog.show({templateUrl:"dialog-channels-group-join.tmpl",parent:angular.element(document.body),targetEvent:o,clickOutsideToClose:!1,fullscreen:!0,controller:"dialogChannelsGroupJoinToChannel",controllerAs:"jCtrl"}).then(function(n){n.$destroy();t=!1},function(n){t=!1;n.$destroy()}))}),f=n.$btnHelper.ButtonsView(),f.ConstructorSizeBtn(3,!0,"Delete all",function(i,r,u,f,e){t||(t=!0,n.$ucdH.openDialogDeepDeleteOtherGroupChannels(e).then(function(){n.$hub.userChannelsDeepDeleteOtherGroupChannels().then(function(){var i=o();i?_.forEach(n.Group.Collection,function(t,r){t.ChannelId!==i.ChannelId&&delete n.Group.Collection[r]}):_.forEach(n.Group.Collection,function(t,i){delete n.Group.Collection[i]});t=!1},function(n){var i=Errors.GetHubMessage(n);console.log("userChannelsService.groupSerchChannelItemsFilterAsync",{errorAnswer:n,msg:i});t=!1})},function(){t=!1}))}),{buttons:[e,r,f]}};n.getSerchTypesView=function(){var r=Utils.ModelFactory.INameIdModel(n.ChannelSerchTypes.All),t,i;return r.Translate=Utils.CreateLangSimple("All","Todas","Все"),r.Name=r.Translate.getCurrent(),t=Utils.ModelFactory.INameIdModel(n.ChannelSerchTypes.OnlyPublic),t.Translate=Utils.CreateLangSimple("Public","Abierto","Открытые"),t.Name=t.Translate.getCurrent(),i=Utils.ModelFactory.INameIdModel(n.ChannelSerchTypes.OnlyPrivate),i.Translate=Utils.CreateLangSimple("Protected","Protegido","Защищенныe"),i.Name=i.Translate.getCurrent(),[r,t,i]};n.removeGroupSerchChannelItem=function(n){i[n]&&delete i[n]};n.addOrUpdateGroupSerchChannelItem=function(n,t,r){i[n]=Utils.ModelFactory.IChannelSerchItem(n,t,r)};n.getGroupExistChannelNames=function(){var t=n.Group.Collection;return t?_.map(t,function(n){return n.ChannelName.toLowerCase()}):[]};n.filterGroupByIgnoreNames=function(n,t){return!t||!t.length?n:_.filter(n,function(n){var i=n.Name.toLowerCase(),r=_.includes(t,i);return!r})};n.addOrReplaceGroupChannelLocal=function(t){t.ComplexButtonView.IsNewItem=!0;n.addOrUpdateGroupSerchChannelItem(t.ChannelId,t.ChannelName,t.IsPublic);n.addOrReplaceLocalChannelItem(t)};r=!1;n.groupSerchChannelItemsFilterAsync=function(t,i,u){var f,o;return(t=t.trim(),f=n.$q.defer(),r)?(f.resolve([]),f.promise):!u&&(o=e(t,i),o.length!==0)?(f.resolve({items:o,fromLocal:!0}),f.promise):(r=!0,n.$hub.userChannelsSerchGroupChannelNames(t).finally(function(){r=!1}).then(function(n){console.log("groupSerchChannelItemsFilterAsync.answer",{answer:n});h(n);o=e(t,i);f.resolve({items:o,fromLocal:!1})},function(n){var i=Errors.GetHubMessage(n);f.reject(n,i);console.log("userChannelsService.groupSerchChannelItemsFilterAsync",{queryName:t,errorAnswer:n,msg:i})}),f.promise)};n.createGroupChannel=function(t,i,r){n.$hub.userChannelsCreateGroupChannel(t).then(function(t){n.addOrReplaceGroupChannelLocal(t);i instanceof Function&&i()},r)};n.$deleteGroupChannelByOwner=function(t,i,r){n.$hub.userChannelsDeleteGroupChannelByOwner(t).then(function(){r();n.deleteGroupChannelFromLoclal(t,!0)},function(t){var u=Errors.GetHubMessage(t);if(u===ErrorMsg.NotPermitted)n.$ucdH.openDialogNotPermitted(i).finally(r);else{r();throw Errors.ClientNotEqualException({errorAnswer:t,msg:u});}})};n.deleteGroupChannelFromLoclal=function(t,i){i&&n.removeGroupSerchChannelItem(t);n.deleteLocalChannelItem(n.ChannelTypes.Group,t)};n.unsubscribeFromGroupChannel=function(i,r,u){t||(t=!0,console.log("confunsubscribeFromGroupChannelirm",{channelId:i,channelName:r,$event:u}),n.$ucdH.openDialogUnsubscribeFromGroupChannel(u,r).then(function(){n.$hub.userChannelsUnsubscribeUserFromGroupChannel(i).then(function(){n.deleteGroupChannelFromLoclal(i,!1);t=!1},function(u){var f=Errors.GetHubMessage(u);if(f===ErrorMsg.IsEmpty)n.deleteGroupChannelFromLoclal(i,!1),t=!1;else{t=!1;throw Errors.ClientNotImplementedException({errorAnswer:u,msg:f,channelId:i,channelName:r,channel:n.Group.Collection[i]});}})},function(){console.log("cancel");t=!1}))};n.addOrUpdateGroupUserToLocalAdminUsers=function(t){var i=n.getChannelByChannelType(t.ChannelType,t.ChannelId);if(i)return i.Users||(i.Users={}),i.Users[t.Id]=t,i};n.deleteGroupUserFromLocalAdminUsers=function(t){var i=n.getChannelByChannelType(t.ChannelType,t.ChannelId);return i&&i.Users&&i.Users[t.Id]&&delete i.Users[t.Id],i};n.setIncorrectPwToToLocalAdminUsers=function(t){var i=n.getChannelByChannelType(n.ChannelTypes.Group,t);i&&i.Users&&_.forEach(i.Users,function(n){n.HasCorrectPassword=!1})};n.onGroupUserUnsubscribe=function(t,i,r){if(t===n.$currentUserInfo.userId){console.log("onGroupUserUnsubscribe",{channelAdminUserId:t,iChannelConnectionUserOut:i,$$RootScope:r});var u=n.deleteGroupUserFromLocalAdminUsers(i);u&&r.$broadcast("user-channels-group-:user-unsubscribe",{ChannelConnectionUserOut:i,channel:u})}};n.onGroupUserSubscribe=function(t,i,r){if(t===n.$currentUserInfo.userId){var u=n.addOrUpdateGroupUserToLocalAdminUsers(i);u&&r.$broadcast("user-channels-group-:user-subscribe",{ChannelConnectionUserOutId:i.Id,channel:u})}};n.onCrUserGroupUpdatedPermition=function(t,i){var r=t,u;n.$currentUserInfo.userId===r.UserId&&(u=n.getChannelByChannelType(r.ChannelType,r.ChannelId),u&&(u.MessageSend=r.MessageSend,i.$broadcast("channelItem:update-permition",{channel:u})))};n.onGroupIconUploaded=function(t,i,r){var f=n.getChannelByChannelType(n.ChannelTypes.Group,i),u;f&&(u=n.getCbButtonByIdx(0,f),u&&u.Data&&(u.Data.ImagePathOrCss=t,r.$broadcast("user-channels-group-:channel-icon-updated",{channel:f})))}};Utils.CoreApp.gameAppExtensions.UserChannelsPrivate=function(n){n.getPriavateLeftRightCbName=function(n,t){if(t&&t.$leftName)return{leftName:t.$leftName,rightName:t.$rightName};var u=_.split(n,"<==>"),i=u[0].trim(),r=u[1].trim();return t&&(t.$leftName&&t.$leftName===i||(t.$leftName=i),t.$rightName&&t.$rightName===r||(t.$rightName=r)),{leftName:i,rightName:r}};n.getPriavateCbHeadHtml=function(n){return"<div class=html-content>"+Utils.SetSpanText(n.leftName)+Utils.SetSpanText(n.rightName)+"<\/div>"};var t=!1;n.createPrivateChannelControls=function(){return{buttons:[n.$btnHelper.ButtonsView().ConstructorSizeBtn(1,!0,"Create private channel",function(i,r,u,f,e){function o(n){n.$destroy();t=!1}t||(t=!0,n.$ucdH.$mdDialog.show({templateUrl:"dialog-channel-private-create-channel.tmpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,fullscreen:!0,controller:"dialogCreatePrivateChannelCtrl",controllerAs:"dcpmCtrl"}).then(o,o))})]}};n.onPrivateChannelCreated=function(t){t.ComplexButtonView.IsNewItem=!0;n.checkPrivateHead(t);n.addOrReplaceLocalChannelItem(t)};n.deletePrivateChannel=function(i,r,u){if(!t)try{t=!0;var f=n.getChannelByChannelType(r,i),e=n.$currentUserInfo,o=f.ComplexButtonView,s=o.$rightName;f.CreatorId!==e.userId&&(s=o.$leftName);n.$ucdH.openDialogConfirmDeletePrivateChannel(u,s).then(function(){n.$hub.userChannelsClosePrivateChannel(i,e.userId).finally(function(){t=!1}).then(function(){n.deleteLocalChannelItem(r,i)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"userChannelsService.sendMessage");})},function(){console.log("openDialogConfirmDeletePrivateChannel.cancel");t=!1})}catch(h){t=!1;throw Errors.ClientNotImplementedException({channelId:i,channelType:r,$event:u},"throw.deletePrivateChannel",h);}};n.checkPrivateHead=function(t){var i,r,u;t.ChannelType===n.ChannelTypes.Private&&(i=t.ComplexButtonView.Collection[1].Data,i.$headNative||(r=i.Head,u=n.getPriavateLeftRightCbName(r,t.ComplexButtonView),i.Head=n.getPriavateCbHeadHtml(u),i.$headNative=r))};n.getPrivateExistChannelNames=function(t){var r=n.Private.Collection,i;return r?(i=[],_.forEach(r,function(t){var u=n.getPriavateLeftRightCbName(t.ChannelName,r.ComplexButtonView);i.push(u.leftName,u.rightName)}),i=_.uniq(i),t&&(i=i.join("|").toLowerCase().split("|")),i):[]}};Utils.CoreApp.gameAppExtensions.ConfederationOfficers=function(n){var t=!1;n.getPresidentOfficerFromOfficerList=function(t){return _.find(t,function(t){return t.Type===n.OfficerTypes.President})};n.officerOpenFormSetOfficer=function(i,r,u,f,e){t||f.userId!==u.UserId||(t=!0,n.$cdH.$mdDialog.show({templateUrl:"dialog-set-officer.tmpl",parent:angular.element(document.body),targetEvent:i,clickOutsideToClose:!1,fullscreen:!0,bindToController:!0,_locals:{postName:e,presidentOfficer:u,targetOficer:r},controller:"dialogSetOfficerCtrl",controllerAs:"soCtrl"}).then(function(n){n.$destroy();t=!1},function(n){n.$destroy();t=!1}),console.log("createGroupChannelControls.click",{emptyUserOfficerOutDataModel:r}))};n.addOrUpdateOfficer=function(t,i){var r=n.Officers.Officers;if(t&&r){var f=t.Type,e=t.Elected,s=f-1,o=r[s],u=e?o.Elected:o.Appointed;if(u.Type!==f||u.Elected!==e)throw Errors.ClientNotImplementedException({newUserOfficerOutDataModel:t,oficers:r},"userOficer.Type !== type || userOficer.Elected !== elected");Utils.UpdateObjData(u,t);console.log("addOrUpdateOfficer && service.Officers.Officers",{newUserOfficerOutDataModel:t,LocalOficers:r,$$RootScope:i})}else console.log("addOrUpdateOfficer.error no Data",{LocalOficers:r,newUserOfficerOutDataModel:t})};n.getIUserOfficerOutListFromOfficers=function(){var t=[];return _.forEach(n.Officers.Officers,function(n){n&&(n.Elected&&t.push(n.Elected),n.Appointed&&t.push(n.Appointed))}),t};n.officerGetExistOfficerNames=function(t){var r=n.getIUserOfficerOutListFromOfficers(),i;return r?(i=[],_.forEach(r,function(n){n.UserName&&n.UserName.length>3&&n.UserName!=="None"&&i.push(n.UserName)}),t&&(i=i.join("|").toLowerCase().split("|")),i):[]};n.getOfficerBonusForCurrentUser=function(){var t=Utils.ModelFactory.IBattleStats(),r=n.$currentUserInfo,u=r.AllianceId,i;return GameServices.npcHelper.isNpcAllianceId(u)?t:(i=n.getIUserOfficerOutListFromOfficers(),_.isEmpty(i),t)}};Utils.CoreApp.gameAppExtensions.ConfederationRating=function(n){n.ratingGetNextPage=function(t,i,r){function u(n){var t=Errors.GetHubMessage(n),u={msg:t,errorAnswer:n,onDone:i};r(n,t,u);throw Errors.ClientNotImplementedException(u,"ConfederationRating.ratingGetNextPage");}var f=t.Users.length;n.$hub.confederationRatingGetNextPage(f).then(function(n){_.forEach(n,function(n){t.Users.push(n)});i(n)},u)};n.ratingAddAndTakeLocalUsers=function(n,t,i){if(_.isInteger(i)){var u=t.length,r=u+i;n[r]||(r=n.length);_.forEach(n,function(n,i){i>=u&&i<r&&t.push(n)})}};n.ratingAddUserItemsToOld=function(n,t){for(var r=t.length,i=0;i<r;i++)n.push(t[i])};n.ratingCheckAndFixUniqe=function(t){if(t.users){var i=t.users.length,r=_.uniqBy(t.users,"UserId");i!==r.length&&(n.Rating.Users=_.uniqBy(n.Rating.Users,"UserId"),t.users=[],n.ratingAddAndTakeLocalUsers(n.Rating.Users,t.users,i),n.Rating.$totalCount&&(n.Rating.$totalCount=null))}};var t=!1;n.ratingGetUserItem=function(i,r,u,f){if(t){f({},ErrorMsg.Locked,{});return}t=!0;var e=_.find(r,function(n){return n.UserId===i});if(e)try{u(e);t=!1}catch(o){t=!1;throw console.log("retingGetUserItem.local",{e:o});}else{if(GameServices.planshetService.getInProgress()){f({},ErrorMsg.Locked,{});return}GameServices.planshetService.setInProgress(!0);n.$hub.confederationRatingGetUser(i).finally(function(){GameServices.planshetService.setInProgress(!1)}).then(function(n){try{u(n);t=!1}catch(i){t=!1;throw console.log("retingGetUserItem.answer",{e:i});}},function(n){var e=Errors.GetHubMessage(n),o={msg:e,userId:i,users:r,errorAnswer:n,onDone:u,onError:f};f instanceof Function&&f(n,e,o);t=!1;throw Errors.ClientNotImplementedException(o,"ConfederationRating.ratingGetNextPage");})}}};Utils.CoreApp.gameAppExtensions.ConfederationElection=function(n){function e(t){setTimeout(function(){var i=$("#skagry-container"),r;if(i&&i.length)r=$("#float-vote-container"),r&&r.length||(n.$compileHelper.$appendHtml(i,"<float-vote/>"),t&&t());else{e(t);return}})}function s(){return i.GetFromStorage(o,!0)}function h(){return{position:{top:185,left:105},show:!0,voiceSendedInWeek:!1,startDay:5,endDay:7,startEndHour:20}}var o=Utils.RepoKeys.LsKeys.FloatVoteParams,f=Utils.RepoKeys.LsKeys.VoteRegistredData,i=Utils.LocalStorage,r,u,t;n.updateCandidates=function(t,i,r){if(_.isEqual(n.Election.Candidates,t)){console.log("service.updateCandidates.isEqual",{candidatesOutList:t,updateVotes:i,service:n});return}if(i&&n.Election.Candidates&&t.length===n.Election.Candidates.length){var u=_.map(n.Election.Candidates,function(n){return n.Id}),f=_.map(t,function(n){return n.Id});_.isEqual(u,f)?Utils.UpdateObjData(n.Election.Candidates,t):n.Election.Candidates=t}else n.Election.Candidates=t;r.$broadcast("election:update-candidates",{Candidates:n.Election.Candidates,updateVotes:i})};r=!1;n.$checkAndRunOrDestroyVoteView=function(n){function t(){r=!1}var s,i,f,u,o,h;if(!r)if(r=!0,s=n.IsRegisterPeriod,i=$("#float-vote-container"),s)i&&i.length&&i.remove(),t();else{if(i&&i.length){t();return}if(f=n.Candidates,!f||!f.length){u=$("#float-vote-container");u&&u.length&&u.remove();t();return}o=$("#Game").scope();o.gameCtrl.skagryLoaded?(console.log("$checkAndRunOrDestroyVoteView: if gameScope.gameCtrl.skagryLoaded"),e(t)):h=o.$watch("gameCtrl.skagryLoaded",function(n){console.log("$checkAndRunOrDestroyVoteView: clearWatch");n?(r=!0,e(function(){t();h()})):t()})}};n.$saveToLsVoteParams=function(n){i.SaveInStorage(o,n,!0)};n.$isVotePeriod=function(n){var t=Utils.Time.GetUtcNow();return t>=n.StartVoteTime&&t<=n.EndVoteTime};n.$checkAndUpdateHasVoice=function(t){var r;if(t.voiceSendedInWeek){var f=Utils.Time.GetUtcNow(!0),u=Utils.Time.GetUtcDateTimeFromMsUtc(f),i=u.getDay(),e=i===0?7:i;if(e<t.startDay){t.voiceSendedInWeek=!1;n.$saveToLsVoteParams(t);return}if(r=u.getHours(),t.startDay===i&&r<t.startEndHour||t.endDay===i&&r>=t.startEndHour){t.voiceSendedInWeek=!1;n.$saveToLsVoteParams(t);return}}};u=!1;n.addVoiceToOfficer=function(t,i,r,f,e,o){if(u){e(ErrorMsg.Locked);return}if(!i||!r||!i.UserId){e(ErrorMsg.InputDataIncorrect);return}if(r.voiceSendedInWeek){n.$cdH.openDialogUserHasAlreadyCastVote(t);e(ErrorMsg.UserHasAlreadyCastVote);return}u=!0;n.$cdH.openDialogConfirmSendVote(t,i.UserName).then(function(){n.$hub.confederationAddVote(i.UserId).then(function(){r.voiceSendedInWeek=!0;n.$saveToLsVoteParams(r);u=!1;f();o.$broadcast("election:cr-user-voice-added",{params:r})},function(o){var s=Errors.GetHubMessage(o),h={msg:s,candidat:i,voteParams:r,errorAnswer:o,onDone:f,onError:e};s===ErrorMsg.UserHasAlreadyCastVote?(n.$cdH.openDialogUserHasAlreadyCastVote(t),r.voiceSendedInWeek=!0,n.$saveToLsVoteParams(r)):s===ErrorMsg.TimeVotingIsOver&&(n.$cdH.openDialogTimeVotingIsOver(t),r.voiceSendedInWeek=!1,n.$saveToLsVoteParams(r));e instanceof Function&&e(s);u=!1;throw Errors.ClientNotImplementedException(h,"addVoiceToOfficer.ratingGetNextPage");})},function(){e("cancel")})};t=!1;n.$registrateOfficer=function(i,r,u,f,e){var o,c;if(!t)if(t=!0,o=n.getElectionData(),c=n.$currentUserInfo,o.IsRegisterPeriod){var s=GameServices.resourceService,h=o.RegistrCcPrice,l=s.isEnoughCc(h);l?n.$hub.confederationRegistrateCandidate().then(function(n){s.setCc(n);t=!1},function(i){var u=Errors.GetHubMessage(i),f,r;u===ErrorMsg.NotEnoughCc&&(f=s.setBalanceFromErrorAnswerNotEnoughCc(i),n.$cdH.openDialogRegistrationNotEnoughCc(e,h,f).finally(function(){t=!1}));t=!1;r={msg:u,errorAnswer:i};console.log("$registrateOfficer.errorAnswer",r);throw r;}):n.$cdH.openDialogRegistrationNotEnoughCc(e,h,s.getCcCount()).finally(function(){t=!1})}else n.$cdH.openDialogTimeRegistrationIsOver(e).finally(function(){o.RegistrBtn=null;r.remove();t=!1})};n.$saveRegistredToLsByElection=function(n,t){i.SaveInStorage(f,{Registred:t,StartVoteTime:n.StartVoteTime,StartRegistrationTime:n.StartRegistrationTime,EndVoteTime:n.EndVoteTime},!0)};n.getElectionData=function(){var t=n.Election,u=!n.$isVotePeriod(t),e,r;return t.IsRegisterPeriod!==u&&(t.IsRegisterPeriod=u),e=Utils.Time.GetUtcNow(),r=i.GetFromStorage(f,!0),t.IsRegisterPeriod?(t.Registred?!t.Registred||r&&r.Registred||n.$saveRegistredToLsByElection(t,!0):!r||e>r.StartVoteTime?n.$saveRegistredToLsByElection(t,!1):r.Registred&&(Math.abs(r.StartVoteTime-t.StartVoteTime)<10?t.Registred=r.Registred:n.$saveRegistredToLsByElection(t,!1)),t.Registred&&t.RegistrBtn?t.RegistrBtn=null:t.Registred||t.RegistrBtn||(t.RegistrBtn=n.$btnHelper.ButtonsView().ConstructorSizeBtn(1,!0,"Registrate ("+t.RegistrCcPrice+" CC)",n.$registrateOfficer))):(t.RegistrBtn&&(t.RegistrBtn=null),r&&i.RemoveItem(f),t.Registred&&(t.Registred=!1)),t.$params||(t.$params=s(),t.$params||(t.$params=h(),n.$saveToLsVoteParams(t.$params))),n.$checkAndUpdateHasVoice(t.$params),n.$checkAndRunOrDestroyVoteView(t),t};n.onVoteFinalize=function(t,i,r){n.Officers.Officers=i;n.Election=t;n.getElectionData();t&&r.$broadcast("election:finished",{newListIOfficerOut:n.Officers.Officers,election:n.Election})}};var GameServices={buildReqHelper:{},buildService:{},commandCenterService:{},industrialComplexService:{},laboratoryService:{},spaceShipyardService:{},mainGameHubService:{},userChannelsService:{},allianceService:{},bookmarkService:{},confederationService:{},estateService:{},gameChestService:{},hangarService:{},journalService:{},mapInfoService:{},planshetService:{},profileService:{},resourceService:{},tabService:{},translateService:{},unitDialogService:{},controlDiskHelper:{},controlPanelSwicherHelper:{},dropableElementHelper:{},journalHelper:{},mainHelper:{},mapControlHelper:{},mapInfoHelper:{},npcHelper:{},paralaxButtonHelper:{},planshetHelper:{},scrollerHelper:{},statisticHelper:{},techTreeHelper:{},timerHelper:{},uploadHelper:{},_updatePlanshet:null,Init:function(n){$.extend(this,n)}};Utils.CoreApp.gameApp=angular.module("gameApp",["ngMaterial","ngSanitize","infinite-scroll","angular-medium-editor","ngMessages","svgAssetsCache","angularFileUpload","ngFileUpload","ngImgCrop","uiCropper","angularAppCommon"]);Utils.CoreApp.gameApp.config(["$mdThemingProvider",function(n){n.disableTheming()}]);Utils.CoreApp.gameApp.config(["$mdIconProvider",function(n){function r(){for(var u="achievement-",f=i+"achievement/"+u,r=1;r<=12;r++)n.icon(u+r,f+r+t)}function u(){n.icon("planshet-arrow","/Content/images/home/arrow.svg",50);n.icon("select-container-cursor","/_svg/select-container-cursor.svg",30)}function f(){var r=i+"interface/";_.forEach({"0":"interface-icon-cc","1":"interface-icon-e","2":"interface-icon-ir","3":"interface-icon-dm","4":"interface-icon-cc-body","5":"interface-icon-e-body","6":"interface-icon-ir-body","7":"interface-icon-dm-body","8":"interface-icon-confederation","9":"interface-icon-alliance","10":"interface-icon-journal","11":"interface-icon-message","12":"interface-icon-hangar-toggle","13":"interface-icon-galaxy-info","14":"interface-icon-sector-info","15":"interface-icon-star-info","16":"interface-icon-planet-info","17":"interface-icon-jump-to-galaxy","18":"interface-icon-jump-to-sector","19":"interface-icon-jump-to-star","20":"interface-icon-jump-to-mother","21":"interface-icon-jump-to-user-planet","22":"interface-icon-jump-to-galaxy-body","23":"interface-icon-jump-to-sector-body","24":"interface-icon-jump-to-star-body","25":"interface-icon-jump-to-mother-body","26":"interface-icon-jump-to-user-planet-body","27":"interface-icon-jump-to-planetoid","28":"interface-icon-open-bookmarks"},function(i){var u=r+i+t;n.icon(i,u)})}function e(){f();r();u()}var t=".svg",i="/_svg/";e()}]);angular.module("infinite-scroll").value("THROTTLE_MILLISECONDS",250);Utils.CoreApp.gameApp.constant("maxLenghtConsts",{AllianceDescription:3e3,PersonalInfoDescription:3e3,DbDescriptionMax:4e3,DescriptionLangDescriptionMax:1e3,DescriptionLangNameMax:50,ChannelMessage:3e3,UniqueName:14,ChannelPassword:14,ChannelNameDbMax:50,ChannelNamePrivate:50,ChannelName:14,UserImagesDbMax:1e3,PropertyName:50,GroupChannelsLimit:20,MaxOfficerCandidates:10});Utils.CoreApp.gameApp.constant("minLenghtConsts",{GameUserName:4,UserPassword:6,ChannelPassword:4,AllianceName:4,ChannelName:4,PlaneetName:3,SerchChannelName:3});Utils.CoreApp.gameApp.value("$regExp",{channelName:new RegExp("^[A-Z]{1,}[A-Z0-9_-]{2,}[A-Z0-9]$"),channelPassword:new RegExp("^[A-Z]{1,}[A-Z0-9_-]{2,}[A-Z0-9]$","i")}),function(){}();Utils.CoreApp.gameApp.controller("userChannelsCtrl",[function(){}]);Utils.CoreApp.gameApp.controller("userChannelsPrivateCtrl",["$scope","userChannelsService",function(n,t){t.Private.channelControls||(t.Private.channelControls=t.createPrivateChannelControls());var i=_.extend(this,t.Private)}]);Utils.CoreApp.gameApp.controller("userChannelsGroupCtrl",["$scope","userChannelsService",function(n,t){var i=this;t.Group.channelControls||(t.Group.channelControls=t.createGroupChannelControls());_.extend(i,t.Group)}]);Utils.CoreApp.gameApp.controller("userChannelsAllianceCtrl",["$scope","userChannelsService",function(n,t){function r(){i.channel=t.Alliance.Collection[Object.keys(t.Alliance.Collection)[0]];i.channel.dropElementFreeze||(i.channel.dropElementFreeze=!0);i.channel._btnIds||t.createBtnIds(i.channel);i.channel.initTargetDropable||(i.channel.initTargetDropable=i.channel._btnIds.MessagesId);!i.channel.cbClick}var i=this;r()}]),function(){"use strict";function r(n,t){n.serchInputId=Utils.Guid.CreateGuid();n.searchText=null;n.onTextChange=function(t,i){n.model.To&&n.model.To.Name&&t!==n.model.To.Name&&(t.toLowerCase()===n.model.To.Name.toLowerCase()&&(n.searchText=n.model.To.Name),i instanceof Function&&i())};n.querySearch=t;var i={required:"This is a required field",serchRequireMmatch:"This requireMmatch.",serchNotFounded:"not founded"};n.$messages?_.extend(n.$messages,i):n.$messages=i}function i(t,i,r){var f=this,u;this.$maxLenght=t.$ucdH.maxLenghtConsts;u={isLocked:!1,password:"",showPassword:!1,inputPsswordType:"password",$passwordMinLenght:i.ChannelPassword,$passwordMaxLenght:t.$ucdH.maxLenghtConsts.ChannelName,$title:""};this.$openChannelLabel="Open channel";this.$lockedChannelLabel="Locked channel";Object.defineProperty(u,"$lockedLabel",{get:function(){return u.isLocked?f.$lockedChannelLabel:f.$openChannelLabel}});Object.defineProperty(this,"cssIconLock",{get:function(){return u.isLocked?n.locked:n.unLocked}});this.showPasswordToggle=function(){u.showPassword=!u.showPassword;u.inputPsswordType=u.showPassword?"text":"password"};Object.defineProperty(this,"cssIconShowPassword",{get:function(){return u.showPassword?n.show:n.notShow}});this.passwordPattern=r.channelPassword;this.$model=u;this.$messages={required:"This is a required field",passwodMinLength:"Password must be longer than "+u.$passwordMinLenght+" characters",passwodMaxLength:"Password must be less than "+u.$passwordMaxLenght+" characters",passwordPattern:"Password It contains invalid characters.<br>"+Utils.SetSpanText("<b>Available symbols : 'a-z', 'A-Z', '0-9', '-', '_'<br> Password must be contain latin only symbols,<br> Beginning  with  'a-z' or 'A-Z' <br>   Ends with  'a-z' or 'A-Z' or '0-9' <\/b>","base-color"),noMatch:"No match!"};this.$toggleLock=function(){u.password="";u.isLocked=!u.isLocked}}function t(n,t,r){var f=this,u;i.call(f,n,t,r);u=_.extend(this.$model,{confirmPassword:"",passwordVerifed:!1});this.toggleLock=function(){this.$toggleLock();u.confirmPassword=""};this.messages=_.extend(this.$messages,{noMatch:"No match!"})}function u(i,r,u,f,e){var s=this,c,o,h;t.call(s,u,f,e);c=u.$currentUserInfo;o=_.extend(this.$model,{channelName:"",isValidName:!1,channelNameIsUnique:!1,$title:"Create group channel",$enterChannelNameLabel:"Channel name",$channelNameMinLenght:f.ChannelName,$channelNameMaxLenght:this.$maxLenght.UniqueName,UserId:c.userId,UserName:c.userName,ChannelType:u.ChannelTypes.Group});this.onChannelNameChange=function(){o.isValidName=s.form.channelName.$valid};this.checkNameIsUnique=function(){o.channelNameIsUnique=!o.channelNameIsUnique};this.onNameValidate=function(){o.isValidName=!0};this.onNameInvalidate=function(){o.isValidName=!1};this.model=o;Object.defineProperty(s,"cssIconChannelName",{get:function(){return o.isValidName?n.checked:n.warn}});this.cancel=function(){r.cancel(i)};h=!1;this.send=function(){if(!h){h=!0;var n=Utils.ModelFactory.IChannelDataModel();n.ChannelName=o.channelName;n.Password=o.password;n.ChannelIcon=c.userAvatar.Icon;s.form.$valid?u.createGroupChannel(n,function(){h=!1;r.hide(i)},function(t){var r=Errors.GetHubMessage(t);r===ErrorMsg.MaxChannelsLimit?(s.form.$setValidity("maxChannelsLimit",!1),h=!1):(h=!1,Errors.ClientNotImplementedException({msg:r,errorAnswer:t,createModel:n,$scope:i},"dialogCreateGroupChannelCtrl.send.errorAnswer"),s.cancel())}):console.log("dialogCreateGroupChannelCtrl.form.$invalid")}};this.channelNamePattern=e.channelName;this.messages=_.extend(this.$messages,{nameMinLength:"Channel name must be longer than "+o.$channelNameMinLenght+" characters",nameMaxLength:"The Channel name must be less than  "+o.$channelNameMaxLenght+" characters long.",namePattern:"Channel name contains invalid characters.<br>"+Utils.SetSpanText("<b>Available symbols : 'A-Z', '0-9', '-','_' <br> Name must be contain latin only  symbols <br>In uppercase.<br> Beginning  with 'A-Z' <br>Ends with  'A-Z'  or '0-9'<\/b>","base-color"),isAvailableName:"Name not Unique"});Object.defineProperty(this.messages,"maxChannelsLimit",{get:function(){var n=u.getGroupLimitModel(),t=u.getTabTranslateNameByChannelType(u.bodyIdx.Group);return u.$ucdH.getTextOpenDialogChannelMaxLimit(t,n.max)}})}function f(n,i,r,u,f){var e=this,o=e._locals.channel,s;t.call(this,r,u,f);this.model=_.extend(this.$model,{$title:"Update password"});this.model.isLocked=!o.IsPublic;this.cancel=function(){i.cancel(n)};s=!1;this.send=function(){if(!s){s=!0;o.IsPublic&&!e.model.isLocked&&e.cancel();var t=!e.model.isLocked,u=t?"":e.model.password,f=r.$hub.userChannelsUpdatePassword(o.ChannelId,u);f.then(function(u){u?(o.IsPublic=t,r.addOrUpdateGroupSerchChannelItem(o.ChannelId,o.ChannelName,t),r.setIncorrectPwToToLocalAdminUsers(o.ChannelId),i.hide(n)):e.cancel()},function(n){var t=Errors.GetHubMessage(n);console.log("dialogChannelsGroupUpdatePassword",{errorAnswer:n,msg:t,$self:e});e.cancel()});console.log("dialogChannelsGroupUpdatePassword",{$scope:n});return}}}function e(n,t,u,f,e){function w(){var n=c-s;return n<0&&(n=0)," "+n+"/"+c+" "}var o=this,v,y,h,a,c,s,p,l;i.call(o,u,f,e);v=u.getGroupExistChannelNames();this.model=_.extend(this.$model,{$minSerchChannelName:f.SerchChannelName,$channelNameMinLenght:f.ChannelName,$channelNameMaxLenght:o.$maxLenght.ChannelName,$title:"Join to channel",serchTypesView:u.getSerchTypesView(),lockForm:!1});this.model.selecctedSerchTypeView=this.model.serchTypesView[0];this.serchInLock=!1;r(o,function(n){function t(t){y=n;h=t&&t.length>0?t:[];i.resolve(h);o.serchInLock=!1}if(o.serchInLock)return[];if(o.serchInLock=!0,y&&y===n&&h&&a===o.model.selecctedSerchTypeView.Id)return console.log("_autocompleteBase.cahce",{$self:o,query:n,_lastItems:h}),o.serchInLock=!1,h;var i=u.$q.defer();return a=o.model.selecctedSerchTypeView.Id,u.groupSerchChannelItemsFilterAsync(n,a).then(function(i){var r=u.filterGroupByIgnoreNames(i.items,v);if(i.items.length!==0||i.fromLocal)i.items.length>0&&i.fromLocal&&!r.length?u.groupSerchChannelItemsFilterAsync(n,a,!0).then(function(n){var i=u.filterGroupByIgnoreNames(n.items,v);o.form.toName.$error.channelExistLocal=n.items.length>0&&i.length===0?!0:!1;t(i);return}):(o.form.toName.$error.channelExistLocal=i.items.length>0&&r.length===0?!0:!1,t(r));else{t();return}}),i.promise});c=5;s=0;this.messages=_.extend(this.$messages,{channelExistLocal:"Вы уже подключенны к этому каналу",passwordWrongMax:"Вы ввели неверный пароль слишком много раз, попробуйте позднее",youAreBlockedInThisChannel:"Вы были заблокированны на этом канале попробуйте связатсья с администратором канала"});this.showChannelChannelOwnerInfo=!1;this.ChannelOwner=null;Object.defineProperty(this.messages,"passwordWrongCount",{get:function(){return"Пароль не верный, у вас  осталось попыток "+w()}});Object.defineProperty(this.messages,"maxChannelsLimit",{get:function(){var n=u.getGroupLimitModel(),t=u.getTabTranslateNameByChannelType(u.bodyIdx.Group);return u.$ucdH.getTextOpenDialogChannelMaxLimit(t,n.max)}});this.cancel=function(){t.cancel(n)};l=!1;this.send=function(){if(!l){if(l=!0,p!==o.model.To.Id&&(s=0,o.ChannelOwner=null,o.showChannelChannelOwnerInfo=!1,p=o.model.To.Id),s++,s>c+1){o.cancel();return}u.$hub.userChannelsJoinToGroupChannel(o.model.To.Id,o.model.password).then(function(i){u.addOrReplaceGroupChannelLocal(i);l=!1;t.hide(n)},function(n){console.log("errorAnswer",{errorAnswer:n});var t=Errors.GetHubMessage(n);t===ErrorMsg.YouAreBlockedInThisChannel?(o.ChannelOwner=n.data.ChannelOwner,o.showChannelChannelOwnerInfo=!0,o.form.$setValidity("youAreBlockedInThisChannel",!1)):t===ErrorMsg.MaxChannelsLimit?o.form.$setValidity("maxChannelsLimit",!1):t===ErrorMsg.NotPermitted?(o.ChannelOwner=n.data.ChannelOwner,o.showChannelChannelOwnerInfo=!0,o.form.password.$setValidity("passwordWrongCount",!1),s===c&&o.form.password.$setValidity("passwordWrongMax",!1),l=!1):(l=!1,Errors.ClientNotImplementedException({$self:o,sendCount:s,maxWrong:c},"dialogChannelsGroupJoinToChannel.send"),o.cancel())})}};this.onSlectedChannelChanged=function(n){n?o.model.isLocked!==!n.IsPublic&&(o.model.isLocked=!n.IsPublic):o.model.isLocked=!1};this.onPasswordChanged=function(){console.log("onPasswordChanged",{q:o.form.password});o.form.password.$error.passwordWrongCount&&o.form.password.$setValidity("passwordWrongCount",!0)}}var n={checked:"fa-check",warn:"fa-exclamation",show:"fa-eye",notShow:"fa-eye-slash",locked:"fa-expeditedssl",unLocked:"fa-unlock"};Utils.CoreApp.gameApp.controller("dialogCreatePrivateChannelCtrl",["$scope","$mdDialog","userNameSercherService","userChannelsService",function(n,t,i,u){var e=this,s=u.$currentUserInfo,h=u.$ucdH.maxLenghtConsts,f=Utils.ModelFactory.IChannelMessageTransfer(),c,l,o;f.UserId=s.userId;f.UserName=s.userName;f.$messageMaxLenght=h.ChannelMessage;f.$userNameMaxLenght=h.UniqueName;f.Message="";f.UserIcon=s.userAvatar.Icon;f.ChannelType=u.ChannelTypes.Private;f.$title="Create private channel";this.model=f;c=u.getPrivateExistChannelNames();l=i.createIgnoreNamesWithNpc(c);this.serchInLock=!1;r(e,function(n){var t=u.$q.defer();return e.serchInLock&&t.reject(),e.serchInLock=!0,i.filterAsync(n).then(function(n){var r=i.filterByIgnoreNames(n,l);t.resolve(r);e.serchInLock=!1},function(){e.serchInLock=!1}),t.promise});this.messages=_.extend(this.$messages,{serchMaxlength:"The user name must be less than "+f.$userNameMaxLenght+" characters long.",messageMaxlength:"The description must be less than "+f.$messageMaxLenght+" characters long."});this.cancel=function(){t.cancel(n)};o=!1;this.send=function(){var i=Utils.ModelFactory.IChannelMessageCreateModel(f);o||(o=!0,u.$hub.userChannelsCreatePrivateChannel(i).then(function(r){o=!1;console.log("createMessageChannelInBlockedState.answer",{answer:r,data:i});t.hide(n)},function(n){o=!1;var t=Errors.GetHubMessage(n);Errors.ClientNotImplementedException({msg:t,errorAnswer:n,model:f,data:i},"dialogCreatePrivateChannelCtrl.send.errorAnswer");e.cancel()}))}}]);t.prototype=Object.create(i.prototype);u.prototype=Object.create(t.prototype);Utils.CoreApp.gameApp.controller("dialogCreateGroupChannelCtrl",["$scope","$mdDialog","userChannelsService","minLenghtConsts","$regExp",u]);f.prototype=Object.create(t.prototype);Utils.CoreApp.gameApp.controller("dialogChannelsGroupUpdatePasswordCtrl",["$scope","$mdDialog","userChannelsService","minLenghtConsts","$regExp",f]);e.prototype=Object.create(i.prototype);Utils.CoreApp.gameApp.controller("dialogChannelsGroupJoinToChannel",["$scope","$mdDialog","userChannelsService","minLenghtConsts","$regExp",e]);Utils.CoreApp.gameApp.controller("dialogChannelsGroupUpdateUser",["$scope","$mdDialog","userChannelsService",function(n,t,i){var r=this,u;this.model=_.extend(_.cloneDeep(this._locals.$updateUser));this.$title="Update user: "+this._locals.$updateUser.UserName+" ";this.css=this._locals.$css;this.labels={};Object.defineProperty(this.labels,"read",{get:function(){return r.model.MessageRead?"Can Read":"Can't Read"}});Object.defineProperty(this.labels,"write",{get:function(){return r.model.MessageSend?"Can Write":"Can't Write"}});Object.defineProperty(this.labels,"pw",{get:function(){return r.updateFromChannel?"Update password":"Don't Update password"}});u=!1;this.toggleCanRead=function(){this.model.MessageRead=!this.model.MessageRead;this.model.MessageRead||(r.model.MessageSend=!1,r.updateFromChannel=!1)};this.toggleCanWrite=function(){this.model.MessageRead&&(this.model.MessageSend=!this.model.MessageSend)};Object.defineProperty(this,"showUpdatePassword",{get:function(){return!r._locals.$updateUser.HasCorrectPassword&&r.model.MessageRead}});this.updateFromChannel=!1;this.toggleUpdatePasswordFromChannel=function(){this.updateFromChannel=!this.updateFromChannel};this.send=function(){u||(u=!0,console.log("send",{$scope:n,$self:r}),!_.isEqual(r.model,r._locals.$updateUser)||r.updateFromChannel?i.$hub.userChannelsGroupUpdateUser(r.model,r.updateFromChannel,r._locals.$channelAdminUserId).then(function(u){i.addOrUpdateGroupUserToLocalAdminUsers(u);r._locals.$onUserUpdated(u);t.hide(n)},function(n){var t=Errors.GetHubMessage(n),u;t===ErrorMsg.NotPermitted?(u=i.Group[r.model.ChannelId],u.Users=null,u.CreatorConnection=null,console.log("dialogChannelsGroupUpdateUser.send.error.NotPermitted",{$self:r,errorAnswer:n,msg:t}),r.cancel()):(console.log("dialogChannelsGroupUpdateUser.send.error",{$self:r,errorAnswer:n,msg:t}),r.cancel())}):r.cancel())};this.cancel=function(){console.log("cancel",{$scope:n,$self:r});t.cancel(n)};n.$on("user-channels-group-:user-unsubscribe",function(t,i){i.ChannelConnectionUserOut.Id===r.model.Id&&console.log("dialogChannelsGroupUpdateUser.user-channels-group-:user-unsubscribe",{$scope:n,data:i,unsubscibedUser:i.ChannelConnectionUserOut})})}])}();Utils.CoreApp.gameApp.controller("achievementCtrl",["$scope",function(n){function t(n,t,i,r){return{contentHead:r,count:n,title:_.random(0,99999999),content:i,svgName:t}}function r(){var i=[];_.forEach(n.bodyData.Meeds,function(n,r){if(n.Id+""===r){var u=n.Translate[_.upperFirst(LANG.toLowerCase())];i.push(t(n.Count,n.SvgName,u.Description,u.Name))}});n.achievementCtrl.tabs=i}var i=0,u=0;r();this.selectedIndex=0;n.$on("planshet:update",function(t){t.targetScope.hasOwnProperty("planshetModel")&&t.targetScope.planshetModel.Bodys&&t.targetScope.planshetModel.Bodys[0]&&t.targetScope.planshetModel.Bodys[0].TemplateData&&t.targetScope.planshetModel.Bodys[0].TemplateData.hasOwnProperty("Achievements")&&t.targetScope.planshetModel.Bodys[0].TemplateData.Achievements.hasOwnProperty("Meeds")&&_.forEach(n.achievementCtrl.tabs,function(n){var r=t.targetScope.planshetModel.Bodys[0].TemplateData.Achievements.Meeds,i=_.find(r,function(t){return t.SvgName===n.svgName});n.count=i?i.Count:0})});n.$watch("achievementCtrl.selectedIndex",function(t,r){u=i;i=n.achievementCtrl.tabs[t];t!==r&&(console.log("achievementCtrl.selectedIndex"),EM.Audio.GameSounds.defaultButtonClick.play())});this.onHover=function(){EM.Audio.GameSounds.defaultHover.play()}}]);Utils.CoreApp.gameApp.controller("allianceCtrl",["$scope","allianceService","translateService",function(n,t,i){var r=this;r.translations=i.getAlliance();Object.defineProperty(r,"allianceList",{get:function(){return t.getAllianceList()}});r.getAllianceItemCompexBtnConfig=function(n){return t.getAllianceItemCompexBtnConfig(n)};r.canCreateAlliance=t.canCreateAlliance();r.getMyAllianceId=t.getMyAllianceId;Object.defineProperty(r,"MyAllianceData",{get:function(){return t.getMyAllianceData()}});r.hasRequestsInMyAlliance=t.hasRequestsInMyAlliance();n.$on("planshet:update",function(){t.isCurrentModel()&&(r.canCreateAlliance=t.canCreateAlliance(),r.hasRequestsInMyAlliance=t.hasRequestsInMyAlliance())});n.$on("allianceCtrl:initializeScrollSerch",function(n,i,r){r==="alliance-serch"&&(n.stopPropagation(),t.initializeScroll(i))})}]);Utils.CoreApp.gameApp.controller("allianceCreateCtrl",["$scope","allianceService","resourceService","paralaxButtonHelper","$mdDialog","$q",function(n,t,i,r,u,f){function k(){var t=n.formCreateAlliance.allianceName.$error;return t?t.required||t.minlength||t.maxlength||t.pattern?!1:!0:!0}function d(){if(!o.disabled&&h&&!s){o.disabled=!0;var r=o.allianceName,u=n.formCreateAlliance.allianceName,i=f.defer();t.checkNameIsUnic(r,i.resolve,i.reject);i.promise.then(function(n){s=n;o.allianceName=r.toUpperCase();o.nameIcon=s?b:y;u.$setValidity("notUnic",s);u.$setValidity("notCeked",!0);o.disabled=!1},function(t){o.disabled=!1;t===ErrorMsg.AllianceNameNotValid&&n.formCreateAlliance.allianceName.$setValidity("pattern",!1)})}}function g(){var t=n.formCreateAlliance.allianceName;h=k();s=!1;o.nameIcon=h?v:y;t.$setValidity("notCeked",!1);t.$setValidity("notUnic",!0)}function nt(r,f,h,c,l){if(s){var a=o.allianceName.toUpperCase(),v=u.confirm().title(e.trConfirm.trTitle.getCurrent()+a).textContent(e.trConfirm.trTextContent.getCurrent()).ariaLabel("default-dialog").targetEvent(l).ok(e.trConfirm.trConfirm.getCurrent()).cancel(e.trConfirm.trCancel.getCurrent());u.show(v).then(function(){t.createAlliance(a,!0,function(){u.show(u.alert().title(e.trConfirmGc.trTitle.getCurrent()).ariaLabel("default-dialog").clickOutsideToClose(!0).htmlContent(e.trConfirmGc.trHtmlContent(a)).ok("Ok"))},function(t){if(t!==ErrorMsg.YouInAlliance){if(t===ErrorMsg.AllianceNameNotValid){n.formCreateAlliance.allianceName.$setValidity("pattern",!1);return}if(t===ErrorMsg.NotEnoughCc){o.canBuy=!1;return}t===ErrorMsg.AllianceNameNotUnic&&n.formCreateAlliance.allianceName.$setValidity("notUnic",!1);console.log("$mdDialog.sho",t)}},i)},function(){})}}var o=this,e=t.allianceCreateMessages(),a=r.ComplexButtonView(),c,l;a.SimpleCentr(null,e.trCreateAlliance.getCurrent());var p=i.getCcCount(),w=p>=e.allianceCreatePrice,b="fa-check-circle-o succsess ",v="fa-question-circle-o check-undefined ",y="fa-exclamation-circle error ",s=!1,h=!1;c=r.ButtonsView();c.ConstructorSizeBtn(4,!0,e.trCheck.getCurrent(),d);l=r.ButtonsView();l.ConstructorSizeBtn(1,!0,e.trCreate.getCurrent(),nt);this.canBuy=w;this.msgCanBuy=e.trMsgCanBuy.trCanBuy.getCurrent();this.msgCantBuy=e.trMsgCanBuy.trError.getCurrent();this.allianceName="";this.disabled=!1;this.nameIcon=v;this.complexButtonView=a;this.createAllianceTitlle=e.trAllianceTitlle.getCurrent();this.errorMsg=e.trErrorMsg;this.checkBtn=c;this.onNameChange=g;this.sendBtn=l}]);Utils.CoreApp.gameApp.controller("allianceMembersCtrl",["$rootScope","$scope","allianceService","dropableElementHelper","translateService","paralaxButtonHelper","mainHelper","profileService","allianceDialogHelper",function(n,t,i,r,u,f,e,o,s){"user strict";function p(n,t,r,u,f){var e=n.member,o=h.crMemberRole;if(!o.Role.DeleteMembers){s.openDialogNotPermitted(f);return}o.UserId!==e.UserId&&i.dropUserFromAlliance(e.UserName,e.UserId,f)}function w(t,r,u,f,e){var o=t.member,v=h.crMemberRole,y=o.UserName,c,l,p;if(v.Role.CanManagePermition&&o.UserId!==v.UserId&&(o.UserName!==a||o.Role.Id!==i.Role.roleNativeNames.CreatorId)){if(c=h.selectedRoleModel,l=c.TranslateName,c.Id===o.Role.Id){s.openDialogRoleNotChanged(y,l,e);return}p=h.getTranslateRoleName(o.Role.RoleName);s.openDialogChangeRole(p,y,l,e).then(function(){console.log("update user role",{member:o,selectedRole:c,selectRole:_.cloneDeep(h.allianceMembers.Roles[c.Id]),roles:h.selectRoles});i.Role.requestUpdateUserRole(o.AllianceUserId,y,o.UserId,c.Id,l,e,n)},function(){console.log("Cancel")});console.log("updateUserRole",{member:o,selectRole:c,curRole:v})}}function v(n,t){return c[0].ConstructorSizeBtn(t,!0,"deleteUserBtn",p,{member:n}),c[0]}function y(n,t){return c[1].ConstructorSizeBtn(t,!0,"updateUserRoleBtn",w,{member:n}),c[1]}function b(n){var t=h.crMemberRole.Role;return n.UserId===h.crMemberRole.UserId?[]:n.UserName===a&&t.Id!==i.Role.roleNativeNames.CreatorId?[]:t.DeleteMembers&&t.CanManagePermition?[v(n,3),y(n,3)]:t.DeleteMembers?[v(n,1)]:t.CanManagePermition?[y(n,1)]:[]}function l(){e.applyTimeout(function(){var n,t;h.allianceMembers=i.getMyAllianceMembers();h.members=h.allianceMembers.Members;n=_.size(h.members);h.memberCount&&h.memberCount===n||(h.memberCount=n,h._updateMembers=!0);t=h.allianceMembers.TranslateRoleNames;h.crMemberRole=i.getCurrentUserMemberFromMembers(h.members);h.getTranslateRoleName=function(n){return i.Role.getTranslateRoleName(t,n)};h.selectRoles=i.Role.createSelectRoles(t);h.selectedRoleModel=null;h.setInitialSelectedRole=function(n){h.selectedRoleModel=_.find(h.selectRoles,function(t){return t.Id===n})};h.roleDescription="";h.memberSettingToggle=function(n){n.hasOwnProperty("setting")||(n.setting=r.create());h.selectedRoleModel&&h.selectedRoleModel.Id===n.Role.Id||h.setInitialSelectedRole(n.Role.Id);n.setting.toggle();h.roleDescription=h.allianceMembers.Roles[n.Role.Id].translateRoleHtmlDescription};i.Role.initRolesView(h._rolesView,h.allianceMembers.Roles);h.onselectedRoleChange=function(){h.roleDescription=h.allianceMembers.Roles[h.selectedRoleModel.Id].translateRoleHtmlDescription}})}var h=this,c=[f.ButtonsView(),f.ButtonsView()],a;h._rolesView={};h._updateMembers=!0;a=i.getMyAllianceData().LeaderName;Object.defineProperty(h,"updateMembers",{get:function(){return h._updateMembers?(h._updateMembers=!1,!0):!1}});h.getProfileInfo=function(n){o.setProfile(n)};h.onLinkHover=function(){EM.Audio.GameSounds.defaultHover.play()};h.getRolePropsView=function(n){return h._rolesView[n]};h.getManageBtns=b;l();t.$watch("amCtrl.serchMemberRequest",function(n,i){n!==i&&t.$emit("dropElementContainer:changeHeight")});t.$watch("amCtrl.onlyOnline",function(n,i){n!==i&&t.$emit("dropElementContainer:changeHeight")});t.$on("planshet:update",function(){i.isCurrentModel()&&(h._updateMembers=!0,l())});t.$on("alliance:user-left-from-alliance",function(n,t){if(i.isCurrentModel()){h._updateMembers=!0;l();var r=t.leftAllianceId,u=t.leftUserId}});t.$on("alliance:user-join-to-alliance",function(){i.isCurrentModel()&&(h._updateMembers=!0,l())});t.$on("$destroy",function(){t.amCtrl=null;delete t.amCtrl})}]);Utils.CoreApp.gameApp.controller("allianceTechCtrl",["$scope","allianceService",function(n,t){"user strict";var i=this;this.$data=t.getMyAllianceData();this.BalanceCCTitle="Alliance balance CC : ";this.TechList=t.prepareTechList(this.$data);n.$on("alliance:tech-updated",function(n,r){i.$data=r.myAllianceData;i.TechList=t.prepareTechList(i.$data)})}]);Utils.CoreApp.gameApp.controller("allianceManageCtrl",["$scope","allianceService","mainHelper",function(n,t,i){function u(n){var e=t.getMyAllianceMembers(),f=t.getManageTabData(),o,u;f&&e&&e.Members&&(n&&r._crAm&&r._crAm.AllianceUserId!==n.AllianceUserId||(o=r._crAm=n||t.getCurrentUserMemberFromMembers(e.Members),u=o.Role,i.applyTimeout(function(){r.permitions=u;r.notPermitted=!(u.AcceptNewMembers||u.EditAllianceInfo||u.SetTech);r.canDeleteAlliance=f.CanDeleteAlliance;f.CanDeleteAlliance&&(r.disbandAlliance=f.DisbandAllianceBtn)})))}var r=this;r.notPermitted=!0;r.canDeleteAlliance=!1;u();n.$on("alliance:user-role-updated",function(n,i){t.isCurrentModel()&&u(i.allianceMember)});n.$on("planshet:update",function(){t.isCurrentModel()&&u()});n.$on("$destroy",function(){n.alManage=null;delete n.alManage})}]);Utils.CoreApp.gameApp.controller("allianceManageRequestCtrl",["$scope","allianceService","dropableElementHelper","profileService","$timeout",function(n,t,i,r,u){function e(){var e=t.$currentUserInfo,o=t.getManageTabData(),i=o.AllianceUserRequests,s=4;f.auRequestsLoaded=!1;f.requests=i.Requests;f.complexButtonView=i.ComplexButtonView;f.onClickCbRequests=function(){n.dropElementonClickByDropable(s)};f.currentAllianceName=e.allianceName;f.getProfileInfo=function(n){r.setProfile(n)};f.requestToggle=function(i){var r=i.hasOwnProperty("ButtonsView");r?i.dropable.toggle(function(){n.$emit("dropElementContainer:changeHeight")}):(t.createAllianceManageRequestBtns(i),u(function(){i.dropable.toggle(function(){n.$emit("dropElementContainer:changeHeight")})},50))}}var f=this;e();n.$on("alliance:user-role-updated",function(n,i){i.IsCurrentUser&&i.allianceMember.Role.AcceptNewMembers&&t.isCurrentModel()&&e()})}]);Utils.CoreApp.gameApp.controller("allianceRequestSendMsgCtrl",["$scope","$mdDialog",function(n,t){var i=this;this.title=i._title||"Create Message";this.from=i._fromName;this.to=i._toName;this.message=i._message;this.messageMaxLength=i._maxLength||1e3;this.messageMinLength=i._minLength||5;this.send=function(){t.hide(i.message)};this.cancel=function(){t.cancel()}}]);Utils.CoreApp.gameApp.controller("allianceUserRequestsCtrl",["$scope","allianceService","$timeout",function(n,t,i){var r=t.getRequestsFromMyAlliance(),u=t.$currentUserInfo;this.currentUserName=u.userName;this.data=r;this.requests=r.Requests;this.requestToggle=function(r){var u=r.hasOwnProperty("ButtonsView")&&r.ButtonsView;u?r.dropable.toggle(function(){n.$emit("dropElementContainer:changeHeight")}):(t.createMyAllianceRequestBtns(r),i(function(){r.dropable.toggle(function(){n.$emit("dropElementContainer:changeHeight")})},50))}}]);Utils.CoreApp.gameApp.controller("allianceEditInfoCtrl",["$scope","allianceService","mainHelper",function(n,t){function i(){t.setEditAllianceInfoModelToScope(r,n,u)}var r=this,u=4;i();n.$on("planshet:update",function(n){t.isCurrentModel()&&i(n)});n.$on("$destroy",function(){n.aeiCtrl=null;delete n.alManage})}]),function(){"use strict";function n(n,t,i,r,u){function h(n,t){return _.filter(t,function(t){return t.hasOwnProperty("value")?t.value.indexOf(n)!==-1:!1})}function e(n){var t=null,i=null;return n&&(t=n.toUpperCase(),i=n),{value:t,display:i}}function c(){var n=o.curItem;return n.hasOwnProperty("value")&&typeof n.value=="string"?n.value:null}var s=!0,o,f;this.isDisabled=!1;o=this;f=!1;this.isValide=!1;this.querySearch=function(i){if(!i||i.length===0||!(t instanceof Function)||f)return null;f=!0;var r=n.defer();return i=i.toUpperCase(),t(i,function(n){n||(n=[]);var t=h(i,n.map(function(n){return e(n)}));(f=!1,t)&&r.resolve(t)}),r.promise};this.curItem=e();this.selectedItemChange=function(n){n&&n.hasOwnProperty("value")?(this.curItem=n,this.isValide=!0,u instanceof Function&&u(this.curItem)):(this.isValide=!1,u instanceof Function&&u(null))};this.searchTextChange=function(n){s&&console.log("Text changed to",{newText:n});this.curItem=e(n);r instanceof Function&&r(n)};this.getNotFoundMsg=function(){var n="";return this.curItem&&this.curItem.hasOwnProperty("display")&&this.curItem.display&&(n=this.curItem.display),"Not Found "+n};this.getPlaceholder=i instanceof Function?i:function(){return"Search:"};this._getCurVal=c;this.clear=function(n,t){var r=angular.element("#"+n),i;r&&(i=r.scope(),console.log("clear",i),i&&i.$parent&&i.$parent.$mdAutocompleteCtrl&&i.$parent.$mdAutocompleteCtrl.clear());t instanceof Function&&t()}}function t(t,i,r,u){function e(){f.clear(f.spySerchInputId)}var f=this;this.getSpyButtonFromSerch=u.getSpyButtonFromSerch;n.call(this,i,function(n,t){r.getPlanetNames(n,t,r.serchPlanetType.OtherUsers)},function(){return"Enter planet name: "});this.spySerchInputId="spy-serch-planet";t.clear=e;t.getSpyTargetPlanetName=this._getCurVal;t.$on("gameCtrl:estate-changed",function(n,t){var i=t.newVal;e()})}function i(t,i,r,u,f,e,o){function y(){s.clear("task-serch-planet",function(){f.resetTaskForm(t)})}function a(n,t){t&&(s.searchText=n);s.isValide=r.containPlanetName(f.getSerchType(),n);s.taskTargetPlanetName=s.isValide?n:s._getCurVal()}function p(n){var t=i.defer();return f.calculateFleetTime(t,n),t.promise.then(function(t){console.log("taskPlanetSerchCtrl.calcTime");n===s.taskTargetPlanetName?(h=n,s.transferTimeVal=t):(s.transferTimeVal=c,h=null);l=!1},function(n){s.transferTimeVal=c;h=null;l=!1;var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({$self:s,msg:t},"taskPlanetSerchCtrl.calcTime.error");}),t.promise}var c,h,s,v,l;this.showTaskForm=!1;this.taskTargetPlanetName=null;this.getNewTaskButtons=u.getNewTaskButtons;this.getTaskActionButtons=u.getTaskActionButtons;this.taskSourceUnits=e.getCloneObjectHangarData();this.taskTargetUnits=u.getTaskTargetUnits();this.taskTransferTypeIsTransfer=!1;this.transferTypeName="";this.transferTimeName="";c="--:--:--";this.transferTimeVal=c;this.activate=!1;h=null;this.unitsIsValid=!1;this.resultIsValid=!1;this.minLength=3;s=this;v=500;this.setResultIsValid=function(n){s.unitsIsValid=n;s.resultIsValid=s.isValide&&s.unitsIsValid};this.closeTaskForm=function(n){s.activate=!1;y();n?s.showTaskForm=!1:o(function(){s.showTaskForm=!1},v)};this.taskErrors=f.taskErrors;this.setTransferType=function(n){this.minLength=n?1:3;s.taskTransferTypeIsTransfer=n;s.transferTypeName=f.getTransferTypeName(n);s.transferTimeName=f.getTransferTimeName();s.transferTimeVal=c};this.updateShowTaskError=function(n,t){n&&s.taskErrors.hasOwnProperty(n)&&(s.taskErrors[n].showError=t)};l=!1;t.$watch("ctrl.isValide",function(n,t){!n||n===t||h||h===s.taskTargetPlanetName||l?(s.transferTimeVal=c,h=null):(l=!0,p(s.taskTargetPlanetName))});t.$on("taskPlanetSerch:showTaskForm",function(n,i,r,u){n.stopPropagation();s.taskErrors.resetErrors();u instanceof Function&&u(t);i?(s.showTaskForm=i,a(r,!0),o(function(){s.activate=!0},150)):s.closeTaskForm()});t.$on("taskPlanetSerch:changeTransferUnit",function(n,t,i){n.stopPropagation();t(n,i)});t.$on("gameCtrl:estate-changed",function(n,i){var r=i.newVal;t.ctrl.closeTaskForm();l=!1});n.call(this,i,function(n,t){r.getPlanetNames(n,t,f.getSerchType(),!0)},function(){return"Enter planet name: "},null,function(n){n?a(n.value,!1):a(null,!1)})}t.prototype=Object.create(n.prototype);Utils.CoreApp.gameApp.controller("spyPlanetSerchCtrl",["$scope","$q","mapInfoService","journalService",t]);i.prototype=Object.create(n.prototype);Utils.CoreApp.gameApp.controller("taskPlanetSerchCtrl",["$scope","$q","mapInfoService","journalService","journalHelper","hangarService","$timeout",i])}();Utils.CoreApp.gameApp.controller("bookmarkCtrl",["$scope","bookmarkService",function(n,t){this.planetItems=t.getPlanetItems;this.systemItems=t.getSystemItems;this.sectorItems=t.getSectorItems}]);Utils.CoreApp.gameApp.controller("buildCtrl",["$scope","industrialComplexService","spaceShipyardService",function(n,t,i){function f(){r=n.planshetModel;u.$buildCollection=r.Bodys[0].TemplateData}function e(n,t){n!==t&&GameServices.mainHelper.applyTimeout(function(){f()})}var u=this,r;this.$buildCollection=null;f();this.getBuildCollection=function(){return u.$buildCollection||f(),u.$buildCollection};this.storageStorableContainer=t.createStorageStorableContainer();this.getStorageTargetShowStatus=t.getStorageTargetShowStatus;this.registerStorageSlider=t.registerStorageSlider;this.extractionContainer=t.getExtractionContainer();this.registerExtractionSlider=t.registerExtractionSlider;this.getExtractionPowerData=t.getExtractionPowerData;this.getExchangeCourceData=t.getExchangeCourceData;this.energyConverterContainer=t.getEnergyConverterContainer();this.registerEnergyConverterSlider=t.registerEnergyConverterSlider;this.exchangeInputModel=0;this.updateExchangeInputModel=t.updateExchangeInputModel;this.checkFloatProperty=function(n){return Number.isInteger(n)?n:Math.round(n*1e3)/1e3};this.updateUnitInputModel=i.updateUnitInputModel;n.$watch("planshetModel.UniqueId",e);n.$watch("planshetModel.IsMother",e);n.$on("planshet:update",function(n){r&&n.targetScope&&n.targetScope.planshetModel&&n.targetScope.planshetModel.UniqueId===r.UniqueId&&e(!0,!1)})}]);Utils.CoreApp.gameApp.controller("confederationCtrl",["$scope","confederationService",function(){}]);Utils.CoreApp.gameApp.controller("officersCtrl",["$scope","confederationService","profileService",function(n,t,i){function e(n){r.hasOfficers=n&&n.length;r.hasOfficers&&(r.list=n,r.$$president=t.getPresidentOfficerFromOfficerList(r.list),r.$$crIsPresident=u.userId===r.$$president.Elected.UserId)}var r=this,f=appL10n.getL10NCurrentLanguage(),u=t.$currentUserInfo;e(t.Officers.Officers);this.trDesctiption=function(){return"Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum."};this.trName=function(n){return n.Translate[f].Name};this.getAllianceInfo=function(n,i,f){var e=f?i.Elected:i.Appointed;console.log("officersCtrl.getAllianceInfo",{officer:i,isElected:f,data:e,$event:n});e&&(e.UserId?e.AllianceId:!f&&e.Elected===!1&&r.$$crIsPresident&&t.officerOpenFormSetOfficer(n,e,r.$$president.Elected,u,r.trName(i)))};this.getUserInfo=function(n,f,e){var o=e?f.Elected:f.Appointed;console.log("officersCtrl.getUserInfo",{officer:f,isElected:e,data:o,$event:n});o&&(o.UserId?i.setProfile(o.UserId):!e&&o.Elected===!1&&r.$$crIsPresident&&t.officerOpenFormSetOfficer(n,o,r.$$president.Elected,u,r.trName(f)))};n.$on("election:finished",function(n){_.isEqual(r.list,n.newListIOfficerOut)?console.log("officersCtrl.election:finished.isEqual"):e(n.newListIOfficerOut);console.log("electionCtrl.election:finished",{data:n,$self:r})})}]);Utils.CoreApp.gameApp.controller("dialogSetOfficerCtrl",["$scope","$mdDialog","confederationService","$q","userNameSercherService","maxLenghtConsts",function(n,t,i,r,u,f){var e=this,o={$title:"Set officer",$userNameMaxLenght:f.UniqueName,postName:e._locals.postName},s,h;this.model=o;s=i.officerGetExistOfficerNames();h=u.createIgnoreNamesWithNpc(s);this.lockInfo=!0;this.serchInputId=Utils.Guid.CreateGuid();this.searchText=null;this.onTextChange=function(n){(console.log("onTextChange",{text:n}),e.model.To&&e.model.To.Name)&&n!==e.model.To.Name&&n.toLowerCase()===e.model.To.Name.toLowerCase()&&(e.searchText=e.model.To.Name)};this.serchInLock=!1;this.querySearch=function(n){var t=r.defer();return e.serchInLock&&t.reject(),e.serchInLock=!0,u.filterAsync(n).then(function(n){var i=u.filterByIgnoreNames(n,h);t.resolve(i);e.serchInLock=!1},function(){e.serchInLock=!1}),t.promise};this.messages={required:"This is a required field",serchRequireMmatch:"This requireMmatch.",serchNotFounded:"not founded",serchMaxlength:"The user name must be less than "+o.$userNameMaxLenght+" characters long."};this.onSelectedItemChange=function(n){e.lockInfo=n&&n.Id?!1:!0;console.log("onSelectedItemChange",{item:n,text:e.searchText})};this.getUserInfo=function(){!e.serchInLock&&e.model.To&&e.model.To.Id&&GameServices.profileService.setProfile(e.model.To.Id)};this.lockUpdate=!1;this.send=function(){var r,u;e.lockUpdate||(o.To&&o.To.Id||console.log("send.validateion.error: no model to",{model:o,$self:e}),e.lockUpdate=!0,e.serchInLock=!0,r=_.cloneDeep(e._locals.targetOficer),r.UserId=o.To.Id,u=e._locals.presidentOfficer,i.$hub.confederationAddNewOfficer(r,u.Id,u.UserId).then(function(i){console.log("dialogSetOfficerCtrl.send.ok",{answerOk:i,$self:e});t.hide(n)},function(n){var t=Errors.GetHubMessage(n),i={msg:t,errorAnswer:n,$self:e};e.lockUpdate=!1;e.serchInLock=!1;throw Errors.ClientNotImplementedException(i,"dialogSetOfficerCtrl.send.error");}),console.log("dialogSetOfficerCtrl.send",{userOfficerOut:r,president:u,$self:e}))};this.cancel=function(){console.log("dialogSetOfficerCtrl.cancel",{$self:e});t.cancel(n)}}]);Utils.CoreApp.gameApp.controller("userRatingCtrl",["$scope","confederationService","profileService","$q","userNameSercherService",function(n,t,i,r,u){var f=this,e=t.Rating,h=!0,o,s;this.scrollDataInProgress=!1;o=!0;Object.defineProperty(this,"scrollDisabled",{get:function(){return o||f.scrollDataInProgress}});this.useScroll=!0;s=e.PerPage;this.users=[];this.loadNextPage=function(){var n,i;if(!this.scrollDataInProgress){if(h){t.ratingAddAndTakeLocalUsers(e.Users,this.users,e.PerPage);n=this.users.length;n<s&&(e.$totalCount=n);h=!1;return}if(!e.$totalCount||this.users.length!==e.$totalCount){if(this.scrollDataInProgress=!0,i=this.users.length,!i){this.scrollDataInProgress=!1;return}if(e.Users[i]){t.ratingAddAndTakeLocalUsers(e.Users,f.users,s);t.ratingCheckAndFixUniqe(f);f.scrollDataInProgress=!1;return}t.ratingGetNextPage(e,function(n){var i=_.size(n);i===0?e.$totalCount=f.users.length:(t.ratingAddUserItemsToOld(f.users,n),t.ratingCheckAndFixUniqe(f));f.scrollDataInProgress=!1},function(){f.scrollDataInProgress=!1});return}}};this.getUserInfo=function(n){i.setProfile(n.UserId)};this.serchedUser=null;this.inLoc=!1;this.serchPlaceholder=GameServices.translateService.getCommon().serch;this.searchText=null;this.onTextChange=function(n){n!==""&&n||(f.useScroll=!0,f.serchedUser=null)};this.selectedSerchedItem=null;this.querySearch=function(n){var t=r.defer();return u.filterAsync(n).then(function(n){var i=u.ignoreNpcFilter(n);t.resolve(i)}),t.promise};this.onSelectedItemChanded=function(n){n?f.useScroll&&(f.inLoc=!0,t.ratingGetUserItem(n.Id,e.Users,function(n){n&&(f.serchedUser=n,f.useScroll=!1);f.inLoc=!1},function(n,t,i){console.log("userRatingCtrl.onSelectedItemChanded.error",{errorAnswer:n,msg:t,errorData:i,$self:f});f.inLoc=!1})):(f.useScroll=!0,f.serchedUser=null)};n.$watch("body.active",function(n,t){n!==t&&(o=!n)})}]);Utils.CoreApp.gameApp.controller("electionCtrl",["$scope","$rootScope","confederationService","profileService","$q","userNameSercherService",function(n,t,i,r){var u=this;this.model=i.getElectionData();this.getUserInfo=function(n){r.setProfile(n.UserId)};this.lockedAddVoice=!1;this.addVoice=function(n,r){u.lockedAddVoice||(u.lockedAddVoice=!0,i.addVoiceToOfficer(n,r,u.model.$params,function(){u.lockedAddVoice=!1},function(n){u.lockedAddVoice=!1;console.log("electionCtrl.addVoice.error",{msg:n})},t))};n.$on("election:finished",function(n,t){_.isEqual(u.model,t.election)?console.log("isEqual.electionCtrl.election:finished.isEqual"):u.model=t.election;console.log("electionCtrl.election:finished",{$event:n,data:t,$self:u})});n.$on("election:update-candidates",function(n,t){_.isEqual(u.model.Candidates,t.Candidates)?console.log("isEqual.electionCtrl.election:update-candidates"):u.model.Candidates=t.Candidates;console.log("electionCtrl.election:update-candidates",{$event:n,data:t,$self:u})});n.$on("election:cr-user-voice-added",function(n,t){_.isEqual(t.params,u.params)?console.log("isEqual.electionCtrl.election:cr-user-voice-added"):u.model.$params=t.params;console.log("electionCtrl.election:update-candidates",{$event:n,data:t,$self:u})})}]);Utils.CoreApp.gameApp.controller("gameCtrl",["$scope","$rootScope","$compile","buildReqHelper","buildService","commandCenterService","industrialComplexService","laboratoryService","spaceShipyardService","mainGameHubService","allianceService","bookmarkService","confederationService","estateService","gameChestService","hangarService","journalService","mapInfoService","userChannelsService","planshetService","profileService","resourceService","tabService","translateService","unitDialogService","controlDiskHelper","controlPanelSwicherHelper","dropableElementHelper","journalHelper","mainHelper","mapControlHelper","mapInfoHelper","npcHelper","paralaxButtonHelper","planshetHelper","scrollerHelper","statisticHelper","techTreeHelper","timerHelper","uploadHelper",function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct,lt,at,vt,yt,pt,wt,bt,kt){"use strict";function dt(t){st.applyTimeout(function(){n.planshetModel=d.getCurrentModel();t instanceof Function&&t();n.$broadcast("planshet:update")})}n.planshetModel=d.getCurrentModel();this.isActiveTab=function(n){return tt.isActiveTab(n)};this.activateTabByIdx=function(n){tt.activateTabByIdx(n)};GameServices._updatePlanshet=n.updatePlanshet=dt;var gt={buildReqHelper:r,buildService:u,commandCenterService:f,industrialComplexService:e,laboratoryService:o,spaceShipyardService:s,mainGameHubService:h,allianceService:c,bookmarkService:l,confederationService:a,estateService:v,gameChestService:y,hangarService:p,journalService:w,mapInfoService:b,userChannelsService:k,planshetService:d,profileService:g,resourceService:nt,tabService:tt,translateService:it,unitDialogService:rt,controlDiskHelper:ut,controlPanelSwicherHelper:ft,dropableElementHelper:et,journalHelper:ot,mainHelper:st,mapControlHelper:ht,mapInfoHelper:ct,npcHelper:lt,paralaxButtonHelper:at,planshetHelper:vt,scrollerHelper:yt,statisticHelper:pt,techTreeHelper:wt,timerHelper:bt,uploadHelper:kt};GameServices.Init(gt);this.setEstateBuilds=function(n){r.addBuildsToPlanshet(n)};this.setCtrlData=function(n){at.setBaseBtns(n);ht.init()};this.setTranslate=function(n){it.init(n)};this.setPersonalData=function(n){g.setInitDataCurrentUser(n)};this.setResources=function(n){nt.init(n)};this.setServerTime=function(n){Utils.Time.LOCAL_SERVER_DELTA_TIME=0;Utils.Time.LOCAL_SERVER_DELTA_TIME=n-Utils.Time.GetUtcNow(!0);Object.freeze(Utils.Time)};this.setInitialAlliance=c.setInitialAlliance;this.setAllianceNames=c.setAllianceNames;this.setInitialUserChannelsModel=k.setInitialUserChannelsModel;this.setInitialConfederationsModel=a.setInitialConfederationsModel;this._$broadcastEstateId=function(n){t.$broadcast("gameCtrl:estate-changed",{newVal:n})};this.skagryLoaded=!1;this.loadGame=function(t){v.loadGame(n,t)};n.$on("user:join-to-game",function(n,t){var r=t.CurrentConnectionUser.UserId,i=t.ConnectedUserId,u=t.ConnectedAllianceId,f=t.OnlineTotalCount;if(r!==i)c.onOtherUserConnected(i,u,f)});n.$on("user:left-game",function(n,i){console.log("gameCtrl.$on user:left-game",{event:n,disconnectedConnectionUser:i});c.onUserLeftGame(i,t)})}]);Utils.CoreApp.gameApp.controller("journalCtrl",["$scope","planshetService","tabService","journalService","hangarService","journalHelper","mapInfoService","mainHelper",function(n,t,i,r,u,f,e,o){var s={};this.getTaskCollection=r.getTaskCollection;this.getReportCollection=r.getReportCollection;this.getReportDeleteBtn=r.getReportDeleteBtn;this.getSpyCollection=r.getSpyCollection;this.getLocalMotherJump=r.getLocalMotherJump;this.hasJumpMother=r.hasJumpMother;this.updateJScope=function(t){s={};t instanceof Function&&o.applyTimeout(function(){t(n)})};this.getProfileInfo=function(n){GameServices.profileService.setProfile(n)};n.updateSimpleTimer=r.updateSimpleTimer;n.$on("journalCtrl:initializeScrollReport",function(n,t,i){i==="journal-report"&&(n.stopPropagation(),r.initializeReportScroll(t))});n.$on("journalCtrl:initializeScrollSpy",function(n,t,i){i==="journal-spy"&&(n.stopPropagation(),r.initializeSpyScroll(t))});this.getReportInfoButtons=function(n){if(n.$btnKey&&s[n.$btnKey])return s[n.$btnKey];var t,i=n.IsReport;return i?(t=r.getReportInfoButtons(n),t.push(r.getReportDeleteBtn(n))):(t=r.getSpyInfoButtons(n),t.push(r.getSpyAtkBtn(n)),t.push(r.getSpyDeleteBtn(n))),n.$btnKey=Utils.Guid.CreateQuickGuid(),s[n.$btnKey]=t,t};this.userNameIsSkagry=function(n){return GameServices.npcHelper.isNpc(n)}}]);Utils.CoreApp.gameApp.controller("mapInfoCtrl",["$scope","mapInfoService",function(n,t){this.getPlanetoidInfo=t.getPlanetoidInfo;n.$on("planshet:update",function(t){n.$broadcast("mapinfo:planshet:update",{planshetEvent:t})})}]);Utils.CoreApp.gameApp.controller("profileCtrl",["$scope","profileService",function(n,t){this.setProfileModel=t.setProfile;this.hasCheset=t.hasCheset;n.$on("user:avatar-updated",function(){GameServices._updatePlanshet()})}]);Utils.CoreApp.gameApp.controller("techTreeDialogCtrl",["$scope","$mdDialog","techTreeData",function(n,t,i){this.$title="Tech tree";this.rows=i.rows;EM.Audio.GameSounds.dialogOpen.play();this.cancel=function(){EM.Audio.GameSounds.dialogClose.play();t.cancel(n)}}]).directive("techTreeRow",[function(){return{restrict:"E",template:"<div class='tech-row' layout='row' layout-align='start center'><tech-tree-item item='row[0]'><\/tech-tree-item><tech-tree-item item='row[1]'><\/tech-tree-item><tech-tree-item item='row[2]'><\/tech-tree-item><\/div>",replace:!0,scope:{row:"="}}}]).directive("techTreeItem",[function(){return{restrict:"E",template:"<div flex='100' layout='column' layout-align='start center'><div layout='column' layout-align='start center'><div class='relative'><span class='tech-level' ng-bind='item.minLevel' ng-if='item.minLevel'><\/span><border-animation-item border='item.border'><\/border-animation-item><\/div><div class='tech-name' ng-bind='item.translateTechName'><\/div><\/div><\/div>",replace:!0,scope:{item:"="}}}]).service("techTreeHelper",["$mdDialog","paralaxButtonHelper",function(n,t){function u(n,t,i,r){this.NativeName=n;this.CssTechClass=t;this.TranslateNames=null;this.TechWeaponUpgrade={MinLevel:i};this.TechDamageControl={MinLevel:r}}function f(){this.TechWeaponUpgrade=new u(r.TECH_NAMES.TechWeaponUpgrade,"tech-wu",0,0);this.TechWeaponUpgrade.TranslateNames=Utils.CreateLangSimple("EN WeaponUpgrade","ES WeaponUpgrade","RU WeaponUpgrade");this.TechDamageControl=new u(r.TECH_NAMES.TechDamageControl,"tech-dc",0,0);this.TechDamageControl.TranslateNames=Utils.CreateLangSimple("EN DamageControl","ES DamageControl","RU DamageControl");this.TechDrone=new u(r.TECH_NAMES.TechDrone,"tech-drone",0,0);this.TechDrone.TranslateNames=Utils.CreateLangSimple("EN Drone","ES Drone","RU Drone");this.TechFrigate=new u(r.TECH_NAMES.TechFrigate,"tech-frigate",8,8);this.TechFrigate.TranslateNames=Utils.CreateLangSimple("EN Frigate","ES Frigate","RU Frigate");this.TechBattlecruiser=new u(r.TECH_NAMES.TechBattlecruiser,"tech-battlecruiser",15,15);this.TechBattlecruiser.TranslateNames=Utils.CreateLangSimple("EN Battlecruiser","ES Battlecruiser","RU Battlecruiser");this.TechBattleship=new u(r.TECH_NAMES.TechBattleship,"tech-battleship",23,23);this.TechBattleship.TranslateNames=Utils.CreateLangSimple("EN Battleship","ES Battleship","RU Battleship");this.TechDreadnout=new u(r.TECH_NAMES.TechDreadnout,"tech-drednout",35,35);this.TechDreadnout.TranslateNames=Utils.CreateLangSimple("EN Dreadnout","ES Dreadnout","RU Dreadnout")}function h(n,i){return"sprite_atlas "+(i?"alliance":"user")+"-tech "+n+" "+t.BUTTONS_CONSTANTS.M}function e(n,i){var r={ImagePathOrCss:h(n,i)};return t.SectionItem().BorderAnimView(t.BUTTONS_CONSTANTS.M,!1,r)}function o(n,t,i){this.border=n;this.minLevel=i;this.translateTechName=t}function c(n){for(var u=[],r=0;r<5;r++){var t=s[r],f=new o(e(i.TechWeaponUpgrade.CssTechClass,n),i.TechWeaponUpgrade.TranslateNames.getCurrent(),t.TechWeaponUpgrade.MinLevel),h=new o(e(i.TechDamageControl.CssTechClass,n),i.TechDamageControl.TranslateNames.getCurrent(),t.TechDamageControl.MinLevel),c=new o(e(t.CssTechClass,n),t.TranslateNames.getCurrent()),l=[f,h,c];u.push(l)}return u}var r=this,i,s;this.TECH_NAMES={TechWeaponUpgrade:"TechWeaponUpgrade",TechDamageControl:"TechDamageControl",TechDrone:"TechDrone",TechFrigate:"TechFrigate",TechBattlecruiser:"TechBattlecruiser",TechBattleship:"TechBattleship",TechDreadnout:"TechDreadnout"};Object.freeze(this.TECH_NAMES);f.prototype.getUnitTechesArray=function(){return[this.TechDrone,this.TechFrigate,this.TechBattlecruiser,this.TechBattleship,this.TechDreadnout]};f.prototype.clone=function(){return _.cloneDeep(this)};i=new f;s=i.getUnitTechesArray();this.createTechTreeDialog=function(t,i){n.show({templateUrl:"dialog-tech-tree.tmpl",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!1,fullscreen:!1,locals:{techTreeData:{rows:c(i)}},controller:"techTreeDialogCtrl",controllerAs:"ttdCtrl"}).then(function(n){n.$destroy()},function(n){n.$destroy()})};Object.defineProperty(this,"$techConfig",{get:function(){return i.clone()}});this.getNativeNames=i.getNativeNames}]);Utils.CoreApp.gameApp.controller("unitDetailDialogCtrl",["$scope","$mdDialog","unitDialogService","unitDetailDialogData",function(n,t,i,r){var u=_.extend(this,i.CreateUnitDetailUnitView(r.unit));EM.Audio.GameSounds.dialogOpen.play();this.cancel=function(){EM.Audio.GameSounds.dialogClose.play();t.cancel()}}]).controller("unitBuyDialogCtrl",["$scope","$mdDialog","unitDialogService","unitBuyDialogData",function(n,t,i,r){var u=_.extend(this,i.CreateBuyUnitViewData(r));EM.Audio.GameSounds.dialogOpen.play();this.updateUnitInputModel=function(){u.hasError=u.$hasError();GameServices.spaceShipyardService.updateUnitInputModel(r.dataUnit)};this.cancel=function(){EM.Audio.GameSounds.dialogClose.play();t.cancel()};this.buy=function(){if(!this.$hasError()){var i=this.Update.Buttons.Submit;console.log([this,i]);try{i.Method(i.Params);t.hide(n)}catch(r){}}};n.$watch("ubdCtrl.errorModels.count.isError",function(n,t){n!==t&&GameServices.mainHelper.applyTimeout(function(){u.errorModels.count.isError=n})});n.$watch("ubdCtrl.hasError",function(n,t){n!==t&&GameServices.mainHelper.applyTimeout(function(){u.hasError=u.$hasError()})})}]);Utils.CoreApp.gameApp.controller("techDetailDialogCtrl",["$scope","$mdDialog","unitDialogService","techDetailDialogData",function(n,t,i,r){_.extend(this,i.CreateTechDetailView(r));EM.Audio.GameSounds.dialogOpen.play();this.cancel=function(){EM.Audio.GameSounds.dialogClose.play();t.cancel()}}]).controller("techBuyDialogCtrl",["$scope","$mdDialog","unitDialogService","techBuyDialogData",function(n,t,i,r){var u=_.extend(this,i.CreateBuyTechViewData(r));EM.Audio.GameSounds.dialogOpen.play();this.updateTechInputModel=function(){u.hasError=u.$hasError()};this.cancel=function(){EM.Audio.GameSounds.dialogClose.play();t.cancel()};this.buy=function(){if(!this.$hasError()){var i=this.Update.Buttons.Submit;try{i.Method(i.Params);t.hide(n)}catch(r){}}};n.$watch("tbdCtrl.hasError",function(n,t){n!==t&&GameServices.mainHelper.applyTimeout(function(){u.hasError=u.$hasError()})})}]);Utils.CoreApp.gameApp.directive("unitPriceInDialog",[function(){function n(){}return{restrict:"E",templateUrl:"unit-price-in-dialog.tmpl",scope:{priceItem:"=",canBuyMultipleItems:"=?",onInputDataChange:"="},link:n}}]);Utils.CoreApp.gameApp.directive("unitErrorsBuyInDialog",[function(){function n(n){console.log("unitErrorsBuyInDialog",{$scope:n})}return{restrict:"E",templateUrl:"unit-errors-buy-in-dialog.tmpl",scope:{priceItem:"="},link:n}}]);Utils.CoreApp.gameApp.service("unitDialogService",["techTreeHelper","$mdDialog","baseDialogHelper",function(n,t,i){"use strict";function p(n,t,i,u,f,e,o,s){var a=t.Attack||0,v=i.Info.Data.Properties.Atack.CurrentValue||0,h,c,l;i.Info.Data.Properties.Level.CurrentValue||(v=0);h=u.Info.Data.Properties.Atack.CurrentValue||0;u.Info.Data.Properties.Level.CurrentValue||(h=0);c=f.Progress.Advanced.Atack.CurrentValue||0;f.Progress.Advanced.Level.CurrentValue||(c=0);l=e.Progress.Advanced.Atack.CurrentValue||0;e.Progress.Advanced.Level.CurrentValue||(l=0);var y=o.Attack||0,w=s.Attack||0,b=(v+h+c+l+y+w)*.01,p=a+a*b,k=n*p;return[r.KeyVal(t.AttackName,a),r.KeyVal(i.TranslateName,v+"%"),r.KeyVal(u.TranslateName,h+"%"),r.KeyVal(f.Text.Name,c+"%"),r.KeyVal(e.Text.Name,l+"%"),r.KeyVal("AtackBooser","0%"),r.KeyVal("Officer ("+t.AttackName+")",y+"%"),r.KeyVal("Sum "+t.AttackName,_.round(p,2)),r.KeyVal("Total stack",_.round(k,2))]}function w(n,t,i,u,f,e,o,s){var l=t.Hp||0,a=i.Info.Data.Properties.Hp.CurrentValue||0,h,c,v;i.Info.Data.Properties.Level.CurrentValue||(a=0);h=u.Info.Data.Properties.Hp.CurrentValue||0;u.Info.Data.Properties.Level.CurrentValue||(h=0);c=f.Progress.Advanced.Hp.CurrentValue||0;f.Progress.Advanced.Level.CurrentValue||(c=0);v=e.Progress.Advanced.Hp.CurrentValue||0;e.Progress.Advanced.Level.CurrentValue||(v=0);var y=o.Hp||0,p=s.Hp||0,b=(a+h+c+v+y+p)*.01,w=l+l*b,k=n*w;return[r.KeyVal(t.HpName,l),r.KeyVal(i.TranslateName,a+"%"),r.KeyVal(u.TranslateName,h+"%"),r.KeyVal(f.Text.Name,c+"%"),r.KeyVal(e.Text.Name,"0%"),r.KeyVal("StructureBooser",p+"%"),r.KeyVal("Officer ("+t.HpName+")",y+"%"),r.KeyVal("Sum "+t.HpName,_.round(w,2)),r.KeyVal("Total stack",_.round(k,2))]}function o(n){return"Tech"+n}function l(){this.Drone=o(f.Drone);this.Frigate=o(f.Frigate);this.Battlecruiser=o(f.Battlecruiser);this.Battleship=o(f.Battleship);this.Drednout=o(f.Drednout)}function u(n,t){return _.find(n,function(n){return n.NativeName===t})}function b(n){return n===f.Battlecruiser?"battleCruiserDescription":n===f.Battleship?"battleShipDescription":_.lowerFirst(n)+"Description"}function k(n,t){var i=_.find(n,function(n){return n.NativeName===t});return i.Info.Data.UnitStats}function d(){return r.IBattleStats()}function h(n,t,i){this.Title=n;this.Icon=t;this.Description=i}function g(n){console.log("UnitView",{unitData:n});var y=GameServices.spaceShipyardService.getBuildCollection(),g=b(n.NativeName),nt=GameServices.translateService.getUnit(),f=k(y,n.NativeName),t=n.Progress.Level||0,o=s.getTechName(n.NativeName),i=GameServices.laboratoryService.getCollection(),c=u(i,o),tt=u(i,e.TechWeaponUpgrade),it=u(i,e.TechDamageControl),rt=GameServices.allianceService.getAllianceTechModel(),r=rt.Teches,ut=r[e.TechWeaponUpgrade],ft=r[e.TechDamageControl],l=r[o],a=GameServices.confederationService.getOfficerBonusForCurrentUser(),v=d();_.extend(this,new h(n.Name+" ("+t+")",n.SpriteImages.Detail,nt[g]));this.Atack=new p(t,f,tt,c,ut,l,a,v);this.Structure=new w(t,f,it,c,ft,l,a,v)}function c(n,t,i,r){function u(){this.MinLevel=n;this.CurrentLevel=t;this.TranslateName=i;this.Description=r}return new u}function a(n){var t=i.setSpanText,r=i.cssSelectName,u=Utils.LangSimple(t("EN: недостаточный уровень технологии "+t(n.TranslateName,r)+" <br> необходимый уровень: "+t(n.MinLevel,r)+" <br> текущий уровень: "+t(n.CurrentLevel,r)),t("ES: недостаточный уровень технологии "+t(n.TranslateName,r)+" <br> необходимый уровень: "+t(n.MinLevel,r)+" <br> текущий уровень: "+t(n.CurrentLevel,r)),t("RU: недостаточный уровень технологии "+t(n.TranslateName,r)+" <br> необходимый уровень: "+t(n.MinLevel,r)+" <br> текущий уровень: "+t(n.CurrentLevel,r)));return u.getCurrent()}function nt(n){var t=i.setSpanText,r=i.cssSelectName,u=Utils.LangSimple(t("EN: технология "+t(n.TranslateName,r)+" не изучена"),t("ES: технология "+t(n.TranslateName,r)+" не изучена"),t("RU: технология "+t(n.TranslateName,r)+" не изучена"));return u.getCurrent()}function v(n,t,i,r){var o=e.TechWeaponUpgrade,f=e.TechDamageControl,s,h,p,l;n.errorModels={count:{isError:!1},resource:{e:{isError:!1,message:"недостаточно e"},ir:{isError:!1,message:"недостаточно ir"},dm:{isError:!1,message:"недостаточно dm"},cc:{isError:!1,message:"недостаточно cc"}}};n.errorModels.resource.$resetCcError=function(){n.errorModels.resource.cc.isError=!1};n.errorModels.resource.$resetMaterialresourcesErrors=function(){var t=n.errorModels.resource;t.e.isError=t.ir.isError=t.dm.isError=!1};var w=u(t,o),v=u(t,f),y=v.Update.Properties[0].CurrentValue,b=w.Update.Properties[0].CurrentValue;i&&(i[f]&&i[f]>y&&(s=c(i[f],y,v.TranslateName),s.Description=a(s),n.errorModels[f]=s),i[o]&&i[o]>b&&(h=c(i[f],y,v.TranslateName),h.Description=a(h),n.errorModels[o]=h));r&&(p=r.Update.Properties[0].CurrentValue,p<=0&&(l=c(1,0,r.TranslateName),l.Description=nt(l),n.errorModels.ProfileTech=l));n.$calcPrice=function(t){var i=Utils.ModelFactory.MaterialResources();return i.E=n.Price.E*t,i.Ir=n.Price.Ir*t,i.Dm=n.Price.Dm*t,i};n.hasError=!1;n.$hasResources=function(){var f=n.Update.upgradeCount,o=n.Price.forCc,e,i;if(o)return n.errorModels.resource.$resetMaterialresourcesErrors(),e=n.Price.Cc*f,i=GameServices.resourceService.isEnoughCc(e),n.errorModels.resource.cc.isError=!i,i;n.errorModels.resource.$resetCcError();var r=n.$calcPrice(f),t=n.errorModels.resource,u=GameServices.resourceService.getStorageResources().Current;return t.e.isError=u.E<r.E,t.ir.isError=u.Ir<r.Ir,t.dm.isError=u.Dm<r.Dm,!t.e.isError&&!t.ir.isError&&!t.dm.isError};n.$hasError=function(){n.errorModels.count.isError=n.Update.upgradeCount<1;var t=!n.$hasResources()||n.errorModels.count.isError||n.errorModels.ProfileTech||n.errorModels[o]||n.errorModels[f];return n.hasError=!!t,n.hasError};n.$hasError()}function y(n,t,i){n.Update=t;n.Update.upgradeCount=1;n.Price=n.Update.Price;n.Translate=i}function tt(n){var t=n.dataUnit,f=t.NativeName,e=n.hangarUnit,l=_.extend(this,new h(t.TranslateName,e.SpriteImages.Icon));y(this,t.Update,t.unitTranslate);var i=n.teches,o=s.getTechName(f),r=u(i,o),c=r.AdvancedData.TechOut.Conditions;v(this,i,c,r)}function it(n,t){var f=_.extend(this,new h(n.TranslateName+" ("+n.Progress.Level+")",n.Info.DropImage,n.Info.Description)),i;this.Stats=[];_.forEach(n.Info.infoStatsModel.stats,function(n){f.Stats.push(r.KeyVal(n.key,n.val))});this.HasConditions=!1;this.Conditions=[];i=n.AdvancedData.TechOut.Conditions;i&&(_.forEach(i,function(n,i){var o=u(t,i),e=r.KeyVal(o.TranslateName,n);e.$css="";o.Progress.Level<n&&(e.$css="red",e.Val=o.Progress.Level+"/"+n);f.Conditions.push(e)}),this.Conditions.length&&(this.HasConditions=!0))}function rt(n){var t=n.tech,i=t.AdvancedData.TechOut.Conditions,r=_.extend(this,new h(t.TranslateName,t.IconSelf));y(this,t.Update,t.unitTranslate);v(this,n.teches,i,null)}var r=Utils.ModelFactory,e=n.TECH_NAMES,f={Drone:"Drone",Frigate:"Frigate",Battlecruiser:"Battlecruiser",Battleship:"Battleship",Drednout:"Drednout"},s;Object.freeze(f);l.prototype.getTechName=function(n){return this[n]};s=new l;Object.freeze(s);this.CreateBuyUnitViewData=function(n){return new tt(n)};this.CreateUnitDetailUnitView=function(n){return new g(n)};this.CreateUnitDetailDialog=function(n,i,r){var u=t.show({templateUrl:"unit-detail-dialog.tmpl",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,fullscreen:!0,locals:{unitDetailDialogData:{unit:GameServices.hangarService.getPanelUnitData(r),tech:{}}},controller:"unitDetailDialogCtrl",controllerAs:"uddCtrl"});return u.then(i,i),u};this.CreateBuyUnitDialog=function(n,i,r){var f=r.NativeName,e=GameServices.hangarService.getPanelUnitData(f),o=GameServices.laboratoryService.getCollection(),u;if(!f||!e||!o){i();console.log("CreateBuyUnitDialog: no data");return}return u=t.show({templateUrl:"unit-buy-dialog.tmpl",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!1,fullscreen:!0,locals:{unitBuyDialogData:{dataUnit:r,hangarUnit:e,teches:o}},controller:"unitBuyDialogCtrl",controllerAs:"ubdCtrl"}),u.then(i,i),u};this.CreateTechDetailView=function(n){return new it(n.tech,n.teches)};this.CreateTechDetailDialog=function(n,i,r){var e=GameServices.laboratoryService.getCollection(),o=u(e,r),f;if(!o){i();console.log("CreateTechDetailDialog: no data");return}return f=t.show({templateUrl:"tech-detail-dialog.tmpl",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,fullscreen:!0,locals:{techDetailDialogData:{tech:o,teches:e}},controller:"techDetailDialogCtrl",controllerAs:"tddCtrl"}),f.then(i,i),f};this.CreateBuyTechViewData=function(n){return new rt(n)};this.CreateBuyTechDialog=function(n,i,r){var e=GameServices.laboratoryService.getCollection(),o=u(e,r),f;if(!o){i();console.log("CreateTechDetailDialog: no data");return}return f=t.show({templateUrl:"tech-buy-dialog.tmpl",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,fullscreen:!0,locals:{techBuyDialogData:{tech:o,teches:e}},controller:"techBuyDialogCtrl",controllerAs:"tbdCtrl"}),f.then(i,i),f}}]);Utils.CoreApp.gameApp.controller("uploadImageCtrl",["$scope","$mdDialog","uploadHelper",function(n,t,i){function u(){if(n.corpedOnLoadDone&&!GameServices.planshetService.getInProgress()){var u=i.getFileUploadModel(null,null,r._locals._request);if(u.onResponse=function(i){GameServices.planshetService.setInProgress(!1);n.$$uploadInProgess=!1;t.hide(i)},u.onError=function(t){GameServices.planshetService.setInProgress(!1);n.$$uploadInProgess=!1;r._locals._onError&&r._locals._onError(t);console.log("uploadImageCtrl.upload.onError.errorAnswer",{errorAnswer:t})},!n.$$childTail.corpedImg){u.onError(ErrorMsg.UploadedImageNotSetInInstance);return}i.loadBase64FileByHub(n.$$childTail.corpedImg,null,u)}}var r=this;if(console.log("uploadImageCtrl",{_self:r,$scope:n}),!r._locals._request||!(r._locals._request instanceof Function))throw new Error("uploadImageCtrl no requests in instance");r._locals._imageSize&&(n.imageSize=r._locals._imageSize);r._locals._cssDialogContainer&&(n.cssDialogContainer=r._locals._cssDialogContainer);i.setScopeCorpImageModel(n,u,t.cancel)}]);Utils.CoreApp.gameApp.service("baseDialogHelper",["$mdDialog",function(n){function h(){return u||(u=Utils.CreateLangSimple("EN У вас недостаточно прав для совержения этого действия","ES У вас недостаточно прав для совержения этого действия","RU У вас недостаточно прав для совержения этого действия")),t(u.getCurrent())}function c(){return f||(f=Utils.CreateLangSimple("EN Not permitted","ES Not permitted","RU Not permitted")),f.getCurrent()}function l(n,r){return LANG===o.Ru?t("RU Максимальная длинна сообщения не может превышать "+t(r,i)+" символов. <br> Текущая длинна сообщения составляет "+t(n,i)+" символов"):LANG===o.Es?t("ES  Максимальная длинна сообщения не может превышать "+t(r,i)+" символов.<br> Текущая длинна сообщения составляет "+t(n,i)+" символов"):t("EN  Максимальная длинна сообщения не может превышать "+t(r,i)+" символов. <br> Текущая длинна сообщения составляет "+t(n,i)+" символов")}var r=this,o=r.supportedLangs=Utils.SupportedLangs(),i=r.cssSelectName=" unique-name ",s=r.defaultTheme="default-dialog",t,u,f,e;this.$$mdDialog=n;t=this.setSpanText=function(n,t){return Utils.SetSpanText(n,t)};this.openDialogNotPermitted=function(t){return n.show(n.alert().title(c()).targetEvent(t).htmlContent(h()).ariaLabel(s).clickOutsideToClose(!0).ok("Ok!"))};this.errorOverMaxLength=function(t,i,r){return n.show(n.alert().title("Error").targetEvent(t).htmlContent(l(i,r)).ariaLabel(s).clickOutsideToClose(!0).ok("Ok!"))};this.titleImportant=function(){return e||(e=Utils.CreateLangSimple("Attention : important message!","¡Atención : mensaje importante!","Внимание : Важное сообщение!")),e.getCurrent()}}]);Utils.CoreApp.gameApp.service("bookmarkDialogHelper",["baseDialogHelper",function(n){function e(){return r||(r=Utils.CreateLangSimple("EN _textOpenDialogBookmarkIsExist","ES _textOpenDialogBookmarkIsExist","RU _textOpenDialogBookmarkIsExist")),r.getCurrent()}function o(){return LANG===u.Ru?i("RU getTextOpenDialogBookMarkLimitDone"):LANG===u.Es?i("ES  getTextOpenDialogBookMarkLimitDone"):i("EN  getTextOpenDialogBookMarkLimitDone")}var s=this,u=n.supportedLangs,h=n.cssSelectName,f=n.defaultTheme,i=n.setSpanText,t=this.$mdDialog=n.$$mdDialog,r;this.openDialogBookmarkIsExist=function(){return t.show(t.alert().title("Bookmark: error").htmlContent(e()).ariaLabel(f).clickOutsideToClose(!0).ok("Ok"))};this.openDialogBookMarkLimitDone=function(){return t.show(t.alert().title("Bookmark: error").htmlContent(o()).ariaLabel(f).clickOutsideToClose(!0).ok("Ok"))}}]);Utils.CoreApp.gameApp.service("confederationDialogHelper",["baseDialogHelper","maxLenghtConsts",function(n){function h(){return e||(e=Utils.CreateLangSimple("EN Текущий период голосования завершён","ES Текущий период голосования завершён","RU Текущий период голосования завершён")),e.getCurrent()}function c(){return o||(o=Utils.CreateLangSimple("EN Текущий период регистрации завершён, регистрация будет открыта после окончания выборов.","ES Текущий период регистрации завершён, регистрация будет открыта после окончания выборов.","RU Текущий период регистрации завершён, регистрация будет открыта после окончания выборов.")),o.getCurrent()}function l(){return s||(s=Utils.CreateLangSimple("EN Вы уже голосовали на этой неделе","ES Вы уже голосовали на этой неделе","RU Вы уже голосовали на этой неделе")),s.getCurrent()}function a(n){return LANG===f.Ru?t("RU  Вы действительно хотите отдать свой голос за  "+t(n,i)+"?"):LANG===f.Es?t("ES  Вы действительно хотите отдать свой голос за  "+t(n,i)+"?"):t("EN  Вы действительно хотите отдать свой голос за  "+t(n,i)+"?")}function v(n,r){return LANG===f.Ru?t("RU На вашем балансе недостаточно СС  для регистрации. <br> Стоимость регистрации составляет :"+t(n,i)+" CC <br> Ваш текущий баланс: "+t(r,i)+" CC <br> Вам нехватет "+t(n-r,i)+" CC "):LANG===f.Es?t("ES На вашем балансе недостаточно СС  для регистрации. <br> Стоимость регистрации составляет :"+t(n,i)+" CC <br> Ваш текущий баланс: "+t(r,i)+" CC <br> Вам нехватет "+t(n-r,i)+" CC "):t("EN На вашем балансе недостаточно СС  для регистрации. <br> Стоимость регистрации составляет :"+t(n,i)+" CC <br> Ваш текущий баланс: "+t(r,i)+" CC <br> Вам нехватет "+t(n-r,i)+" CC ")}var o,s;GameServices.$cdH=this;var f=n.supportedLangs,i=n.cssSelectName,u=n.defaultTheme,r=this.$mdDialog=n.$$mdDialog,t=n.setSpanText,e;this.openDialogTimeVotingIsOver=function(n){return r.show(r.alert().clickOutsideToClose(!0).title("ELECTION: ").targetEvent(n).ariaLabel(u).htmlContent(h()).ok("Ok"))};this.openDialogTimeRegistrationIsOver=function(n){return r.show(r.alert().clickOutsideToClose(!0).title("ELECTION: ERROR ").targetEvent(n).ariaLabel(u).htmlContent(c()).ok("Ok"))};this.openDialogUserHasAlreadyCastVote=function(n){return r.show(r.alert().clickOutsideToClose(!0).title("ELECTION: ").targetEvent(n).ariaLabel(u).htmlContent(l()).ok("Ok"))};this.openDialogConfirmSendVote=function(n,t){var i=r.confirm().ariaLabel(u).title("ELECTION: Send vote").htmlContent(a(t)).targetEvent(n).ok("Confirm").cancel("Cancel");return r.show(i)};this.openDialogRegistrationNotEnoughCc=function(n,t,i){return r.show(r.alert().clickOutsideToClose(!0).title("ELECTION: Registration - Not enough cc ").targetEvent(n).ariaLabel(u).htmlContent(v(t,i)).ok("Ok"))};this.openDialogNotPermitted=n.openDialogNotPermitted}]);Utils.CoreApp.gameApp.service("allianceDialogHelper",["baseDialogHelper","maxLenghtConsts",function(n,t){function a(n){return LANG===f.Ru?i("Вы уже состоите в альянсе  "+i(n,r)+"<br> запустите процедуру выхода из текущего альянса, <br>дождитесь  окончания блокировки (не менее 24 часов) "):LANG===f.Es?i("Es Вы уже состоите в альянсе  "+i(n,r)+"<br>  запустите процедуру выхода из текущего альянса, <br>дождитесь  окончания блокировки (не менее 24 часов) "):i("En Вы уже состоите в альянсе  "+i(n,r)+"<br>запустите процедуру выхода из текущего альянса, <br> дождитесь  окончания блокировки (не менее 24 часов) ")}function v(n){return LANG===f.Ru?i("Ваша заявка в альянс  "+i(n,r)+" принята "):LANG===f.Es?i("Es Ваша заявка в альянс  "+i(n,r)+" принята "):i("En Ваша заявка в альянс  "+i(n,r)+" принята ")}function y(n){return LANG===f.Ru?i("Ваша заявка в альянс  "+i(n,r)+" и вся переписка будет удалена <br> Хотите подтвердить удаление? "):LANG===f.Es?i("Es Ваша заявка в альянс   "+i(n,r)+" и вся переписка будет удалена <br> Хотите подтвердить удаление?  "):i("En Ваша заявка в альянс   "+i(n,r)+"  и вся переписка будет удалена <br> Хотите подтвердить удаление? ")}function p(n){return LANG===f.Ru?i("Вы не можете принять новую заявку до окончания блокиовки. <br> До окончания блокировки осталость "+i(n,r)):LANG===f.Es?i("ES Вы не можете принять новую заявку до окончания блокиовки. <br> До окончания блокировки осталость "+i(n,r)):i("EN Вы не можете принять новую заявку до окончания блокиовки. <br> До окончания блокировки осталость "+i(n,r))}function w(n){return u.show(u.alert().ariaLabel(e).clickOutsideToClose(!0).title("Join to alliance in block").htmlContent(p(n)).ok("Ok!").openFrom({width:1,height:1}))}function b(n){u.show(u.alert().ariaLabel(e).clickOutsideToClose(!0).title("Error").htmlContent(a(n)).ok("Ok!").openFrom({width:1,height:1}))}function k(n,t,i,r){console.log("errorJoinToAlliance",{allianceName:i,allianceId:t,errorAnswer:n,allianceService:r})}function d(n){return u.show(u.alert().clickOutsideToClose(!0).title("Sucsess").htmlContent(v(n)).ariaLabel(e).ok("Ok!").openFrom({width:1,height:1}))}function g(n,t,i,r){i(!0);u.show({templateUrl:"dialog-alliance-send-msg.tmpl",parent:angular.element(document.body),targetEvent:r,clickOutsideToClose:!1,fullscreen:!0,locals:{_fromName:n.Model.FromName,_toName:n.Model.ToName,_maxLength:1e3,_minLength:2,_title:null,updateBlockedState:i},controller:"allianceRequestSendMsgCtrl",bindToController:!0,controllerAs:"arsmCtrl"}).then(function(r){if(console.log("message",r),r&&r.length>1e3){console.log("message length > 1000",{message:r});return}n.Model.Message=r;t();i(!1)},function(){console.log("createMessageToAlliance onCancel");i(!1)})}function nt(n,t,i,r){i(!0);var f=u.confirm().ariaLabel(e).title("Confirm").htmlContent(y(n)).ok("Confirm").cancel("Cancel").targetEvent(r);u.show(f).then(function(){t(i)},function(){i(!1)})}function tt(){return o||(o=Utils.CreateLangSimple("EN Удаление заявки","ES Удаление заявки","RU Удаление заявки")),o.getCurrent()}function it(n){return LANG===f.Ru?i("RU Заявка от пользователя   -"+i(n,r)+" будет удалена. <br> Подтвердить действие? "):LANG===f.Es?i("ES  Заявка от пользователя   -"+i(n,r)+" будет удалена. <br> Подтвердить действие? "):i("EN  Заявка от пользователя   -"+i(n,r)+" будет удалена. <br> Подтвердить действие? ")}function rt(n){return LANG===f.Ru?i("Вы дейсттвительно хотите выйти из  "+i(n,r)):LANG===f.Es?i("Es Вы дейсттвительно хотите выйти из  "+i(n,r)):i("En Вы дейсттвительно хотите выйти из  "+i(n,r))}function ut(n){return LANG===f.Ru?i("Вы вышли из альянса "+i(n,r)+"  и вошли в режим блокировки, <br> через 24 часа вы сможете подать новую заявку в альянс "):LANG===f.Es?i("es Вы вышли из альянса "+i(n,r)+"  и вошли в режим блокировки, <br> через 24 часа вы сможете подать новую заявку в альянс "):i("en Вы вышли из альянса "+i(n,r)+"  и вошли в режим блокировки, <br> через 24 часа вы сможете подать новую заявку в альянс ")}function ft(n){return LANG===f.Ru?i("Вы действующией лидер альянса "+i(n,r)+"<br> Переназначте лидера, или распустите альянс и повторите попытку "):LANG===f.Es?i("es Вы действующией лидер альянса "+i(n,r)+"<br> Переназначте лидера, или распустите альянс и повторите попытку "):i("en Вы действующией лидер альянса "+i(n,r)+"<br> Переназначте лидера, или распустите альянс и повторите попытку ")}function et(n){var t=u.confirm().ariaLabel(e).title("Confirm").htmlContent(rt(n)).ok("Confirm").cancel("Cancel");return u.show(t)}function ot(n){return u.show(u.alert().ariaLabel(e).clickOutsideToClose(!0).title("Warn").htmlContent(ut(n)).ok("Ok!").openFrom({width:1,height:1}))}function st(n){return u.show(u.alert().ariaLabel(e).clickOutsideToClose(!0).title("Sucsess").htmlContent(ft(n)).ok("Ok!").openFrom({width:1,height:1}))}function ht(){return s||(s=Utils.CreateLangSimple("EN Drop user","ES  Drop user","RU  Drop user")),s.getCurrent()}function ct(n){return LANG===f.Ru?i("RU Вы удаляете пользователя "+i(n,r)+" из состава вашего альянса, подтвердить действие?"):LANG===f.Es?i("ES Вы удаляете пользователя "+i(n,r)+" из состава вашего альянса, подтвердить действие?"):i("EN Вы удаляете пользователя "+i(n,r)+" из состава вашего альянса, подтвердить действие?")}function lt(n){return LANG===f.Ru?i("EN Вы "+i("удаляете альянс "+n,r)+" <br> после удаления вы не сможете восстановить или создать  альянс с имнем "+i(n,r)+"<br> подтвердить удаление?"):LANG===f.Es?i("ES Вы "+i("удаляете альянс "+n,r)+" <br> после удаления вы не сможете восстановить или создать  альянс с имнем "+i(n,r)+"<br> подтвердить удаление?"):i("EN Вы "+i("удаляете альянс "+n,r)+" <br> после удаления вы не сможете восстановить или создать  альянс с имнем "+i(n,r)+"<br> подтвердить удаление?")}function at(n){return LANG===f.Ru?i("пользователь "+i(n,r)+" уже состоит в альянсе. Удалить заявку?"):LANG===f.Es?i("ES пользователь "+i(n,r)+" уже состоит в альянсе. Удалить заявку?"):i("EN пользователь "+i(n,r)+" уже состоит в альянсе. Удалить заявку?")}function vt(n){var t=u.confirm().ariaLabel(e).title("User in alliance").htmlContent(at(n)).ok("Confirm").cancel("Cancel");return u.show(t)}function yt(n){return LANG===f.Ru?i("Ваша заявка в альянс "+i(n,r)+" рассмотренна и принята. <br> Подтвердить вступление сейчас  или сделать это позднее?"):LANG===f.Es?i("ES Ваша заявка в альянс "+i(n,r)+" рассмотренна и принята. <br> Подтвердить вступление сейчас  или сделать это позднее?"):i("EN Ваша заявка в альянс "+i(n,r)+" рассмотренна и принята. <br> Подтвердить вступление сейчас  или сделать это позднее?")}function pt(n){var t=u.confirm().ariaLabel(e).title("Accepted").htmlContent(yt(n)).ok("Now").cancel("Late");return u.show(t)}function wt(){return h||(h=Utils.CreateLangSimple("EN Change Tax","ES Change Tax","RU Change Tax")),h.getCurrent()}function bt(n,t){var i=u.prompt().title(wt()).placeholder(n).ariaLabel(e).initialValue(n).targetEvent(t).ok("Ok").cancel("Cancel");return u.show(i)}function kt(){return c||(c=Utils.CreateLangSimple("EN Alliance member change Role","ES Alliance member change Role","RU Alliance member change Role")),c.getCurrent()}function dt(n,t,u){return LANG===f.Ru?i("Обновить текущую роль  -"+i(n,r)+" для пользователя  "+i(t,r)+" на роль - "+i(u,r)+" ?"):LANG===f.Es?i("Обновить текущую роль  -"+i(n,r)+" для пользователя  "+i(t,r)+" на роль - "+i(u,r)+" ?"):i("Обновить текущую роль  -"+i(n,r)+" для пользователя  "+i(t,r)+" на роль - "+i(u,r)+" ?")}function gt(n,t){return LANG===f.Ru?i("RU Пользователю "+i(n,r)+" уже назначенна роль "+i(t,r)):LANG===f.Es?i("ES Пользователю "+i(n,r)+" уже назначенна роль "+i(t,r)):i("En Пользователю "+i(n,r)+" уже назначенна роль "+i(t,r))}function ni(){return l||(l=Utils.CreateLangSimple("EN Alliance member change Role","ES Alliance member change Role","RU Alliance member change Role")),l.getCurrent()}function ti(n,t){return LANG===f.Ru?i("RU Польззователю "+i(n,r)+" назначена новая роль - "+i(t,r)):LANG===f.Es?i("ES Польззователю "+i(n,r)+" назначена новая роль - "+i(t,r)):i("EN Польззователю "+i(n,r)+" назначена новая роль - "+i(t,r))}function ii(n,t){return LANG===f.Ru?i("RU Обновить технологию  "+i(n,r)+" до уровня "+i(t,r)+"?"):LANG===f.Es?i("ES Обновить технологию  "+i(n,r)+" до уровня "+i(t,r)+"?"):i("EN  Обновить технологию  "+i(n,r)+" до уровня "+i(t,r)+"?")}function ri(n,t){return LANG===f.Ru?i("RU Технология  "+i(n,r)+" успешно обновлена до уровня "+i(t,r)):LANG===f.Es?i("ES Технология  "+i(n,r)+" успешно обновлена до уровня "+i(t,r)):i("EN Технология  "+i(n,r)+" успешно обновлена до уровня "+i(t,r))}var o,s,h,c,l;GameServices.$adH=this;var f=n.supportedLangs,r=n.cssSelectName,e=n.defaultTheme,u=n.$$mdDialog,i=n.setSpanText;this.errorUserInAlliance=b;this.openDialogJoinMessageSended=d;this.errorJoinToAlliance=k;this.openDialogSendMessage=g;this.openDialogDeleteUserRequestToAlliance=nt;this.errorUserCantJoinToAllianceBecauseInBlockedState=w;this.openDialogAllianceManageRefuseMemberRequest=function(n,t){var i=u.confirm().title(tt()).htmlContent(it(n)).ariaLabel("default-dialog").targetEvent(t).ok("Ok").cancel("Cancel");return u.show(i)};this.openDialogleaveFromAlliance=et;this.openDialogOnLeaveFromUserAlliance=ot;this.openDialogLeaveLeader=st;this.openDialogDropUserFromAlliance=function(n,t){var i=u.confirm().title(ht()).htmlContent(ct(n)).ariaLabel(e).targetEvent(t).ok("Confirm").cancel("Cancel");return u.show(i)};this.openDialogDisbandAlliance=function(t,i){var r=u.confirm().title(n.titleImportant()).htmlContent(lt(t)).ariaLabel(e).targetEvent(i).ok("Delete --"+t+"--").cancel("Cancel");return u.show(r)};this.errorAllianceManageTargetUserInAlliance=vt;this.onRequestAllianceConfirmAcceptToAllianceForUser=pt;this.openDialogChengeTax=bt;this.openDialogNotPermitted=n.openDialogNotPermitted;this.openDialogChangeRole=function(n,t,i,r){var f=u.confirm().title(kt()).htmlContent(dt(n,t,i)).ariaLabel(e).targetEvent(r).ok("Ok").cancel("Cancel");return u.show(f)};this.openDialogRoleNotChanged=function(n,t,i){return u.show(u.alert().title("Alliance role").targetEvent(i).htmlContent(gt(n,t)).ariaLabel(e).clickOutsideToClose(!0).ok("Ok!"))};this.openDialogRoleUpdated=function(n,t,i){return u.show(u.alert().title(ni()).ariaLabel(e).targetEvent(i).clickOutsideToClose(!0).htmlContent(ti(n,t)).ok("Ok"))};this.errorDescriptionOverMaxLength=function(i,r){return n.errorOverMaxLength(i,r,t.AllianceDescription)};this.openDiaologConfirmTechUpgrade=function(n,t,i){var r=u.confirm().title("Alliance : update tech").htmlContent(ii(t,i)).ariaLabel(e).targetEvent(n).ok("Update").cancel("Cancel");return u.show(r)};this.openDiaologTechUpgraded=function(n,t,i){return u.show(u.alert().title("Alliance :  tech upgraded").ariaLabel(e).targetEvent(n).clickOutsideToClose(!0).htmlContent(ri(t,i)).ok("Ok"))}}]);Utils.CoreApp.gameApp.service("journalDialogHelper",["baseDialogHelper","maxLenghtConsts",function(n){function s(){return f||(f=Utils.CreateLangSimple("EN Spy","ES Spy","RU Spy")),f.getCurrent()}function h(n){return LANG===r.Ru?t("RU У вас "+t(n,i)+" отчетов ,  ваше хранилише переполненно <br> удалите лишние отчеты и пвторите попытку"):LANG===r.Es?t("ES У вас "+t(n,i)+" отчетов,  ваше хранилише переполненно  <br>  удалите лишние отчеты и пвторите попытку"):t("EN У вас "+t(n,i)+" отчетов,  ваше хранилише переполненно  <br>  удалите лишние отчеты и пвторите попытку")}function c(){return e||(e=Utils.CreateLangSimple("RU Transfer","ES Transfer","RU Transfer")),e.getCurrent()}function l(n){return LANG===r.Ru?t("RU флот прибыл на планету  "+t(n,i)):LANG===r.Es?t("ES флот прибыл на планету  "+t(n,i)):t("EN  флот прибыл на планету  "+t(n,i))}var e;GameServices.$jdH=this;var r=n.supportedLangs,i=n.cssSelectName,o=n.defaultTheme,u=n.$$mdDialog,t=n.setSpanText,f;this.openDialogMaxLimitSpyItems=function(n,t){return u.show(u.alert().title(s()).targetEvent(t).htmlContent(h(n)).ariaLabel(o).clickOutsideToClose(!0).ok("Ok"))};this.openDialogTransferComplete=function(n){return u.show(u.alert().title(c()).targetEvent().htmlContent(l(n)).ariaLabel(o).clickOutsideToClose(!0).ok("Ok"))}}]);Utils.CoreApp.gameApp.service("journalMotherJumpDialogHelper",["baseDialogHelper","maxLenghtConsts",function(n){function h(){return s||(s=Utils.CreateLangSimple("You are already in the system","Ya se encuentra en el sistema","Вы уже находитесь в этой системе")),t(s.getCurrent())}function c(n,r){return LANG===u.Ru?t("Мазер уже перемещается в систему: "+t(n,i)+". <br/> До завершения прыжка осталось  "+t(r,i)+". <br/>Отмените текущее задание для нового прыжка."):LANG===u.Es?t("Mothership se mudó a: "+t(n,i)+". <br/> Tiempo para completar los "+t(r,i)+" restantes. <br/>Cancele el salto actual para el nuevo salto."):t("Mothership has moved in: "+t(n,i)+" <br/> Remaining to complete the jump  "+t(r,i)+". <br/>Cancel the current jump for the new jump")}function l(n,r){return LANG===u.Ru?t("RU Мазер выполнил прыжок из системы : "+t(n,i)+" в систему "+t(r,i)):LANG===u.Es?t("ES Мазер выполнил прыжок из системы : "+t(n,i)+" в систему "+t(r,i)):t("EN Мазер выполнил прыжок из системы : "+t(n,i)+" в систему "+t(r,i))}function a(n){return LANG===u.Ru?t("RU мазер уже выполнил прыжок в систему "+t(n,i)+"  и находится в ней"):LANG===u.Es?t("ES мазер уже выполнил прыжок в систему "+t(n,i)+"  и находится в ней"):t("EN мазер уже выполнил прыжок в систему "+t(n,i)+"  и находится в ней")}function v(n,r,f){return LANG===u.Ru?t("RU Запросить у конфедерации  моментальное перемещение из системы "+t(n,i)+" в систему "+t(r,i)+" за "+t(f,i)+"CC "):LANG===u.Es?t("ES Запросить у конфедерации  моментальное перемещение из системы "+t(n,i)+" в систему "+t(r,i)+" за "+t(f,i)+"CC ?"):t("EN Запросить у конфедерации  моментальное перемещение из системы "+t(n,i)+" в систему "+t(r,i)+" за "+t(f,i)+"CC ?")}GameServices.$mjdH=this;var u=n.supportedLangs,i=n.cssSelectName,f=n.defaultTheme,r=n.$$mdDialog,t=n.setSpanText,e="Mothership:",o={JumpMotherInProgress:"JumpMotherInProgress",DataIsOldRepeatRequest:"DataIsOldRepeatRequest",NoData:"No data",InputDataIncorrect:"Input data incorrect",JupmMotherIsCurrentSystem:"JupmMotherIsCurrentSystem"},s;this.openDialogMotherJumpEnter=function(n,e){var o,s=r.confirm().ariaLabel(f).closeTo({left:0});return LANG===u.Ru?(o="Целевая система "+n,s.title(o).htmlContent(t("Время до прыжка: "+t(e,i))).ok("Прыжок").cancel("Отмена")):LANG===u.Es?(o="Sistema de destino "+n,s.title(o).htmlContent(t("Tiempo para saltar: "+t(e,i))).ok("Saltar").cancel("Cancelar")):(o="Target system "+n,s.title(o).htmlContent(t("Time to jump: "+t(e,i))).ok("Jump").cancel("Cancel")),r.show(s)};this.openDialogErrorJumpMotherRequest=function(n){return r.show(r.alert().title(e).ariaLabel(f).clickOutsideToClose(!0).textContent(n).ok("Ok"))};this.openDialogErrorJumpMotherInProgress=function(n){return r.show(r.alert().ariaLabel(f).title(e).clickOutsideToClose(!0).htmlContent(c(n,"00:00:05")).ok("Ok"))};this.openDialogErrorJupmMotherIsCurrentSystem=function(){return r.show(r.alert().title(e).ariaLabel(f).clickOutsideToClose(!0).htmlContent(h()).ok("Ok"))};this.openDialogErrorJupmMother=function(n,t){return n===o.JumpMotherInProgress?this.openDialogErrorJumpMotherInProgress(t):n===o.JupmMotherIsCurrentSystem?this.openDialogErrorJupmMotherIsCurrentSystem():this.openDialogErrorJumpMotherRequest(n)};this.jumpErrors=o;this.openDialogMotherJumped=function(n,t){return r.show(r.alert().title(e).ariaLabel(f).clickOutsideToClose(!0).htmlContent(l(n,t)).ok("Ok"))};this.openDialogErrorMoterJumpTaskCompleted=function(n){return r.show(r.alert().title(e).ariaLabel(f).clickOutsideToClose(!0).htmlContent(a(n)).ok("Ok"))};this.openDialogBuyInstMotherJump=function(n,t,i,u){var o=r.confirm().ariaLabel(f).title(e).htmlContent(v(n,t,i)).targetEvent(u).ok("Confirm").cancel("Cancel");return r.show(o)}}]);Utils.CoreApp.gameApp.service("userChannelsDialogHelper",["baseDialogHelper","maxLenghtConsts",function(n,t){function h(n){return LANG===f.Ru?i("RU  Вы действительно хотите удалить переписку с пользователем  "+i(n,r)+"?"):LANG===f.Es?i("ES  Вы действительно хотите удалить переписку с пользователем  "+i(n,r)+"?"):i("EN  Вы действительно хотите удалить переписку с пользователем  "+i(n,r)+"?")}function c(n){return LANG===f.Ru?i("RU  У вас уже существует канал "+i(n,r)+"  что то там еще"):LANG===f.Es?i("ES У вас уже существует канал "+i(n,r)+"  что то там еще"):i("EN  У вас уже существует канал "+i(n,r)+"  что то там еще")}function l(n){return LANG===f.Ru?i("RU  Канал"+i(n,r)+" будет удален  без возможности восстановления  со всей историей, <br> вы действительно хотите удлать канал?"):LANG===f.Es?i("ES   Канал"+i(n,r)+" будет удален  без возможности восстановления  со всей историей, <br> вы действительно хотите удлать канал?"):i("EN   Канал"+i(n,r)+" будет удален  без возможности восстановления  со всей историей, <br> вы действительно хотите удлать канал?")}function a(n){return LANG===f.Ru?i("RU  Вы отписываетесь от канала "+i(n,r)+"  и больше не сможете получать сообщения, подтвердить действие?"):LANG===f.Es?i("ES  Вы отписываетесь от канала "+i(n,r)+"  и больше не сможете получать сообщения, подтвердить действие?"):i("EN  Вы отписываетесь от канала "+i(n,r)+"  и больше не сможете получать сообщения, подтвердить действие?")}function s(n,t){return LANG===f.Ru?i("RU  У вас слишком много каналов  в разделе "+i(n,r)+" ("+i(t+"/"+t,r)+") <br> Удалите не используемые каналы и повторите попытку "):LANG===f.Es?i("ES  У вас слишком много каналов  в разделе"+i(n,r)+" ("+i(t+"/"+t,r)+") <br> Удалите не используемые каналы и повторите попытку "):i("EN  У вас слишком много каналов в разделе "+i(n,r)+" ("+i(t+"/"+t,r)+") <br> Удалите не используемые каналы и повторите попытку ")}function v(){return o||(o=Utils.CreateLangSimple("EN Вы дейстительно хотите провести глубокую очистку и  удалить все подключенные каналы  и связанную с вами информацию?","ES Вы дейстительно хотите провести глубокую очистку и  удалить все подключенные каналы  и связанную с вами информацию?","RU Вы дейстительно хотите провести глубокую очистку и  удалить все подключенные каналы  и связанную с вами информацию?")),o.getCurrent()}var y=this,f=n.supportedLangs,r=n.cssSelectName,e=n.defaultTheme,u=n.$$mdDialog,i=n.setSpanText,o;this.$mdDialog=n.$$mdDialog;this.maxLenghtConsts=t;this.openDialogConfirmDeletePrivateChannel=function(n,t){var i=u.confirm().ariaLabel(e).title("WARN: Delete private channel!").htmlContent(h(t)).targetEvent(n).ok("Confirm").cancel("Cancel");return u.show(i)};this.openDialogUserHasChannel=function(n,t){return u.show(u.alert().clickOutsideToClose(!0).title("Create channel: Warn!").targetEvent(n).ariaLabel(e).htmlContent(c(t)).ok("Ok"))};this.openDialogConfirmDeleteGroupChannel=function(n,t){var i=u.confirm().ariaLabel(e).title("WARN: Delete group channel!").htmlContent(l(t)).targetEvent(n).ok("Confirm").cancel("Cancel");return u.show(i)};this.openDialogUnsubscribeFromGroupChannel=function(n,t){var i=u.confirm().ariaLabel(e).title("Unsubscribe from group channel").htmlContent(a(t)).targetEvent(n).ok("Confirm").cancel("Cancel");return u.show(i)};this.getTextOpenDialogChannelMaxLimit=s;this.openDialogChannelMaxLimit=function(n,t,i){return u.show(u.alert().clickOutsideToClose(!0).title("WARN: Channel max limit").targetEvent(n).ariaLabel(e).htmlContent(s(t,i)).ok("Ok"))};this.openDialogDeepDeleteOtherGroupChannels=function(n){var t=u.confirm().ariaLabel(e).title("WARN: Deep delete all group channels!").htmlContent(v()).targetEvent(n).ok("Confirm").cancel("Cancel");return u.show(t)};this.openDialogNotPermitted=n.openDialogNotPermitted}]);Utils.CoreApp.gameApp.service("planshetHelper",["mainHelper",function(n){function t(){if(!u){var n=$("#planshet");if(n&&n.length)u=n;else return!1}return i=u.scope(),u}function v(){return f}function l(n){var i=n||t(),r;return i?(r=parseInt(i.css("right")),r<5?!1:!0):null}function a(r){var u=r||t();if(!u||(u.removeAttr("style"),!i.planshetToggle.opened))return null;c?EM.Audio.GameSounds.planshetClose.play():c=!0;n.applyTimeout(function(){i.planshetToggle.opened=!1})}function e(r){var u=r||t();u&&(i.planshetToggle.opened||(u.css("right",5),EM.Audio.GameSounds.planshetOpen.play(),n.applyTimeout(function(){i.planshetToggle.opened=!0})))}function o(n){var i=n||t();i&&(l(i)?a(i):e(i))}function y(n){var i=n||t();i&&(Date.now()-r<h||(r=Date.now(),o(i)))}function p(n){var i=t(),u;if(i&&!(Date.now()-r<h)){if(r=Date.now(),n)u=n.hasOwnProperty("name")?n.name:n;else{o(i);return}if(u!==s){s=u;e();return}o(i)}}function w(){var n=t();return n?(f=!1,n.find(".load-indicator").removeClass("display-none"),this):this}function b(n){var i=t();return i?f?this:(f=!0,i.find(".load-indicator").addClass("display-none"),n instanceof Function&&n(),this):(n instanceof Function&&n(),this)}var s,r=Date.now(),h=200,u,i,f=!0,c=!1;this.isLoaded=v;this.updateState=p;this.isOpened=l;this.toggle=y;this.open=e;this.close=a;this.startLoad=w;this.endLoad=b}]);Utils.CoreApp.gameApp.service("journalHelper",["planshetService","journalService","tabService","mapInfoService","hangarService","journalDialogHelper","$timeout",function(n,t,i,r,u,f,e){function d(n){k=n}function ut(){return k}function ft(n,i,r){t.getJournalPlanshet(null,r,n,i)}function tt(n,r,u){function e(){i.isActiveTabByIdx(u)?r():i.activateTabByIdx(u,r)}if(n){e();return}var f=t.journalStatus();i.setIdxOnCompile(u);f===nt.noJournal?ft(u,r,!0):f===nt.inCache&&t.updatePlanshetView(r)}function et(n){return n?s.transfer.getCurrent():s.atack.getCurrent()}function ot(){return s.time.getCurrent()}function st(){return{before:w(),source:w(),target:w()}}function g(n,t,i,r){i.$emit("taskPlanetSerch:showTaskForm",n,t,r)}function it(n,t){var i=n.targetScope.unit,r=o.before[t].count,u=i.sourceUnit;r<=i.Count&&(i.Count=r);u.Count=r-i.Count;o.target[t].count=i.Count}function ht(n,t){var r,i,u;if(o||(o=st()),r=n.unit,i=r.NativeName,t==="source"){o.before[i].count=r.Count;o.source[i].count=r.Count;o.source[i].scope=n;return}t==="target"&&(u=o.source[i].scope.unit,n.unit.sourceUnit=u,o.target[i].scope=n,u.Count||(n.unit.Count=null,n.target=!1),n.unitChange=function(){n.$emit("taskPlanetSerch:changeTransferUnit",it,i);return})}function v(n){if(o){var t=u.getCloneObjectHangarData(),i=n.ctrl.taskSourceUnits,r=n.ctrl.taskTargetUnits;_.forEach(t,function(n,u){if(i.hasOwnProperty(u)&&r.hasOwnProperty(u)&&o.before&&o.before.hasOwnProperty(u)){var f=t[u].Count;i[u].Count=f;o.before[u].count=f;r[u].Count=f===0||f===null?null:0}})}}function rt(n){return n.$parent.getSpyTargetPlanetName()}function ct(n){var t=rt(n);return t&&t.length<5?(Utils.Console.Warn("Planet name is not unic",t),!1):r.containPlanetName(r.serchPlanetType.OtherUsers,t)}function lt(n){n.$parent.clear()}function at(i){a=i.TargetName;d(b.OtherUsers);r.addPlanetNames([a],k);tt(i.SourceIsTab,function(){var r=t.getNewAttackBtn(),u="#"+r.ButtonId,i;n.conditionAwaiter(function(){return i=$(u),i.length===1},function(){e(function(){i.click()},40)})},i.TabIdx);return}function vt(n,t,i,r){h=null;d(b.OtherUsers);n.Data.TargetName=null;a&&(n.Data.TargetName=a,a=null);n.Data.IsTransfer=!1;g(!0,n.Data.TargetName,r,function(t){v(t);t.ctrl.setTransferType(n.Data.IsTransfer)});h=n}function yt(n,t,i,r){d(b.OnlyUserPlanet);n.Data.TargetName=null;n.Data.IsTransfer=!0;g(!0,n.Data.TargetName,r,function(t){v(t);t.ctrl.setTransferType(n.Data.IsTransfer)});h=n}function pt(n,i,r,u){if(!c){c=!0;tt(n.SourceIsTab,function(){l.$hub.journalCreateSpyItemByPlanetId(n.Data.planetId).finally(function(){setTimeout(function(){c=!1},1e3)}).then(function(n){console.log("spy item",n);t.addSpyItem(n)},function(t){var i=Errors.GetHubMessage(t);throw Errors.ClientNotImplementedException({params:n,scope:u,errorAnswer:t,msg:i},"journalHelper.spy");})},n.TabIdx);return}}function wt(n,i,r,u){if(!c&&ct(u)){c=!0;var f=rt(u).toUpperCase();l.$hub.journalCreateSpyItemByPlanetName(f).finally(function(){setTimeout(function(){c=!1},1e3)}).then(function(i){t.addSpyItem(i);n.Data.planetName=null;lt(u)},function(t){var i=Errors.GetHubMessage(t);throw Errors.ClientNotImplementedException({params:n,scope:n,errorAnswer:t,msg:i},"journalHelper.newSpy");})}}function bt(n){t.deleteReportOrSpyItem(n,"deleteSpyItem")}function kt(n){t.deleteReportOrSpyItem(n,"deleteReportItem")}function y(n,t,i){(console.log("updateShowTaskError",n),n&&t)&&n.taskErrors.hasOwnProperty(t)&&n.taskErrors[t].showError!==i&&(n.taskErrors[t].showError=i)}function dt(n,i,r,f){function a(n){e(function(){p=!1},n?0:1e3)}function d(){_.forEach(c,function(n,t){if(c.hasOwnProperty(t)&&n.hasOwnProperty("count")&&n.count>0){b=!0;return}})}function nt(){y(s,"planetNotExist",!1);y(s,"unitsIsEmpty",!1);var r=Utils.ModelFactory.UnitList(),i={};_.forEach(r,function(n,t){if(r.hasOwnProperty(t)){var u=typeof c[t].count=="number"?c[t].count:0;i[t]=u}});h.Data.SourceId=EM.EstateData.GetCurrentEstate().EstateId;h.Data.Units=i;h.Data.TargetName=s.taskTargetPlanetName;console.log("submitTaskForm",{transferParams:h,tpCtrl:s,unitCounts:i,"ournalService.$taskCreateDelayedActions":t.$taskCreateDelayedActions});l.$hub.journalCreateTaskItem(h.Data).then(function(n){console.log("$self.$hub.journalCreateTaskItem(transferParams.Data)",{newTaskId:n});t.$taskCreateDelayedActions[n]=function(n){function r(n,t){n=n?n:0;t=t?t:0;var i=n-t;return i?i:null}t.addToLocalTaskItem(n);var e=n.HangarInTask,i=o.before;_.forEach(i,function(n,t){var o,s,f;i.hasOwnProperty(t)&&(o=e[t],s=i[t],s.count=r(s.count,o.Count),f=u.getPanelUnitData(t),f.Progress||(f.Progress={}),f.Progress.Level=r(f.Count,o.Count),f.Count=f.Progress.Level,f.Count<0&&(f.Count=0,console.log("repoUnit.Count < 0",f)))});g(!1,null,f,v);u.updateHangarView();a();delete t.$taskCreateDelayedActions[n.Id]};console.log("newTaskId",n)},function(t){a();var i=Errors.GetHubMessage(t);throw Errors.ClientNotImplementedException({params:n,scope:f,errorAnswer:t,msg:i},"journalHelper.submitTaskForm.send.onError");})}var c,w;if(f&&!p){p=!0;c=o.target;w=f.$parent.$parent.$parent;console.log("taskPlanetScope",{taskPlanetScope:w,scope:f});var s=w.ctrl,k=s.isValide,b=!1;d();s.setResultIsValid(b);s.resultIsValid?nt():(y(s,"planetNotExist",!k),y(s,"unitsIsEmpty",!s.unitsIsValid),a(!0))}}function gt(n,t,i,r){function l(n,t){return n===0||n===null?null:t?n:0}function h(n,t,i,r,u){var f=l(r,u);t[n].count=f;i[n].Count=f}var f=r.$parent.$parent.$parent,e=u.getCloneObjectHangarData(),s=f.ctrl.taskSourceUnits,c=f.ctrl.taskTargetUnits;f.$apply(function(){_.forEach(e,function(n,t){if(e.hasOwnProperty(t)&&s.hasOwnProperty(t)){var i=e[t];h(t,o.source,s,i.Count,!1);h(t,o.target,c,i.Count,!0,!0)}})});return}function ni(n,t,i,r){var u=r.$parent.$parent;v(u)}function ti(){t.requestCancelMotherJump()}function ii(n,i,r,u,f){console.log("instMotherJump params",{params:n,PriceCc:n.PriceCc,type:typeof n.PriceCc,isEnoughCc:GameServices.resourceService.isEnoughCc(n.PriceCc)});typeof n.PriceCc=="number"&&GameServices.resourceService.isEnoughCc(n.PriceCc)&&t.requestInstMotherJump(n.PriceCc,f)}var l=this,w=function(){return Utils.ModelFactory.UnitList(null,!0)},a,nt=t.statuses,b=r.serchPlanetType,k,s,o,h,c,p;Object.defineProperty(l,"$hub",{get:function(){return GameServices.mainGameHubService}});s={};s.atack=Utils.CreateLangSimple("Attack the planet :","Ataque al planeta :","Атаковать планету :");s.transfer=Utils.CreateLangSimple("en transfer to planet :","es transfer to planet :","ru transfer to planet :");s.time=Utils.CreateLangSimple("en TaskTime :","es TaskTime :","ru TaskTime :");this.getTransferTypeName=et;this.getTransferTimeName=ot;this.transferTranslate=s;this.taskErrors=function(){function t(n,t,i){var r=Utils.CreateLangSimple(n,t,i);return{showError:!1,translatedError:"",getTranslateError:function(){return r.getCurrent()}}}var n={planetNotExist:t("en planetNotExist","es planetNotExist","ru planetNotExist"),unitsIsEmpty:t("en UnitsIsEmpty","es UnitsIsEmpty","ru  UnitsIsEmpty"),resetErrors:null};return n.resetErrors=function(){n.planetNotExist.showError=!1;n.unitsIsEmpty.showError=!1},n}();this.calculateFleetTime=function(n,t){var f=EM.EstateData.GetCurrentEstate(),i=f.EstateId,r=0,o=f.EstateType===EM.EstateData.MotherEstateType,u={startSystem:"mother start system is not exist",notEstate:"estateId  not exist"},e;if(o){if(r=f.SystemId,typeof r!="number"||r===0||i){console.log(u.startSystem);n.reject(u.startSystem);return}}else if(!i){console.log(u.notEstate);n.reject(u.notEstate);return}e=l.$hub.journalGetTaskTime(i,t,r);e.then(function(t){var r=EM.EstateData.GetCurrentEstate().EstateId;console.log("calculateFleetTime",{answer:t,curEstateId:r});i!==r?n.reject("sourceEstateIsWrong"):n.resolve(t.FormatedSeconds)},function(t){var i=Errors.GetHubMessage(t);i===ErrorMsg.SystemIdNotSet&&console.log("timer fleet error : ",i);n.reject(t)})};c=!1;p=!1;this.cancelMotherJump=ti;this.instMotherJump=ii;this.resetTaskForm=v;this.rgisterTaskUnit=ht;this.resetTaskUnits=ni;this.updateTaskHangar=it;this.attack=at;this.newAttack=vt;this.newTransfer=yt;this.setAllUnits=gt;this.submitTaskForm=dt;this.deleteReportItem=kt;this.spy=pt;this.newSpy=wt;this.deleteSpyItem=bt;this.getSerchType=ut}]);Utils.CoreApp.gameApp.service("mainHelper",["$q","$timeout",function(n,t){this.$q=n;this.$timeout=t;this.applyTimeout=function(n,i){return t(n,i)};this.applyAsync=function(t){if(!(t instanceof Function))throw new Error("applySync action not set in param");var i=n.defer();return i.promise.then(t,angular.noop),i.resolve(),i.promise}}]);Utils.CoreApp.gameApp.service("mapControlHelper",["planshetService","mapInfoHelper","mainHelper",function(n,t,i){function s(n){return GameServices.paralaxButtonHelper.getMapCtrlBtn(n)}function h(n,t){n&&(n.Hide=!t)}function u(n,t,u,f,e,o,s,c,l,a){var v=h,y=r;i.applyTimeout(function(){v(y.btnGalaxyInfo(),n);v(y.btnSectorInfo(),t);v(y.btnPlanetInfo(),u);v(y.btnStarInfo(),f);v(y.btnJumpToSector(),e);v(y.btnJumpToPlanetoid(),o);v(y.btnJumpToMother(),s);v(y.btnJumpToUserPlanet(),c);v(y.btnJumpToGalaxy(),l);v(y.btnOpenBookmarks(),a)})}function c(){u(1,0,0,0,0,0,1,0,0,1)}function l(){u(1,1,0,0,0,0,1,0,1,1)}function a(){u(1,1,0,0,0,0,1,0,1,1)}function v(){u(1,1,0,0,1,0,0,0,1,1)}function y(){u(0,1,0,0,1,0,1,0,1,1)}function p(){u(0,0,1,1,0,1,1,0,0,1)}function o(){u(0,1,0,1,1,0,0,0,1,1)}function e(n){var t=this["set"+n];t instanceof Function&&t()}function w(n,i,r,u){var e=f.Galaxy;t.getInfo(e,EM.EstateData.GetCurrentSpaceLocation().GalaxyId,u)}function b(n,i,r,u){var e=f.Sector;t.getInfo(e,EM.EstateData.GetCurrentSpaceLocation().SectorId,u)}function k(n,i,r,u){var e=f.Planet;t.getInfo(e,EM.EstateData.GetCurrentSpaceLocation().SpaceObjectId,u)}function d(n,i,r,u){var e=f.Star;t.getInfo(e,EM.EstateData.GetCurrentSpaceLocation().SystemId,u)}function g(){t.getInfo(f.Bookmark)}function nt(n){var t,i;n||(t=EM.EstateData.GetCurrentSpaceLocation(),EM.EstateData.SetSpaceLocationFromSectorId(t.SectorId));console.log("jumpToSector",n);i=new EM.SpaceState.SpacePosition;i.clickBySector()}function tt(){var n=EM.EstateData.GetPlanetLocation();EM.MapGeometry.System.Destroy();EM.SpaceState.SetNewCoord(n.SectorId,n.SystemId);EM.MapBuilder.System.Callback=function(){var t=new EM.SpaceState.SpacePosition;t.clickByBtnSystem(EM.SpaceState.LastActiveStarSystem);setTimeout(function(){var t=EM.MapGeometry.System.GetPlanetMeshIdByUniqueId(n.PlanetId);EM.MapEvent.PlanetoidDubleClick(t,null,!0);e("PlanetoidState")},10)};EM.MapBuilder.System.Build()}function it(n,t,i,r,u){u||(GameServices.estateService.setEstate(0),EM.EstateData.SaveCurrentEstateByEsateType(!1,0));var f=EM.EstateData.GetMotherLocation();if(EM.MapGeometry.System.GetStarStatus(f.SystemId)){console.log("if (EM.MapGeometry.System.GetStarStatus(motherLoc.SystemId))");EM.EstateBuilder.UpdateMother();return}EM.MapGeometry.System.Destroy();EM.SpaceState.SetNewCoord(f.SectorId,f.SystemId);EM.MapBuilder.System.Callback=function(){var r=EM.GetMesh(EM.SpaceState.LastActiveStarSystem),n=r.position.clone(),t=400,i;n.x+=t;n.y+=200;n.z+=t;i=EM.GetMotherMesh();i.position=n;EM.EstateBuilder.UpdateMother()};EM.MapBuilder.System.Build()}function rt(n){function r(){EM.EstateData.SaveCurrentEstateByEsateType(!0,t);EM.EstateBuilder.UpdatePlanet();e("UserPlanetState")}var t=n.OwnId,i,u;if(t)if(i=EM.EstateData.GetCurrentEstate().EstateId,n.UpdateSelect)u=GameServices.estateService.getEstateItem(t),u&&(GameServices.estateService.setEstate(t),r());else{if(i===t)return;r()}}function ut(){var n=EM.EstateData.GetCurrentSpaceLocation(),t=new EM.SpaceState.SpacePosition;t.clickByBtnGalaxy("Galaxy",n.GalaxyId);EM.EstateData.SetSpaceLocationFromGalaxyId(n.GalaxyId)}var ft=Utils.RepoKeys.LowerEstateListKeys(),r={},f=EM.MapGeometry.MapTypes;r._check=function(n){var t=r["_"+n];return t||(t=s(n),r["_"+n]=t),t};r._btnGalaxyInfo=null;r.btnGalaxyInfo=function(){return r._check("btnGalaxyInfo")};r._btnSectorInfo=null;r.btnSectorInfo=function(){return r._check("btnSectorInfo")};r._btnPlanetInfo=null;r.btnPlanetInfo=function(){return r._check("btnPlanetInfo")};r._btnStarInfo=null;r.btnStarInfo=function(){return r._check("btnStarInfo")};r._btnJumpToSector=null;r.btnJumpToSector=function(){return r._check("btnJumpToSector")};r._btnJumpToPlanetoid=null;r.btnJumpToPlanetoid=function(){return r._check("btnJumpToPlanetoid")};r._btnJumpToMother=null;r.btnJumpToMother=function(){return r._check("btnJumpToMother")};r._btnJumpToUserPlanet=null;r.btnJumpToUserPlanet=function(){return r._check("btnJumpToUserPlanet")};r._btnJumpToGalaxy=null;r.btnJumpToGalaxy=function(){return r._check("btnJumpToGalaxy")};r._btnOpenBookmarks=null;r.btnOpenBookmarks=function(){return r._check("btnOpenBookmarks")};this.galaxyInfo=w;this.sectorInfo=b;this.planetInfo=k;this.starInfo=d;this.openBookmarks=g;this.jumpToPlanetoid=tt;this.jumpToUserPlanet=rt;this.jumpToGalaxy=ut;this.jumpToMother=it;this.jumpToSector=nt;this.setState=e;this.setGalaxyState=c;this.setSectorState=l;this.setSystemState=a;this.setStarState=v;this.setPlanetoidState=y;this.setUserPlanetState=p;this.setMotherState=o;this.init=function(){return o(),!0}}]);Utils.CoreApp.gameApp.service("mapInfoHelper",[function(){function r(t,r,u){if(t){if(n.Bookmark===t){GameServices.bookmarkService.loadBokmarksPlanshet();return}var e=t.toLowerCase(),f=_.upperFirst(t);i[f]&&GameServices.mapInfoService.getMapInfo(f,r,i[f],u)}}var t=EM.MapData,n=EM.MapGeometry.MapTypes,i={};Object.defineProperty(i,n.Galaxy,{get:function(){return t._getHubAction(t._actionNames.worldGetGalaxyInfo)}});Object.defineProperty(i,n.Sector,{get:function(){return t._getHubAction(t._actionNames.worldGetSectorInfo)}});Object.defineProperty(i,n.Star,{get:function(){return t._getHubAction(t._actionNames.worldGetStarInfo)}});Object.defineProperty(i,n.Planet,{get:function(){return t._getHubAction(t._actionNames.worldGetPlanetInfo)}});Object.defineProperty(i,n.Moon,{get:function(){return t._getHubAction(t._actionNames.worldGetMoonInfo)}});this.getGalaxyInfo=function(t,i){r(n.Galaxy,t,i)};this.getSectorInfo=function(t,i){r(n.Sector,t,i)};this.getStarInfo=function(t,i){r(n.Star,t,i)};this.getPlanetInfo=function(t,i){r(n.Planet,t,i)};this.getInfo=r;this.mapTypes=n}]);Utils.CoreApp.gameApp.service("npcHelper",[function(){this.isNpc=function(n){if(!n)return!1;var t=n.toUpperCase();switch(t){case this.NPC_NATIVE_NAMES.SKAGRY:return!0;case this.NPC_NATIVE_NAMES.CONFEDERATION:return!0;default:return!1}};this.isNpcUser=function(n){if(!n||_.isInteger(n))return!1;switch(n){case this.NPC_USER_IDS.SKAGRY:return!0;case this.NPC_USER_IDS.CONFEDERATION:return!0;default:return!1}};this.isNpcAllianceId=function(n){if(!n||_.isInteger(n))return!1;switch(n){case this.NPC_ALIANCE_IDS.SKAGRY:return!0;case this.NPC_ALIANCE_IDS.CONFEDERATION:return!0;default:return!1}};this.NPC_NATIVE_NAMES={SKAGRY:"SKAGRY",CONFEDERATION:"CONFEDERATION"};this.NPC_USER_IDS={SKAGRY:1,CONFEDERATION:2};this.NPC_ALIANCE_IDS={SKAGRY:1,CONFEDERATION:2};Object.freeze(this.NPC_USER_IDS);Object.freeze(this.npcNativeNames)}]);Utils.CoreApp.gameApp.service("paralaxButtonHelper",["planshetService","hangarService","mapControlHelper",function(n,t,i){function s(n,t){n&&(n.Params||(n.Params={}),n.Params.onHovered||(n.Params.onHovered=t||function(){EM.Audio.GameSounds.defaultHover.play()}))}function h(n,t){n&&(n.Params||(n.Params={}),n.Params.svgName||(n.Params.svgName=t))}function g(t,i,r){function u(){return r.q?t:i instanceof Function?(i(t),r.q=!0,t):t}function f(){return t instanceof Object?!Utils.CheckObjIsEmpty(t):!!t}return n.conditionAwaiter(f,u)}function c(n,t,i){return i.q?n:g(n,t,i)}function nt(n){function i(){EM.Audio.GameSounds.defaultHover.play(.005)}function t(n,t){h(n,t);s(n,i)}return n[0].Method=function(n,t,i,r,u){GameServices.allianceService.toggleAlliance(n,t,i,r,u)},n[1].Method=function(n,t,i,r,u){GameServices.confederationService.leftNavGetConfederation(n,t,i,r,u)},n[2].Method=function(n,t,i,r,u){GameServices.journalService.leftNavGetJournal(n,t,i,r,u)},n[3].Method=function(n,t,i,r,u){GameServices.userChannelsService.leftNavGetUserChannels(n,t,i,r,u)},t(n[0],"alliance"),t(n[1],"confederation"),t(n[2],"journal"),t(n[3],"message"),n}function tt(n,t){return n.Method=function(){t();EM.Audio.GameSounds.defaultButtonClick.play()},s(n),h(n,"hangar-toggle"),n}function it(n){for(var r,t=0;t<n.length;t++){function u(n,t){i[n._methodName](n,t.target,null,w)}n[t].Method=u;n[t].Hide=!0;s(n[t]);r=_.lowerFirst(n[t].ButtonId.substr(3));n[t].Params._methodName=r;h(n[t],_.kebabCase(r))}return n}function v(){return c(e,it,k)}function u(){function n(){var n=this;this.Data={};this.Path="";this.IsPath=!1;this.Size="";this.ItemId="";this.JsFunction="";this.IsComplexPart=!1;this.BorderAnimView=function(t,i,r){return n.Size=t,i&&(n.Path=i,n.IsPath=!0),r&&(n.Data=r),n}}return new n}function rt(n,t,i){function r(){this.Left=n||u();this.Centr=t||u();this.Right=i||u()}return new r}function y(n,t){function i(){this.PartialPath=t||"";this.Data=n}return new i}function f(n,t){function i(){var i=this;this._constants=r;this.TranslateName="";this.ButtonId="";this.CssClass="";this.ShowName=!1;this.ConteinPartial=!1;this.PartialView=n||y();this.IsCssImage=!1;this.CssImage="";this.Method="";this.Params=t||{};this.ConstructorSizeBtn=function(n,t,r,u,f,e){n||(n=1);var o=this._constants.CssXlBtn;return n===2&&(o=i._constants.CssMediaDouble),n===3&&(o=i._constants.CssMediaTriple),n===4&&(o=i._constants.CssSmall),r==null&&(r="Ok"),i.TranslateName=r,i.CssClass=o,i.Method=u,i.ShowName=t,i.Params=f,i.ButtonId=e,i}}return new i}function ut(){function n(){var n=this;this.Collection=[];this.IsNewItem=!1;this.Full=function(t){return t.Left.BorderAnimView(r.Ms),t.Centr.BorderAnimView(r.Center),t.Right.BorderAnimView(r.Ms),n.Collection[0]=t.Left,n.Collection[1]=t.Centr,n.Collection[2]=t.Right,n};this.OnlyCentr=function(t,i){var o=u(),f,e;return o.BorderAnimView(r.Ms),f=u(),f.BorderAnimView(r.Center,t,i),e=u(),e.BorderAnimView(r.Ms),n.Collection=[o,f,e],n};this.SimpleCentr=function(t,i){return n.OnlyCentr(t,{Head:i})}}return new n}var o=["leftNavBtns","toggleBtns","mapControllBtns","hangarBtns"],p=[],l=[],a={},e=[],w=function(){n.updatePlanshet()},b={q:!1},k={q:!1},d={q:!1},r;this.setBaseBtns=function(n){l=n[o[0]];a=n[o[1]][0];e=n[o[2]];t.saveInitHangarPanel(n[o[3]])};this.getLeftNavButtons=function(){return c(l,nt,b)};this.getMapCtrlBtns=v;this.getMapCtrlBtn=function(n){return _.find(v(),function(t){return t.ButtonId===n})};this.updateMapCtrlBtn=function(n){var t=_.findIndex(e,function(t){return t.ButtonId===n.ButtonId});e[t]=n};this.getToggle=function(n){return c(a,function(t){n&&tt(t,n)},d)};this.addMapCtrlBtn=function(n){e.push(n)};this.removeButton=function(n){_.pull(p,n)};r={CssSmall:"small",CssMediaTriple:"media-triple",CssMediaDouble:"media-double",CssMid:"mid",CssTabButton:"tab-btn",CssXlBtn:"xl-btn",Post:"POST",Get:"GET",Center:"center",Ms:"ms",M:"m"};Object.freeze(r);this.SectionItem=u;this.ButtonPartialView=y;this.ButtonsView=f;this.ComplexButtonView=ut;this.SectionContentViewData=rt;this.BUTTONS_CONSTANTS=r;this.setHoverVoiceToButton=s;this.createAllianceManageUserRequestBtns=function(n,t,i,r,u){var s,h;if(n.AllianceAccepted===u.Accept){n.ButtonsView=[];return}var e=3,o={request:n},c=f();c.ConstructorSizeBtn(e,!0,"new Message",t,o);s=f();s.ConstructorSizeBtn(e,!0,"Refuse",i,o);h=f();h.ConstructorSizeBtn(e,!0,"Accept",r,o);console.log("createAllianceManageUserRequestBtns",n);n.ButtonsView=[c,s,h]};this.getOrCreateMyAllianceRequestBtns=function(n,t,i,r){function e(i){var r=f();return r.ConstructorSizeBtn(i,!0,"new Message",t,{request:n}),r}function u(t){var r=f();return r.ConstructorSizeBtn(t,!0,"Refuse",i,{request:n}),r}function o(t){var i=f();return i.ConstructorSizeBtn(t,!0,"Join",r,{request:n}),i}function s(){var t=GameServices.allianceService.armAllianceAcceptedStatus;if(console.log("getOrCreateMyAllianceRequestBtns",{request:n,armStatus:t}),n.AllianceAccepted===t.NoAction)n.hasOwnProperty("ButtonsView")&&n.ButtonsView.length===2||(n.ButtonsView=[e(2),u(2)]);else if(n.AllianceAccepted===t.Accept)n.hasOwnProperty("ButtonsView")&&n.ButtonsView.length===3||(n.ButtonsView=[e(3),u(3),o(3)]);else if(n.AllianceAccepted===t.Reject)n.hasOwnProperty("ButtonsView")&&n.ButtonsView.length===1||(n.ButtonsView=[u(1)]);else throw new Error("paralaxButtonHelper.getRequestBtns no data");return n.ButtonsView}return s()}}]);Utils.CoreApp.gameApp.service("scrollerHelper",["planshetService","$q",function(n,t){function r(t){!n.getInProgress()&&t._lastCollectionLenght<t.TotalServerCount&&t._isLastItemVisible()&&(t._lock=!0,t.GetPage(t.GetMinIdOrCondition(),t._lastCollectionLenght,function(n){t._updateCollection=!0;t.SaveAndSetItem(n);t._lock=!1;console.log("scrollerHelper.update",{opts:t,"opts._lastCollectionLenght":t._lastCollectionLenght,"opts._isLastItemVisible()":t._isLastItemVisible()})}))}function u(){var n=this,r;this.GUID=null;this.GetTotalServerCountPromise=null;this.GetMinIdOrCondition=null;this.GetItemsCollection=null;this.SaveAndSetItem=null;this.ItemSelector="div.dropable:last-child";this.GetPage=null;this._scrollerGuid=null;this._updateCollection=!0;Object.defineProperty(this,"HtmlElementToBind",{get:function(){return i.Data.Get(n.GUID)},set:function(t){var r=i.CreateGuid(),u=$(t);i.Data.GetFromElem(u)?(i.Data.Update(n.GUID,r),n.GUID=r):(n.GUID=r,i.Data.Add(t,n.GUID));n._scrollerGuid=i.CreateGuid()}});this.TotalServerCount=null;this.UpdateTotal=!0;this.updateTotal=function(){n.UpdateTotal=!0};this._lock=!1;this._isLastItemVisible=function(){var u=n._getLastItemPosition()||{top:0},t=i.Data.Get(n._scrollerGuid),r;return t&&t.length||(r=n.HtmlElementToBind.parents(e),t=i.Data.Update(null,n._scrollerGuid,r)),t.height()>u.top-t.offset().top-121};this._getLastItemPosition=function(){return n.HtmlElementToBind.find(n.ItemSelector).offset()};var t=!1,u=0,f=1e4;Object.defineProperty(n,"_lock",{get:function(){return t?(u+f<Date.now()&&(t=!1),t):t},set:function(n){if(!n){t=!1;return}t||(u=Date.now(),t=n)}});r=0;Object.defineProperty(n,"_lastCollectionLenght",{get:function(){if(n._updateCollection){var t=n.GetItemsCollection();r=t.length;n._updateCollection=!1}return r}})}var f=this,i=Utils.Guid,e=".content_scroller";this.initializeScroll=function(n,t){if(t||!Utils.Event.HasScroll(n.HtmlElementToBind))n.HtmlElementToBind.bind("DOMMouseScroll mousewheel onmousewheel",function(t){n._lock||t.originalEvent.wheelDelta>0||(n.UpdateTotal?(n._lock=!0,n.GetTotalServerCountPromise().then(function(t){n.TotalServerCount=t;n._lock=!1;n.UpdateTotal=!1;r(n)},function(t){t||(t={});t.scrollerHelperError="scrollerHelper.GetTotalServerCountPromise error";n.HtmlElementToBind.unbind("DOMMouseScroll mousewheel onmousewheel");n._lock=!1;throw Errors.ClientNotImplementedException({opts:n},"scrollerHelper.initScroller");})):r(n))});else return n.HtmlElementToBind.unbind("DOMMouseScroll mousewheel onmousewheel"),f.initializeScroll(n,!0);return n};this.IScrollerOptions=function(){return new u}}]);Utils.CoreApp.gameApp.service("statisticHelper",[function(){"use strict";function n(n,t){var i={onHover:t||null,hasOnclick:!1,_onClick:n||null};return Object.defineProperty(i,"onClick",{get:function(){return i._onClick},set:function(n){n?(i._onClick=n,i.hasOnclick=!0,i.onHover||(i.onHover=function(){EM.Audio.GameSounds.defaultHover.play()})):(i.hasOnclick=!1,i._onClick=null,i.onHover=null)}}),i}function t(t,i){var r=n(t,i);return r.title="",r.style="",r.css="",r.isImg=!1,r.isBgImage=!1,r.url="",r.alt="",r.hasContent=!1,r.templateUrl=null,r.setTemplate=function(n){r.hasContent=!0;r.templateUrl=n},r}this.resizePictire=function(n,t,i){var r=new Image;r.src=t;r.onload=function(){function e(){r=null}var t=r.width,u=r.height,f=t/u,o;return f===1?e():f>2||f<.5?(n.backgroundSize=i||"contain",e()):(o=t<u?u/t:t/u,n.backgroundSize=o*100+"%",e())}};this.createImg=function(n,i,r,u,f,e,o){var s=t(e,o);return s.isImg=!0,s.url=n,s.alt=i,s.title=r,s.css=u,s.style=f,s};this.createBgImage=function(n,i,r,u,f,e){var o=t(u,e);return o.isBgImage=!0,o.css=n,o.title=i,o.style=r,o.setTemplate(f),o};this.createStatisticModel=function(n,t){return{stats:n,image:t}};this.createStatItemModel=function(t,i,r,u,f,e,o){var s=n(e,o);return s.key=t,s.val=i,s.advancedCss=r,s.advancedCssKey=u,s.advancedCssVal=f,s}}]);Utils.CoreApp.gameApp.service("timerHelper",["$interval","buildService",function(n,t){function c(){this.simpleTimer="simpleTimer";this.buildTimer="buildTimer";this.noTimerRight="noTimerRight";this.hangarUnitTimer="hangarUnitTimer"}function u(){}function h(n){return Utils.A.getParentScopeWithProp(n,"dropElement")}function l(n,t){if(!n.timerData)throw new Error("registerSimpleTimer:!timerScope.timerData");t&&Utils.UpdateObjFromOther(n.timerData,t);var u,i,s,c;n.hasOwnProperty("timerAdvancedParam")&&n.timerAdvancedParam?(i=n.timerAdvancedParam.cbItemData,s=function(){n.timerAdvancedParam.activateUpdate(n,i)},c=n.timerAdvancedParam.timerName):(u=h(n),i=u.item,s=function(){var r=Utils.A.getValFromParent(u,"updateSimpleTimer");if(r)return r(n,i);throw Errors.ClientNotImplementedException({timerScope:n,newTimerData:t,updateSimpleTimer:r,cbItemData:i,cbScope:u},"registerSimpleTimer : activateUpdateTimer");},c=r.timerNameConstuctior(e.simpleTimer,u.body.BodyId,i.Id));n.timerData.$orientation=o;n.timerData.$hasTimer=n.timerData.IsProgress;n.timerData.$timerHtmlData||(n.timerData.$timerHtmlData="");n.timerData.$indicator||(n.timerData.$indicator=f.getIndicator(!1,0));n.timerData.$hasTimer&&r.addTimer(c,s,n,!0)}function a(n){n.$noTimer={};n.$noTimer.$showData=!0;n.$noTimer.$orientation=s;n.$noTimer.$hasTimer=!1;n.$noTimer.$timerHtmlData=n.hasOwnProperty("Level")?n.Level:null;n.$noTimer.$indicator=f.getIndicator(!0,0)}function v(n,i,u,s){function v(){return t.updateBuildTimer(n,c)}var l,c,a;if(typeof u=="number"){if(!n.timerData)throw new Error("registerBuildTimer: !timerData");(n.timerData.$isUnit=t.isUnit(n.border.Data.NativeName),n.timerData.$isUnit)||(i&&!_.isEqual(n.timerData,i)&&Utils.UpdateObjFromOther(n.timerData,i),l=s||h(n),c=l.item,n.timerData.$ownId=u,n.timerData.$orientation=o,n.timerData.$hasTimer=n.timerData.IsProgress,n.timerData.$indicator||(n.timerData.$indicator=f.getIndicator(!1,0)),n.timerData.$hasTimer&&(a=r.timerNameConstuctior(e.buildTimer,c.parentUniqueId,c.NativeName),r.addTimer(a,v,n,!0)))}}function y(n,t,u,f){function e(){if(i.HasTimeDelay(n)){f?(i.UpdateTimer(n,u),f=!1):i.IsTimeOver(n)&&t();return}i.Start(n,u)}r.addSinchronizer(n,e)}function p(n,t){r.addSinchronizer(n,t)}var f=this,e,i,s,o,r;c.prototype.getKeys=function(){return Object.keys(this)};e=new c;Object.freeze(e);i={};i.BaseDelay=2e3;i.Objects={};s="vertical";o="horizontal";i.Start=function(n,t){i.Objects[n]||(i.Objects[n]={StartTime:Date.now(),Delay:t||i.BaseDelay})};i.IsTimeOver=function(n){if(!i.Objects[n])return!0;var t=i.Objects[n];return t.StartTime+t.Delay<Date.now()?(delete i.Objects[n],!0):!1};i.HasTimeDelay=function(n){return!!i.Objects[n]};i.UpdateTimer=function(n,t){i.IsTimeOver(n)?i.Start(n,t):(delete i.Objects[n],i.Start(n,t))};u.prototype.names=[];u.prototype.updateTimer=function(n){var t=this[n],i=t.activateUpdateTimer();i&&(t.scope.timerData.$hasTimer=!1,this.deleteTimer(n))};u.prototype.addTimer=function(n,t,i,r){this.names=_.union(this.names,[n]);this[n]={};this[n].activateUpdateTimer=t;this[n].scope=i;r&&this[n].scope&&f.updateStringTimer(this[n].scope)};u.prototype.deleteTimer=function(n){_.remove(this.names,function(t){return t===n});delete this[n]};u.prototype.getTimer=function(n){return this[n]};u.prototype.timerNameConstuctior=function(n,t,i){return e[n]+"_"+t+"_"+i};u.prototype.addSinchronizer=function(n,t){function i(){return t(),!1}this.addTimer(n,i,{})};r=new u;n(function(){var n=r.names;n.length>0&&_.forEach(n,function(n){n&&r.updateTimer(n)})},1e3);this.updateStringTimer=function(n){var t=n.timerData,o=t.StartTime,r=t.Duration,i=o+r-Utils.Time.GetUtcNow(!1),u,e;return i>r&&(i=r),i<0&&(i=0),u=Math.ceil(Math.abs(i/r*100-100)),t.$indicator?Utils.UpdateObjFromOther(t.$indicator,f.getIndicator(!1,u)):t.$indicator=f.getIndicator(!1,u),t.$timerHtmlData=Utils.Time.Seconds2Time(i),e=i===0,t.IsProgress=!e,e};this.deleteTimerFromList=function(n){r[n]&&r.deleteTimer(n)};this.registerSimpleTimer=l;this.registerNoTimerRight=a;this.registerBuildTimer=v;this.timeDelay=i;this.refTimerTypes=e;this.addSinchronizer=y;this.addViewSinchronizer=p;this.getIndicator=function(n,t){var i={};return i[n?"height":"width"]=t+"%",i};this.verticalCss=s;this.horizontalCss=o;this.getComplexBtnScope=h}]);Utils.CoreApp.gameApp.service("controlDiskHelper",["$timeout","mainHelper","mapInfoHelper","bookmarkService","journalService",function(n,t,i,r,u){"use strict";function h(n,t){if(t.mapType===e.GO_TYPE_NAMES.star&&t._meshServerData){var i=EM.EstateData.GetMotherLocation();i.SystemId&&i.SystemId!==t._meshServerData.Id&&(t.jumpTranslate=s.getCurrent(),t.showMotherJump=!0)}}function l(n){Utils.Event.HasClick(n.element)||n.element.click(function(t){if(!c){if(EM.Audio.GameSounds.defaultButtonClick.play(),!n.mapType||!n.mapId)throw Errors.ClientNotImplementedException({model:n,mapType:n.mapType,mapId:n.mapId},"controlDiskHelper.model.element.click type and id not set in instance");var f=null,e=$(t.target);typeof e.data("target")=="string"?f=e.data("target"):typeof e.parent().data("target")=="string"?f=e.parent().data("target"):console.log("target not exist");o.bookmark===f?r.addBookmark(n.mapType,n.mapId):o.info===f?i.getInfo(n.mapType,n.mapId):o.jumpMotherDialog===f&&u.jumpMotherToTargetSystemByMapControl(t,n);n.hide()}});n.element.find(".md-button").hover(function(){EM.Audio.GameSounds.defaultHover.play()},angular.noop)}function a(t,i){return f={element:t,scope:i,activeCssClass:"active",visible:!1,dropContainerActiveCss:!1,styles:{left:0,top:0},_setSyles:function(n,t){f.styles.left=n;f.styles.top=t},_resetSyles:function(){f.styles.left=-9999;f.styles.top=-9999},meshId:"",mapId:0,mapType:null,delayDone:!0,showMotherJump:!1,jumpTranslate:null,_meshInfo:null,_meshServerData:null,_mapTypeItem:null,_setMeshData:function(n){var t,i,r;if(!f._meshInfo){if(i=e.CreateMeshArgumentType(n.source),i.IsMesh)t=n.source;else if(i.IsObject&&!i.IsEmptyObject&&i._isCorrectMeshId(n.source.id))t=EM.GetMesh(n.source.id);else if(i.IsCorrectMeshId())t=EM.GetMesh(n.source);else throw Errors.ClientNotImplementedException({event:n,cDm:f},"controlDiskHelper.cDm.controlDiskModel._setMeshData");if(!t)throw Errors.ClientNullReferenceException({event:n,cDm:f,_mesh:t},"_mesh","controlDiskHelper.cDm.controlDiskModel._setMeshData");if(f._meshInfo=e.GetMeshInfoFromMeshOrMeshId(t),f.meshId=t.id,f.mapId=f._meshInfo.UniqueId,f._mapTypeItem=f._meshInfo.GetMapType(),!f._mapTypeItem)throw Errors.ClientNotImplementedException({event:n,cDm:f},"controlDiskHelper.cDm.controlDiskModel._setMeshData._mapTypeItem");r=f._mapTypeItem.MapType;f.mapType=r===e.MapTypes.Satellite&&f._mapTypeItem.SubMapType===e.MapTypes.Moon?f._mapTypeItem.SubMapTypeLower:f._mapTypeItem.MapTypeLower;f._mapTypeItem.MapTypeLower===e.GO_TYPE_NAMES.star&&(f._meshServerData=e.GetLocalsFromMesh(t,e.SERVER_DATA_KEY))}},_isReseted:!1,reset:function(){f._isReseted||(f.visible=!1,f.dropContainerActiveCss=!1,f._resetSyles(),f.meshId=null,f.mapId=null,f.mapType=null,f.showMotherJump=!1,f.targetSystemId=null,f._meshInfo=null,f._mapTypeItem=null,f._isReseted=!0)},show:function(t){f._isReseted=!1;f.visible=!0;console.log("event",t);f._setMeshData(t);f._setSyles(t.pointerX+20,t.pointerY);h(f.meshId,f);f.dropContainerActiveCss=!0;n(angular.noop);n(function(){EM.Audio.GameSounds.onControlDiscShow.play()},200);return},hide:function(){f.reset();n(angular.noop)}},l(f),f}var v=Utils.RepoKeys.HtmlKeys,y=i.mapTypes,e=EM.AssetRepository,p=e.MESH_LOCALS_KEY,w=e.MESH_INFO_KEY,o={info:"info",bookmark:"bookmark",jumpMotherDialog:"jump-mother-dialog"},s=Utils.CreateLangSimple("Jump","Saltar","Гиперпрыжок"),c=!1,f;this.createCdModel=a;this.show=function(n){return f.show(n)};this.hide=function(){return f.hide()}}]);Utils.CoreApp.gameApp.service("controlPanelSwicherHelper",["mainHelper",function(n){function u(){return t?t:t=angular.element("#control-panel").scope()}function i(t){var i=u(),e,f;(e=t===undefined?!i.cpShowHangar:t,f=i.cpShowHangar,f!==e)&&n.applyTimeout(function(){f?(i.cpAnimateCss=r,n.$timeout(function(){i.cpShowHangar=!1;i.cpMapAnimateCss=r},400)):(i.cpAnimateCss="",i.cpMapAnimateCss="",i.cpShowHangar=!0)})}var t,r="animate";this.updateState=i;this.setMap=function(){i(!1)};this.setHangar=function(){i(!0)}}]);Utils.CoreApp.gameApp.service("dropableElementHelper",["$timeout",function(n){function t(){function u(t){i.isOpened=!1;t instanceof Function&&n(function(){t()},r,!1)}function f(u){i.compileContent=!0;t.lastOpenedElement&&t.lastOpenedElement.isOpened?t.lastOpenedElement.close(function(){i.isOpened=!0;t.lastOpenedElement=i;u instanceof Function&&u()}):(i.isOpened=!0,t.lastOpenedElement=i,u instanceof Function&&n(function(){u()},r,!1))}var r=Utils.Time.DROP_ELEMENT_ANIMATION,i={compileContent:!1,isOpened:!1,guid:_.uniqueId("a_setting")};return i.open=f,i.close=u,i.toggle=function(n){i.isOpened?i.close(n):i.open(n)},i}t.lastOpenedElement=null;this.create=function(){return new t}}]);Utils.CoreApp.gameApp.service("uploadHelper",["Upload","mainHelper","$timeout",function(n,t,i){function u(n,t){var r=n.config.data.file.name,i;t.progreses[r]||(t.progreses[r]={loaded:0,total:0,progress:0,addProgress:function(t,i){this.loaded=t;this.total=i;this.progress=100*n.loaded/n.total}});t.progreses[r].addProgress(n.loaded,n.total);i={loaded:0,total:0,progress:0};_.forEach(t.progreses,function(n){i.progress+=n.progress;i.loaded+=n.loaded;i.total+=n.total});t.onProgress(n,i,t)}function r(t,i){t.$error||n.upload({url:i.url,data:{file:t}}).then(function(n){if(i.onResponse instanceof Function)i.onResponse(n.data,n)},function(n){if(i.onError instanceof Function)i.onError(n)},function(n){i.onProgress instanceof Function&&u(n,i)})}function f(n){if(n.files.length)for(var t=0;t<n.files.length;t++)r(n.files[t],n)}this.upload=function(n){n&&n.files&&(typeof n.files=="object"&&typeof n.files.name=="string"?r(n.files,n):f(n))};this.loadBase64FileByHub=function(n,t,i){var r,u,f;if(!i){r="uploadHelper.loadBase64FileByHub file model not Set in instance arg: fileUploadModel";console.log(r,{fileUploadModel:i});throw new Error(r);}if(!i.hasOwnProperty("request")||!(i.request instanceof Function)){u="uploadHelper.loadBase64FileByHub fileUploadModel.request not Set in instance";console.log(u,{fileUploadModel:i});throw new Error(u);}return f=Utils.ModelFactory.Base64ImageOut(n,t),i.request(f).then(i.onResponse,i.onError)};this.getFileUploadModel=function(n,t,i){return{files:t||null,url:n||"",request:i,onProgress:null,onResponse:null,onError:null,progreses:{}}};this.setScopeCorpImageModel=function(r,u,f){r.imageSize||(r.imageSize=260);r.$$uploadInProgess=!1;r.file=null;r.corpImg="";r.corpImgBlob="";r.corpLocalLoaded=!1;r.corpedLocalLoaded=!1;r.corpedOnLoadDone=function(){r.corpedLocalLoaded=!0};r.upload=function(){r.$$uploadInProgess||(r.$$uploadInProgess=!0,u.apply(this,arguments))};r.imageSaved=!1;r.$watch("file",function(){r.file&&n.base64DataUrl(r.file).then(function(n){r.corpImg=n;r.corpLocalLoaded=!0;console.log("setScopeModel.scope.$watch.file.Upload.base64DataUrl",r)})});r.$watch("$$childTail.$$childHead.urlBlob",function(n,t){n!==t&&(r.corpImgBlob=n)});r.cancel=function(){r.$$uploadInProgess||t.applyTimeout(function(){r.corpLocalLoaded=!1;r.corpedLocalLoaded=!1;r.corpImg="";r.corpImgBlob=null;f instanceof Function&&f();i(function(){r.$destroy()})})}}}]);Utils.CoreApp.gameApp.factory("hubFactory",["$rootScope",function(n){return function(t,i){var r="create"+t,u,f;if(signalR&&signalR.hasOwnProperty(r)&&signalR[r]instanceof Function)return u=signalR[r](i),u.$apply=function(t,i){n.$apply(function(){t instanceof Function&&t(i)})},{hub:u,$$rootScope:n};f="SignalR: hab not exist, hub name: "+t;throw new Error(f);}}]);Utils.CoreApp.gameApp.service("mainGameHubService",["hubFactory","allianceService","profileService","userChannelsService","confederationService","journalService",function(n,t,i,r,u,f){function v(n,t){g&&(t?console.log(n,t):console.log(n))}function b(){var t=Date.now(),n=s.ping();return n.then(function(){console.log({ping:Date.now()-t,connectionState:c.connectionState})},function(n){console.log({e:n})}),n}function tt(){y.start().then(function(){e.onConnected(c.connectionState===l.connected,function(){w&&clearInterval(w);w=setInterval(function(){var n,t;c.connectionState===l.connected?b():(clearInterval(w),n="Внимение!! соединение было потерянно, необходимо перезагрузиьт игру. Сделать это сейчас?",Utils.Console.Error(n),t=confirm(n),t&&location.reload())},k)})},function(n){console.log({error:n});throw n;})}var l={initial:2,connecting:0,connected:1,disconnected:2},g=!0,a=n("MainGameHub"),y=a.hub,c=y.connection,k,w,h,d;c.logging=!0;var nt=Utils.ModelFactory,o=y.client,s=y.server,e=this,p=0;e._currentUser=nt.ConnectionUser();e._checkCurrentUser=function(){if(!e.isValidUserData(e._currentUser))throw new Error("gameNotLoad");};e.isValidUserData=function(n){return n&&n.hasOwnProperty("UserId")&&n.UserId>0&&n.hasOwnProperty("AllianceId")&&n.AllianceId>0};e.isCurrentUser=function(n){return e._currentUser.UserId===n};e._removeHubGroupForCr=function(n){delete e._currentUser.Groups[n]};e._addHubGroupForCr=function(n){e._currentUser.Groups||(e._currentUser.Groups={});e._currentUser.Groups[n.GroupeName]=n};k=1e4;e.reconnect=function(){console.log("client reconnected")};e._updateCurrentUser=function(n){n.UserId===e._currentUser.UserId&&e._currentUser._updateData(n)};h={};d=5e3;h.IDelayUser=function(n){function t(){var t=this;this.data=n;this.timer=setTimeout(function(){p--;a.$$rootScope.$broadcast("user:left-game",t.data)},d)}return new t};h.add=function(n){h[n.UserId]=h.IDelayUser(n)};h.tryCancelTimer=function(n){h[n]&&(clearTimeout(h[n].timer),delete h[n])};e.onConnected=function(n,t){if(n)s.init(LANG).then(function(){t()},function(n){console.log("onConnected:init:error",{error:n})});else throw new Error("client.onConnected - error");};o.onUserInitialized=function(n,t,i,r){if(v("========== START onUserInitialized =========="),p=n,r)e._currentUser._updateData(r.ConnectionUser),EM.GameLoader.Load(r),v("client.onConnected",{onlineCount:p,initializeData:r,currentUser:e._currentUser});else{h.tryCancelTimer(t);GameServices.allianceService.onOtherUserConnected(t,i)}a.$$rootScope.$broadcast("user:join-to-game",{CurrentConnectionUser:_.cloneDeep(e._currentUser),ConnectedUserId:t,ConnectedAllianceId:i,OnlineTotalCount:n});v("========== END onUserInitialized ==========")};o.onReconnected=function(n){console.log("onReconnected connectionId:"+n)};o.userLeftGame=function(n){console.log("userLeftGame",n);h.add(n)};o.updateConnectionUser=function(n){e._checkCurrentUser();e._updateCurrentUser(n)};e.disconnect=o.disconnect=function(n){c.stop();n&&Utils.RedirectToAction()};e.notAutorized=o.notAutorized=function(){c.stop();Utils.Console.Error("notAutorized");Utils.RedirectToAction("/Account/LogOff/")};e.getPing=function(){return b()};o.test=function(n){console.log(" client.test",{data:n,hub:y})};Object.defineProperty(this,"onlineCount",{get:function(){return p}});e.sercherGetUserNames=function(n){return s.sercherGetUserNames(n)};Utils.CoreApp.gameAppExtensions.HubAlliance(e,o,s,t,a.$$rootScope);Utils.CoreApp.gameAppExtensions.HubWorld(e,o,s);Utils.CoreApp.gameAppExtensions.HubPersonalInfo(e,o,s,t,i);Utils.CoreApp.gameAppExtensions.HubBookmark(e,o,s);Utils.CoreApp.gameAppExtensions.HubBuild(e,o,s);Utils.CoreApp.gameAppExtensions.HubEstate(e,o,s);Utils.CoreApp.gameAppExtensions.HubJournal(e,o,s,f);Utils.CoreApp.gameAppExtensions.HubUserChannels(e,o,s,r,a.$$rootScope);Utils.CoreApp.gameAppExtensions.HubConfederation(e,o,s,u,a.$$rootScope);_.forEach(o,function(n,t){a.hub.on(t,n)});console.log("hub",y);$(window).on("beforeunload",function(){return e.disconnect(!1),""});console.log("hbConn.connectionState on run start",c.connectionState);switch(c.connectionState){case l.initial:v("hbConn.state : connectionStates.initial");tt();l.initial=-1;break;case l.connecting:v("hbConn.state : connectionStates.connecting");break;case l.connected:v("hbConn.state :  connectionStates.connected");break;case l.disconnected:console.log("hbConn.state : connectionStates.disconnected",currentUser);break;default:throw new Error("hbConn.state:connectionStates not exist  - default");}}]);Utils.CoreApp.gameApp.service("translateService",["planshetService",function(n){function i(n){t.alliance=n.alliance;t.mapInfo=n.mapInfo;t.confederation=n.confederation;t.journal=n.journal;t.common=n.common;t.unit=n.unit}var t={alliance:null,mapInfo:null,confederation:null,journal:null,common:null,unit:null},r;this.getAlliance=function(){return t.alliance};this.getMapInfo=function(){return t.mapInfo};this.getConfederation=function(){return t.confederation};this.getJournal=function(){return t.journal};this.getCommon=function(){return t.common};this.getUnit=function(){return t.unit};this.getAll=function(){return t};r=Utils.CreateLangSimple;this.local={notPermitedForShow:r("EN notPermitedForShow","Es notPermitedForShow","RU не достаточно прав для просмотра")};this.init=i}]);Utils.CoreApp.gameApp.service("hangarService",["spaceShipyardService",function(n){function i(){return{Level:null,StartTime:null,Duration:null,IsProgress:!1,RemainToComplete:null,verticalIndicator:{height:0}}}function u(){return GameServices.spaceShipyardService.getBuildCollection()}function o(n){return _.find(t,function(t){return t.PartialView.Data.NativeName===n})}function f(n){var i="mid",t=o(n.NativeName);n.Count!==null&&n.Count>0?t.CssClass=i:t.CssClass===i&&(t.CssClass=i+" grayScale");t.PartialView.Data=n}function r(){for(var s=u(),f=[],r=0;r<t.length;r++){var e=t[r].PartialView.Data,n=e,o=_.find(s,function(n){return n.NativeName===e.NativeName});o?(n.Progress=o.Progress,n.Progress||(n.Progress=i()),n.Count=n.Progress.Level):(n.Progress=i(),n.Count=null);f.push(n)}return f}function e(){return _.cloneDeep(r())}function h(n){for(var r,i={},t=0;t<n.length;t++)r=n[t].NativeName,i[r]=n[t];return i}function c(){return h(e())}function l(n){return _.find(t,function(t){return t.PartialView.Data.NativeName===n}).PartialView.Data}function a(){var i,t;for(n.upgradeShipyardUnits(),i=r(),t=0;t<i.length;t++)f(i[t])}function v(){GameServices.timerHelper.addViewSinchronizer("units",a)}var t,y={NativeName:"",Name:"",SpriteImages:"",Count:null,Progress:i()},p=Utils.RepoKeys.DataKeys.UnitListNames();this.saveInitHangarPanel=function(n){function r(){i=!1}t=n;var i=!1;_.forEach(t,function(n){n.Method=function(t,u,f,e,o){i||(i=!0,GameServices.unitDialogService.CreateUnitDetailDialog(o,r,n.PartialView.Data.NativeName))}})};this.getHangarPanel=function(){return t};this.getHangarData=r;this.getCloneHangarData=e;this.getCloneObjectHangarData=c;this.updateHangarView=function(){_.forEach(t,function(n,i){t.hasOwnProperty(i)&&f(n.PartialView.Data)})};this.retstartView=function(){GameServices.estateService.updateSinchronizer(!0);v()};this.getPanelUnitData=l}]);Utils.CoreApp.gameApp.service("journalService",["planshetService","tabService","hangarService","journalDialogHelper","npcHelper","timerHelper","scrollerHelper","journalMotherJumpDialogHelper","mainHelper",function(n,t,i,r,u,f,e,o,s){function d(t){n.updatePlanshet(t)}function et(n){return h.PlanshetModel.Bodys[n]}function ni(n){return h.$planshetIndex?n===undefined||n===null?y.noJournal===h.journalStatus():n:!0}function ot(n,t){return _.orderBy(n,["Id"],t?["ask"]:["desc"])}function p(n){return et(n).TemplateData}function a(){return p(c.task)}function ti(){return p(c.spy)}function g(n){return p(n).MaxItems}function st(n){return p(n).TotalItems}function ii(n){s.applyTimeout(function(){var t=a();t.MotherJump=n})}function nt(){var n=a();n&&(f.deleteTimerFromList(ht),n.MotherJump=null,d(),EM.EstateData.SaveMotherSpaceLocationFromData(GameServices.estateService.getEstateItem(0)))}function ct(n,t){var r,u,i;EM.EstateData.UpdateMotherDataLocation(n.Galaxy,n.Sector,n.System);r=t.SourceSystemName;u=t.TargetSystemName;nt();i=EM.EstateData.GetCurrentSpaceLocation();i.SystemId===n.System&&n.OwnId===i.SpaceObjectId&&console.log("curState.SystemId === newAdress.System && newAdress.OwnId === curState.SpaceObjectId");l.openDialogMotherJumped(r,u)}function ri(n,t,i){s.applyTimeout(function(){GameServices.resourceService.addCc(n,"-")});ct(t,i)}function ui(n,t){h.$hub.journalIsMotherJumpTimeDone().then(function(i){typeof i=="number"?n(i):ct(i,t)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});})}function v(n){var t=et(n).TemplateData;return t.hasOwnProperty("Collection")?t.Collection:t.Collection=[]}function tt(n,t){t instanceof Array||(t=[t]);var r=_.unionBy(v(n),t,"Id"),u=h.PlanshetModel,i=u.Bodys[n].TemplateData;(!i.TotalItems||i.TotalItems<r.length-1)&&(i.TotalItems=r.length-1);i.Collection=ot(r)}function lt(){return v(c.report)}function at(){return v(c.spy)}function it(n){tt(c.spy,n);h._spyScrollerOptions.updateTotal()}function rt(n){tt(c.report,n);h._reportScrollerOptions.updateTotal()}function vt(n){var t=n.HangarInTask;return console.log("fixTaskUnitCount",t),_.forEach(t,function(n){n.Count===0&&(n.Count=null)}),n}function yt(n){var t=v(n);return t?_.minBy(t,"Id").Id:0}function fi(){return yt(c.report)}function ei(){return yt(c.spy)}function oi(){var n=v(c.task),t;if(n&&n.length>0)for(t=0;t<n.length;t++)vt(n[t])}function si(n){n.ComplexButtonView.IsNewItem=!0;it([n])}function pt(n){rt([n])}function wt(n){h._deleteItemFromCollectionByIdx(c.task,n)}function hi(n){var t=f.updateStringTimer(n);return t,t}function bt(){return a().Buttons}function w(n,t){var u=t?"spy_":"report_",i=u+n+"_",r={mes:i+"mes",spy:i+"spy",remove:i+"delete"};return t&&(r.attack=i+"attack"),r}function kt(){if(b)return b;var n=bt();return b=[_.find(n,function(n){return n.ButtonId==="add-task-attack"}),_.find(n,function(n){return n.ButtonId==="add-task-transfer"})]}function ci(n){var t=w(n.Id);return _.find(n.Buttons,function(n){return n.ButtonId===t.remove})}function li(n){var i=[],r=n.Buttons,e=n.Id,u=w(e,!0),t,f;return n.TargetUserName===ut?(t=_.find(r,function(n){return n.ButtonId===u.spy}),t&&i.push(t)):(f=_.find(r,function(n){return n.ButtonId===u.mes}),t=_.find(r,function(n){return n.ButtonId===u.spy}),f&&i.push(f),t&&i.push(t)),i}function ai(){var n=ti().Buttons;return _.find(n,function(n){return n.ButtonId===ft[0]})}function vi(n){var t=w(n.Id,!0);return _.find(n.Buttons,function(n){return n.ButtonId===t.attack})}function yi(n){var t=w(n.Id,!0);return _.find(n.Buttons,function(n){return n.ButtonId===t.remove})}function dt(){return n.isCurrentModel(h.UniqueId)}function pi(){return n.needUpdateCache(h.UniqueId)}function wi(n){console.log("saveReportCollection",{answer:_.cloneDeep(n)});n&&n.length>0&&s.applyTimeout(function(){rt(n)})}function bi(n){n&&n.length>0&&s.applyTimeout(function(){it(n)})}function ki(n,t,i){h.$hub.journalGetReportItems(n).then(function(n){i instanceof Function&&i(n)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});})}function di(n,t,i){h.$hub.journalGetSpyItems(n).then(function(n){i instanceof Function&&i(n)},function(i){var r=Errors.GetHubMessage(i);throw Errors.ClientNotImplementedException({minPosition:n,collectionCount:t,errorAnswer:i,msg:r},"journalService.getServeSpyItems");})}function gi(n,t){function u(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});}var i,r=!1;if(t==="deleteSpyItem")r=!0,i=function(){return h.$hub.journalDeleteSpyItem(n.Id)};else if(t==="deleteReportItem")i=function(){return h.$hub.journalDeleteReportItem(n.Id)};else throw Errors.ClientNotImplementedException({params:n,name:t,exMessage:"method not exist"},"journalService.deleteReportOrSpyItem");i().then(function(t){if(t)r?h._spyScrollerOptions.updateTotal():h._reportScrollerOptions.updateTotal(),s.applyTimeout(function(){h._deleteItemFromCollectionByIdx(n.TabIdx,n.Id)});else throw u("Journal item not deleted");},u)}var h=this,gt,ft,l,ht;this.$planshetIndex=null;Object.defineProperty(h,"UniqueId",{value:"journal-collection",writable:!1,configurable:!1});Object.defineProperty(h,"PlanshetModel",{get:function(){if(!h.$planshetIndex)throw Errors.ClientNullReferenceException({$self:h},"$self.$planshetIndex","journalService",ErrorMsg.NoData);var t=n.$planshetModels[h.$planshetIndex];if(t.UniqueId!==h.UniqueId)throw Errors.ClientNotImplementedException({$self:h},"is not  journal model");return t},set:function(t){n.updatePlanshetItemData(t,!0,Utils.Time.TIME_CACHE_JOURNAL);h.$planshetIndex=n.getModelIndex(h.UniqueId)}});Object.defineProperty(h,"$currentUserInfo",{get:function(){return GameServices.allianceService.$currentUserInfo}});this.$taskCreateDelayedActions={};var b,k,c={task:0,report:1,spy:2},y={noJournal:0,inCache:1,isActive:2},ut=u.NPC_NATIVE_NAMES.SKAGRY;Object.defineProperty(h,"$hub",{get:function(){return GameServices.mainGameHubService}});gt=["NewTaskAttack","NewTaskTransfer","Reset","LoadAll","SubmitForm"];ft=["btn-serch-target-spy"];this.getTabs=function(){return h.PlanshetModel};this.updatePlanshetView=function(t){n.setCurrentModel(h.UniqueId);t instanceof Function?d(t):d()};this.getTaskMaxItems=function(){return g(c.task)};this.getSpyMaxItems=function(){return g(c.spy)};this.getReportMaxItems=function(){return g(c.report)};this.getTaskTotalItems=function(){var n=a();return typeof n.TotalItems!="number"&&(n.TotalItems=h.getTaskCollection().length),n.TotalItems};this.getReportTotalItems=function(n){var i=st(c.report),t;return n?i:(t=s.$q.defer(),t.resolve(i,angular.noop),t.promise)};this.getSpyTotalItems=function(n){var i=st(c.spy),t;return n?i:(t=s.$q.defer(),t.resolve(i,angular.noop),t.promise)};l=o;ht="journalTask_motherJumpTimer";this.requestGetMotherJumpTime=function(n,t,i,r){n instanceof Function&&i&&r&&(t instanceof Function||(t=function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});}),h.$hub.journalGetMotherJumpTime(i,r).then(n,t))};this.setMotherJumpTimer=function(n){n&&n.FlyDuration&&n.FlyDuration>0&&(EM.EstateData.SaveMotherSpaceLocationFromData(GameServices.estateService.getEstateItem(0),n.TargetSystemId,n.StartTime,n.EndTime),ii(n))};this.requestAddTaskMotherJump=function(n,t){h.$hub.journalAddTaskMotherJump(n).then(h.setMotherJumpTimer,function(n){if(t instanceof Function)t(n);else{var i=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:i,errorAnswer:n});}})};this.getLocalMotherJump=function(){return a().MotherJump};this.hasJumpMother=function(){return!!h.getLocalMotherJump()};this.updateJumpMotherTimer=function(n,t){var i=f.updateStringTimer(n);return i&&ui(function(t){typeof t=="number"&&(n.timerData.Duration=t,n.timerData.IsProgress=!0,f.registerSimpleTimer(n,n.timerData))},t),i};this.requestCancelMotherJump=function(){var n=h.getLocalMotherJump(),t;n&&(t=n.Id,h.$hub.journalCancelMotherJump(t).then(nt,function(n){var t=Errors.GetHubMessage(n);if(t==="TaskCompleted")nt();else throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});}))};this.requestInstMotherJump=function(n,t){var i=h.getLocalMotherJump();i&&l.openDialogBuyInstMotherJump(i.SourceSystemName,i.TargetSystemName,n,t).then(function(){h.$hub.journalInstMotherJump(i.Id).then(function(t){ri(n,t,i)},function(n){var t=Errors.GetHubMessage(n);t===ErrorMsg.TaskCompleted&&l.openDialogErrorMoterJumpTaskCompleted();throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});})},function(){})};this.jumpMotherToTargetSystemByMapControl=function(n,t){function e(n){var t=Errors.GetHubMessage(n);l.openDialogErrorJupmMother(t,r);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});}function s(n){console.log("setDialog.answer",n);var i=n.FormatedSeconds,t=h.$hub,u=l.openDialogMotherJumpEnter(r,i);u.then(function(){h.requestAddTaskMotherJump(n.Guid,function(i){t.journalRemoveGuid(n.Guid);e(i)})},function(){t.journalRemoveGuid(n.Guid)})}var i=t._meshServerData,r="";if(i)r=i.NativeName;else throw Errors.ClientNotImplementedException({systemData:i,msg:"System name not exist",model:_.cloneDeep(t)});var f=i.Id,u=EM.EstateData.GetMotherLocation(),o=u.SystemId;return o===f?l.openDialogErrorJupmMotherIsCurrentSystem():u.IsMoving?l.openDialogErrorJumpMotherInProgress(r):(h.requestGetMotherJumpTime(s,e,u.SystemId,f),null)};this._deleteItemFromCollectionByIdx=function(n,t){var r=v(n),i;_.remove(r,function(n){return n.Id===t});i=h.PlanshetModel;i.Bodys[n].TemplateData.Collection=ot(r);i.Bodys[n].TemplateData.TotalItems--};this.getTaskCollection=function(){return v(c.task)};this.getReportCollection=lt;this.addReportCollection=rt;this.getSpyCollection=at;this.addSpyCollection=it;this.addToLocalTaskItem=function(n){tt(c.task,[vt(n)])};this.addSpyItem=si;this.addReportItem=pt;this.updateSimpleTimer=hi;this.getNewTaskButtons=kt;this.getNewAttackBtn=function(){return kt()[0]};this.getTaskActionButtons=function(){if(k)return k;var n=bt();return k=[n[2],n[3],n[4]]};this.getReportInfoButtons=function(n){var i=[],e=n.Id,u=w(e),f=n.Buttons,t,r;return n.IsLose&&(t=_.find(f,function(n){return n.ButtonId===u.spy}),n.TargetUserName===ut?t&&i.push(t):(r=_.find(f,function(n){return n.ButtonId===u.mes}),r&&i.push(r),t&&i.push(t))),i};this.getReportDeleteBtn=ci;this.getSpyInfoButtons=li;this.getSpyButtonFromSerch=ai;this.getSpyAtkBtn=vi;this.getSpyDeleteBtn=yi;this.getSourceHangarInTask=i.getHangarData;this.getTaskTargetUnits=function(){return _.cloneDeep(a().HangarInTask)};this.hasJournalInPlanshet=function(){return h.$planshetIndex?!0:!1};this.isActiveModel=dt;this.statuses=y;this.journalStatus=function(){return h.hasJournalInPlanshet()?dt()?y.isActive:pi()?y.noJournal:y.inCache:y.noJournal};this.journalIdx=c;this._checkTaskTimeIsOver=function(n,t){h.$hub.journalTaskTimeIsOver(n).then(function(n){t instanceof Function&&t(n)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});})};this._getReportItemByTaskId=function(n,t){var i=s.$q.defer();return i.promise.then(function(n){console.log("_getReportItemByTaskId",{answer:n});t instanceof Function&&t(n)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});}),h.$hub.journalGetReportItemByTaskId(n).then(i.resolve,i.reject),i.promise};this.leftNavGetJournal=function(){this.getJournalPlanshet()};this.getJournalPlanshet=function(i,r,u,f){var o=ni(r),e;if(!o&&n.isCurrentModel(h.UniqueId)){_.isInteger(u)?(n.open(),t.isActiveTab(u)||t.setTabIdx(u),f instanceof Function&&f()):n.toggle(h.UniqueId);return}if(!o){h.updatePlanshetView(f);n.toggle(h.UniqueId);return}e=n.IHubRequestOptions(function(){return h.$hub.journalInitialPlanshet()},h.UniqueId);e.OnSuccsess=function(t){h.PlanshetModel=t;oi();h.updatePlanshetView(f);n.toggle(h.UniqueId)};e.OnError=function(n){var t=typeof n=="string"?n:Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});};e.TryGetLocal=!0;e.SetToCurrent=!0;e.UpdateCacheTime=!0;e.CacheTime=Utils.Time.TIME_CACHE_JOURNAL;n.planshetHubRequest(e)};this.deleteReportOrSpyItem=gi;this.onTaskCreated=function(n,t){if(console.log(" onTaskCreated",{newTaskItem:n,maxCount:t}),a(),n&&n.Id){if(h.$taskCreateDelayedActions[n.Id]){h.$taskCreateDelayedActions[n.Id](n);return}h.addToLocalTaskItem(n);return}};this.onTaskFinished=function(i){var u,f;if(console.log("onTaskFinished",{notyfyData:i}),!i||!i.Task){console.log("onTaskFinished:error",{notyfyData:i});return}u=i.Task;u.TaskEnd?u.IsTransfer?(r.openDialogTransferComplete(u.TargetPlanetName),wt(u.Id)):(f=i.TabReportOut,s.applyTimeout(function(){f.IsLose&&h.$currentUserInfo.userName===f.TargetUserName&&GameServices.estateService.updateServerEstateList(!0);wt(u.Id);pt(f);n.isCurrentModel(h.UniqueId)&&(t.isActiveTabByIdx(c.report)||t.addNewDataInTabEvent(c.report));i.NewTotalWinnerUserCc&&GameServices.resourceService.setCc(i.NewTotalWinnerUserCc)})):console.log("onTaskFinished:error task not finished")};this._reportScrollerOptions=e.IScrollerOptions();this._spyScrollerOptions=e.IScrollerOptions();this.initializeReportScroll=function(n){var t=h._reportScrollerOptions;t.HtmlElementToBind=n;t.GetTotalServerCountPromise=h.getReportTotalItems;t.GetItemsCollection=lt;t.GetMinIdOrCondition=fi;t.GetPage=ki;t.SaveAndSetItem=wi;e.initializeScroll(h._reportScrollerOptions)};this.initializeSpyScroll=function(n){var t=h._spyScrollerOptions;t.HtmlElementToBind=n;t.GetTotalServerCountPromise=h.getSpyTotalItems;t.GetItemsCollection=at;t.GetMinIdOrCondition=ei;t.GetPage=di;t.SaveAndSetItem=bi;e.initializeScroll(h._spyScrollerOptions)};this.setInitializeJournal=function(n){h.PlanshetModel=_.cloneDeep(n[h.UniqueId])}}]);Utils.CoreApp.gameApp.service("planshetService",["$interval","timerHelper","planshetHelper",function(n,t,i){function k(t,i,r,u){if(t())return i();r=r?r:40;u=u?u:10;var f=n(function(){if(t())return n.cancel(f),f=null,i()},r,u)}function s(n){h=n}function d(){return h}function g(){return Utils.ModelFactory.RequestParams()}function ct(n){var t=g();return t.url=n.Url,t.method=n.Method,t.data=n.Data,t}function c(){i.endLoad()}function nt(){i.startLoad()}function lt(){i.close()}function tt(){i.open()}function at(){return i.isOpened()}function vt(n){i.updateState(n)}function v(n){var t=n||u.UniqueId;it===t?i.toggle():tt();it=t}function rt(){return!!r[o-1]}function wt(){return!!r[o+1]}function bt(n){return!_.find(pt,function(t){return t===n})}function kt(n){if(bt(n)){r.push(n);r.length>yt&&r.shift();var t=r.length-1;o=r[t]?t:0}}function dt(n){var t=o+n,i=r[t];r[t]&&a.updatePlanshet(function(){o=t},i,!0,!0)}function l(n){return _.find(e,function(t){return t.UniqueId===n})}function p(n){return!!l(n)}function w(n){if(p(n.UniqueId)){var t=_.findIndex(e,{UniqueId:n.UniqueId});e[t]=n}else e.push(n)}function ut(n,i,r){w(n);i&&t.timeDelay.UpdateTimer(n.UniqueId,r||Utils.Time.TIME_CACHE_PLANSHET)}function b(n,t){u=l(n);!t&&u&&u.hasOwnProperty("UniqueId")&&r[r.length-1]!==u.UniqueId&&kt(u.UniqueId)}function gt(){var n=Utils.ModelFactory.PlanshetHelper();return n.HasTabs=!1,n.HeadTranslateName="Hi Planshet",n.UniqueId=y,w(n),l(y)}function ni(){return h?!1:u}function ft(){return u.UniqueId}function et(n){var t=ft();return n&&t&&n===t}function ot(n){return t.timeDelay.IsTimeOver(n)}function ti(n){if(!n)return!0;var t=p(n);return t?ot(n):!0}function st(n,i,r,u){function l(i){s(!1);n.onSuccess(i);(e&&(c(),v(i.UniqueId)),u)||t.timeDelay.UpdateTimer(i.UniqueId,r||Utils.Time.TIME_CACHE_PLANSHET)}var o;s(!0);var f=null,e=!i,h=function(t){if(s(!1),c(),n.onError instanceof Function)n.onError(t)};f=n.showError?n.showError:!1;e&&nt();o=new Utils.Request(n.url,l,n.data?n.data:null,n.method,h,f);o.getJson()}function ht(n,t){if(n.hasOwnProperty("onError")&&n.onError instanceof Function)n.onError(t)}function ii(n){if(n.$isValid(),h)throw n.OnError(f.planshetInProgress);n.UniqueId&&n.TryGetLocal&&n.$tryUpdateLocal()||(s(!0),nt(),n.Delegate().finally(function(){s(!1)}).then(function(t){ut(t,!0,n.CacheTime||Utils.Time.TIME_CACHE_PLANSHET);n.$onDone(t)},function(t){c();n.OnError(t)}))}function ri(n,t,i,r,u,e){if(!n.hasOwnProperty("onSuccess")){ht(n,f.notHasOnSuccess);return}if(d()&&!i){ht(n,f.planshetInProgress);return}if(i)st(n,r,u,e);else if(!e&&t){var o=a.IHubRequestOptions(null,t);if(o.OnSuccsess=n.onSuccess,o.OnError=n.onError,o.$$tryUpdateLocalIgnoreValid())return}else st(n,r,u,e)}function ui(n,i){var r=this;this.Delegate=n;this.UniqueId=i;this.OnSuccsess=null;this.OnError=null;this.TryGetLocal=!1;this.SetToCurrent=!1;this.UpdateCacheTime=!1;this.ChangePlanshetState=!1;this.CacheTime=0;this.$tryUpdateLocal=function(){return r.UniqueId?r.$isValidSilent()?this.$$tryUpdateLocalIgnoreValid():!1:!1};this.$$tryUpdateLocalIgnoreValid=function(){var n=l(r.UniqueId);if(!n)return!1;if(r.CacheTime)t.timeDelay.UpdateTimer(r.CacheTime);else if(ot(r.UniqueId))return!1;return r.$onDone(n)};this.$isValid=function(){if(this.IsValidated&&this._isValidated)return!0;if(!(this.OnError instanceof Function)){this.IsValidated=!0;this._isValidated=!1;throw new Error(f.notHasOnError);}if(!(this.Delegate instanceof Function)){this.IsValidated=!0;this._isValidated=!1;throw this.OnError(f.notHasHubDelegate);}if(!(this.OnSuccsess instanceof Function)){this.IsValidated=!0;this._isValidated=!1;throw this.OnError(f.notHasOnSuccess);}if(this.UpdateCacheTime&&!this.CacheTime){this.IsValidated=!0;this._isValidated=!1;throw this.OnError(f.noCachePolic);}this.IsValidated=!0;this._isValidated=!0};this.IsValidated=!1;this._isValidated=!1;this.$isValidSilent=function(){return this.IsValidated?this._isValidated:(this.IsValidated=!0,!(this.OnError instanceof Function))?(this.IsValidated=!0,this._isValidated=!1,!1):(this.Delegate instanceof Function)?(this.OnSuccsess instanceof Function)?this.UpdateCacheTime&&!this.CacheTime?(this.IsValidated=!0,this._isValidated=!1,!1):(this.IsValidated=!0,this._isValidated=!0,this._isValidated):(this.IsValidated=!0,this._isValidated=!1,!1):(this._isValidated=!1,!1)};this.$onDone=function(n){return r.SetToCurrent?a.updatePlanshet(function(){c();r.OnSuccsess(n);r.ChangePlanshetState&&v(n.UniqueId)},n.UniqueId,!0):(c(),r.OnSuccsess(n),r.ChangePlanshetState&&v(n.UniqueId)),!0}}var a=this,y="startPlanshet",h=!1,fi=function(){return{UniqueId:"",HeadTranslateName:"",Buttons:[],Bodys:[],TemplateUrl:"",HasTabs:!1,IsMother:!1}},e=[],u={},f={planshetInProgress:"planshetInProgress",notHasOnSuccess:"notHasOnSuccess",notHasHubDelegate:"notHasHubDelegate",notHasOnError:"notHasOnError",noCachePolicy:"noCachePolicy"},it,r=[],o=0,yt=20,pt=["startPlanshet","build-collection-industrial-complex","build-collection-space-shipyard","build-collection-laboratory","build-collection-command-center"];this.hasPrevPlanshetElem=rt;this.hasNextPlanshetElem=wt;this.updateByHistory=dt;gt();b(y);this.getCurrentModel=ni;this.getCurrentUniqueId=ft;this.isCurrentModel=et;this.addOrUpdatePlanshetModel=w;this.updatePlanshetItemData=ut;this.updatePlanshet=function(n,t,i,r){t&&(et(t)||i)&&b(t,r);GameServices._updatePlanshet(n)};this.setCurrentModel=b;this.hasItemById=p;this.getItemById=l;this.getPlanshetModels=function(){return e};this.requestHelper=ri;this.toggle=v;this.open=tt;this.updateState=vt;this.close=lt;this.isOpened=at;this.setInProgress=s;this.getInProgress=d;this.conditionAwaiter=k;this.needUpdateCache=ti;this.reqParams=g;this.reqFixParam=ct;this.LocalErrors=f;this.planshetHubRequest=ii;this.getModelIndex=function(n){return _.findIndex(e,function(t){return t.UniqueId===n})};this.IHubRequestOptions=function(n,t){return new ui(n,t)};Object.defineProperty(a,"$planshetModels",{get:function(){return e}})}]);Utils.CoreApp.gameApp.service("profileService",["mainHelper","planshetService","timerHelper","statisticHelper","$filter","translateService","$q","gameChestService",function(n,t,i,r,u,f,e,o){function w(n){return h&&h.UniqueId===n?t.isCurrentModel(n):!1}function l(n){return v+n}function y(){return h?h.Bodys[0].TemplateData:null}function bt(n){var t=l(n);return w(t)}function kt(n){var t=y();return t&&t.Info.Name===n?w(l(t.UserId)):!1}function ft(n){return typeof n=="number"?bt(n):typeof n=="string"?kt(n):(console.log("userNotSet"),!1)}function a(n){return t.getItemById(n)}function dt(n,t){if(typeof n=="number"){var i=l(n);return _.find(t,function(n){return n.UniqueId===i})}return typeof n=="string"?_.find(t,function(t){if(t.Bodys&&t.Bodys[0]&&t.Bodys[0].hasOwnProperty("TemplateData")&&t.Bodys[0].TemplateData&&t.Bodys[0].TemplateData.hasOwnProperty("Info")&&t.Bodys[0].TemplateData.Info.hasOwnProperty("Name")&&n===t.Bodys[0].TemplateData.Info.Name){var i=t.Bodys[0].TemplateData.UserId;if(t.UniqueId===l(i))return!0}return!1}):null}function b(n,i,r,u){function f(){r instanceof Function&&r()}w(i.UniqueId)||(t.updatePlanshetItemData(i,u),n&&t.setCurrentModel(i.UniqueId),h=t.getItemById(i.UniqueId));t.updatePlanshet(f,i.UniqueId,n)}function k(n,i,r,u){function l(){t.toggle(n.UniqueId)}var f,h;i?(s=n.UniqueId,c=n.Bodys[0].TemplateData.UserId,nt=n.Bodys[0].TemplateData.Info.Name,f=e.defer(),f.promise.then(function(t){var i=o.$getPremiumModelByChestData(t),u=o.$hasPremium(i);u&&(n.Bodys[0].TemplateData.Info.HasPremium=u,n.Bodys[0].TemplateData.Info.PremiumEndTime=o.$getPremiumEndTime(i));n.Bodys[0].TemplateData.Chest.Chest=t;b(!r,n,l)},function(n){console.log("setNewProfile",{errorAnswer:n})}),h=o.getUserChestData(),h?f.resolve(h):f.reject()):b(!0,n,l,u)}function et(n){return s===n}function d(n){return typeof n=="number"?n===c:typeof n=="string"?n===nt:!1}function gt(n){return n&&n.Bodys&&n.Bodys[0]&&n.Bodys[0].TemplateData?n.Bodys[0].TemplateData:null}function g(n){return n?n.Bodys[0].TemplateData:null}function ot(n){var t=g(n);return t?t.Info:null}function st(n){var t=g(n);return t?t.Alliance:null}function ni(n){var t=ot(n);return t?t.Avatar:null}function tt(){var n=y();return n?n.Info:null}function ti(){var n=y();return n?n.Alliance:null}function ii(){var n=y();return n?n.Achievements:null}function ht(){var n=y();return n&&et(h.UniqueId)?n.Chest:null}function ri(){return!1}function ui(){var n=tt();return n?(n.HasPremium=o.$hasPremium(),n.HasPremium):null}function ct(n,t){i.timeDelay.UpdateTimer(n.UniqueId,Utils.Time.TIME_CACHE_PROFILE);k(n,!0,t,!0)}function lt(){return ot(a(s))}function fi(n){if(d(n))return a(s);var i=ft(n);return i?h:(i=dt(n,t.getPlanshetModels()),console.log("getProfile",{localData:i,isCurrentModelByDynamic:ft(n),userIdOrName:n}),i)?i:null}function it(n,i,r,u,f,e){var c,h,a,l,o;if(typeof n=="string")c=!0;else if(typeof n=="number")c=!1;else throw new Error("argument userIdOrName is wrong");h=null;a=u||d(n);a?h=s:(l=fi(n),l&&(h=l.UniqueId));o=t.IHubRequestOptions(function(){return c?p.$hub.personalInfoGetProfileByUserName(n):p.$hub.personalInfoGetProfileByUserId(n)},h);o.OnSuccsess=function(n){i instanceof Function&&i(n)};o.OnError=function(n){var t=typeof n=="string"?n:Errors.GetHubMessage(n);e&&e(n,t);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t,opts:o},"profileService.requestGetProfile");};o.TryGetLocal=f?!1:!0;o.SetToCurrent=!0;o.UpdateCacheTime=r;o.CacheTime=Utils.Time.TIME_CACHE_PROFILE;t.planshetHubRequest(o)}function rt(n,t,i){var r=i||d(n),u,f;if(r){if(u=st(a(s)),!u)throw Errors.ClientNullReferenceException({alliance:u,currentUserModelId:s},"alliance","profileService.setCurrentUserProfile");f=_.cloneDeep(u);it(n,function(n){var i=g(n);i.Alliance||(i.Alliance=f);k(n,r,t)},null,r)}else it(n,function(n){k(n,r,t)},null,r)}function ut(){rt(c,null,null,!0)}function ei(){return ni(a(s))}function oi(n,i,r){if(!GameServices.planshetService.getInProgress()){var u=n.PersonalDescription;t.setInProgress(!0);p.$hub.personalInfoUpdateUserDescription(i).finally(function(){t.setInProgress(!1)}).then(function(t){console.log("answer",t);n.PersonalDescription=t},function(n){r(u,Errors.GetHubMessage(n),n)})}}function si(t){var i=lt();n.applyTimeout(function(){i.Avatar=t})}function hi(){var n=e.defer();it(c,n.resolve,!0,!0,!0,n.reject);n.promise.then(function(n){console.log("requestUpdateCurrentUserProfile",n);n&&ct(n,!0)})}function at(n,t){var u=h.UniqueId,i=a(t),r=st(i);r&&(GameServices.allianceService._updateAllianceInfo(r,n,!0),i.UniqueId===u&&(h=i),b(!1,i))}function ci(n){if(n&&n.AllianceMembers&&n.AllianceMembers.Members){var t=_.find(n.AllianceMembers.Members,function(n){return n.UserId===c});t&&at(n,s)}}function vt(){var n=t.getCurrentUniqueId();_.startsWith(n,v)&&n!==s&&ut()}function li(n){var r=t.getPlanshetModels(),i=[];return r?(_.filter(r,function(t){return _.startsWith(t.UniqueId,v)&&t.Bodys&&t.Bodys[0]&&t.Bodys[0].hasOwnProperty("TemplateData")&&t.Bodys[0].TemplateData&&t.Bodys[0].TemplateData.hasOwnProperty("Alliance")&&t.Bodys[0].TemplateData.Alliance.hasOwnProperty("Id")&&t.Bodys[0].TemplateData.Alliance.Id===n?(i.push(t.UniqueId),!0):!1}),i):i}function ai(n){vt();_.remove(t.getPlanshetModels(),function(t){return _.startsWith(t.UniqueId,v)&&t.Bodys&&t.Bodys[0]&&t.Bodys[0].hasOwnProperty("TemplateData")&&t.Bodys[0].TemplateData&&t.Bodys[0].TemplateData.hasOwnProperty("Alliance")&&t.Bodys[0].TemplateData.Alliance.hasOwnProperty("Id")&&t.Bodys[0].TemplateData.Alliance.Id===n?!0:!1})}function vi(n){var r,i;n!==c&&(vt(),r=l(n),_.remove(t.getPlanshetModels(),function(n){return n.UniqueId===r}),i=t.getCurrentUniqueId(),_.startsWith(i,v)&&i!==s&&ut())}var p=this,yt="/api/",pt="UserProfile/",v="user_profile_",h,s,c,nt;Object.defineProperty(p,"$hub",{get:function(){return GameServices.mainGameHubService}});this.checkIsCurrentUser=d;this.getPersonalInfo=tt;this.getAlliance=ti;this.getAchievements=ii;this.getChest=ht;this.hasCheset=ri;this.getPremiumStatus=ui;this.setInitDataCurrentUser=ct;this.getActiveUserName=function(){var n=tt();return n?n.Name:null};this.getCurrentUserInfo=lt;this.setNewProfile=k;this.setProfile=rt;this.setCurrentUserProfile=ut;this.getCurrentUserAvatar=ei;this.rquestUpdateUserDescription=oi;this.updateLocalUserAvatar=si;this.requestUpdateCurrentUserProfile=hi;this.updateAllianceInfoInCurrentUserProfile=ci;this.removeProfilesByAllianceId=ai;this.removeOtherProfileByUserId=vi;this.getCurrentUserName=function(){return _.clone(nt)};this.getCurrentUserId=function(){return _.clone(c)};this.updateAllianceInfoInProfiles=function(n){if(n&&n.Id){var t=li(n.Id);_.forEach(t,function(t){at(n,t)})}};this.setUserInfoProfileModelInScope=function(n,t){var e=f.getCommon(),s=f.getMapInfo(),h=f.getAlliance(),o=[r.createStatItemModel(e.name,t.Name,null,null," unique-name "),r.createStatItemModel(h.pvpPoint,t.PvpPoint),r.createStatItemModel(e.topPosition,t.TopPosition),r.createStatItemModel(s.planets,t.Planets),r.createStatItemModel(e.wins,t.Wins),r.createStatItemModel(e.losses,t.Loses)],i=r.createBgImage("",t.Name);if(i.url=t.Avatar.Detail,i.style={backgroundImage:Utils.CssHelper.SetUrl(i.url)},r.resizePictire(i.style,i.url),t.IsCurrentUser){var c=t.HasPremium?"active":"inactive";o.push(r.createStatItemModel("Premium",c));i.setTemplate("profile-change-avatar.tmpl");t.PremiumEndTime&&o.push(r.createStatItemModel("Premium End (UTC)",u("date")(new Date(t.PremiumEndTime),"dd.MM.yyyy")))}n.profileInfoStatsModel=r.createStatisticModel(o,i)};this.setOnClickToUser=function(n,t){n.advancedCssVal+=" active ";n.hasOnclick=!0;n.onClick=function(){rt(t)}};this.onUserUpdateAvatar=function(n,t){var u=l(t),i=a(u),r;i&&(r=gt(i),r&&(r.Info.Avatar=n),w(u)&&b(!1,i))}}]);Utils.CoreApp.gameApp.service("tabService",["planshetService","mainHelper",function(n,t){function c(){return e}function w(n){e=n}function o(){return i&&i.Buttons?i.Buttons:null}function l(){return i&&i.Bodys?i.Bodys:null}function s(n,t){f=t;var i=o();return i&&(i[n].Params.hasNewEvent=t),null}function b(n){s(n,!0)}function k(n){n.CssClass=n.active?h+p:h}function a(n){var u=l(),i,e;u&&(i=o(),e=r===n,t.applyTimeout(function(){for(var t=0;t<i.length;t++)i[t].active=!1,u[t].active=!1,t===n&&(i[n].active=!0,u[n].active=!0),k(i[t]);f&&s(n,!1)}),e&&EM.Audio.GameSounds.planshetTabActivate.play())}function u(n){r=n;a(n)}function d(n){u(n.tabIdx)}function g(n){for(var r,t=0;t<n.Buttons.length;t++)n.Buttons[t].Method=d,r={hasNewEvent:!1,newEventCss:y,tabIdx:t},n.Buttons[t].Params=r;i=n;u(c()||0);e=null}function v(n,t){u(n);t instanceof Function&&t();f&&s(n,!1)}var y="new-data-in-tab",h="tab-btn",p=" "+Utils.RepoKeys.HtmlKeys.CssActive,f=!1,r=0,i,e;this.activateTabItem=a;this.getButtons=o;this.getBodys=l;this.isActiveTab=function(n){return+n.BodyId.substr(-1)===r};this.isActiveTabByIdx=function(n){return n===r};this.delayActivate=function(t,r){n.conditionAwaiter(function(){return i&&i.hasOwnProperty("Buttons")&&i.Buttons.length===3},function(){v(t,r)})};this.activateTabByIdx=v;this.addNewDataInTabEvent=b;this.initializeTabs=g;this.setTabIdx=u;this.getIdxOnCompile=c;this.setIdxOnCompile=w;this.tabIds=["planshet_tab_0","planshet_tab_1","planshet_tab_2"]}]);Utils.CoreApp.gameApp.service("allianceService",["planshetService","tabService","scrollerHelper","mainHelper","statisticHelper","profileService","allianceDialogHelper","npcHelper","timerHelper","$q","$mdDialog","$timeout","maxLenghtConsts",function(n,t,i,r,u,f,e,o,s,h,c,l,a){function ri(t){n.updatePlanshet();b&&t&&GameServices.tabService.initializeTabs(n.getItemById(b))}function vi(n,t,i){v.$hub.allianceGetAllianceItemByMinRating(n,t).then(function(n){i instanceof Function&&i(n)},function(n){console.log("getAlliancePage.getAlliancePage",{errorAnswer:n})})}function yi(){r.applyTimeout(function(){})}function pi(n,t,i){function u(){var n=_.filter(p,function(n){return _.includes(n.Name.toLowerCase(),r)&&!n.Disbandet});return _.map(n,function(n){return console.log("getLocalAllianceNames.item",n),{label:n.Name,value:n.Name,id:n.Id}})}var r=n.term.toLowerCase();if(p&&!i)return t?t(u()):void 0;v.$hub.allianceGetAllianceNamesByPartName(r).then(function(n){var i=[];_.forEach(n||[],function(n,t){i[t]=Utils.ModelFactory.IAllianceNameSerchItem(n)});p=_.unionBy(p,i,"Id");v._allianceTotalCount=p.length;t&&t(u())},function(n){console.log("getLocalAllianceNames.AllianceGetAllActiveAllianceNames",{errorAnswer:n})})}function at(n){function t(n){return n!==-1}return typeof n=="number"?t(_.findIndex(p,function(t){return t.Id===n})):typeof n=="string"?t(_.findIndex(p,function(t){return t.Name===n})):void 0}function vt(n){if(n&&n.hasOwnProperty("Id")&&n.hasOwnProperty("Name")){if(at(n.Id)){console.log("alliance exist!!",{allianceNames:p,newAlliance:n});return}p.push(n);v._allianceTotalCount=p.length}}function wi(n){at(n)?(typeof n=="number"?_.remove(p,function(t){return t.Id===n}):typeof n=="string"&&_.remove(p,function(t){return t.Name===n}),v._allianceTotalCount=p.length):console.log("error can't remove, alliance not exist")}function yt(n,t){return Utils.SetSpanText(n,t)}function bi(n){return typeof n=="number"&&n!==0}function ki(n){return typeof n=="string"&&n!==""}function ui(n){return console.log({type:typeof n=="number",typeName:typeof n,notZero:n!==0,myAlId:v.getMyAllianceId(),equalId:n!==0&&n===v.getMyAllianceId(),allEqual:typeof n=="number"&&n!==0&&n===v.getMyAllianceId()}),typeof n=="number"&&n!==0&&n===v.getMyAllianceId()}function di(t,i){var r=n.IHubRequestOptions(function(){throw r.OnError("альянс уже должен был быть инициализирован");},b);r.OnSuccsess=function(n){t instanceof Function&&t(n)};r.OnError=function(n){var t=typeof n=="string"?n:Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({msg:t,errorAnswer:n});};r.TryGetLocal=!0;r.SetToCurrent=!0;r.UpdateCacheTime=!0;r.ChangePlanshetState=!i;r.CacheTime=Utils.Time.TIME_CACHE_ALLIANCE;n.planshetHubRequest(r)}function gi(){if(b&&!_.isEmpty(d))n.isCurrentModel(b)?n.toggle():n.updatePlanshet(n.toggle,b,!0,!1);else throw new Error("allianceService.toggleAlliance NotImplementedException");}function tt(t,i){v.Role._addAdvancedDataToPlanshetRole(t);d=t;b=t.UniqueId;n.updatePlanshetItemData(t,!0,Utils.Time.TIME_CACHE_ALLIANCE);n.isCurrentModel(b)&&GameServices._updatePlanshet();i&&f.updateAllianceInfoInCurrentUserProfile(v.getMyAllianceData())}function nr(n,t,i){if(ti(n)){t instanceof Function&&t();return}i||(i=0);v.$hub.allianceGetAllianceItemById(n,i).then(function(n){console.log("answer",n);ct(n);t instanceof Function&&t()},function(n){console.log("getAllianceItem.errorAnswer",n)})}function fi(t){function i(i){console.log("filterAllianceSerchByName",i);var r;n.conditionAwaiter(function(){return r=angular.element("#inputlg").scope(),!!r},function(){r.allianceName=t})}di(i,!0)}function tr(){return d}function pt(n){return d.Bodys&&d.Bodys[n]?d.Bodys[n]:null}function ir(){return pt(0)}function wt(n){return _.find(v.getAllianceList(),function(t){return t.Id===n})}function rr(n,t){var u=v._allianceTotalCount,r=n?u:lt,i;return t?r:(i=h.defer(),i.resolve(r),i.promise)}function ur(){return _.minBy(v.getAllianceList(),"PvpPoint").PvpPoint}function fr(n){d.Bodys[0].TemplateData.Collection=_.unionBy(v.getAllianceList(),n,"Id")}function er(n){fr(n.Collection);yi()}function ei(){var n=v.getMyAllianceData();return n&&n.hasOwnProperty("Name")?n.Name:null}function et(n){return o.isNpc(n)}function y(n){dt=n}function g(){return dt}function or(n,t){return!ui(n)||!ki(t)}function sr(n,t){if(or(n,t))return null;var i=v.getMyAllianceMembers();return i?_.find(i,function(n){return n.UserName===t}):null}function oi(n,t){if(!ui(n)||!bi(t))return null;var i=v.getMyAllianceMembers();return i&&i.Members&&i.Members.length?_.find(i.Members,function(n){return n.UserId===t}):null}function si(n,t){n&&r.applyTimeout(function(){n.OnlineStatus=t})}function hi(){var n=v.getManageTabData();return n&&n.hasOwnProperty("AllianceUserRequests")&&n.AllianceUserRequests?n.AllianceUserRequests:null}function hr(){var t=angular.element("#my-alliance-requests"),n;return t.scope&&(n=t.scope(),n&&n.hasOwnProperty("aurCtrl"))?n:null}function cr(){var t=angular.element("#alliance-manage-requests"),n;return t.scope&&(n=t.scope(),n&&n.hasOwnProperty("amrCtrl"))?n:null}function gt(n,t){function u(){i.$emit("dropElementContainer:changeHeight",{resolve:r.resolve})}var i=n?hr():cr(),r=h.defer(),f=t&&i?40:1;return l(function(){i?u():r.reject("no scope")},f),r.promise}function lr(){var n=v.$currentUserInfo,t=w.AllianceMessageModelExt(!0,n.allianceRoleId,n.allianceUserId);return t._setModel(k.IsAlliance,n.allianceId,n.allianceName,n.allianceLabel.Icon),t}function ar(){var n=v.$currentUserInfo,t=w.AllianceMessageModelExt(!1,n.allianceRoleId,n.allianceUserId);return t._setModel(k.IsUser,n.userId,n.userName,n.userAvatar.Icon),t}function ni(n,t){var i=n._clone();return i.Model._setTo(t.GroupId,t.GroupName),i.Model.Message="",i}function ci(n,t,i,r,u){var o,e,c;if(u instanceof Function||(u=function(){y(!1)}),!n||!n.hasOwnProperty("Requests"))if(u(),SHOW_DEBUG){console.log({allianceUserRequests:n});throw new Error("allianceService._addNewRequestItem : no allianceUserRequests");}else return;if(typeof i!="boolean")throw new Error("allianceService._addNewrequestItem : argument -isMyAllianceTab- is wrong ");o=n.Requests;o||(o=n.Requests=[]);var f=t.Model,s=null,h="";if(k.IsAlliance===f.SourceType&&i||k.IsUser===f.SourceType&&!i)s=f.FromId,h=f.FromName;else if(k.IsAlliance===f.SourceType&&!i||k.IsUser===f.SourceType&&i)s=f.ToId,h=f.ToName;else{SHOW_DEBUG&&console.log({allianceUserRequests:n,newDataArmModelExt:t,isMyAllianceTab:i});throw new Error("condition is wrong");}e=_.find(o,function(n){return n.GroupId===s});e?e.Messages.push(f):(c=Utils.ModelFactory.AllianceUserRequestItem(h,s,[f],f.UserAccepted,f.AllianceAccepted),n.LastUpdateTime=Utils.Time.GetUtcNow(),o.push(c),e=c);e.AllianceAccepted=f.AllianceAccepted;f.UserAccepted&&(e.UserAccepted=f.UserAccepted);r instanceof Function&&r(e);e.dropable&&e.dropable._closed===!1?(y(!0),l(function(){e.dropable.updateHeihgt(function(){gt(i,!0).finally(function(){console.log("group.dropable.updateHeihgt.finally");y(!1);u()})})},10)):u();console.log("_addNewRequestItem",{group:e,m:f,allianceUserRequests:n})}function st(n){return n&&n.hasOwnProperty("GroupId")&&typeof n.GroupId=="number"&&n.hasOwnProperty("GroupName")&&typeof n.GroupName=="string"?!0:!1}function li(n){y(!0);v.$hub.requestAllianceAcceptJoinUserToAlliance(n).finally(function(){console.log("allianceService._acceptJoinUserToAlliance.finally");y(!1)}).then(function(n){tt(n,!0);console.log("newAlliancePlanshet",n)},function(n){var t=Errors.GetHubMessage(n),i;t===ErrorMsg.AllianceActionInBlockedState&&(i=n.data.TimeToDone,e.errorUserCantJoinToAllianceBecauseInBlockedState(Utils.Time.Seconds2Time(i)));console.log("allianceService._acceptJoinUserToAlliance.errorAnswer",{msg:t,errorAnswer:n})})}function ai(n,t,i){n&&n.Requests&&n.Requests.length&&(y(!0),r.applyTimeout(function(){_.remove(n.Requests,function(n){return n.GroupId===t});gt(i,!0).finally(function(){y(!1)})}))}function vr(n){n&&typeof n=="number"&&ai(v.getRequestsFromMyAlliance(),n,!0)}var v=this,d={},w=Utils.ModelFactory,b,ct=null,ti=null,p,ii=0,lt=0,it,k,nt,bt,kt,dt,ot,rt,ht,ut,ft;Object.defineProperty(v,"_allianceTotalCount",{get:function(){if(lt!==v._scrollerOptions.TotalServerCount){var n=_.filter(p,function(n){return!n.Disbandet&&n.Id>=1e3});v._scrollerOptions.TotalServerCount=lt=n.length}return ii},set:function(n){ii=n}});this._scrollerOptions=i.IScrollerOptions();it=appL10n.getL10NCurrentLanguage();k={IsAlliance:1,IsUser:2};this.MESSAGE_SOURCE_TYPE=k;nt={NoAction:1,Accept:2,Reject:3};this.armAllianceAcceptedStatus=nt;Object.defineProperty(v,"$hub",{get:function(){return GameServices.mainGameHubService}});this.addAllianceNameToLocal=vt;this.getAllianceNames=pi;this.getAllianceItemDescription=function(n){if(n&&_.startsWith(n,"{")){var t=JSON.parse(n);return t[it]}return n};this.isCurrentModel=function(){return b?n.isCurrentModel(b):!1};this.Role=function(){function f(n,t){this.propName=n;this.propVal=t}function o(n,t){this.TranslateName=null;this.Id=t;this.NativeName=n;this.updateTranslateName=function(n){this.TranslateName=n[this.NativeName][it]}}function s(){var n=this;return this._roles={},this.Add=function(n,t){this._roles[n]=t},this.Get=function(t){return n._roles[t]},this.GetCurrent=function(n){return this.Get(n).getCurrent()},this}function r(){this.Creator=w.INameIdModel(1,"Creator");this.Recrut=w.INameIdModel(2,"Recrut");this.Director=w.INameIdModel(3,"Director");this.RecrutManager=w.INameIdModel(4,"RecrutManager");this.Scientist=w.INameIdModel(5,"Scientist");this.InfoManager=w.INameIdModel(6,"InfoManager");this.AdvManager=w.INameIdModel(7,"AdvManager");this.ChannelManager=w.INameIdModel(8,"ChannelManager");this.Reader=w.INameIdModel(11,"Reader");this.Outcast=w.INameIdModel(12,"Outcast")}var n={},i,t,u;return n.IRolePropModel=function(n,t){return new f(n,t)},n.ISelectRole=function(n,t){return new o(n,t)},i={EditAllianceInfo:"EditAllianceInfo",CanManagePermition:"CanManagePermition",MessageRead:"MessageRead",MessageSend:"MessageSend",SetTech:"SetTech",ShowManage:"ShowManage",AcceptNewMembers:"AcceptNewMembers",DeleteMembers:"DeleteMembers"},r.prototype._error=function(n){if(SHOW_DEBUG)throw new Error("paramIsWrong param : "+n);return null},r.prototype.getIdByName=function(n){if(typeof n!="string")return this._error(n);var i=n.toLowerCase(),t;return(_.forEach(this,function(n){if(n.Name.toLowerCase()===i)return t=n.Id,!1}),!t)?this._error(n):t},r.prototype.getNameById=function(n){if(typeof n!="number")return this._error(n);var t;return(_.forEach(this,function(i){if(i.Id===n)return t=i.Name,!1}),!t)?this._error(n):t},r.prototype.equal=function(n,t){var i=typeof n,r=typeof t;return i===r?i==="number"?n===t:i==="string"?n.toLowerCase()===t.toLowerCase():this._error("source is: "+n+" , sourct is:"+t):i==="string"?this.getNameById(n).toLowerCase()===t.toLowerCase():r==="string"?this.getNameById(t).toLowerCase()===t.toLowerCase():this._error("source is: "+n+" , sourct is:"+t)},t=n.roleNativeNames=new r,n.rolePropsKeys=i,n._addAdvancedDataToPlanshetRole=function(t){var i=t.Bodys[1].TemplateData.AllianceMembers.Roles;_.forEach(i,function(t,i){t.translateRoleHtmlDescription=n.allianceRoleDescription.GetCurrent(i)})},n.getRoleByName=function(n){var r=t.getIdByName(n),i;return typeof r=="number"&&(i=v.getMyAllianceData(),i&&i.AllianceMembers&&i.AllianceMembers.Roles.hasOwnProperty(r))?i.AllianceMembers.Roles[r]:null},n.createSelectRoles=function(n){return _.map(t,function(t){var i=new o(t.Name,t.Id);return i.updateTranslateName(n),i})},n.getRolePropertyName=function(n,t){return n[t][it]},n.allianceRoleDescription=function(){function n(n,t,i,r,u){var f="alliance-role-description",e="unique-name";return u&&(f=u),i&&(e=i),"<div class='"+f+"'>"+Utils.SetSpanText(n,e)+Utils.SetSpanText(t,r)+"<\/div>"}var i=new s,r=Utils.CreateLangSimple;return i.Add(t.Creator.Id,r(n("Leader "," description heare"),n("Líder "," description heare"),n("Лидер "," обладает безграничными полномочиями в рамках своего альянса"))),i.Add(t.Recrut.Id,r(n("Member ","description heare"),n("Miembro ","description heare"),n("Участнику ","доступны основные функции комуникации в альянсе<br><b>Полномочия:<\/b><br>-отправка сообщений в чат альянса <br>-чтение сообщений альянса"))),i.Add(t.Director.Id,r(n("Director ","description heare"),n("Director ","description heare"),n("Директор ","назначается лидером для помощи в управлении альянсом и обладате теми же полномочиями что и лидер альянса"))),i.Add(t.RecrutManager.Id,r(n("HR Manager ","descr HR Manager"),n("HR Gerente "," descr HR Manager"),n("HR Менеджер ","занимается рассмотрением заявок от кандидатов на вступление в альянс<br><b>Полномочия:<\/b><br>-Приём заявок на вступление в альянс"))),i.Add(t.Scientist.Id,r(n("Scientist ","description heare"),n("Científico ","description heare"),n("Учёные ","уполномочены выбирать направление развития технологий в альянсе<br><b>Полномочия:<\/b><br>-Доступ в лаботаторию альянса"))),i.Add(t.InfoManager.Id,r(n("Community manager ","description heare"),n("El responsable de comunicacion ","description heare"),n("Комьюнити менеджер ","отвечает за информационную составляющую альянса<br><b>Полномочия:<\/b><br>-Редактирование информации альянса"))),i.Add(t.AdvManager.Id,r(n("Deputy director ","description heare"),n("Subdirector ","description heare"),n("Заместитель директора ","руководит альянсом в отсутствие вышестоящего руководства<br><b>Полномочия:<\/b><br>-Приём заявок на вступление в альянс<br>-Доступ управлением лаботаторией альянса<br>-Редактирование информации альянса"))),i.Add(t.ChannelManager.Id,r(n("Messenger ","description heare"),n("Mensajero ","description heare"),n("Связист ","руководит каналами связи альянса<br><b>Полномочия:<\/b><br>-Управление каналами связи альянса"))),i.Add(t.Reader.Id,r(n("Observer ","description heare"),n("Observador ","description heare"),n("Наблюдателю ","доступно только чтение альянсовых сообщений<br><b>Полномочия:<\/b><br>-Чтение сообщений альянса"))),i.Add(t.Outcast.Id,r(n("Outcast ","description heare"),n("El exiliado ","description heare"),n("Изгой ","отбывающий наказание, не имеет никаких прав и ограничен в комуникации с альянсом<br><b>Полномочия:<\/b><br>-Лишён всех полномочий"))),i}(),n.initRoleView=function(t,r,u,e){function s(t,i){return new f(n.getRolePropertyName(u,t),i)}if(!t.hasOwnProperty(r)){var o=e[r];t[r]=[s(i.EditAllianceInfo,o.EditAllianceInfo),s(i.CanManagePermition,o.CanManagePermition),s(i.MessageRead,o.MessageRead),s(i.MessageSend,o.MessageSend),s(i.SetTech,o.SetTech),s(i.ShowManage,o.ShowManage),]}},n.initRolesView=function(i,r){var u=v.getMyAllianceData(),f;if(!u||!u.AllianceMembers||!u.AllianceMembers.TranslateRoleFields)throw Errors.ClientNotImplementedException({rolesView:i,outRoles:r,data:u});f=u.AllianceMembers.TranslateRoleFields;_.forEach(t,function(t){n.initRoleView(i,t.Id,f,r)})},n.getTranslateRoleName=function(n,t){return n[t][it]},n.updateLoacalAmRole=function(n,t){var r=v.getMyAllianceMembers(),i=_.find(r.Members,function(t){return t.UserId===n});return i?(Utils.UpdateObjData(i.Role,t),i):null},u=!1,n.requestUpdateUserRole=function(t,i,r,f,o,s,h){u||(u=!0,v.$hub.allianceUpdateUserRole(t,r,f).finally(function(){u=!1}).then(function(t){e.openDialogRoleUpdated(i,o,s);t.$$RootScope=h;t.IsCurrentUser=!1;n.onAllianceUserUpdateRole(t)},function(n){var t=Errors.GetHubMessage(n);if(t===ErrorMsg.NotPermitted)e.openDialogNotPermitted(s);else if(t===ErrorMsg.AllianceRoleNotChanged)e.openDialogRoleNotChanged(i,o,s);else throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t,targetUserName:i,targetUserId:r,targetRoleId:f,targetRoleName:o});}))},n.onAllianceUserUpdateRole=function(t){var i=v.getMyAllianceData(),u,r,f;if(i&&i.Id===t.AllianceId&&i.hasOwnProperty("AllianceMembers")&&i.AllianceMembers.hasOwnProperty("Members")&&i.AllianceMembers.Members){if(u=t.NewRole,r=n.updateLoacalAmRole(t.TargetUserId,u),!r)return;if(t.IsCurrentUser){if(u.AcceptNewMembers&&!t.AllianceUserRequests)throw Errors.ClientNullReferenceException({answer:t,allianceMember:r,data:i},"allianceService.Role.onAllianceUserUpdateRole","user has role but AllianceUserRequests not exist");f=v.getManageTabData();f.AllianceUserRequests=t.AllianceUserRequests}t.$$RootScope.$broadcast("alliance:user-role-updated",{allianceMember:r,IsCurrentUser:t.IsCurrentUser})}},n}();this.toggleAlliance=gi;this.getAllianceItem=nr;this.filterAllianceSerchByName=fi;ti=function(n){return!!_.find(v.getAllianceList(),{Id:n})};ct=function(n){d.Bodys[0].TemplateData.Collection=_.unionBy(v.getAllianceList(),[n],"Id")};this.getTabs=tr;this.getAllianceList=function(){return ir().TemplateData.Collection};this.addItemInAllianceList=ct;this.getMyAllianceData=function(){var n=pt(1);return n&&n.hasOwnProperty("TemplateData")?n.TemplateData:null};this.getMyAllianceId=function(){var n=v.getMyAllianceData();return n&&n.hasOwnProperty("Id")?n.Id:null};this.getMyAllianceName=ei;Object.defineProperty(v,"$currentUserInfo",{get:function(){var n=v.getMyAllianceData(),t;if(!n)throw new Error("current alliance not exist");var i=f.getCurrentUserId(),e=f.getCurrentUserName(),o=f.getCurrentUserAvatar(),r=null,u=null,s=n.Id,h=n.Name,c=n.Label;return n.hasOwnProperty("AllianceMembers")&&n.AllianceMembers&&n.AllianceMembers.hasOwnProperty("Members")&&n.AllianceMembers.Members&&n.AllianceMembers.Members.length>0&&(t=_.find(n.AllianceMembers.Members,function(n){return n.UserId===i}),t&&(r=t.AllianceUserId,u=t.Role.Id)),Utils.ModelFactory.AllianceUserShort(s,h,i,e,r,u,c,o)}});Object.defineProperty(v,"_allianceTranslate",{get:function(){return bt||(bt=_.cloneDeep(GameServices.translateService.getAlliance())),bt}});Object.defineProperty(v,"_commonTranslate",{get:function(){return kt||(kt=_.cloneDeep(GameServices.translateService.getCommon())),kt}});this.setAllianceStatsModelInScope=function(n,t,i){var h,r;if(!n||!t)return null;t.AllianceTranslates||(t.AllianceTranslates=v._allianceTranslate);var e=t.AllianceTranslates,s=u.createStatItemModel(e.leader,t.LeaderName,null,null," link-to-target unique-name "),o=u.createStatItemModel(e.name,t.Name,null,null," unique-name ");return i?et(t.Name)||(o.advancedCssVal+="link-to-target active ",o.hasOnclick=!0,o.onClick=function(){fi(t.Name)}):f.setOnClickToUser(s,t.LeaderName),h=[o,s,u.createStatItemModel(e.pvpPoint,t.PvpPoint),u.createStatItemModel(e.tax,t.TaxView+""),u.createStatItemModel(e.controlledPlanet,t.ControlledPlanet),u.createStatItemModel(e.population,t.Pilots)],r=u.createBgImage("",t.Name),r.url=t.Label.Detail,r.style={backgroundImage:Utils.CssHelper.SetUrl(r.url)},u.resizePictire(r.style,r.url),n.allianceStatsModel=u.createStatisticModel(h,r),n};this.isNpcAllianceName=et;dt=!1;this.allianceButtonsNativeName={leaveFromAlliance:"leavefromalliance",joinToAlliacne:"jointoalliacne"};this.getAllianceItemBtns=function(n){var t=n.Buttons,i=[];return t&&_.forEach(i,function(n){i.push(_.cloneDeep(n))}),t};this.updateMessageBlockedState=y;this.getMessageBlockedState=g;this.leaveFromAlliance=function(n,t,i,r){var h,c;if(!ot&&n&&n.hasOwnProperty("Id")&&n.Id){function n(){ot=!1}if(h=r.button,h.Params.NativeName!=="LeaveFromAlliance".toLowerCase())return;var o=r.$parent.item,s=o.Name,u=1;if(o.Pilots===1?u=2:(c=f.getCurrentUserInfo().Name,c.toLowerCase()===o.LeaderName.toLowerCase()&&(u=2)),u===2)e.openDialogLeaveLeader(s);else if(u===1)ot=!0,e.openDialogleaveFromAlliance(s).then(function(){v.$hub.allianceLeaveFromUserAlliance().then(function(t){tt(t,!0);e.openDialogOnLeaveFromUserAlliance(s).finally(n)},function(t){var i=Errors.GetHubMessage(t);console.log("leavePilotFromAlliance",{errorAnswer:t,msg:i});n()})},function(){ot=!1});else throw new Error("leaveFromAlliance.leaveType NotImplementedException");}};rt=!1;this.dropUserFromAlliance=function(n,t,i){rt||e.openDialogDropUserFromAlliance(n,i).then(function(){return rt=!0,v.$hub.allianceDropUserFromAlliance(t).finally(function(){rt=!1}).then(function(){},function(n){var t=Errors.GetHubMessage(n);if(t===ErrorMsg.NotPermitted)e.openDialogNotPermitted(i);else throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"allianceDropUserFromAlliance.error");})},function(){rt=!1})};this.onAllianceUserDroped=function(n,t,i){tt(i,!0);console.log("onAllianceUserDroped",{oldAllianceId:n,newConnectionUser:t,newPlanshetData:i})};this.updateAllianceMemberStatusByUserName=function(n,t,i){si(sr(n,t),i)};this.updateAllianceMemberStatusByUserId=function(n,t,i){si(oi(n,t),i)};this.getMyAllianceMembers=function(){var n=v.getMyAllianceData();return n&&n.hasOwnProperty("AllianceMembers")?n.AllianceMembers:null};this.getCurrentUserMemberFromMembers=function(n){var i=f.getCurrentUserId(),t=_.find(n,function(n){return n.UserId===i});if(!t)throw new Error("user not exist");return t};this.getRequestsFromMyAlliance=function(){var n=v.getMyAllianceData();return n&&n.hasOwnProperty("AllianceUserRequests")&&n.AllianceUserRequests?n.AllianceUserRequests:null};this.hasRequestsInMyAlliance=function(){return!!v.getRequestsFromMyAlliance()};this.requestDeleteRequestForUserToAlliance=function(n,t,i,r){e.openDialogDeleteUserRequestToAlliance(t,function(t){v.$hub.requestAllianceDeleteRequestForUserToAlliance(n).then(function(i){if(i)vr(n,!0),t(!1),r instanceof Function&&r(i);else{t(!1);throw new Error("requestDeleteRequestForUserToAlliance.Error");}},function(n){var i=null;n&&(i=Errors.GetMessage(n),console.log("requestDeleteRequestForUserToAlliance.errorAnswer",{msg:i,errorAnswer:n}));t(!1);throw new Error(n);})},y,i)};this.myAllianceRequestSendRequestMessage=function(n,t,i,r){if(typeof n!="object")throw new Error("AllianceMessageModelExt allianceService.myAllianceRequestSendRequestMessage argument armModelExt is wrong");e.openDialogSendMessage(n,function(){function i(){y(!1)}function r(n){t instanceof Function&&t(n);console.log({answer:n})}function u(t){var r=Errors.GetMessage(t);n.FromAlliance||(r==="YouInAlliance"?e.errorUserInAlliance(ei()).finally(i).then(function(n){console.log("allianceDialogHelper.errorUserInAlliance on ok",n)},function(n){console.log("allianceDialogHelper.errorUserInAlliance on cancel",n)}):e.errorJoinToAlliance(t,n.Model.ToId,n.Model.ToName,v));console.log({errorAnswer:t})}if(n.FromAlliance&&!n.AllianceUserId||n.FromAlliance&&!n.AllianceRoleId){console.log("myAllianceRequestSendRequestMessage.NOT PERMITION");return}n.Model.AllianceAccepted===0&&(n.Model.AllianceAccepted=nt.NoAction);y(!0);n.FromAlliance?v.$hub.requestAllianceFromAllianceManageAddMessage(n).finally(i).then(r,u):v.$hub.requestAllianceFromMyAllianceAddMessage(n).finally(i).then(r,u)},y,r)};this.addNewRequetToMyAlliance=function(n){var t=v.getRequestsFromMyAlliance();if(!t)if(SHOW_DEBUG){console.log({requests:t,newDataArmModelExt:n});throw new Error("allianceService.addNewRequetToMyAlliance : no data");}else return;y(!0);r.applyTimeout(function(){ci(t,n,!0,v.createMyAllianceRequestBtns)})};this.addNewRequetToAllianceManage=function(n){var t=hi();if(!t)if(SHOW_DEBUG)throw new Error("allianceService.addNewRequetToAllianceManage : no data");else return;y(!0);r.applyTimeout(function(){ci(t,n,!1,v.createAllianceManageRequestBtns)})};this.onRequestAllianceConfirmAcceptFromAllianceManage=function(n,t){var i=Utils.ModelFactory.AllianceMessageModelExt();i._setFromData(n);t?(v.addNewRequetToMyAlliance(i),l(function(){y(!0);var n=i.Model.FromName;e.onRequestAllianceConfirmAcceptToAllianceForUser(n).finally(function(){console.log("onRequestAllianceConfirmAcceptToAllianceForUser.finally");y(!1)}).then(function(n){li(i.Model.FromId);console.log("onRequestAllianceConfirmAcceptToAllianceForUser.now",n)},function(n){console.log("onRequestAllianceConfirmAcceptToAllianceForUser.late",n)})},100)):v.addNewRequetToAllianceManage(i)};this.onRequestAllianceRejectRequestToAlliance=function(n,t,i){console.log("onRequestAllianceRejectRequestToAlliance",{isRequestUser:t,rejectUserId:n,armModelExt:i});t?v.addNewRequetToMyAlliance(i):v.deleteRequestHistoryFromAllianceManage(n)};this.onDeleteAllianceRequestsByManager=function(n,t){var i=v.getMyAllianceData();i&&i.Id===n&&v.deleteRequestHistoryFromAllianceManage(t)};this.createAllianceManageRequestBtns=function(n){if(n.AllianceAccepted===nt.Accept)return n.ButtonsView=[],n.ButtonsView;if(!n.hasOwnProperty("ButtonsView")){var t=lr();function i(){y(!1)}function r(n,r,u,f,e){var o,s;g()||(o=n.request,st(o))&&(s=ni(t,o),y(!0),v.myAllianceRequestSendRequestMessage(s,function(n){console.log("createMessageToMember.succsess",n);v.addNewRequetToAllianceManage(n)},function(n){console.log("createMessageToMember.errorAnswer",n);i()},e))}function u(n,t,r,u,f){if(!g()){var o=n.request;st(o)&&(y(!0),e.openDialogAllianceManageRefuseMemberRequest(o.GroupName,f).finally(i).then(function(){y(!0);v.$hub.requestAllianceRejectRequestToAlliance(o.GroupId).finally(i).catch(function(n){var t="createAllianceManageRequestBtns.refuseMember.Error, request data";n&&(t=Errors.GetHubMessage(n));console.log("createAllianceManageRequestBtns.refuseMember.Error, request data",{request:o,ErrorMsg:t})})},function(){}))}}function f(n){var r,u;g()||(r=n.request,r)&&(y(!0),u=ni(t,r),v.$hub.requestAllianceConfirmAcceptFromAllianceManage(u).finally(i).then(v.onRequestAllianceConfirmAcceptFromAllianceManage,function(n){var t=Errors.GetHubMessage(n);t===ErrorMsg.UserInAlliance&&e.errorAllianceManageTargetUserInAlliance(u.Model.ToName).then(function(){v.deleteRequestHistoryFromAllianceManage(r.GroupId)},function(n){console.log("cancel",n)});console.log("onRequestAllianceConfirmAcceptFromAllianceManage.Error",{errorAnswer:n})}))}GameServices.paralaxButtonHelper.createAllianceManageUserRequestBtns(n,r,u,f,nt)}return n.ButtonsView};this.createMyAllianceRequestBtns=function(n){function i(){y(!1);console.log("createMyAllianceRequestBtns.always")}function r(r,u,f,e,o){var s,h;(console.log("createMyAllianceRequestBtns.createMsg",{params:r,requestItem:n,getMessageBlockedState:g(),bms:t}),g())||(s=r.request,st(s))&&(h=ni(t,s),y(!0),v.myAllianceRequestSendRequestMessage(h,function(n){if(!n)throw new Error("allianceService.myAllianceRequestSendRequestMessage no answer");v.addNewRequetToMyAlliance(n)},function(){i()},o))}function u(n,t,i,r,u){var f=n.request;st(f)&&(y(!0),v.requestDeleteRequestForUserToAlliance(f.GroupId,f.GroupName,u,function(){gt(!0,!0)}))}function f(n){if(!g()){var t=n.request,i=t.GroupId;li(i)}}var t=ar();return GameServices.paralaxButtonHelper.getOrCreateMyAllianceRequestBtns(n,r,u,f),n.ButtonsView};this.sendRequestJoinToAlliance=function(n,t,i,r,u){var f,h,s,o;if(n&&n.hasOwnProperty("Id")&&n.Id&&n.hasOwnProperty("AllianceName")&&n.AllianceName){if(f=v.$currentUserInfo,!et(f.allianceName)){e.errorUserInAlliance(f.allianceName);return}if(h=n.Id,s=n.AllianceName,!f.userName||!f.userId||!f.userAvatar||!h||!s||!f.allianceRoleId||!f.userAvatar.Icon){console.log("requestJoinToAlliance.error input data incorrect");return}o=Utils.ModelFactory.AllianceMessageModelExt(!1,f.allianceRoleId,f.allianceUserId);o._setModel(k.IsUser,f.userId,f.userName,f.userAvatar.Icon);o.Model._setTo(h,s);o.Model.AllianceAccepted=nt.NoAction;v.myAllianceRequestSendRequestMessage(o,function(n){v.addNewRequetToMyAlliance(n,f.userName);e.openDialogJoinMessageSended(s)},function(n){console.log("sendRequestJoinToAlliance.myAllianceRequestSendRequestMessage.errorAnswer",n)},u)}};this.deleteRequestHistoryFromAllianceManage=function(n){typeof n=="number"&&ai(hi(),n,!1)};this.allianceAddNewUsersToAlliane=function(n,t){var i=v.getMyAllianceData(),r,u;i&&i.hasOwnProperty("AllianceMembers")&&i.AllianceMembers.hasOwnProperty("Members")&&i.AllianceMembers.Members&&(_.forEach(n,function(n){var t=_.find(i.AllianceMembers.Members,function(t){return t.UserId===n.UserId});t||(i.AllianceMembers.Members.push(n),i.Pilots++,i.ComplexButtonView.Collection[1].Data.Pilots=i.Pilots)}),r=!1,u=v.Role.getRoleByName(i.AllianceMembers.CurrentUserRoleName),u&&u.AcceptNewMembers&&(r=!0),r&&_.forEach(n,function(n){v.deleteRequestHistoryFromAllianceManage(n.UserId)}));t.$broadcast("alliance:user-join-to-alliance",{AllianceData:i})};this.allianceAddNewUserToAlliane=function(n,t){v.allianceAddNewUsersToAlliane([n],t)};this.onAllianceUserLeftAlliance=function(n,t,i){var r,u;console.log("aService.onAllianceUserLeftAlliance",{leftUserId:n,leftAllianceId:t});f.removeOtherProfileByUserId(n);r=v.getMyAllianceData();r&&r.Id===t&&r.hasOwnProperty("AllianceMembers")&&r.AllianceMembers.hasOwnProperty("Members")&&r.AllianceMembers.Members&&(u=_.find(r.AllianceMembers.Members,function(t){return t.UserId===n}),u&&(console.log("aService.onAllianceUserLeftAlliance.tryFindUser",{leftUserId:n,leftAllianceId:t,data:r,"data.PvpPoint":r.PvpPoint,"data.Pilots":r.Pilots}),r.Pilots--,r.ComplexButtonView.Collection[1].Data.Pilots=r.Pilots,_.remove(r.AllianceMembers.Members,function(t){return t.UserId===n})));console.log("aService.onAllianceUserLeftAlliance",{leftUserId:n,leftAllianceId:t,$$RootScope:i});i.$broadcast("alliance:user-left-from-alliance",{leftUserId:n,leftAllianceId:t})};this.getManageTabData=function(){var n=pt(2);return n?n.TemplateData:null};ht=!1;this.onAllianceDisbanded=function(n,t,i){wi(n);t?tt(i,!0):f.removeProfilesByAllianceId(n)};this.disbandAlliance=function(n,t,i,r,u){if(!ht){var f=v.$currentUserInfo,o=f.allianceId;if(!o){console.log("alliance id not exist",v.getMyAllianceData());return}v.Role.roleNativeNames.equal(v.Role.roleNativeNames.CreatorId,f.allianceRoleId)&&e.openDialogDisbandAlliance(f.allianceName,u).then(function(){ht=!0;var n=v.$hub;n.allianceDisbandAlliance().finally(function(){ht=!1}).then(function(n){console.log("onAllianceDisbanded.isOk",n)},function(n){console.log("disbandAlliance.errorAnswer",n)})},function(){})}};ut=null;this.allianceCreateMessages=function(){if(ut)return ut;var i=100,t=" "+i+" CC",n=Utils.CreateLangSimple;return ut={allianceCreatePrice:i,trCreateAlliance:n("EN Create alliance","ES Create alliance","RU Create alliance"),trAllianceTitlle:n("EN Allaince name","ES Allaince name","RU Allaince name"),trCreate:n("Create","Crear","Создать"),trErrorMsg:{required:n("en is required","es is required","ru is required"),minlength:n("en min minlength = 5","es min minlength = 5","ru min minlength = 5"),maxlength:n("en max maxlength = 12","es max maxlength = 12","ru max maxlength = 12"),pattern:n("en uppercase no spase first is letter end is letter or number","es uppercase no spase first is letter end is letter or number","ru uppercase no spase first is letter end is letter or number"),notUnic:n("EN Name not unic","ES Name not unic","RU Name not unic"),notChecked:n("EN not checked","ES not checked","RU not checked")},trMsgCanBuy:{trCanBuy:n("en Стоимость лицензии составляет :"+t,"es Стоимость лицензии составляет :"+t,"ru Стоимость лицензии составляет :"+t),trError:n("en На вашем балансе недостаточно средств стоимость лицензии составляет :"+t,"es На вашем балансе недостаточно средств стоимость лицензии составляет :"+t,"ru На вашем балансе недостаточно средств стоимость лицензии составляет :"+t)},trConfirm:{trTitle:n("EN Вы создаете альянс : ","ES Вы создаете альянс : ","RU Вы создаете альянс : "),trConfirm:n("Confirm","Confirmar","Подтвердить"),trCancel:n("Cancel","Cancelar","Отменить"),trTextContent:n("en C вашего счета будет списанно "+t,"es C вашего счета будет списанно "+t,"ru C вашего счета будет списанно "+t)},trConfirmGc:{trTitle:n("EN Congratulations!","ES Congratulations!","RU Congratulations!"),trHtmlContent:function(t){var i=n("EN Теперь вы лидер альянса  - "+yt(t," unique-name ")+" для завершения настройки передйтите в раздел управления.","ES Теперь вы лидер альянса  - "+yt(t," unique-name ")+" для завершения настройки передйтите в раздел управления.","RU Теперь вы лидер альянса  - "+yt(t," unique-name ")+" для завершения настройки передйтите в раздел управления.");return i.getCurrent()}},trCheck:n("EN Check","ES Check","RU Check")}};this.checkNameIsUnic=function(n,t,i,r){if(n||t(!1),n.length<5&&t(!1),r||(n=n.toUpperCase()),at(n)){t(!1);return}v.$hub.allianceCheckAllianceNameIsUnic(n).then(function(n){if(typeof n=="boolean"){t(n);return}if(n.hasOwnProperty("Id")&&n.hasOwnProperty("Name")){vt(n);t(!1);return}n||t(!1)},function(n){var t=Errors.GetHubMessage(n);i instanceof Function&&i(t)})};this.canCreateAlliance=function(){var n=v.getMyAllianceData();return et(n.Name)};this.createAlliance=function(n,t,i,r,u){t||(n=n.toUpperCase());var f=v.$hub;f.allianceCreateAlliance(n).then(function(n){var t=n.ConnectionUser;f._updateCurrentUser(t);tt(n.NewAlliancePlanshet,!0);vt({Id:t.AllianceId,Name:t.AllianceName});u.setCc(n.NewBalanceCc);i instanceof Function&&i(t.AllianceName);console.log("createAlliance answer",n)},function(n){var t=Errors.GetHubMessage(n);r instanceof Function&&r(t)})};this.setEditAllianceInfoModelToScope=function(t,i,f){function c(t){n.setInProgress(t);y(t)}function d(n){o.mediumBindOptions.disableEditing=n;o.mediumBindOptions.toolbar=n?!1:{buttons:["bold","italic","underline","strikethrough","subscript","superscript","anchor","image","quote","pre","orderedlist","unorderedlist","indent","outdent","justifyLeft","justifyCenter","justifyRight","justifyFull","h1","h2","h3","h4","h5","h6","removeFormat","html"]};i.aeiCtrl.description=o;i.$broadcast("mediumEditor:update-option",o.mediumBindOptions)}var s=v.getMyAllianceData(),k=v._allianceTranslate,w=GameServices.paralaxButtonHelper.ComplexButtonView(),p,b,h,o,l;w.SimpleCentr(null,"Edit info");p=u.createStatItemModel(k.tax,s.TaxView+"");p.hasOnclick=!0;p.onClick=function(t){g()||n.getInProgress()||(c(!0),EM.Audio.GameSounds.dialogOpen.play(),e.openDialogChengeTax(s.Tax,t).then(function(n){_.endsWith(n,"%")&&(n=n.substr(0,n.length-1));var t=_.toInteger(n);if(t===s.Tax){c(!1);return}t<0?t=0:t>100&&(t=100);c(!1);v.$hub.allianceInfoUpdateTax(t);EM.Audio.GameSounds.dialogClose.play()},function(){EM.Audio.GameSounds.dialogClose.play();c(!1)}),console.log("on click by tax ",{$event:t}))};b=[p];h=u.createBgImage("",s.Name);h.url=s.Label.Detail;h.style={backgroundImage:Utils.CssHelper.SetUrl(h.url)};h.setTemplate("alliance-change-label.tmpl");u.resizePictire(h.style,h.url);o={text:s.AllianceDescription,activateEdit:!1,mediumBindOptions:{toolbar:!1,disableEditing:!0,placeholder:!1}};o.setActivate=function(n){r.applyTimeout(function(){o.activateEdit=n;d(!n)})};o.resetDescription=function(){o.text=s.AllianceDescription;o.setActivate(!1);EM.Audio.GameSounds.defaultButtonClose.play()};o.sendDescription=function(n,t,i,r,u){if(!GameServices.planshetService.getInProgress()){var f=typeof o.text=="string"&&s.AllianceDescription!==o.text;f?o.text.length<=a.AllianceDescription?(c(!0),v.$hub.allianceInfoUpdateDescription(o.text).finally(function(){c(!1)}).then(function(n){s.AllianceDescription=n.Description;o.text=n.Description;o.setActivate(!1);v.onAllianceInfoUpdateDescription(n.Description,n.Id);EM.Audio.GameSounds.defaultButtonClose.play()},function(n){var t=Errors.GetHubMessage(n);t===ErrorMsg.OverMaxLength?console.log("msg === ErrorMsg.OverMaxLength  (message lenght > 600)"):t===ErrorMsg.NotPermitted&&console.log("msg === ErrorMsg.NotPermitted  not has edit role in alliance");o.resetDescription();console.log("msg",{msg:t,errorAnswer:n})})):e.errorDescriptionOverMaxLength(u,o.text.length).finally(o.resetDescription):o.resetDescription()}};l={edit:GameServices.paralaxButtonHelper.ButtonsView(),send:GameServices.paralaxButtonHelper.ButtonsView(),cancel:GameServices.paralaxButtonHelper.ButtonsView()};l.edit.ConstructorSizeBtn(1,!0,v._commonTranslate.edit,function(){(console.log(" buttons.edit.ConstructorSizeBtn",{getInProgress:GameServices.planshetService.getInProgress(),buttons:l,scope:i}),GameServices.planshetService.getInProgress())||(EM.Audio.GameSounds.defaultButtonClick.play(),o.setActivate(!0))});l.send.ConstructorSizeBtn(2,!0,v._commonTranslate.send,o.sendDescription);l.cancel.ConstructorSizeBtn(2,!0,"Cancel",o.resetDescription);t.description=o;t.Buttons=l;t.complexButtonView=w;t.onClickCb=function(){i.dropElementonClickByDropable(f)};t.allianceStatsModel=u.createStatisticModel(b,h);o.setActivate(!1)};this._updateAllianceInfo=function(n,t){if(!t||!n)return null;var i=t,f=n.ComplexButtonView.Collection[0],u=n.ComplexButtonView.Collection[1],e=n.ComplexButtonView.Collection[2];return r.applyTimeout(function(){n.Id!==i.Id&&(n.Id=i.Id);n.LeaderName!==i.LeaderName&&(n.LeaderName=i.LeaderName);n.Tax!==i.Tax&&(n.Tax=i.Tax,n.TaxView=i.Tax+"%");n.AllianceDescription!==i.AllianceDescription&&(n.AllianceDescription=i.AllianceDescription||"");_.isEqual(n.Label,i.Label)||Utils.UpdateObjData(n.Label,i.Label);_.isEqual(n.LeaderImg,i.LeaderImg)||Utils.UpdateObjData(n.LeaderImg,i.LeaderImg);n.Pilots!==u.Pilots!==u.Data.Pilots!==i.Pilots&&(n.Pilots=u.Pilots=u.Data.Pilots=i.Pilots);n.PvpPoint!==u.PvpPoint!==u.Data.PvpPoint!==i.PvpPoint&&(n.PvpPoint=u.PvpPoint=u.Data.PvpPoint=i.PvpPoint);n.Name!==f.Title!==f.Data.Title!==u.Name!==u.Data.Name!==e.Title!==i.Name&&(n.Name=f.Title=f.Data.Title=u.Name=u.Data.Name=e.Title=i.Name);n.ControlledPlanet!==u.ControlledPlanet!==u.Data.ControlledPlanet!==i.ControlledPlanet&&(n.ControlledPlanet=u.ControlledPlanet=u.Data.ControlledPlanet=i.ControlledPlanet);f.ImagePathOrCss!==f.Data.ImagePathOrCss!==t.Label.Icon&&(f.ImagePathOrCss=f.Data.ImagePathOrCss=t.Label.Icon);e.ImagePathOrCss!==e.Data.ImagePathOrCss!==t.LeaderImg.Icon&&(e.ImagePathOrCss=e.Data.ImagePathOrCss=t.LeaderImg.Icon)}),v.isCurrentModel()&&ri(),n};this.onAllianceInfoUpdateLabel=function(n,t){var i=v.getMyAllianceData(),r;i&&i.Id===t&&(i.Label=n,v._updateAllianceInfo(i,i),r=wt(t),v._updateAllianceInfo(r,i),f.updateAllianceInfoInProfiles(i))};this.onAllianceInfoUpdateDescription=function(n,t){var i=v.getMyAllianceData(),r;i&&i.Id===t&&(i.AllianceDescription=n,v._updateAllianceInfo(i,i),r=wt(t),v._updateAllianceInfo(r,i),f.updateAllianceInfoInProfiles(i))};this.onAllianceInfoUpdateTax=function(n,t){var i=v.getMyAllianceData(),r;i&&i.Id===t&&(i.Tax=n,i.TaxView=n+"%",v._updateAllianceInfo(i,i),r=wt(t),v._updateAllianceInfo(r,i),f.updateAllianceInfoInProfiles(i))};this.getAllianceTechModel=function(){var n=v.getMyAllianceData();return n?n.AllianceTechesOut:null};ft=!1;this.$updateTechConditionIfTechUpdate=function(n,t){t.Progress.Level&&(t.NativeName==="TechDamageControl"||t.NativeName==="TechWeaponUpgrade")&&_.forEach(n,function(i){if(i.Disabled&&i.Conditions[t.NativeName]<=t.Progress.Level){var r=t.NativeName==="TechWeaponUpgrade"?"TechDamageControl":"TechWeaponUpgrade",u=i.Conditions[r]<=n[r].Progress.Level;u&&(i.Disabled=!1)}})};this.$prepareTechItem=function(n,t){var f,i,r;t.infoStatsModel||(f=t.Progress.Advanced,i=[],_.forEach(f,function(n,t){var r=n.CurrentValue;t!=="Level"&&r&&(r=_.round(r,2)+"%");i.push(u.createStatItemModel(n.PropertyName,r))}),r=u.createBgImage(t.SpriteImages.Detail,t.Text.Name),r.onClick=function(n){GameServices.techTreeHelper.createTechTreeDialog(n,!0)},t.infoStatsModel=u.createStatisticModel(i,r));t.$getCanUpgrade||(t.$getCanUpgrade=function(){return n.AllianceTechesOut.CanUpgrade});!n.AllianceTechesOut.CanUpgrade||t.Disabled||t.$controls||(t.$controls={buyBtn:GameServices.paralaxButtonHelper.ButtonsView().ConstructorSizeBtn(1,!0,"Upgrade ("+t.BasePrice.Cc+" Alliance CC)",function(i,r,u,f,o){if(!ft&&!(t.BasePrice.Cc>n.BalanceCc)){if(!n.AllianceTechesOut.CanUpgrade){e.openDialogNotPermitted(o).then(function(){t.$controls=null;delete t.$controls});return}var s=t.Progress.Level+1;ft=!0;e.openDiaologConfirmTechUpgrade(o,t.Text.Name,s).then(function(){var i=t.Text.Name;v.$hub.allianceUpdateAllianceTech(t.TechType).then(function(){console.log("allianceUpdateAllianceTech answer");e.openDiaologTechUpgraded(o,i,s);ft=!1},function(i){var r=Errors.GetHubMessage(i);if(ft=!1,r===ErrorMsg.NotPermitted)e.openDialogNotPermitted(o);else if(r===ErrorMsg.NotEnoughCc)throw new Error("ErrorMsg.NotEnoughCc");else throw Errors.ClientNotImplementedException({errorAnswer:i,msg:r,techItem:t,myAllianceData:n});})});console.log("buyBtn",{techModel:n.AllianceTechesOut,techItem:t})}})})};this.prepareTechList=function(n){var t=[];return _.forEach(n.AllianceTechesOut.Teches,function(i){v.$prepareTechItem(n,i);t.push(i)}),t};this.onAllianceTechUpdated=function(n,t,i){var r=v.getMyAllianceData();r.BalanceCc=t;v.$updateTechConditionIfTechUpdate(r.AllianceTechesOut.Teches,n);_.forEach(r.AllianceTechesOut.Teches,function(t,i){if(t.TechType===n.TechType)return r.AllianceTechesOut.Teches[i]=n,!1});i.$broadcast("alliance:tech-updated",{newTech:n,myAllianceData:r})};this.getAllianceItemCompexBtnConfig=function(n){return _.find(v.getAllianceList(),{Id:n}).ComplexButtonView};this.setInitialAlliance=function(n){tt(n)};this.setAllianceNames=function(n){p=[];_.forEach(n,function(n){p.push(Utils.ModelFactory.IAllianceNameSerchItem(n))});v._allianceTotalCount=n.length};this.initializeScroll=function(n){var t=v._scrollerOptions;t.HtmlElementToBind=n;t.GetTotalServerCountPromise=rr;t.GetItemsCollection=v.getAllianceList;t.GetMinIdOrCondition=ur;t.GetPage=vi;t.SaveAndSetItem=er;i.initializeScroll(v._scrollerOptions)};this.onOtherUserConnected=function(n,t){t===v.getMyAllianceId()&&v.updateAllianceMemberStatusByUserId(t,n,!0)};this.onUserLeftGame=function(n){var t=n;v.$hub.isValidUserData(t)&&v.updateAllianceMemberStatusByUserId(t.AllianceId,t.UserId,!1)};this.onUserUpdateAvatar=function(n,t,i){var r=v.getMyAllianceData(),u;r&&(u=oi(i,t),u&&u.UserName===r.LeaderName&&(r.LeaderImg=n,r.ComplexButtonView.Collection[2].Data.ImagePathOrCss=n.Icon,v.isCurrentModel()&&ri()))};this.onLocalUserUpdateAvatar=function(n){var t=v.$currentUserInfo;if(t)v.onUserUpdateAvatar(n,t.userId,t.allianceId)}}]);Utils.CoreApp.gameApp.service("bookmarkService",["planshetService","tabService","mapInfoService","mainHelper","bookmarkDialogHelper","gameChestService",function(n,t,i,r,u,f){function b(t){n.updatePlanshet(t)}function it(n,t){return _.orderBy(n,["BookmarkId"],t?["ask"]:["desc"])}function rt(){return Utils.ModelFactory.BookmarkOut()}function ut(){return n.isCurrentModel(o)}function ft(n,t,i,r,u,f){function h(f){EM.EstateData.SaveCurrentSpaceLocation(n,t,i,r,u,f)}function y(){EM.GameCamera.Camera.minZ=EM.GameCamera.System.minZ}function c(n){EM.MapEvent.PlanetoidDubleClick(n,null,!0)}function p(n,t){h(t);c(n)}function w(n,r,u){EM.MapGeometry.System.Destroy();EM.SpaceState.SetNewCoord(t,i);EM.MapBuilder.System.Callback=function(){h(r);EM.StarLight.SetOther();var t=new EM.SpaceState.SpacePosition;t.setState(t.getSystemSelectedState());y();setTimeout(function(){c(n);u&&u()},100)};EM.MapBuilder.System.Build()}function l(n,t,i){var r=EM.GetMesh(n);r?p(n,t):w(n,t,i)}var s="bookmarkService.bookmarkJump_"+(n||0)+"_"+(t||0)+"_"+(i||0)+"_"+(r||0)+"_"+(u||0)+"_"+f,e,o,a,v;if(Utils.TimeDelay.IsTimeOver(s)&&(Utils.TimeDelay.Start(s),e=EM.MapGeometry.MapTypes,f)&&n&&t)if(o=f.toLowerCase(),o===e.Sector.toLowerCase())EM.MapEvent.SectorProgrammClick(t);else if(o===e.Star.toLowerCase()){if(i===0)return;a=EM.MapGeometry.System.GetOrCreateStarMeshId(i,u,!0);l(a,e.Star,EM.StarLight.SetOther)}else if(o===e.Planet.toLowerCase()){if(i===0)return;if(r===0)return;v=EM.MapGeometry.System.GetOrCreatePlanetMeshId(r,u,!0);l(v,e.Planet,EM.StarLight.SetInSystem)}}function p(n){return s.Bodys[n]}function c(n){return p(n).TemplateData}function w(n){var t=n.toLowerCase();return(t==="star"&&(t="system"),h.hasOwnProperty(t))?h[t]:(Utils.Console.Error("Не верный тип планетоида или ключа",{typeName:n,bodyIdx:h}),!1)}function k(){return c(h.planet)}function d(){return c(h.system)}function g(){return c(h.sector)}function et(n,t){var i=c(t);return _.findIndex(i,function(t){return t.BookmarkId===n})}function nt(n,t){var i=c(t);return _.find(i,function(t){return t.Id===n})}function ot(n,t){var i=c(t),r=_.findIndex(i,function(t){return t.BookmarkId===n});_.pullAt(i,r);return}function st(n,t){var u=p(n),r;u&&(r=u.TemplateData,r)&&(t.ComplexButtonView.IsNewItem=!0,r.push(t),t.mapStatsModel=i.getContent(t),u.TemplateData=it(r))}function ht(){function n(n){_.forEach(n,function(n){n.mapStatsModel=i.getContent(n)})}_.forEach(s.Bodys,function(t,i){var r=c(i);r.length>0&&n(r)})}function ct(){var n=k().length,t=d().length,i=g().length;return n+t+i}function lt(){var n=f.$hasPremium();return n?(console.log("outPremium",{hasPremium:n,GetPremiumMods:f.chestService.$getPremiumMods()}),y||(y=f.chestService.$getPremiumMods().PremiumBookmarkMod),Math.floor(v*y)):v}function at(){var n=lt(),t=ct();return n<=t}function tt(t){s=t;o=s.UniqueId;ht();n.updatePlanshetItemData(s,!0,Utils.Time.TIME_CACHE_BOOKMARKS)}function vt(n,t,i,r){var u;u=i?nt(n,t):et(n,t);u.ComplexButtonView.IsNewItem=r}function yt(n,t){if(s){if(at()){e.ErrorHandler.BookMarkLimitDone();return}var i=nt(t,w(n));if(i){e.ErrorHandler.BookmarkIsExist();return}e.$requestAddBookmark(n,t,!1)}else e.$requestAddBookmark(n,t,!0)}function pt(){if(o&&n.isCurrentModel(o)){n.toggle(o);return}var t=n.IHubRequestOptions(e.$hub.bookmarkGetPlanshet,o);t.OnSuccsess=function(t){tt(t);n.setCurrentModel(o);b()};t.OnError=function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"mapInfoService.getMapInfo");};t.TryGetLocal=!0;t.SetToCurrent=!0;t.UpdateCacheTime=!0;t.ChangePlanshetState=!0;t.CacheTime=Utils.Time.TIME_CACHE_BOOKMARKS;n.planshetHubRequest(t)}function wt(n){l||(l=!0,e.$hub.bookmarkDeleteItem(n.Data).finally(function(){l=!1}).then(function(t){t&&r.applyTimeout(function(){ot(n.Id,n.TabIdx)})},function(t){var i=Errors.GetHubMessage(t),r={errorAnswer:t,msg:i,params:n,bookmarksData:s};throw Errors.ClientNotImplementedException(r,"bookmarkService.deleteBokmark.error");}))}var e=this,o,s,v,y,h,l,a;this.$bdH=u;v=100;h={planet:0,system:1,sector:2};Object.defineProperty(e,"$hub",{get:function(){return GameServices.mainGameHubService}});this.ErrorHandler={BookMarkLimitDone:function(n){console.log("ErrorHandler.BookMarkLimitDone",{errorAnswer:n});u.getTextOpenDialogBookMarkLimitDone()},BookmarkIsExist:function(n){console.log("ErrorHandler.BookmarkIsExist",{errorAnswer:n});u.openDialogBookmarkIsExist()},HandleError:function(n){var t=Errors.GetHubMessage(n);return e.ErrorHandler.hasOwnProperty(t)?(e.ErrorHandler[t](n),!0):!1}};l=!1;a=!1;e.$requestAddBookmark=function(i,r,u){var f,h;a||(a=!0,f=rt(),f.TypeName=i,f.ObjectId=r,f.IsFull=u,h=w(i),e.$hub.bookmarkAddBookmark(f).finally(function(){a=!1}).then(function(i){u?(tt(i),vt(r,h,!0,!0)):st(h,i);var f=o&&ut();f||n.setCurrentModel(o);b(function(){t.delayActivate(h);n.isOpened()||n.toggle(o)})},function(n){if(!e.ErrorHandler.HandleError(n)){var t=Errors.GetHubMessage(n),u={errorAnswer:n,msg:t,data:f,mapType:i,mapObjectId:r,bookmarksData:s};throw Errors.ClientNotImplementedException(u,"bookmarkService.$requestAddBookmark.error");}}))};this.getTabs=function(){return s};this.loadBokmarksPlanshet=pt;this.bookmarkJump=ft;this.getPlanetItems=k;this.getSystemItems=d;this.getSectorItems=g;this.deleteBokmark=wt;this.addBookmark=yt}]);Utils.CoreApp.gameApp.service("mapInfoService",["planshetService","translateService","statisticHelper","profileService","$filter","mapInfoHelper","allianceService","npcHelper",function(n,t,i,r,u,f,e,o){function tt(n,t){if(a||(a=_.union(a,n)),t!==h.AllPlanets){if(k=Utils.Time.GetUtcNow(),t===h.OtherUsers){y=_.union(y,n);return}if(t===h.OnlyUserPlanet){p=_.union(p,n);return}}}function et(n){return n?n+Utils.Time.ONE_MINUTE_SECOND*5<Utils.Time.GetUtcNow():!0}function w(n){return n===h.AllPlanets?a:n===h.OtherUsers?y:n===h.OnlyUserPlanet?p.length===0||et(k)?(tt(GameServices.estateService.getEstateNames(),n),p):p:(SHOW_DEBUG&&console.log("Error serchType не верен",{serchType:n,serchPlanetType:h}),[])}function at(n,t){var i,u,r;return t?(i=w(n),!i||i.length===0)?!1:(u=t.toUpperCase(),r=_.filter(i,function(n){return n===u}),!r||r.length===0)?!1:r.length===1?!0:r.length>1?(SHOW_DEBUG&&Utils.Console.Error("Multimle chooses data:",{inputName:t,resultCollection:i}),!1):!1:!1}function vt(n,t,i,r){function u(n,t){if(!f||t)return n;var i=f.toUpperCase();return _.filter(n,function(n){return _.includes(n,i)})}function e(n){var t=u(n,!1);return t&&t.length>0}function o(){function t(n){return et(k)?(n=[],!0):!1}if(!k)return!0;var n=e(a);return a.length>0&&i===h.AllPlanets&&n?!1:y.length>0&&i===h.OtherUsers?t(y)?!0:!n:!0}var f=n;f?i===h.OnlyUserPlanet?t(u(w(i,r))):o()?ft.$hub.worldSerchPlanetNames(f,i).then(function(n){n&&n.length>0&&tt(n,i);t&&t(u(w(i,r)))},function(u){var f=Errors.GetHubMessage(u);throw Errors.ClientNotImplementedException({errorAnswer:u,msg:f,serchType:i,request:n,response:t,ignoreFiltr:r});}):t(u(w(i,r))):t(u(w(i,r)))}function yt(n,t){return n.toLowerCase()+"_"+t}function pt(t){return n.isCurrentModel(t)}function wt(t){return n.hasItemById(t)}function ot(t,i){n.setCurrentModel(t);n.open();n.updatePlanshet(i,t)}function kt(){b=t.getAlliance();s=t.getMapInfo();it=t.getCommon();st=!0}function v(){st||s&&b&&it||kt()}function ht(n){var t=i.createStatItemModel(s.owner,n.Owner,null,null,d);return o.isNpc(n.Owner)||r.setOnClickToUser(t,n.Owner),t}function rt(n,t){if(!t.AllianceName)return null;var r=i.createStatItemModel(n,t.AllianceName,null,null," unique-name ");return o.isNpc(t.AllianceName)||(r.advancedCssVal+="link-to-target active ",r.hasOnclick=!0,r.onClick=function(){e.filterAllianceSerchByName(t.AllianceName)}),r}function g(n,t,i){t||(n.advancedCssVal+=" active ",n.hasOnclick=!0,n.onClick=i)}function nt(n,t){var r=i.createStatItemModel(s.galaxy,n.GalaxyName,null,null,d);return g(r,t,function(){f.getGalaxyInfo(n.GalaxyId)}),r}function ut(n,t){var r=i.createStatItemModel(s.sector,n.SectorName,null,null,d);return g(r,t,function(){f.getSectorInfo(n.SectorId)}),r}function ct(n,t){var r=i.createStatItemModel(s.system,n.SystemName,null,null,d);return g(r,t,function(){f.getStarInfo(n.SystemId)}),r}function dt(n,t,r){var u=i.createStatItemModel(n,t.NativeName,null,null," unique-name ");return g(u,r,function(){f.getPlanetInfo(t.Id)}),u}function gt(n){v();var t=[nt(n,!0),i.createStatItemModel(s.type,n.SubtypeNativeName),i.createStatItemModel(s.sectors,n.ChildCount)],r=i.createBgImage(n.SpriteImages.Detail,n.GalaxyName);return i.createStatisticModel(t,r)}function ni(n){v();var t=[rt(b.dominantAlliance,n),ut(n,!0),nt(n),i.createStatItemModel(s.systems,n.ChildCount)],r=i.createBgImage(n.SpriteImages.Detail,n.SectorName);return i.createStatisticModel(t,r)}function ti(n){v();var t=[i.createStatItemModel("EnergyBonus_tr",n.Bonus,null,null,n.Bonus>1?" bonus-positive ":" bonus-negative "),ht(n),rt(b.alliance,n),ct(n,!0),ut(n),nt(n),i.createStatItemModel(s.type,n.SubtypeTranslateName),i.createStatItemModel(s.planets,n.ChildCount)],r=i.createBgImage(n.SpriteImages.Detail,n.SystemName);return i.createStatisticModel(t,r)}function ii(n){v();var t=[dt(it.name,n,!0),ht(n),rt(b.alliance,n),i.createStatItemModel(s.lastActivity,u("date")(new Date(n.LastActive),"dd.MM.yyyy"),null,null,bt),ct(n),ut(n),nt(n),i.createStatItemModel(s.type,n.TypeTranslateName||n.TypeNativeName),i.createStatItemModel(s.subType,n.SubtypeTranslateName),i.createStatItemModel(s.moons,n.ChildCount)],r=i.createBgImage(n.SpriteImages.Detail,n.SystemName);return i.createStatisticModel(t,r)}function ri(){v()}function ui(n){v();var t=[i.createStatItemModel(s.moon,n.NativeName,null,null," unique-name ")],r=i.createBgImage(n.SpriteImages.Detail,n.SystemName);return i.createStatisticModel(t,r)}function fi(n,t){c||(c={},c.galaxy=gt,c.sector=ni,c.star=ti,c.planet=ii,c.moon=ui,c.satellite=ri);var i=n.toLowerCase();if(c.hasOwnProperty(i))return c[i](t);console.log("methodNotExist",{modelName:n,model:t});return}function lt(n){return fi(n.TypeNativeName,n)}function ei(t,i,r,u,f){function o(){var o=n.IHubRequestOptions(function(){return r(i)},e);o.OnSuccsess=function(o){l=o;l.Bodys[0].TemplateData.mapStatsModel=lt(l.Bodys[0].TemplateData);e!==l.UniqueId&&Utils.Console.Error("planetoidId не совпадает!!! data: ",{planetoid:l,answer:o,uniqueId:e,type:t,id:i,url:r,update:f});n.addOrUpdatePlanshetModel(l);ot(e,u)};o.OnError=function(n){var e=typeof n=="string"?n:Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:e,type:t,id:i,hubAction:r,accept:u,update:f,opts:o},"mapInfoService.getMapInfo");};o.TryGetLocal=!1;o.SetToCurrent=!0;o.UpdateCacheTime=!0;o.CacheTime=Utils.Time.TIME_CACHE_PROFILE;n.planshetHubRequest(o)}var e=yt(t,i);if(!(r instanceof Function))throw Errors.ClientNullReferenceException({type:t,id:i,hubAction:r,update:f,accept:u},"hubAction","mapInfoService.getMapInfo");if(f){o();return}if(n.needUpdateCache(e)){o();return}if(pt(e)){n.toggle();return}if(wt(e)){l=n.getItemById(e);ot(e,u);return}o()}function oi(){return l.Bodys[0].TemplateData}var ft=this,l,h={AllPlanets:1,OtherUsers:2,OnlyUserPlanet:3},k,a=[],y=[],p=[];Object.defineProperty(ft,"$hub",{get:function(){return GameServices.mainGameHubService}});this.addPlanetNames=tt;this.containPlanetName=at;this.getPlanetNames=vt;var bt=" lower-text ",d=" unique-name link-to-target ",b,it,s,st=!1,c;this.getContent=lt;this.getMapInfo=ei;this.getPlanetoidInfo=oi;this.serchPlanetType=h}]);Utils.CoreApp.gameApp.service("confederationService",["planshetService","confederationDialogHelper","paralaxButtonHelper","compileHelper",function(n,t,i,r){function f(n,t){return this.NativeName=n,this.PlanshetIdx=t,this}function e(n){Object.defineProperty(u,n.NativeName,{get:function(){return u._confederationModel.Bodys[n.PlanshetIdx].TemplateData},set:function(t){u._confederationModel.Bodys[n.PlanshetIdx].TemplateData=t}})}var u=this;this.$planshetIndex=null;this.$cdH=t;this.$btnHelper=i;this.$compileHelper=r;Object.defineProperty(u,"_confederationId",{value:"confederation-collection",writable:!1,configurable:!1});Object.defineProperty(u,"_confederationModel",{get:function(){if(!u.$planshetIndex)throw Errors.ClientNullReferenceException({$self:u},"$self.$planshetIndex","confederationService",ErrorMsg.NoData);var t=n.$planshetModels[u.$planshetIndex];if(t.UniqueId!==u._confederationId)throw Errors.ClientNotImplementedException({$self:u},"is not  confederation model");return t},set:function(t){n.updatePlanshetItemData(t,!0,Utils.Time.TIME_CACHE_CONFEDERATION);u.$planshetIndex=n.getModelIndex(u._confederationId)}});Object.defineProperty(u,"$hub",{get:function(){return GameServices.mainGameHubService}});this.bodyIdx={Officers:0,Rating:1,Election:2};Object.freeze(this.bodyIdx);this.ConfederationTabNames={Officers:"Officers",Rating:"Rating",Election:"Election"};Object.freeze(this.ConfederationTabNames);this.ConfederationRefs={Officers:new f(u.ConfederationTabNames.Officers,u.bodyIdx.Officers),Rating:new f(u.ConfederationTabNames.Rating,u.bodyIdx.Rating),Election:new f(u.ConfederationTabNames.Election,u.bodyIdx.Election)};_.forEach(this.ConfederationRefs,function(n,t){Object.freeze(u.ConfederationRefs[t])});Object.freeze(u.ConfederationRefs);e(u.ConfederationRefs.Officers);e(u.ConfederationRefs.Rating);e(u.ConfederationRefs.Election);this.OfficerTypes={President:1,Atacker:2,Protector:3,Supporter:4};Object.freeze(this.OfficerTypes);Object.defineProperty(u,"$currentUserInfo",{get:function(){return GameServices.allianceService.$currentUserInfo}});this._updatePlanshet=function(t,i){n.updatePlanshet(t,u._confederationId,i)};this._toggle=function(){n.toggle(u._userChannelsUniqueId)};this.leftNavGetConfederation=function(){u.loadConfederationPlanshet()};this.loadConfederationPlanshet=function(t){t||!u._confederationModel?u.getServerPlanshetData(u._toggle):n.isCurrentModel(u._confederationId)?u._toggle():u._updatePlanshet(u._toggle,!0)};this._setNewPlanshetData=function(n,t){u._confederationModel=n;t instanceof Function&&t(u._confederationModel)};this.getServerPlanshetData=function(n,t){return u.$hub.confederationGetPlanshet().then(function(t){console.log("_______UPDATE_confederation_FROM SERVER______");u._setNewPlanshetData(t,n)},function(n){if(t instanceof Function)t(n);else{var i=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:i},"confederationService.getServerPlanshetData");}})};Utils.CoreApp.gameAppExtensions.ConfederationOfficers(this);Utils.CoreApp.gameAppExtensions.ConfederationRating(this);Utils.CoreApp.gameAppExtensions.ConfederationElection(this);this.setInitialConfederationsModel=function(n){u._confederationModel=_.cloneDeep(n[u._confederationId]);u.$checkAndRunOrDestroyVoteView(u.getElectionData())}}]);Utils.CoreApp.gameApp.service("estateService",["hangarService","mapControlHelper",function(n,t){"use strict";function a(n){var t=EM.EstateData.GetCurrentEstate();return Number.isInteger(n)&&n===t.EstateId?!0:(SHOW_DEBUG&&Utils.Console.Error("CurrentEstate is wrong",{GetCurrentEstate:t,id:n}),!1)}function v(){i=_.orderBy(i,["OwnId"],["ask"])}function s(){var n=angular.element(f).scope();n.$apply(function(){n.estateList=i})}function h(n,t){i=n;t||s()}function k(){return i}function c(n){return _.find(i,function(t){return t.OwnId===+n})}function d(n){_.remove(i,function(t){return t.OwnId===n});v();s()}function y(n){i=_.unionBy(i,n,"OwnId");v();s()}function g(n,t){o=!1;f.val(n).trigger("change",[n,t])}function nt(n){var t=u.$hub.estateGetEstateList();return t.then(function(t){var o,e;if(h(t),n){var r=Utils.RepoKeys.HtmlKeys.CssNewItem,u=angular.element("#own-list-container"),f=7,i=!0;function n(){i?u.addClass(r):u.removeClass(r)}n();e=setInterval(function(){f--;i=!i;(f<=0||o)&&(i=!1,n(),clearInterval(e));n()},1500);u.addClass(r)}},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"estateService.updateServerEstateList");}),t}function tt(n){var t=u.$hub.estateGetEstateItemByPlanetId(n);return t.then(y,function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"estateService.getServerEstateItem");}),t}function p(n,t){h(n,!0);EM.EstateData.SaveCurrentEstateByEsateType(!1,0);e=t}function w(n){function r(n){return i.attr(u,n)}var u,i,s;f=n;u="aria-expanded";i=n.parent();n.change(function(i,u){if(!o){o=!0;return}u=u||f.find(":selected")[0].value;n.scope().gameCtrl._$broadcastEstateId(u);var e=c(u);e.Type?t.jumpToUserPlanet(e):t.jumpToMother(e);r(!1)});n.select2({templateResult:function(n){var t=$("<div/>",{text:n.text,"class":"select2-estate-item-container"}),i=function(){var i=c(n.id),t;if(i)return(t=i.TextureTypeId,$.isNumeric(t))?EM.AssetRepository.GetIconSelectCss(t):null},r=$("<span/>",{"class":"select2-sprite "+i()});return t.prepend(r)},dropdownCssClass:"select2-dropdown-container-estate-resource"});Utils.Event.HasClick(i)||i.bind("click",function(){var t=Utils.ConvertToBool(i.attr(u));t?(n.select2("close"),r(!1)):(n.select2("open"),r(!0))});r(!1);s=this;e instanceof Function&&(e(),e=null,delete s.registerEvents,w=null,p=null)}function b(n,t){var i,f;if(!(typeof n=="number"))throw Errors.ClientNotImplementedException({onFinally:t,ownId:n,message:"НЕ установлен ид истоничка для обновления"},"estateService.getFullEstate");if(i=n===0,a(i?0:EM.EstateData.GetPlanetLocation().PlanetId)){if(!l){l=!0;r(!0);t instanceof Function&&t();return}return f=u.$hub.estateGetFullEstate(n),f.then(function(n){GameServices.buildReqHelper.addBuildsToPlanshet(n,i);r(!0);t instanceof Function&&t()},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"estateService.getFullEstate");}),f}}function it(n,t){var i=this;n.gameCtrl.setServerTime(t.serverTime);n.gameCtrl.setTranslate(t.TranslationKey);GameServices.gameChestService.$rebuildChestData(t[GameServices.gameChestService.CHEST_KEY]);p(t.EstateListDataKey,function(){delete i.loadGame});n.gameCtrl.setResources(t.ResourcesViewKey);n.gameCtrl.setEstateBuilds(t.EstateViewKey);n.gameCtrl.setCtrlData(t.BaseBtnsKey);n.gameCtrl.setInitialAlliance(t["alliance-collection"]);n.gameCtrl.setPersonalData(t.AvatarViewKey);n.gameCtrl.setAllianceNames(t.AllianceNamesKey);n.gameCtrl.setInitialUserChannelsModel(t);n.gameCtrl.setInitialConfederationsModel(t);GameServices.journalService.setInitializeJournal(t);n.gameCtrl.skagryLoaded=!0}var u=this,i,f,o=!0,e,r,l;Object.defineProperty(u,"$hub",{get:function(){return GameServices.mainGameHubService}});r=null;l=!1;r=function(n){function f(){var n=EM.EstateData.GetCurrentEstate();return t=n.EstateId,typeof t=="number"}function e(){GameServices.timerHelper.addSinchronizer("estate",function(){b(t)},Utils.Time.DELAY_SYNCHRONIZE,!!n);u=!0}var t,u,i,r;f()?e():(i=100,r=100,GameServices.planshetService.conditionAwaiter(f,e,r,i),SHOW_DEBUG&&setTimeout(function(){u||Utils.Console.Error("CurrentEstate is Wrong")},i*r+1))};this.getEstateNames=function(){var n=[];return _.forEach(i,function(t){t.Name!=="MotherShip"&&n.push(t.Name)}),n};this.setEstateListData=h;this.registerEvents=w;this.getEstateListData=k;this.getEstateItem=c;this.deleteEstateItem=d;this.addEstateItem=y;this.setEstate=g;this.getServerEstateItem=tt;this.updateServerEstateList=nt;this.getFullEstate=b;this.updateSinchronizer=r;this.isCorrectEstateId=a;this.loadGame=it}]);Utils.CoreApp.gameApp.factory("gameChestService",["chestService",function(n){return n.$getActiveItemByItemType=function(n,t){return!n||n.ActivatedItemsView?null:_.find(n.ActivatedItemsView,function(n){return n.ProductTypeId===t})},n.$getPremiumItem=function(){return n.getActiveDataByTypeId(n.ProductTypes.Premium.Id)},n.$getPremiumModelByChestData=function(t){var i=n.$getActiveItemByItemType(t,n.ProductTypes.Premium.Id);return!i||!i.Data||!i.Data.Premium?null:i.Data.Premium},n.$hasPremium=function(t){var i,r,u;return t?(i=t.Finished,i)?!1:(r=Utils.Time.GetUtcNow(),u=n.$getPremiumEndTime(),r>u&&(t.Finished=!0),!t.Finished):!1},n.$getPremiumEndTime=function(n){return n?n.EndTime:0},n.$getPremiumMods=function(){var t=n.$getPremiumItem();return!t||!t.ProductItemProperty||!t.ProductItemProperty.Property?null:t.ProductItemProperty.Property},n}]);Utils.CoreApp.gameApp.service("resourceService",[function(){function c(){return GameServices.industrialComplexService.getStorageData()}function p(n){c().StorageResources=n}function w(){return GameServices.industrialComplexService.getExtractionModuleData()}function o(){return c().StorageResources}function i(n){return _.find(u,function(t){return t.NativeName===n})}function l(){function t(n){n.Percent=GameServices.industrialComplexService.calcResPercent(n.Current,n.Max)}t(i(n.e));t(i(n.ir));t(i(n.dm))}function b(n,t){i(n).Max=t}function k(n,r){var u=i(n),f;u.Current=r;f=u.Max;r>=f&&(u.Current=f,t=!0);t&&e()}function d(n,r){var u=i(n),f;u.Current+=r;f=u.Max;r>=f&&(u.Current=f,t=!0);t&&e()}function s(t,i){function r(n,t){i?b(n,t):k(n,t)}r(n.e,t.E);r(n.ir,t.Ir);r(n.dm,t.Dm)}function g(t,i){function r(n,t){d(n,t)}r(n.e,t.E);r(n.ir,t.Ir);r(n.dm,t.Dm);i&&l()}function a(n,t){s(n.Max,!0);s(n.Current);t&&l()}function nt(n){var t=o().Current;return t.E<n.E?!1:t.Ir<n.Ir?!1:t.Dm<n.Dm?!1:!0}function f(){return i(n.cc)}function h(){return f().Current}function v(n){f().Current=n}function tt(n,t){t==="-"&&(n=-n);f().Current+=n}function it(n){return h()>=n}function rt(n){var i=n.Current,r=n.Max;return _.forEach(i,function(n,u){var f=r[u],e=i[u];if(e>=f)return t=!0,!1}),!1}function ut(){function e(n,t){return n+t/3600}function c(){n=_.cloneDeep(r);n.E=f(n.E);n.Ir=f(n.Ir);n.Dm=f(n.Dm)}var i,u,r,s,f,n,h;t||(i=o(),rt(i))||(u=w().ExtractionPerHour,r=Utils.ModelFactory.MaterialResources(),r.E=e(i.Current.E,u.E),r.Ir=e(i.Current.Ir,u.Ir),r.Dm=e(i.Current.Dm,u.Dm),s=_.cloneDeep(i),s.Current=r,p(s),f=Utils.ConvertToInt,c(),h=_.cloneDeep(i),h.Current=n,a(h,!0))}function ft(){GameServices.timerHelper.addViewSinchronizer("resources",ut)}function y(){t=!1;GameServices.estateService.updateSinchronizer(!0);ft()}var r=["e","ir","dm","cc"],n={e:r[0],ir:r[1],dm:r[2],cc:r[3]},u,t=!1,et=Utils.ModelFactory.ResourceItemModel(),e;e=function(){};this.init=function(n){u=n;y()};this.getEstateResources=function(){return u};this.isEnoughCc=it;this.addCc=tt;this.setBalanceFromErrorAnswerNotEnoughCc=function(n,t){if(t&&t===ErrorMsg.NotEnoughCc&&n.data&&n.data.InnerException&&n.data.InnerException.Message&&$.isNumeric(n.data.InnerException.Message)&&_.isInteger(+n.data.InnerException.Message)){var i=+n.data.InnerException.Message;return v(i),i}return h()};this.isEnoughResources=nt;this.updateViewCountsByMaterialResource=s;this.addViewCountsByMaterialResource=g;this.retstartView=y;this.getCcItem=f;this.getCcCount=h;this.getStorageResources=o;this.updateViewDataResourceByStorageResource=a;this.setCc=v}]);Utils.CoreApp.gameApp.service("buildReqHelper",["planshetService","statisticHelper",function(n,t){function s(n){return u.$hub[n]}function f(n){return n.Bodys[0].TemplateData}function h(n){var u,i=n.Info.Data,r,f;if(i&&i.IsTech){n.$isTech=!0;GameServices.laboratoryService.setTechViewData(t,n);return}if(!n.Info.infoStatsModel){if(i&&i.IsUnitDetail){if(!i.UnitStats)return;if(r=i.UnitStats,n.$isUnit=!0,n.Info.infoStatsModel)return;u=[t.createStatItemModel(r.HpName,r.Hp),t.createStatItemModel(r.AttackName,r.Attack)]}else n.$isBuild=!0,u=[t.createStatItemModel("build propKey","prop Val")];f=t.createBgImage(n.Info.DropImage,n.TranslateName);n.Info.infoStatsModel=t.createStatisticModel(u,f)}}function e(n,t,i){var r=GameServices.translateService.getUnit();_.forEach(t,function(t){var e,f,u;t.$guid||(t.$guid=Utils.Guid.CreateGuid(),e=t.$guid,t.ComplexButtonView.Collection[1].buildItemId=e,t.ComplexButtonView.Collection[2].buildItemId=e);t.unitTranslate||(t.unitTranslate=r);t.$isMother=i;t.$compileItem=!0;t.$isMother&&t.NativeName&&(t.NativeName==="Battleship"||t.NativeName==="Drednout")&&(t.$compileItem=!1);t.Info&&h(t);t.Update&&(t.Update.Price.forCc=!1,t.Update.upgradeCount=1,t.Update.HasButtons&&t.Update.Buttons.Submit&&(f=t.Update.Buttons.Submit,f.Method=GameServices.buildService.upgradeSubmit,f.Params=t,f.Params.parentUniqueId=n));t.Action&&(t.Action.sendFormDisabled=!0,u=t.Action.Buttons,u.hasOwnProperty("Submit")&&u.Submit&&(u.Submit.Params&&typeof u.Submit.Params=="object"||(u.Submit.Params={}),u.Submit.Params.parentUniqueId=n,u.Submit.Params.NativeName=t.NativeName,u.Submit.Method=function(n,t,i,r){GameServices.buildService.hasOwnProperty("actionSubmit")&&GameServices.buildService.actionSubmit instanceof Function&&GameServices.buildService.actionSubmit(n,t,i,r)}));t.$isUnit&&GameServices.spaceShipyardService.registerUnitItem(t)})}function c(t,i,r,u,s){e(t.UniqueId,f(t),s);n.addOrUpdatePlanshetModel(t);o(i,r,u||t.UniqueId)}function l(t,i,r,u,f,e){var h,o;(f=!!f,h=EM.EstateData.GetPlanetLocation(),GameServices.estateService.isCorrectEstateId(f?0:h.PlanetId))&&(!e&&n.needUpdateCache(u)&&(e=!0),o=n.IHubRequestOptions(function(){var n=f?null:h.PlanetId,i=s(t);return i(n)},u),o.OnSuccsess=function(n){c(n,i,r,u,f)},o.OnError=function(n){var o=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({hubActionName:t,setModel:i,afterSetPlanshet:r,uniqueId:u,isMother:f,ignore:e,msg:o,errorAnswer:n},"buildReqHelper.getBuild");},o.TryGetLocal=!e,o.SetToCurrent=!0,o.UpdateCacheTime=!0,o.CacheTime=Utils.Time.TIME_CACHE_BUILD,o.ChangePlanshetState=!0,n.planshetHubRequest(o))}function a(t,i){return n.isOpened()&&!t&&n.isCurrentModel(i)?(n.close(),!0):!1}function r(t,i,r,u){var f=t.getUniqueId(),e=f&&r!==n.getItemById(f).IsMother;a(e,f)||(u instanceof Function||(u=angular.noop),l(i,t.upgradeModel,u,f,r,e))}function v(){r(GameServices.industrialComplexService,i.GetMotherIndustrialComplex,!0)}function y(){r(GameServices.laboratoryService,i.GetMotherLaboratory,!0)}function p(){r(GameServices.spaceShipyardService,i.GetMotherSpaceShipyard,!0)}function w(){r(GameServices.industrialComplexService,i.GetIndustrialComplex,!1)}function b(){r(GameServices.commandCenterService,i.GetCommandCenter,!1)}function k(){r(GameServices.spaceShipyardService,i.GetSpaceShipyard,!1)}function d(t,i){_.forEach(t,function(r,u){t.hasOwnProperty(u)&&(e(r.UniqueId,f(r),i),n.addOrUpdatePlanshetModel(r))});GameServices.buildService.upgradeEstateBuilds(i)}var u=this,o=function(t,i,r){function u(){i instanceof Function&&i()}n.setCurrentModel(r);t();n.updatePlanshet(u)},i={GetMotherIndustrialComplex:"buildGetMotherIndustrialComplex",GetMotherLaboratory:"buildGetMotherLaboratory",GetMotherSpaceShipyard:"buildGetMotherSpaceShipyard",GetIndustrialComplex:"buildGetIndustrialComplex",GetCommandCenter:"buildGetCommandCenter",GetSpaceShipyard:"buildGetSpaceShipyard"};Object.defineProperty(u,"$hub",{get:function(){return GameServices.mainGameHubService}});this.getMotherIndustrialComplexList=v;this.getMotherLaboratoryList=y;this.getMotherSpaceShipyardList=p;this.getIndustrialComplexList=w;this.getCommandCenterList=b;this.getSpaceShipyardList=k;this.addBuildsToPlanshet=d}]);Utils.CoreApp.gameApp.service("buildService",[function(){function f(n){var t=EM.EstateData.GetCurrentEstate();return n===t.EstateId}function o(n){var i=Utils.RepoKeys.DataKeys.UnitListNames(),t=!1;return _.forEach(i,function(i){if(i.toLowerCase()===n.toLowerCase())return t=!0,!1}),t}function e(t){return t===r.GetBuildIdByIdx(n.IC)?GameServices.industrialComplexService:t===r.GetBuildIdByIdx(n.CC)?GameServices.commandCenterService:t===r.GetBuildIdByIdx(n.SS)?GameServices.spaceShipyardService:t===r.GetBuildIdByIdx(n.Lab)?GameServices.laboratoryService:null}function s(n,r){var u,f;return(console.log("_updateTechTimer"),t)?!0:r.Progress?(u=GameServices.timerHelper.updateStringTimer(n),u&&(f=0,t=!0,i.$hub.techItemUpgraded(r.NativeName).then(function(i){var u=i,o;console.log("_updateTechTimer.answer",{answer:i,progress:u});u.IsProgress?(o=e(r.parentUniqueId),o.hasOwnProperty("updateBuildProgress")&&o.updateBuildProgress(r.NativeName,u),GameServices.timerHelper.registerBuildTimer(n,u,f),t=!1,console.log("_updateTechTimer.progress.IsProgress : data",{answer:i,itemData:r,service:o})):GameServices.estateService.getFullEstate(f,function(){console.log("_updateTechTimer.progress.getFullEstate : finalize",{answer:i,itemData:r,labItem:GameServices.laboratoryService.getItem(r.NativeName)});t=!1})},function(n){t=!1;var i=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:i},"buildService._updateTechTimer");})),u):!0}function h(n,r){var h,u,o,c;if(r&&r.AdvancedData&&r.AdvancedData.TechOut)return s(n,r);if((h=EM.EstateData.GetCurrentEstate(),u=h.EstateId,t||n.timerData.$ownId!==u||n.timerData.$isUnit)||!r.Progress||!r.Progress.IsProgress)return!0;if(o=GameServices.timerHelper.updateStringTimer(n),o){if(u===0)return!0;function o(){t=!1}function s(){f(u)?GameServices.estateService.getFullEstate(u,o):Utils.Console.Bold("clickSubmitBuyUpgrade.own changed",{itemData:r})}t=!0;c=i.$hub.buildItemUpgraded(u,r.NativeName);c.then(function(t){var i,h;f(u)&&(i=t,i.IsProgress?(h=e(r.parentUniqueId),h.hasOwnProperty("updateBuildProgress")&&h.updateBuildProgress(r.NativeName,i),GameServices.timerHelper.registerBuildTimer(n,i,u),o()):s())},function(n){o();var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"buildService.updateBuildTimer");})}return o}function c(n,t){var r=GameServices.resourceService.getStorageResources().Current,i=!0;return _.forEach(r,function(r,u){var f=n[u];if(r<f*t)return i=!1,!1}),i}function l(n,t){var r=GameServices.resourceService.getCcItem(),i;return r?(i=r.Current,!i||!(typeof i=="number"))?!1:i>=n*t:!1}function a(n){function s(){u=!1}function w(){f(t.OwnId)?GameServices.estateService.getFullEstate(t.OwnId,s):(s(),Utils.Console.Bold("clickSubmitBuyUpgrade.own changed",{data:t}))}var r,y,p,t,h,a;if(!u&&n&&(r=n.Update,r&&r.Price&&n.Progress)){var e=r.Price,v=!0,o=1;if((n.Progress.$isUnit?o=r.upgradeCount:v=!n.Progress.IsProgress,v)&&(y=e.forCc?l(e.Cc,o):c(e,o),y)){if(p=EM.EstateData.GetCurrentEstate(),t=Utils.ModelFactory.UnitTurnOut(),t.OwnId=p.EstateId,t.Count=+o,t.ForCc=e.forCc,t.NativeName=n.NativeName,h=i.$hub,n.IsBuildItem)a=h.buildItemUpgrade,console.log("clickSubmitBuyUpgrade.section. IsBuildItem",{section:n,data:t});else if(n.Progress.$isUnit)a=h.buildSpaceShipyardSetUnitTurn,console.log("clickSubmitBuyUpgrade.section. isUnit",{section:n,data:t});else if(n.AdvancedData&&n.AdvancedData.TechOut&&!n.AdvancedData.TechOut.Disabled)console.log("clickSubmitBuyUpgrade.section. is tech upgrade",{section:n,data:t}),a=h.buildLaboratorySetTechTurn;else{console.log("clickSubmitBuyUpgrade.section undefinded",{section:n,data:t});throw new Error("No imp");}u=!0;a(t,n.NativeName).then(function(n){if(e.forCc&&typeof n=="number")GameServices.resourceService.setCc(n),w();else if(n===!0)w();else{s();throw Errors.ClientNotImplementedException({answer:n,requestData:t},"buildService.clickSubmitBuyUpgrade.responcce not impl");}},function(n){s();var i=Errors.GetHubMessage(n);ErrorMsg.TechInProgress;throw Errors.ClientNotImplementedException({errorAnswer:n,requestData:t,msg:i},"buildService.clickSubmitBuyUpgrade");})}}}function v(n){a(n)}function y(n,t,i,r){var u=e(n.parentUniqueId);u&&u.hasOwnProperty("actionSubmit")&&u.actionSubmit(n,t,i,r)}function p(){GameServices.laboratoryService.upgradeModel()}function w(){GameServices.commandCenterService.upgradeModel()}function b(){GameServices.industrialComplexService.upgradeModel();GameServices.spaceShipyardService.upgradeModel()}function k(n){b();n?p():w()}var i=this,r=Utils.RepoKeys.DataKeys.BuildIds,n={IndustrialComplex:0,CommandCenter:1,SpaceShipyard:2,laboratory:3},t,u;n.IC=n.IndustrialComplex;n.CC=n.CommandCenter;n.SS=n.SpaceShipyard;n.Lab=n.laboratory;Object.defineProperty(i,"$hub",{get:function(){return GameServices.mainGameHubService}});u=!1;this.isUnit=o;this.updateBuildTimer=h;this.upgradeSubmit=v;this.actionSubmit=y;this.upgradeEstateBuilds=k}]);Utils.CoreApp.gameApp.service("commandCenterService",["mainHelper","planshetService",function(n,t){function u(){return t.getItemById(i)}function f(){r=u();t.isCurrentModel(i)&&t.updatePlanshet(null,i)}var r={},i=Utils.RepoKeys.DataKeys.BuildIds.GetBuildIdByIdx(1);this.getUniqueId=function(){return i};this.upgradeModel=f}]);Utils.CoreApp.gameApp.service("industrialComplexService",["mainHelper","planshetService","translateService",function(n,t,i){function b(n){return{current:0,max:0,persent:0,showMax:!1,title:"",htmlName:n,showItem:!0}}function et(n,t){return{NativeName:_.upperFirst(n),TranslateName:t,htmlName:_.lowerFirst(n)}}function o(n,t){return n&&t?n/t*100:0}function d(){return i.getUnit()}function g(){var n=angular.element("#buildContainer");return n&&n.length>0&&n.scope().hasOwnProperty("buildCtrl")?n.scope():!1}function st(n){return{range:"min",max:0,value:0,step:1,animate:n||300,slide:null,stop:null}}function hi(n,t,i){return nt[n]/nt[t]*i}function wt(){return p}function li(){if(p&&u&&!it){var t="storage-transfer-slider-",i=u.storableItems;n.applyTimeout(function(){_.forEach(i,function(n){var i=angular.element("#"+t+n.htmlName);i.slider("value",n.source.current);console.log("sliderElement",n)})})}}function bt(){function r(n,t){var i=et(n,t);return i.showTarget=wt,i.toTransfer=0,i.source=b(i.htmlName),i.target=b(i.htmlName),i}function e(){var n=_.cloneDeep(c().StorageResources);n&&(_.forEach(n.Current,function(t,i){n.Current[i]=f(n.Current[i])}),GameServices.resourceService.updateViewDataResourceByStorageResource(n,!0))}var i,n,t;return u={},e(),i=GameServices.resourceService.getEstateResources(),n=[],_.forEach(i,function(t){if(t.NativeName!=="cc"){var i=r(t.NativeName,t.TranslateName);i.source.current=t.Current;i.source.max=t.Max;i.source.persent=t.Percent;n.push(i)}}),t=EM.EstateData.GetCurrentEstate(),u.storableItems=n,u.SourceId=t.EstateId,u.SourceType=t.EstateType,u.TargetId=null,u}function ai(t,i,r){var e=t,s=e.Current;_.forEach(s,function(n,t){var r=_.findIndex(u.storableItems,function(n){return n.NativeName===t}),i=u.storableItems[r];i.target.current=f(s[t]);i.target.max=e.Max[t];i.target.persent=o(i.target.current,i.target.max)});n.applyTimeout(function(){r();u.TargetId=i})}function dt(n,t){var i=ci+n,r;if(u&&u.TargetId===n&&!GameServices.timerHelper.timeDelay.IsTimeOver(i)){t();return}tt();r=v.$hub.buildStorageGetStorageResources(n);r.then(function(r){ai(r,n,t);GameServices.timerHelper.timeDelay.UpdateTimer(i,Utils.Time.ONE_MINUTE)},function(n){var t=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:t},"industrialComplexService.requestTargetStorableItems");})}function vi(n,t){var i=[{OwnId:null,Name:"Выбрать цель",TextureTypeId:null}],r=GameServices.estateService.getEstateListData();return _.forEach(r,function(n){var t=EM.EstateData.GetCurrentEstate();n.OwnId!==t.EstateId&&i.push({OwnId:n.OwnId,Name:n.Name,TextureTypeId:n.TextureTypeId})}),n.targetTransferList=i,t.change(function(){var n=t.find(":selected")[0].value;n===""?p=!1:(n=+n,dt(n,function(){p=!0}))}),t.select2({templateResult:function(n){var t=$("<div/>",{text:n.text}),r=function(){var t=_.find(i,function(t){return t.Name=n.text}),r;if(t)return(r=t.TextureTypeId,$.isNumeric(r))?"sprite_control_icons m map-object jumptomother":null},u=$("<span/>",{"class":"main_directior_css_class "+r()});return t.prepend(u)},minimumInputLength:0,containerCssClass:"select2-container-transfer",dropdownCssClass:"select2-dropdown-container-transfer"}),i}function yi(t,i){function h(n,t,i){var u,r,e,h;if(i)return(u=s.source.current,u-t<0&&(t=u),r=s[v].current+t*c,r>n.max)?(e=r-n.max,n.current=n.max,e===0)?t:(h=t-f(e/c),n.persent=o(r,n.max),h):(n.current=f(r),n.persent=o(r,n.max),t);n.current=s[a].current-t;n.persent=o(n.current,n.max)}function l(t,i){console.log("stopSlide");u=null;u=+i.value;n.applyTimeout(function(){var n=h(r.target,u,!0);h(r.source,n,!1);r.toTransfer=n})}function y(n,i){console.log("stopSlide");u=null;u=+i.value;var f=h(r.target,u,!0);f!==u&&(h(r.source,f,!1),r.toTransfer=f,t.slider("value",f));r.toTransfer=f}var c=kt(),r=i.sliderData,s=_.cloneDeep(r),e=st(),u,a="source",v="target";e.slide=l;e.stop=y;e.max=s.source.current;e.change=function(n,t){l(n,t)};t.slider(e)}function pi(){function h(n){return n===0?!1:!0}function e(){it=!1}function r(t,i){if(e(),!i){var r=Errors.GetHubMessage(t);n.msg=r;n.errorAnswer=t;n.isLocl=i}tt();throw Errors.ClientNotImplementedException(n,"submitStorageAction.DoTransfer");}var t,n,o;if(!it){var f=Utils.ModelFactory.MaterialResources(),s=u.storableItems,i=0;if(_.forEach(s,function(n){var t=n.toTransfer;f[n.NativeName]=t;i+=t}),i<3){i=0;return}t={Resources:f,SourceId:u.SourceId,SourceType:u.SourceType,TargetId:u.TargetId,TargetType:h(u.TargetId)};n={retquestData:t};it=!0;o=v.$hub.buildStorageDoTransfer(t);o.then(function(i){if(i){var u=EM.EstateData.GetCurrentEstate();if(t.SourceId===u.EstateId)GameServices.estateService.getFullEstate(t.SourceId,e);else{n.CurrentEstate=u;throw r("submitStorageAction own is changed",!0);}}else throw r("Not transfered",!0);},r)}}function wi(){return k().Power}function bi(){return d().productionPower+" : "+wi()}function gt(){function o(t,i,u){var e=r[pt[t]],f=et(t,e);return f.currentPercent=i||0,f.targetPersent=0,f.extractionPerHour=u||0,f.freePercent=0,f.power=n.Power,f}var i;s={};var r=d(),n=k(),u=n.ExtractionPerHour,e=n.Percent,t=[];return _.forEach(e,function(n,i){var r=f(u[i]),e=o(i,n,r);t.push(e)}),i=EM.EstateData.GetCurrentEstate(),s.productionItems=t,s.OwnId=i.EstateId,s}function di(t,i){function v(){var n=100;return _.forEach(o,function(t){n-=t.currentPercent}),n}function y(n){var t=n/100;return t*(a/l)}function p(n){_.forEach(o,function(t,i){o[i].freePercent=n})}function h(n){r.currentPercent=n;r.extractionPerHour=f(y(n));p(v())}function w(t,i){var f=!0,o=+i.value,u=o/e;return n.applyTimeout(function(){if(r.freePercent>0)return r.currentPercent+r.freePercent>=u?h(u):h(r.currentPercent+r.freePercent),f;r.currentPercent>u?h(u):f=!1}),f}function b(){r.freePercent<=0&&t.slider({value:r.currentPercent*e})}var r=i.sliderData,u,e;ki=_.cloneDeep(s);var o=s.productionItems,c=r.NativeName,l=nt[c],a=r.power;u=st();e=100;u.slide=w;u.stop=b;u.max=100*e;u.value=r.currentPercent*e;t.slider(u)}function ni(n){if(n){var t=g();t}gt()}function gi(){function e(){rt=!1}function u(n,i){if(e(),!i){var r=Errors.GetHubMessage(n);t.msg=r;t.errorAnswer=n;t.isLocl=i}ni();throw Errors.ClientNotImplementedException(t,"submitExtractionAction");}var n,f,i,t,o;if(!rt){rt=!0;n=Utils.ModelFactory.MaterialResources();f=s.productionItems;_.forEach(f,function(t){n[t.NativeName]=t.currentPercent});var h=n.E+n.Ir+n.Dm,r=h/100;n.E=n.E/r;n.Ir=n.Ir/r;n.Dm=n.Dm/r;i={OwnId:s.OwnId,Proportion:n};t={retquestData:i};o=v.$hub.buildExtractionModuleChangeProportion(i);o.then(function(n){if(n){var r=EM.EstateData.GetCurrentEstate();if(i.OwnId===r.EstateId)GameServices.estateService.getFullEstate(i.OwnId,e);else{t.CurrentEstate=r;throw u("submitExtractionAction own is changed",!0);}}else throw u("Proportion not changed",!0);},u)}}function ti(){return y().ConvertLoses}function nr(){return d().exchangeCourse+" : "+ti()}function tr(){y().StorageResources=_.cloneDeep(c().StorageResources)}function ir(){return{maximum:0,rate:null,sourceHtmlName:"",targetHtmlName:"",toTransfer:{}}}function ri(){function s(n){var r=i[pt[n]],t=et(n,r);return t.source=b(t.htmlName),t.target=b(t.htmlName),t}function e(t,i){t.current=f(n[i]);t.max=h[i];t.persent=o(n[i],t.max)}var i,t;r={};i=d();var u=y().StorageResources,n=u.Current,h=u.Max;return t=[],_.forEach(n,function(n,i){var r=s(i);e(r.source,i);e(r.target,i);r.upgradeConnecton=ht;t.push(r)}),r.activeConnectionData=ir(),r.convertableItems=t,r.findItemByName=function(n){return n=n.toLowerCase(),_.find(r.convertableItems,function(t){return t.htmlName===n})},r.getItemByType=function(n,t){var i=t?"target":"source";return r.findItemByName(n)[i]},r.getStorageResources=function(){return _.cloneDeep(y().StorageResources)},r.upgradeConvertableItems=function(){function n(n){var t=n.NativeName,i=r.getStorageResources(),u=i.Current[t],e=i.Max[t];n.source.current=f(u);n.source.max=e;n.source.persent=o(n.source.current,n.source.max);n.target.current=f(u);n.target.max=e;n.target.persent=o(n.target.current,n.target.max)}var t=r.convertableItems;_.forEach(t,function(t){n(t)})},r.getRate=function(){return r.activeConnectionData.rate},r.updateRate=function(n,t){r.activeConnectionData.rate=hi(n,t,ti())},r}function ui(n){ct=!0;var t=st();t.slide=function(n,t){var i=+t.value;ut(!0,i)};t.max=0;n.slider(t)}function fi(n,t){var i=$("#energy-converter-slider");i.slider("option","max",n);i.slider("option","value",t)}function ur(n){$("#energy-converter-slider").slider("option","value",n)}function fr(n,t,i){function y(n,t){return{startColor:n,endColor:t}}function d(){return t?y(r[o],r.E):y(r.E,r[o])}function g(){var n=d(),t=b.find("stop"),i=$(t[0]),r=$(t[2]);i.attr("stop-color",n.startColor);r.attr("stop-color",n.endColor)}function nt(){if(!u){var n=function(n){var t=Utils.ModelFactory.MaterialResources();return n?(t.E="M0,17 C96,17 0,96 93,96",t.Ir="m0,96 96,1",t.Dm="M0,174 C93,174 0,96 93,96",t):(t.E="M0,96 C93,96 0,17 93,17",t.Ir="m0,96 93,1",t.Dm="M0,96 C93,96 0,174 93,174",t)};u={};u.source=n(!0);u.target=n(!1)}return t?u.source:u.target}function tt(){var n=nt()[o];s.attr("class","connection-item "+f);s.attr("d",n)}function a(){l.attr("class",c+" active "+f);g();tt()}function it(n){function v(n){n?s.removeAttr("readonly"):s.attr("readonly","readonly")}function u(n){n?h.addClass(o):h.removeClass(o)}function y(n){n.attr("class",c)}function p(){r.each(function(){y($(this))})}var w=$(k),o=oi.CssActive,r=w.find("."+o),b=r&&r.length>0,s=h.find("input");return n?(p(),u(!1),null):b?l.hasClass(f)?e.notChanged:t?(u(!1),v(!1),p(),setTimeout(function(){u(!0);a()},i),e.isSource):$(r[0]).hasClass(f)?e.notChanged:(y(l),setTimeout(function(){v(!0);a()},i),e.isTarget):(u(!0),a(),e.isSource)}var o=n.NativeName,f=n.htmlName,v=t?"source":"target",p=v+"-path-res",w=v+"-connection-gradient",b=$("#"+w),s=$("#"+p),h=$("#exchange-connection-value-conteiner"),k=".exchange-connection-container",c="exchange-connection-item",l=s.parents("."+c),r=Utils.ModelFactory.MaterialResources(),u;return r.E="#30c4c8",r.Ir="#98cfd6",r.Dm="#9365c4",it}function er(n,t,i,u){var f,h,e,c,a;if(r&&(f=r.activeConnectionData,f&&f.toTransfer>0&&!l)){if(h=r.getStorageResources(),e=r.findItemByName(f.targetHtmlName),e.target.current-h.Current[e.NativeName]<1)return;if(c=r.findItemByName(f.sourceHtmlName),c.source.current<0)return;l=!0;var y=EM.EstateData.GetCurrentEstate(),s={OwnId:y.EstateId,From:c.NativeName,To:e.NativeName,ToConvert:f.toTransfer},o={btnParams:n,$scope:u,sr:h,targetItem:e,data:s};function i(){l=!0}function t(n,t){if(!t){var r=Errors.GetHubMessage(n);o.msg=r;o.errorAnswer=n;o.isLocl=t}i();throw Errors.ClientNotImplementedException(o,"submitEcAction");}a=v.$hub.buildEnergyConverterExchangeResource(s);a.then(function(n){if(n){var r=EM.EstateData.GetCurrentEstate();if(s.OwnId===r.EstateId)GameServices.estateService.getFullEstate(s.OwnId,i);else{o.CurrentEstate=r;throw t("submitEcAction own is changed",!0);}}else throw t("submitEcAction.not updated",!0);},t)}}function or(){return t.getItemById(w)}function sr(){vt=or();tt();ni();ii();var n=g();n&&(n.buildCtrl.extractionContainer=s,n.buildCtrl.energyConverterContainer=r);t.isCurrentModel(w)&&t.updatePlanshet(null,w)}function hr(n,t,i,r){n.NativeName===a.Storage?pi(n,t,i,r):n.NativeName===a.ExtractionModule?gi(n,t,i,r):n.NativeName===a.EnergyConverter&&er(n,t,i,r)}function cr(){return vt.Bodys[0].TemplateData}function lt(n){return _.find(cr(),function(t){return t.NativeName===n})}function at(){return lt(ft.storage)}function ei(){return lt(ft.energyConverter)}function lr(n,t){n===a.Storage?at().Progress=t:n===a.ExtractionModule?ot().Progress=t:n===a.EnergyConverter&&(ei().Progress=t)}var v=this,oi=Utils.RepoKeys.HtmlKeys,h=Utils.RepoKeys.DataKeys,ft={energyConverter:h.EnergyConverter,extractionModule:h.ExtractionModule,storage:h.Storage},vt={},w=h.BuildIds.GetBuildIdByIdx(0),c=null,yt=null,a={ExtractionModule:h.ExtractionModule,EnergyConverter:h.EnergyConverter,Storage:h.Storage},f=Utils.ConvertToInt,k=null,ot=null,y=null,pt={Cc:"cc",E:"enegry",Ir:"iridium",Dm:"darkMatter"},nt,kt,s,rt,ki,e,ii,r,ht,ut,rr,l,ct;Object.defineProperty(v,"$hub",{get:function(){return GameServices.mainGameHubService}});nt=Utils.ModelFactory.MaterialResources(1,2,5);this.calcResPercent=o;var ci="storage-storable-item_",p=!1,u,tt,it=!1;kt=function(){return c().Losses};tt=function(){p=!1;bt();var n=g();n&&(n.buildCtrl.storageStorableContainer=u)};this.getStorageTargetShowStatus=wt;this.requestTargetStorableItems=dt;this.createStorageStorableContainer=bt;this.registerStorageTransferListEvents=vi;this.registerStorageSlider=yi;rt=!1;this.getExtractionPowerData=bi;this.getExtractionContainer=gt;this.registerExtractionSlider=di;this.getExchangeCourceData=nr;e={notChanged:1,isSource:2,isTarget:4};l=!1;ct=!1;rr=function(){ui($("#energy-converter-slider"))};ut=function(t,i){function v(n){return _.find(r.convertableItems,function(t){return t.htmlName===n})}function y(n,t,i,r){var c=t?1:-1,u=t?"target":"source",e=n.NativeName,s=h.Current[e]+r*c*i,l=f(s);n[u].current=l;n[u].persent=o(s,h.Max[e])}var u=g().buildCtrl,h,p,l;typeof u.exchangeInputModel!="number"&&(u.exchangeInputModel=0);var e=u.exchangeInputModel,s=r.activeConnectionData,a=s.maximum;if(typeof i=="number"&&(e=i),h=_.cloneDeep(c().StorageResources),p=v(s.sourceHtmlName),l=v(s.targetHtmlName),!l){u.exchangeInputModel=0;return}n.applyTimeout(function(){u.exchangeInputModel=e>a?a||0:e;y(p,!1,1,u.exchangeInputModel);y(l,!0,s.rate,u.exchangeInputModel);s.toTransfer=e;t||ur(e)})};ht=function(n,t,i){var u,s,c,a,v,y,h;l=!0;var p=fr(n,t,300),o=p(i);if(!i&&(u=r.activeConnectionData,o!==e.notChanged)){if(o===e.isSource){r.upgradeConvertableItems();u.sourceHtmlName=n.htmlName;u.maximum=0;fi(0,0);ut(!0,0);return}if(o===e.isTarget){if(n.htmlName===u.sourceHtmlName){SHOW_DEBUG&&Utils.Console.Error("последовательность не верна",{convertableItem:n,isSource:t,upgradeType:o,convertableKeyResults:e,energyConverterContainer:r,activeData:u});return}s=r.getStorageResources();u.targetHtmlName=n.htmlName;c=r.findItemByName(u.sourceHtmlName);r.updateRate(c.NativeName,n.NativeName);a=s.Current[c.NativeName];v=s.Current[n.NativeName];n.target.max=s.Max[n.NativeName];n.target.current=f(v);y=n.target.max-n.target.current;h=y/r.getRate();a<=h&&(h=a);u.maximum=f(h);fi(u.maximum,0);l=!1}}};ii=function(){l=!1;tr();r={};ri();ct&&ht(r.findItemByName("e"),!0,!0)};this.getEnergyConverterContainer=ri;this.updateExchangeInputModel=ut;this.registerEnergyConverterSlider=ui;yt=function(){return at().Action};c=function(){return yt().Data};ot=function(){return lt(ft.extractionModule)};k=function(){return ot().Action.Data};y=function(){return ei().Action.Data};this.getUniqueId=function(){return w};this.upgradeModel=sr;this.getStorage=at;this.getStorageData=c;this.getExtractionModuleData=k;this.actionSubmit=hr;this.updateBuildProgress=lr;this.btnStorageSendAllResources=li}]);Utils.CoreApp.gameApp.service("laboratoryService",["planshetService","techTreeHelper",function(n){function r(){i=!1}var t=this,i;this.getUniqueId=function(){return t._laboratoryUniqueId};this.upgradeModel=function(){n.isCurrentModel(t._laboratoryUniqueId)&&n.updatePlanshet(null,t._laboratoryUniqueId)};i=!1;this.setTechViewData=function(n,t){var u;if(!t.Info.infoStatsModel){var o=t.Info.Data,s=o.Properties,e=[];_.forEach(s,function(t,i){var r=t.CurrentValue;r||(r=t.BaseValue);i!=="Level"&&r&&(r=_.round(r,2),r+="%",r="+"+r);e.push(n.createStatItemModel(t.PropertyName,r))});u=n.createBgImage(t.Info.DropImage,t.TranslateName);u.onClick=function(){};t.Info.infoStatsModel=n.createStatisticModel(e,u)}var f=t.ComplexButtonView.Collection,h=f[0],c=f[1],l=f[2];h.$onClick=function(n){i||(i=!0,GameServices.unitDialogService.CreateTechDetailDialog(n,r,t.NativeName))};c.$onClick=function(n){GameServices.techTreeHelper.createTechTreeDialog(n)};l.$onClick=function(n){i||(i=!0,GameServices.unitDialogService.CreateBuyTechDialog(n,r,t.NativeName))};t.AdvancedData.TechOut.Disabled&&!t.$mainContainerItemCss&&Object.defineProperty(t,"$mainContainerItemCss",{get:function(){return t.AdvancedData.TechOut.Disabled?" grayScale ":""}})};this.$planshetIndex=null;Object.defineProperty(this,"_laboratoryUniqueId",{value:Utils.RepoKeys.DataKeys.BuildIds.GetBuildIdByIdx(3),writable:!1,configurable:!1});Object.defineProperty(this,"$laboratoryModel",{get:function(){if(!t.$planshetIndex&&(t.$planshetIndex=n.getModelIndex(t._laboratoryUniqueId),!t.$planshetIndex))return null;var i=n.$planshetModels[t.$planshetIndex];return i&&i.UniqueId===t._laboratoryUniqueId?i:!i||i.UniqueId!==t._laboratoryUniqueId?(t.$planshetIndex=n.getModelIndex(t._laboratoryUniqueId),i=n.$planshetModels[t.$planshetIndex],!i)?(t.$planshetIndex=null,null):i:null}});this.getCollection=function(){var n=t.$laboratoryModel;return n?n.Bodys[0].TemplateData:null};this.getItem=function(n,i){var r=t.getCollection(),u;return r?i?(u=n.toLowerCase(),_.find(r,function(n){return n.NativeName.toLowerCase()===u})):_.find(r,function(t){return t.NativeName===n}):null};this.updateBuildProgress=function(n,i){var r=t.getItem(n);r||console.log("updateBuildProgress.tech item not exist",{techNativeName:n,newProgress:i,$self:t});Utils.UpdateObjFromOther(r.Progress,i);Utils.UpdateObjFromOther(r.AdvancedData.TechOut.Progress,i)}}]);Utils.CoreApp.gameApp.service("spaceShipyardService",["mainHelper","planshetService",function(n,t){function h(n){var i=function(){u=!1},r,f;u=!0;r=t.getInProgress;r()?f=setInterval(function(){var t=EM.EstateData.GetCurrentEstate();if(t.EstateId!==n){clearInterval(f);i();return}if(!r()){GameServices.estateService.getFullEstate(n,i,!1);clearInterval(f);return}},100):GameServices.estateService.getFullEstate(n,i,!1)}function f(){return e.Bodys[0].TemplateData}function c(){return t.isCurrentModel(i)}function o(){var r=f(),u=c(),n=GameServices.timerHelper,t=!1,i;_.forEach(r,function(i){var w=i.NativeName,r=i.Progress,c,l,o,h,s;if(w!==Utils.RepoKeys.DataKeys.SpaceShipyard&&r.IsProgress){if(typeof r._duration=="number"&&r._duration<=0){t=!0;return}var b=r.StartTime,f=r.Advanced,k=f.DateCreate,d=f.TotalCount,g=f.ReadyUnits;if(r._ups||(r._ups=r.RemainToComplete/r.Duration,r._duration=_.clone(r.Duration),r._remainToСomplete=_.clone(r.RemainToComplete),r.__remainToComplete=d-g,f.UnitToSave=f.ReadyUnits-Math.floor(f.ReadyUnits)),c=r._ups,f.UnitToSave+=c,r.__remainToComplete-=c,r._remainToComplete=Math.ceil(r.__remainToComplete),l=Math.floor(f.UnitToSave),f.UnitToSave>=1&&(f.UnitToSave-=l,r.Level+=l),o=f.UnitToSave*100,o>100&&(o=0),r.verticalIndicator?Utils.UpdateObjFromOther(r.verticalIndicator,n.getIndicator(!0,o)):r.verticalIndicator=n.getIndicator(!0,o),r._duration--,u)if(h=angular.element("#"+i.$guid),h.length){var a="time-contiol",nt=h.find(".center ."+a).scope(),tt=h.find(".ms ."+a).scope(),e=nt.$parent.timerData,v=b+r.Duration,it=v-k,y=v-Utils.Time.GetUtcNow(),p=Math.floor(Math.abs(y/it*100-100));e.$orientation=n.horizontalCss;e.$hasTimer=!0;e.$timerHtmlData=Utils.Time.Seconds2Time(Math.ceil(y));e.$indicator?Utils.UpdateObjFromOther(e.$indicator,n.getIndicator(!1,p)):e.$indicator=n.getIndicator(!1,p);e.$noTimer||n.registerNoTimerRight(tt.timerData);s=e.$noTimer;s.$orientation=n.verticalCss;s.$hasTimer=!0;s.$timerHtmlData=r._remainToComplete;Utils.UpdateObjFromOther(s.$indicator,r.verticalIndicator)}else console.log("spaceShipyardService.upgradeShipyardUnits.shipyardIsActive: unit not exist")}});t&&(i=EM.EstateData.GetCurrentEstate(),h(i.EstateId))}function l(n){return _.find(f(),function(t){return t.NativeName===n})}function a(n,t){l(n).Progress=t}function v(n){var s=GameServices.resourceService,t=n.Update.Price,e=n.Update.upgradeCount,r,u,h,c,i,f,o;if(!(e<1)){if(t.forCc){if(r=s.getCcCount(),u=t.Cc,u>r){n.Update.upgradeCount=0;return}if(h=e*u,h<=r)return;c=Math.floor(r/u);n.Update.upgradeCount=c;return}(i=s.getStorageResources().Current,i.E<t.E&&i.Ir<t.Ir&&i.Dm<t.Dm&&(n.Update.upgradeCount=0),f=[],_.forEach(i,function(n,i){t[i]!==0&&f.push(n/t[i])}),f.length<1)||(o=Math.floor(Math.min.apply(Math,f)),e>o&&(n.Update.upgradeCount=o))}}function y(){return t.getItemById(i)}function p(){u=!1;e=y();t.isCurrentModel(i)&&t.updatePlanshet(o,i);GameServices.hangarService.retstartView()}function s(){r=!1}function w(n){var t=n.ComplexButtonView.Collection,i=t[0],u=t[1],f=t[2];i.$onClick=u.$onClick=function(t){r||(r=!0,GameServices.unitDialogService.CreateUnitDetailDialog(t,s,n.NativeName))};f.$onClick=function(t){r||(r=!0,GameServices.unitDialogService.CreateBuyUnitDialog(t,s,n))}}var e={},i=Utils.RepoKeys.DataKeys.BuildIds.GetBuildIdByIdx(2),u=!1,r=!1;this.getUniqueId=function(){return i};this.upgradeModel=p;this.getBuildCollection=f;this.upgradeShipyardUnits=o;this.setUnitProgress=a;this.updateUnitInputModel=v;this.registerUnitItem=w}]);Utils.CoreApp.gameApp.service("userChannelsService",["planshetService","paralaxButtonHelper","$q","userChannelsDialogHelper",function(n,t,i,r){function f(n,t,i){return this.NativeName=n,this.PlanshetIdx=t,this.ChannelType=i,this}function e(n){Object.defineProperty(u,n.NativeName,{get:function(){return u._userChannelsModel.Bodys[n.PlanshetIdx].TemplateData},set:function(t){u._userChannelsModel.Bodys[n.PlanshetIdx].TemplateData=t}})}var u=this;this.$planshetService=n;Object.freeze(this.$planshetService);this.$btnHelper=t;Object.freeze(this.$paralaxButtonHelper);Object.defineProperty(u,"_userChannelsUniqueId",{value:"user-channels-collection",writable:!1,configurable:!1});this.$planshetIndex=null;Object.defineProperty(u,"_userChannelsModel",{get:function(){if(!u.$planshetIndex)throw Errors.ClientNullReferenceException({$self:u},"$self.$planshetIndex","userChannelsService",ErrorMsg.NoData);var t=n.$planshetModels[u.$planshetIndex];if(t.UniqueId!==u._userChannelsUniqueId)throw Errors.ClientNotImplementedException({$self:u},"is not  message model");return t},set:function(t){n.updatePlanshetItemData(t,!0,Utils.Time.TIME_CACHE_USER_CHANNELS);u.$planshetIndex=n.getModelIndex(u._userChannelsUniqueId)}});this.$ucdH=r;this.$q=i;this.ChannelTypes={Private:1,Group:2,Alliance:3};Object.freeze(this.ChannelTypes);this.ChannelSerchTypes={All:1,OnlyPublic:2,OnlyPrivate:3};Object.freeze(this.ChannelSerchTypes);this.cbIds={Setting:2,Messages:1,Delete:2};Object.freeze(this.cbIds);this.bodyIdx={Private:u.ChannelTypes.Private-1,Group:u.ChannelTypes.Group-1,Alliance:u.ChannelTypes.Alliance-1};Object.freeze(this.bodyIdx);this.ChannelTypeNames={Private:"Private",Group:"Group",Alliance:"Alliance"};Object.freeze(this.ChannelTypeNames);this.ChannelRefs={Private:new f(u.ChannelTypeNames.Private,u.bodyIdx.Private,u.ChannelTypes.Private),Group:new f(u.ChannelTypeNames.Group,u.bodyIdx.Group,u.ChannelTypes.Group),Alliance:new f(u.ChannelTypeNames.Alliance,u.bodyIdx.Alliance,u.ChannelTypes.Alliance)};_.forEach(this.ChannelRefs,function(n,t){Object.freeze(u.ChannelRefs[t])});Object.freeze(u.ChannelRefs);this._updatePlanshet=function(t,i){n.updatePlanshet(t,u._userChannelsUniqueId,i)};this.leftNavGetUserChannels=function(){u.loadUserChannelsPlanshet()};Object.defineProperty(u,"$hub",{get:function(){return GameServices.mainGameHubService}});this.getServerPlanshetData=function(n,t){return u.$hub.userChannelsGetPlanshet().then(function(t){console.log("_______UPDATE_userChannelsService_FROM SERVER______");u._setNewPlanshetData(t,n)},function(n){if(t instanceof Function)t(n);else{var i=Errors.GetHubMessage(n);throw Errors.ClientNotImplementedException({errorAnswer:n,msg:i},"userChannelsService.getServerPlanshetData");}})};this._toggle=function(){n.toggle(u._userChannelsUniqueId)};this.loadUserChannelsPlanshet=function(t){t||!u._userChannelsModel?u.getServerPlanshetData(u._toggle):n.isCurrentModel(u._userChannelsUniqueId)?u._toggle():u._updatePlanshet(u._toggle,!0)};this._getCollectionByIdx=function(n){return u._userChannelsModel.Bodys[n].TemplateData.Collection};e(u.ChannelRefs.Private);e(u.ChannelRefs.Group);e(u.ChannelRefs.Alliance);this.setInitialUserChannelsModel=function(n){u._userChannelsModel=_.cloneDeep(n[u._userChannelsUniqueId])};this._setNewPlanshetData=function(n,t){u._userChannelsModel=n;t instanceof Function&&t(u._userChannelsModel)};this.getCbButtonByIdx=function(n,t){return!t||!t.ComplexButtonView?null:t.ComplexButtonView.Collection[n]};this.createBtnIds=function(n){if(!n._btnIds){function t(){this.SettingId=null;this.MessagesId=null;this.DeleteId=null;var i=u.getCbButtonByIdx(u.cbIds.Messages,n),t=u.getCbButtonByIdx(u.cbIds.Setting,n);return t&&(t.ItemId==="setting"?this.SettingId=t.ItemId:t.ItemId==="delete"&&(this.DeleteId=t.ItemId)),i&&(this.MessagesId=i.ItemId),this}n._btnIds=new t}return n._btnIds};this.getTabTranslateNameByChannelType=function(n){return u._userChannelsModel.Buttons[n].TranslateName};Utils.CoreApp.gameAppExtensions.UserChannelsPrivate(u);Utils.CoreApp.gameAppExtensions.UserChannelsGroup(u);Utils.CoreApp.gameAppExtensions.UserChannelsAlliance(u);Object.defineProperty(u,"$currentUserInfo",{get:function(){return GameServices.allianceService.$currentUserInfo}});this.getTabDataByChannelType=function(n){var t="";if(n===u.ChannelTypes.Private)t=u.ChannelTypeNames.Private;else if(n===u.ChannelTypes.Group)t=u.ChannelTypeNames.Group;else if(n===u.ChannelTypes.Alliance)t=u.ChannelTypeNames.Alliance;else throw Errors.ClientNotImplementedException({intChannelType:n},"userChannelsService.getTabDataByChannelType ChannelTypeNotExist");return u[t]};this.getCollectionByChannelType=function(n){var t=u.getTabDataByChannelType(n);return t&&t.Collection?t.Collection:null};this.getChannelByChannelType=function(n,t){var i=u.getCollectionByChannelType(n);if(!i)throw Errors.ClientNotImplementedException({collection:i},"userChannelsService.getChannelByChannelType channelCollection not exist");return i[t]};this.addOrReplaceLocalChannelItem=function(n){var i=n.ChannelId,r=n.ChannelType,t=u.getCollectionByChannelType(r);t&&(t[i]=n)};this.deleteLocalChannelItem=function(n,t){var i=u.getCollectionByChannelType(n);i&&i[t]&&delete i[t]};this.addMessageToLocal=function(n,t){var i=u.getChannelByChannelType(t,n.ChannelId);return i?i.Messages[n.Id]=n:console.log("GroupAddMessageToLocal channel not exist need create channel",{newMessage:n,intChannelType:t,$self:u}),i};this.sendMessage=function(n){var e=u.$currentUserInfo,t=Utils.ModelFactory.IChannelMessageTransfer(),r,f;t.Message=n.text;t.UserIcon=e.userAvatar.Icon;t.ChannelId=n.ChannelId;t.ChannelType=n.ChannelType;r=i.defer();r.promise.finally(function(){n.onFinally instanceof Function&&n.onFinally()}).then(function(t){if(n.onSuccess instanceof Function)n.onSuccess(t)},function(t){var i=Errors.GetHubMessage(t);if(n.onError instanceof Function)n.onError(i);throw Errors.ClientNotImplementedException({params:n,errorAnswer:t,msg:i},"userChannelsService.sendMessage");});f=u.$hub.userChannelsSendMessage(t);f.then(function(n){return r.resolve(n)},function(n){return r.reject(n)})};this.onMessageSended=function(n,t){console.log("userChannelsService.onMessageSended.before",{iMessageTransferDataModel:n,$self:u});try{var i=u.addMessageToLocal(n,n.ChannelType);if(!i)throw Errors.ClientNullReferenceException({iMessageTransferDataModel:n},"channel","userChannelsService.onMessageSended",ErrorMsg.NoData);t.$broadcast("channelItem:add-message",{newChannel:i,newMessageData:n})}catch(r){throw Errors.ClientNotImplementedException({iMessageTransferDataModel:n},"userChannelsService.onMessageSended",r);}};this.getNextMessagesPage=function(n,t,i,r){function o(u,f){var e=Errors.GetHubMessage(u),o={_data:f,channelId:n,intChannelType:t,msg:e,errorAnswer:u,onDone:i};r(u,e,o);throw Errors.ClientNotImplementedException(o,"userChannelsService.getNextMessagesPage");}var f=u.getChannelByChannelType(t,n),e;if(!f||!f.Messages){r(ErrorMsg.ChannelNotExist,{$self:u,channel:f});return}e=_.size(f.Messages);u.$hub.userChannelsGetNextMessagesPage(n,t,e).then(function(n){_.extend(f.Messages,n);i(n,f)},o)}}]);Utils.CoreApp.gameApp.service("userNameSercherService",["$q","npcHelper",function(n,t){function e(n){i=_.unionBy(i,n,"Id")}var r=this,i=[],f=t.NPC_USER_IDS,o=[t.NPC_NATIVE_NAMES.SKAGRY,t.NPC_NATIVE_NAMES.SKAGRY],u;this.filter=function(n,t){var i=n.toLowerCase();return _.filter(t,function(n){return n.Name.toLowerCase().indexOf(i)!==-1})};u=!1;this.filterAsync=function(t){var f,o;return(t=t.trim(),f=n.defer(),u)?(f.resolve([]),f.promise):(o=t.length===0?i:r.filter(t,i),console.log("local",{local:o}),o.length!==0)?(f.resolve(o),f.promise):(u=!0,GameServices.mainGameHubService.sercherGetUserNames(t).finally(function(){u=!1}).then(function(n){e(n);o=r.filter(t,i);f.resolve(o);console.log("userNameSercherService.answer",{queryName:t,answer:n,local:o,localNames:i})},function(n){var i=Errors.GetHubMessage(n);f.reject(n,i);console.log("userNameSercherService.filterAsync",{queryName:t,errorAnswer:n,msg:i})}),f.promise)};this.ignoreNpcPredicate=function(n){return n.Id===f.SKAGRY?!1:n.Id===f.CONFEDERATION?!1:!0};this.ignoreNpcAndUserIdPredicate=function(n,t){return n.Id===t?!1:r.ignoreNpcPredicate(n)?!1:!0};this.ignoreNpcFilter=function(n){return _.filter(n,this.ignoreNpcPredicate)};this.ignoreNpcAndUserId=function(n,t){return _.filter(n,function(n){return r.ignoreNpcAndUserIdPredicate(n,t)})};this.createIgnoreNamesWithNpc=function(n){return _.concat(o,n).join("|").toLowerCase().split("|")};this.filterByIgnoreNames=function(n,t){return!t||!t.length?n:_.filter(n,function(n){var i=n.Name.toLowerCase(),r=_.includes(t,i);return!r})}}]);Utils.CoreApp.gameApp.directive("timerProgress",["timerHelper",function(n){function t(t){var u=n.refTimerTypes,i,r,f,e,o;if(u.simpleTimer===t.timerType)console.log("timerType.simpleTimer === $scope.timerType",{$scope:t}),t.border&&t.border.dataOnload&&t.border.dataOnload instanceof Function&&(i=t.border.dataOnload(),i&&i.hasOwnProperty("cbItemData")&&i.hasOwnProperty("activateUpdate")&&i.hasOwnProperty("timerName")&&(t.timerAdvancedParam=i)),n.registerSimpleTimer(t);else if(u.buildTimer===t.timerType){if(r=n.getComplexBtnScope(t),!r)throw new Error("timerProgress: !cbScope");r.item.hasOwnProperty("Progress")&&(t.timerData=r.item.Progress||Utils.ModelFactory.ItemProgress());f=t.border.Data;f&&f.NativeName&&f.NativeName.substr(0,4)==="Tech"?n.registerBuildTimer(t,null,0,r):(e=EM.EstateData.GetCurrentEstate(),o=e.EstateId,n.registerBuildTimer(t,null,o,r))}else if(u.noTimerRight===t.timerType){if(!t.timerData)throw new Error("timerProgress: !$scope.timerData");n.registerNoTimerRight(t.timerData)}else u.hangarUnitTimer===t.timerType}return{restrict:"EA",templateUrl:"timer-progress.tmpl",replace:!0,scope:{timerType:"@",border:"=?",timerData:"=?"},link:t}}]);Utils.CoreApp.gameApp.directive("paralaxButton",[function(){return{replace:!0,restrict:"EA",scope:{button:"="},templateUrl:"parralax-button.tmpl",link:function(n,t,i){var r=n.button;r&&r.Method&&!Utils.Event.HasClick(t)&&t.bind("click",function(u){if(r.Method instanceof Function)r.Method(r.Params,t,i,n,u);else if(typeof r.Method=="string"&&!i.ignore){var f=Utils.StrToRef(r.Method);f(r.Params,t,i,n,u)}});r&&(GameServices.paralaxButtonHelper.setHoverVoiceToButton(r),$(t).hover(function(){EM.Audio.GameSounds.defaultHover.play()},angular.noop))}}}]);Utils.CoreApp.gameApp.directive("complexButton",[function(){return{restrict:"E",templateUrl:"complexButton.tmpl",replace:!0,scope:{complexButton:"=",advancedCbParams:"=?"}}}]);Utils.CoreApp.gameApp.directive("estateList",["estateService",function(n){function t(t,i){t.estateList=n.getEstateListData();n.registerEvents(i)}return{restrict:"A",template:'<select class="estates-list"><option ng-repeat="estate in estateList" ng-attr-value="{{estate.OwnId}}">{{estate.Name}}<\/option><\/select>',replace:!0,link:t}}]);Utils.CoreApp.gameApp.directive("estateResource",["resourceService",function(n){function t(t){t.estateResource=n.getEstateResources()}return{restrict:"A",templateUrl:"estate-resource.tmpl",replace:!0,link:t}}]);Utils.CoreApp.gameApp.directive("borderAnimationItem",[function(){function n(n){var t=n.hasOwnProperty("Data")&&n.Data&&n.Data.hasOwnProperty("Head")&&typeof n.Data.Head=="string";n.IsSimpleCentr=t}return{scope:{border:"="},replace:!0,restrict:"EA",templateUrl:"border-animation.tmpl",link:function(t,i){function o(n){return f?f:f=Utils.A.getParentScopeWithProp(n,"dropElement")}var r=t.border,f,u,e;n(r);r.$onClick?Utils.Event.HasClick(i)||i.click(function(n){n.$$border=r;r.$onClick(n)}):(r.Size==="center"&&(u=Utils.A.getParentScopeWithPropAndDepth(t,"advancedCbParams",3),u&&u.advancedCbParams.needBroadCast&&u.advancedCbParams.activateUpdate.length>0&&(e=!1,u.advancedCbParams.activateUpdate==="updateJumpMotherTimer"&&(u.advancedCbParams.cbItemData=GameServices.journalService.getLocalMotherJump(),u.advancedCbParams.cbItemData&&(e=!0,u.advancedCbParams.activateUpdate=GameServices.journalService.updateJumpMotherTimer)),e&&(u.advancedCbParams.borderScope=t,r.dataOnload=function(){return u.advancedCbParams}))),Utils.Event.HasClick(i)||(r.IsComplexPart?i.click(function(){var n=o(t);if(!n){console.log("borderAnimationItem.click parentScope not exist");return}n.dropElementonClickByDropable(null,!0,r.ItemId)}):i.click(function(n){r.JsFunction instanceof Function?r.JsFunction(n):typeof r.JsFunction=="string"&&eval(r.JsFunction)})))}}}]);Utils.CoreApp.gameApp.directive("userAvatar",["profileService","planshetService",function(n,t){function i(i){function u(t){i.avatar={Avatar:t.Avatar,Name:t.Name,Onclick:function(){n.setCurrentUserProfile()}}}var r;t.conditionAwaiter(function(){return r=n.getCurrentUserInfo(),!!r},function(){u(r)},40,1e3)}function r(n){i(n);n.$on("user:avatar-updated",function(t,i){n.avatar.Avatar=i.data})}return{restrict:"A",template:'<section><div class="" ng-click="avatar.Onclick()" id="user-avatar"><img ng-src="{{avatar.Avatar.Icon}}" ng-attr-alt="{{avatar.Name}}" ng-attr-title="{{avatar.Name}}" class="user-ava" /><\/div><\/section>',replace:!0,scope:{},link:r}}]);Utils.CoreApp.gameApp.directive("translateAutocomplete",["$q",function(n){var t=Utils.Yandex.Translate,i={},r;return Object.defineProperty(i,"items",{get:function(){return r||(r=_.concat([t.createFlagItem("None","none")],t.flagItems)),r}}),{restrict:"E",templateUrl:"translate-autocomplete.tmpl",replace:!1,scope:{nativeText:"=",setText:"=",label:"@?",menuCss:"@?"},controller:["$scope",function(r){this.label=r.label?r.label:!1;this.menuCss=r.menuCss?r.menuCss:"custom-autocomplete-drop-1";var u={none:{text:[r.nativeText]}};this.selectedLang=null;this.searchText="None";this.querySearch=function(n){if(!n||!n.length||n==="None")return i.items;n=n.trim().toLowerCase();return _.filter(i.items,function(t){return t.Name.toLowerCase().indexOf(n)!==-1||t.LangCode.indexOf(n)!==-1})};this.onTextChange=function(n){if(n&&n.length!==0&&this.selectedLang&&this.selectedLang.LangCode&&n!==this.selectedLang.Name&&n!==this.selectedLang.LangCode){var t=n.toLowerCase();t===this.selectedLang.Name?this.searchText=this.selectedLang.Name:t===this.selectedLang.LangCode&&(this.searchText=this.selectedLang.Name)}};this.getTextFromItem=function(n){return n.Name};this.onSelect=function(f){var e,o;f&&(console.log("onSelect",{flags:i.items,selectedItem:f,$scope:r}),e=n.defer(),u[f.LangCode]?e.resolve(u[f.LangCode]):(o=t.models.translate(r.nativeText,f.LangCode),t.translate(o).then(function(n){u[f.LangCode]=n;e.resolve(u[f.LangCode])},e.reject)),e.promise.then(function(n){n.text[0]&&r.setText(n.text[0]);console.log("translate",{translateItem:n})},function(n){console.log("errorAnswer",n)}))};this.notFoundedMsg="not found msg";this.inProgress=!1;this.reset=function(){r.setText(r.nativeText)}}],controllerAs:"taCtrl"}}]);Utils.CoreApp.gameApp.directive("scroller",[function(){function n(n,t,i){n.$emit(i.emitName,t,i.id)}return{restrict:"A",link:n}}]);Utils.CoreApp.gameApp.directive("statistic",[function(){function n(){}return{restrict:"E",templateUrl:"statistic.tmpl",scope:{statisticModel:"="},replace:!0,link:n}}]);Utils.CoreApp.gameApp.directive("dropElement",["$timeout","$rootScope",function(n,t){function h(t,i,u){function c(n){return angular.element(n).scope()}function l(n){v.find(s).find(f).each(n)}function y(){l(function(n,t){var i=c(t);i.dropElementClose()})}function p(){var n=!1;return l(function(){return c(this).dropElementShow?(n=!0,!1):!0}),n}function o(i){i?n(function(){t.dropElementOpen();r=u},e,!1):(t.dropElementOpen(),r=u)}r||(r=u);var h=t.dropElement,a="#"+Utils.GetParentValue(h,0,null,i,null,0),v=h.parents(a);if(t.dropElementShow){if(t.dropElementClose(),t.dropElementIsGroup&&u&&r!==u){o(!0);return}}else p()?(y(),o(!0)):o()}function c(r,s,c){r.dropElementShow=!1;r.dropElement=s;r.dropElementTargetContainer=r.dropElement.find(f);r.dropElementTargetItemSelector=u;r.dropElementIsGroup=Utils.ConvertToBool(c.isGroup);r.dropElementFreeze=Utils.ConvertToBool(c.dropElementFreeze);r.dropElementTargetItem=function(){return r.dropElementTargetContainer.find(r.dropElementTargetItemSelector)};r.$$dropElementToggle=function(n,t){h(r,n,t)};var a=c.skipParent?+c.skipParent:0,l;Object.defineProperty(r,"_dropElementTargetItems",{get:function(){return l&&l.length&&o===r.$id?l:(l=r.dropElementTargetContainer.find(u),o=r.$id,l)}});r.dropElementSetHeight=function(n){var t,u;return r.dropElementShow=!!n,t=r.dropElementTargetItem(),n?(u=t.height(),u>50&&EM.Audio.GameSounds.dropableOpen.play(),t.addClass(i),r.dropElementTargetContainer.css("height",u),r.dropElementTargetContainer.addClass(i)):(r.dropElementIsGroup?r._dropElementTargetItems.each(function(n,t){$(t).removeClass(i)}):t.removeClass(i),r.dropElementTargetContainer.removeClass(i),r.dropElementTargetContainer.removeAttr("style")),!1};r.dropElementClose=function(){r.dropElementSetHeight()};r.dropElementOpen=function(){r.dropElementSetHeight(!0)};r.dropElementonClickByDropable=function(n,i,f){if(GameServices.timerHelper.timeDelay.IsTimeOver("dropElementToggle")&&(GameServices.timerHelper.timeDelay.Start("dropElementToggle",e),!r.dropElementShow||!r.dropElementFreeze)){if(r.dropElementFreeze){t.$broadcast("dropElement:dropElementonClickByDropable",{dropElementScope:r,skipParent:n||r.dropElementIsGroup?2:1,isComplex:i,dataTargetDropable:f});return}i?(r.dropElementIsGroup||(r.dropElementIsGroup=!0),r.dropElementTargetItemSelector=u+Utils.GenAttrDataName([Utils.RepoKeys.DataKeys.Target],f),r.$$dropElementToggle(n||a||2,f)):r.$$dropElementToggle(n||a||1)}};r.dropElementFreeze?r.dropElementShow=!0:r.dropElementClose();r.$on("dropElementContainer:changeHeight",function(n,t){n.defaultPrevented||(n.stopPropagation?n.stopPropagation():n.preventDefault(),console.log("dropElementContainer:changeHeight.e",{e:n}),r.dropElementSetHeight(!0),t&&t.hasOwnProperty("resolve")&&t.resolve instanceof Function&&t.resolve())});r.$on("dropElementContainer:changeComplexHeight",function(t,i){if(!t.defaultPrevented&&(t.stopPropagation?t.stopPropagation():t.preventDefault(),r.dropElementShow)){i&&i.dropItemSelectior&&(r.dropElementTargetItemSelector=u+Utils.GenAttrDataName([Utils.RepoKeys.DataKeys.Target],i.dropItemSelectior));var f=n(function(){r.dropElementSetHeight(!0)},100);console.log("dropElementContainer:changeComplexHeight",{e:t,options:i,$scope:r})}})}var i="active",s=".dropable",f=".drop-container",u=".drop-item",e=Utils.Time.DROP_ELEMENT_ANIMATION,r,o;return{restrict:"A",link:c}}]);Utils.CoreApp.gameApp.directive("dropItem",function(){function n(e,o){function s(){var s=this,v=null,l=null,h=null,a=null,y=null,p=_.uniqueId(),w=o||f,c;this._guid="dropable_item_"+p;var b="drop_container_"+p,k="drop_item_"+p,d="#"+b,g="#"+k;this._updateParams=function(){v=s._getDom(w);l=s._getDom(d);a=s._getDom(g);h=a.height();y=_.ceil(h/r*i,2)};this._mainscrollerSelector=w;this.conteinerId=b;this.dropItemId=k;this._getDom=function(n){return angular.element(n)};this._getItemDom=function(){return a||(a=s._getDom(g)),a};this._closed=!0;this._getItemHeight=function(){return h||(h=s._getItemDom().height()),h};this._getContainerDom=function(){return l||(l=s._getDom(d)),l};this._getMainParentDom=function(){return v||(v=s._getDom(w)),v};this._getOffsetStep=function(){return y||(y=_.ceil(s._getItemHeight()/r*i,2)),y};c=!1;this._runTopAnimation=function(n){var l;if(!c){c=!0;var f=s._getMainParentDom(),w=e,a=0,b=f.offset().top,v=f.scrollTop(),k=w.offset().top,o=v+(k-b),y=f[0].scrollHeight-f.height();o>y&&(o=y);var d=o-v,p=d*i/r,h=f.scrollTop()+p;if(f.scrollTop(h),h>=o){h>o&&f.scrollTop(_.floor(h));c=!1;n instanceof Function&&n();return}l=setInterval(function(){if(h=f.scrollTop()+p,f.scrollTop(h),h>=o&&(clearInterval(l),h>o&&f.scrollTop(_.floor(o)),c=!1,n instanceof Function&&n()),a>u){clearInterval(l);c=!1;t=!1;n instanceof Function&&n();throw new Error("_runTopAnimation in loop");}a++},i)}};this.close=function(r){var o;if(s._closed){r instanceof Function&&r();return}if(n.lastItem&&(s._guid!==n.lastItem._guid||n.lastItem._closed))if(n.lastItem)if(o=s._getDom(n.lastItem.dropItemId),o)n.lastItem.close(function(){s.close(r)});else{n.lastItem=s;s.close(r);return}else n.lastItem=s,s.close(r);else{s._updateParams();t=!0;var h=s._getOffsetStep(),f=0,e=setInterval(function(){var i=s._getContainerDom(),n=i.height();if(n-=h,i.height(n),n<=0&&(clearInterval(e),n<0&&i.height(0),t=!1,s._closed=!0,r instanceof Function&&r()),f>u){clearInterval(e);t=!1;r instanceof Function&&r();throw new Error("close in loop");}f++},i)}};this.open=function(r){if(!t){if(!s._closed){r instanceof Function&&r();return}if(!n.lastItem||n.lastItem._guid===s._guid&&n.lastItem._closed)s._updateParams(),t=!0,s._runTopAnimation(function(){var e=0,f=s._getItemHeight(),h=s._getOffsetStep(),o=setInterval(function(){var c=s._getContainerDom(),i=c.height();if(i+=h,c.height(i),i>=f&&(clearInterval(o),i>f&&c.height(f),s._closed=!1,t=!1,n.lastItem=s,r instanceof Function&&r()),e>u){clearInterval(o);t=!1;r instanceof Function&&r();throw new Error("open in loop");}e++},i)});else if(n.lastItem){var f=s._getDom(n.lastItem.dropItemId);if(f){if(!n.lastItem._closed){n.lastItem.close(function(){s.open(r)});return}}else{n.lastItem=s;s.open(r);return}}else n.lastItem=s,s.open(r)}};this.toggle=function(n){s._closed?s.open(n):s.close(n)};this.updateHeihgt=function(n){s._closed||(s._updateParams(),l.height(h));n instanceof Function&&n()}}return e.hasOwnProperty("DropableItem")&&e.DropableItem||(e.DropableItem=new s),e.DropableItem}var r=Utils.Time.DROP_ELEMENT_ANIMATION,i=40,t=!1,u=1e3,f=".content_scroller";return n.lastItem=null,{restrict:"A",link:function(t,i){var r=t._element=$(i);t.contData||(t.contData={});t.contData.dropable=n(r,t.mainParentSelector);t.$on("$destroy",function(){r=t._element=null;t.contData.dropable=null;n.lastItem=null;delete t._element;delete t.contData.dropable})},scope:{mainParentSelector:"@",contData:"="}}});Utils.CoreApp.gameApp.directive("allianceRatingCentr",[function(){function n(n){n.allianceHead=n.border.Data}return{restrict:"A",replace:!0,scope:!0,link:n}}]);Utils.CoreApp.gameApp.directive("allianceItem",["allianceService",function(n){function t(t,i){t.item=t.$parent.item;var r=1;i.hasOwnProperty("skipParent")&&(r=+i.skipParent);t.item.skipParent=r;n.setAllianceStatsModelInScope(t,t.item);t.alianceButtons=n.getAllianceItemBtns(t.item);t.description=n.getAllianceItemDescription(t.item.AllianceDescription)}function i(n,i,r){t(n,r);n.$on("planshet:update",function(){t(n,r)});n.$on("alliance:user-join-to-alliance",function(i,u){var f=u.AllianceData;n.item.Id===f.Id&&(console.log("allianceItem.$on(alliance:user-join-to-alliance",{ma:f,$scope:n}),t(n,r));t(n,r)});n.$on("alliance:user-left-from-alliance",function(i,u){var e=u.leftUserId,f=u.leftAllianceId;n.item.Id===f&&t(n,r)})}return{restrict:"E",templateUrl:"alliance-item.tmpl",replace:!0,link:i,scope:{}}}]);Utils.CoreApp.gameApp.directive("allianceItemSearch",["allianceService",function(n){function t(t,i){i.autocomplete({delay:250,minLength:0,source:function(t,i){n.getAllianceNames(t,i)},select:function(i,r){function e(){t.$apply(function(){t.allianceName=f})}var u=r.item.id,f=r.item.value;n.getAllianceItem(u,e)}})}return{restrict:"A",controller:"allianceCtrl as allianceCtrl",link:t}}]);Utils.CoreApp.gameApp.directive("allianceRequestMessage",["$filter",function(n){function t(t){t.dateCreate=n("date")(n("date")(Utils.Time.GetUtcDateTimeFromSecondUtc(t.message.DateCreate),"dd.MM.yyyy HH:mm"));var i=t.currentUserName===t.message.FromName;t.positionAvatarCss=i?"message-avatar_left":"message-avatar_right"}return{restrict:"A",templateUrl:"alliance-request-message.tmpl",replace:!1,link:t,scope:{message:"=",currentUserName:"=",getUserProfile:"&?"}}}]);Utils.CoreApp.gameApp.directive("allianceChangeLabel",[function(){return{restrict:"E",template:"<div class='alliance-change-label'  ng-click='replaceImage($event)'><i class='fa fa-plus-circle fa-3x'><\/i><\/div>",replace:!0,scope:{},controller:"allianceLabelDialogCtrl"}}]);Utils.CoreApp.gameApp.controller("allianceLabelDialogCtrl",["$scope","$rootScope","$mdDialog","mainGameHubService",function(n,t,i,r){n.customFullscreen=!1;n.replaceImage=function(u){EM.Audio.GameSounds.dialogOpen.play();i.show({parent:angular.element(document.body),_locals:{_request:r.allianceInfoUpdateLabel,_onError:function(n){n===ErrorMsg.UploadedImageNotSetInInstance&&i.cancel();console.log("allianceLabelDialogCtrl._onError",n)}},targetEvent:u,clickOutsideToClose:!0,fullscreen:n.customFullscreen,controller:"uploadImageCtrl",bindToController:!0,templateUrl:"dialog-upload-user-image.tmpl",controllerAs:"uploadImageCtrl"}).then(function(){EM.Audio.GameSounds.dialogClose.play();t.$broadcast("alliance:label-updated")},function(){EM.Audio.GameSounds.dialogClose.play()})}}]);Utils.CoreApp.gameApp.directive("controlPanel",["hangarService","paralaxButtonHelper","controlPanelSwicherHelper",function(n,t,i){function r(r){i.setHangar();r.cpToggleBtn=t.getToggle(function(){i.updateState()});r.cpHangarEstateItems=n.getHangarPanel();r.cpMapControlBtns=t.getMapCtrlBtns()}return{restrict:"A",templateUrl:"control-panel.tmpl",replace:!0,scope:!0,link:r}}]);Utils.CoreApp.gameApp.directive("buildProgress",[function(){function n(n,t){var r=n.border.buildItemId,u=t.parents("#"+r),i=u.scope().item;n.ParentScope=i;n.timerData=i.Progress||{};n.timerData.$isUnit=GameServices.buildService.isUnit(i.NativeName);n.Icon=i.ComplexButtonView.Collection[2].Data.Icon}return{restrict:"A",replace:!0,scope:!0,link:n}}]);Utils.CoreApp.gameApp.directive("planshetUnitItem",[function(){return{scope:{item:"="},replace:!0,restrict:"EA",templateUrl:"planshet-unit-item.tmpl",link:function(){},controller:["$scope",function(n){n.dropElement={};console.log("unit.controller",n)}]}}]);Utils.CoreApp.gameApp.directive("resourceItem",[function(){function n(){}return{restrict:"A",replace:!0,scope:{resourceData:"="},link:n,templateUrl:"build-av-resource-item.tmpl"}}]);Utils.CoreApp.gameApp.directive("resourceTransferList",["industrialComplexService",function(n){function t(t,i){n.registerStorageTransferListEvents(t,i)}return{restrict:"A",scope:!0,link:t}}]);Utils.CoreApp.gameApp.directive("biuldSlider",[function(){function n(n,t){var i=n.registerSlider();t.hasOwnProperty("slider")&&t.slider("destroy");i(t,n)}return{restrict:"A",scope:{registerSlider:"&",sliderData:"="},link:n}}]);Utils.CoreApp.gameApp.directive("floatVote",[function(){return{restrict:"E",templateUrl:"float-vote.tmpl",replace:!0,scope:{},controller:["$scope","$rootScope","confederationService","$element","profileService",function(n,t,i,r,u){var f=this,o,e;this.model=i.getElectionData();this.title="Voting";r.css(this.model.$params.position);o=400;e=!1;this.toggleShow=function(){e||(e=!0,f.model.$params.show=!f.model.$params.show,i.$saveToLsVoteParams(f.model.$params),setTimeout(function(){e=!1},o))};this.getUserInfo=function(n){n&&n.UserId&&u.setProfile(n.UserId)};this.lockedAddVoice=!1;this.addVoice=function(n,r){f.lockedAddVoice||(f.lockedAddVoice=!0,i.addVoiceToOfficer(n,r,f.model.$params,function(){f.lockedAddVoice=!1},function(){f.lockedAddVoice=!1},t))};r.draggable({containment:"#estateCanvas",scroll:!1,cancel:"#float-vote-content",stop:function(n,t){console.log("draggable.stop",{event:n,$params:t});f.model.$params.position=t.position;i.$saveToLsVoteParams(f.model.$params)}});n.$on("election:finished",function(){n.$destroy();r.remove();console.log("floatVote.election:finished")});n.$on("election:update-candidates",function(n,t){t.updateVotes&&(_.isEqual(f.model.Candidates,t.Candidates)?console.log("isEqual.floatVote.election:update-candidates",{$event:n,data:t}):f.model.Candidates=t.Candidates);console.log("floatVote.election:update-candidates",{$event:n,data:t})});n.$on("election:cr-user-voice-added",function(n,t){_.isEqual(t.params,f.model.$params)?console.log("isEqual.floatVote.election:election:cr-user-voice-added",{$event:n,data:t,$self:f}):f.model.$params=t.params;console.log("floatVote.election:election:voice-added",{$event:n,data:t})})}],controllerAs:"voteCtrl"}}]);Utils.CoreApp.gameApp.directive("userElectionItem",[function(){return{restrict:"E",templateUrl:"confederation-user-election-item.tmpl",replace:!0,scope:{user:"=",getUserInfo:"&",isRegistredPeriod:"=",canSendVoice:"=",sendVoice:"="}}}]);Utils.CoreApp.gameApp.directive("userRatingItem",[function(){return{restrict:"E",templateUrl:"confederation-user-rating-item.tmpl",replace:!0,scope:{user:"=",getUserInfo:"&"}}}]);Utils.CoreApp.gameApp.directive("taskUnit",["journalHelper",function(n){return{replace:!0,restrict:"E",scope:{unit:"="},templateUrl:"journal-task-unit.tmpl",link:function(t,i,r){t.target=r.target==="target";n.rgisterTaskUnit(t,r.target)}}}]);Utils.CoreApp.gameApp.directive("reportUnit",[function(){return{replace:!0,restrict:"E",scope:{unit:"="},templateUrl:"journal-report-unit.tmpl",link:function(n,t){var i=t.parent().parent().data("hangar");n.unit.StartUnitCount===0&&(n.unit.StartUnitCount=null,n.unit.cssSepia="grayScale");n.unit.LostUnitCount===0&&(n.unit.LostUnitCount=null);n.unit.LostUnitCount!==null&&n.unit.LostUnitCount>0&&(n.unit.LostUnitCount=-n.unit.LostUnitCount);return}}}]);Utils.CoreApp.gameApp.directive("reportInfo",["journalService","translateService",function(n,t){return{replace:!0,restrict:"E",scope:{info:"=",infoButtons:"=?",commonTranslate:"=?"},templateUrl:"journal-report-info.tmpl",link:function(i){var r=i.info.IsReport;i.infoButtons=r?n.getReportInfoButtons(i.info):n.getSpyInfoButtons(i.info);i.commonTranslate=t.getCommon()}}}]);Utils.CoreApp.gameApp.directive("leftNav",["mainHelper","paralaxButtonHelper",function(n,t){return{restrict:"A",link:function(n){n.leftNavButtons=t.getLeftNavButtons()}}}]);Utils.CoreApp.gameApp.directive("mapControlNavigator",["controlDiskHelper",function(n){return{templateUrl:"map-control-navigator.tmpl",restrict:"E",replace:!0,scope:{controlDisk:"@"},link:function(t,i){t.controlDisk=n.createCdModel(i,t)}}}]);Utils.CoreApp.gameApp.directive("mapInfo",[function(){function n(n){n.$on("mapinfo:planshet:update",function(t,i){var r=i.planshetEvent.targetScope.planshetModel.Bodys[n.$index].TemplateData;n.infoModel=r})}return{restrict:"E",templateUrl:"map-info.tmpl",replace:!0,link:n}}]),function(n){n.directive("channelItem",["$rootScope","userChannelsService",function(n,t){function i(n,i){n._btnIds||(i.btnIds=t.createBtnIds(n));i.btnIds||(i.btnIds=n._btnIds)}return{restrict:"E",templateUrl:"channel-item.tmpl",replace:!0,scope:{channel:"="},controller:["$scope",function(n){var r=this,u,f;i(n.channel,r);t.checkPrivateHead(n.channel);u=n.channel.PerPage;this.scrollEventName="channelItem:get-next-page:filtered-"+n.channel.ChannelId;f=!0;this.scrollDataInProgress=!1;this.loadNextPage=function(){var h,i,e,o,s;if(!this.scrollDataInProgress){if(f){this.messages=_.take(_.orderBy(_.toArray(n.channel.Messages),["Id"],["desc"]),u);h=_.size(n.channel.Messages);h<u&&(n.channel.$totalMessagesCount=h);f=!1;return}if(!n.channel.$totalMessagesCount||this.messages.length!==n.channel.$totalMessagesCount){if(this.scrollDataInProgress=!0,i=_.orderBy(_.toArray(n.channel.Messages),["Id"],["desc"]),e=this.messages.length,!e){this.scrollDataInProgress=!1;return}if(i[e]){for(o=e+u-1,o>i.length-1&&(o=i.length-1),s=e;s<=o;s++)r.messages.push(i[s]);r.scrollDataInProgress=!1;return}t.getNextMessagesPage(n.channel.ChannelId,n.channel.ChannelType,function(t){var f=_.size(t),i;f===0?n.channel.$totalMessagesCount=_.size(n.channel.Messages):(i=_.orderBy(_.toArray(t),["Id"],["desc"]),_.forEach(i,function(n){r.messages.push(n)}),i.length<u&&(n.channel.$totalMessagesCount=_.size(n.channel.Messages)));r.scrollDataInProgress=!1},function(){r.scrollDataInProgress=!1});return}}};this.channelTypes=t.ChannelTypes;n.$on("channelItem:add-message",function(t,u){if(!t.defaultPrevented&&u.newChannel.ChannelId===n.channel.ChannelId){t.stopPropagation?t.stopPropagation():t.preventDefault();i(n.channel,r);var f=u.newMessageData;r.messages.unshift(f);n.$broadcast("dropElementContainer:changeComplexHeight",{dropItemSelectior:r.btnIds.MessagesId})}});n.$on("channelItem:update-permition",function(t,i){t.defaultPrevented||i.channel.ChannelId===n.channel.ChannelId&&(t.stopPropagation?t.stopPropagation():t.preventDefault(),n.$broadcast("dropElementContainer:changeComplexHeight",{dropItemSelectior:r.btnIds.MessagesId}))})}],controllerAs:"channelCtrl"}}]);n.directive("channelControlMenu",[function(){return{restrict:"E",templateUrl:"channel-control-menu.tmpl",replace:!0,scope:{channelControls:"="}}}]);n.directive("channelMessageForm",["userChannelsService","allianceService",function(n){return{restrict:"E",templateUrl:"channel-message-form.tmpl",replace:!0,scope:{btnSendMessage:"="},controller:["$scope",function(t){var i=this;this.mesageModel={maxLength:t.btnSendMessage.Params.MessageMaxLength};this.mesageModel.text="";this._inProgress=!1;this.onChange=function(n){n.text&&n.text.length>n.maxLength&&(n.text=n.text.substring(0,n.maxLength))};this.sendMessage=function(t,r,u,f,e){if(!i._inProgress&&(i.mesageModel.text=i.mesageModel.text.trim(),i.mesageModel.text.length!==0)){t.text=i.mesageModel.text;t.onFinally=function(){i._inProgress=!1};t.onError=function(n){console.log("userChannelsService.errorMessage",{errorMessage:n,$event:e})};t.onSuccess=function(){i.mesageModel.text=""};n.sendMessage(t,e);return}};t.btnSendMessage.Method=this.sendMessage}],controllerAs:"mFormCtrl"}}]);n.directive("channelPrivateCreateForm",["userChannelsService",function(n){return{restrict:"E",templateUrl:"channel-private-create-form.tmpl",replace:!0,controller:["$scope",function(t){t.buttons=n.createPrivateChannelControls()}]}}]);n.directive("channelMessageItem",["$filter","$q",function(n){return{restrict:"E",templateUrl:"channel-message-item.tmpl",replace:!0,scope:{message:"="},controller:["$scope",function(t){var i=this,r,u;t.message.$dateCreate||(r=Utils.Time.GetUtcDateTimeFromSecondUtc(t.message.DateCreate),t.message.$dateCreate=n("date")(r,"dd.MM.yyyy HH:mm")+" (server time)");t.message.$isCurrentUser===undefined&&(u=GameServices.profileService.getCurrentUserId(),t.message.$isCurrentUser=u===t.message.UserId,t.message.$avatarCss=t.message.$isCurrentUser?"message-avatar_left":"message-avatar_right");this.messageText=t.message.Message;this.setTranslate=function(n){i.messageText=n};this.setting={show:!1,btnCloseCss:"fa-times-circle-o",btnOpenCss:"fa-bars",toggle:function(n){this.show=!n;this.btnCss=this.show?this.btnCloseCss:this.btnOpenCss;this.show||i.setTranslate(t.message.Message)},btnCss:""};this.setting.btnCss=this.setting.btnOpenCss;this.getUserInfo=function(){GameServices.profileService.setProfile(t.message.UserId)}}],controllerAs:"chmiCtrl"}}]);n.directive("channelGroupSetting",["userChannelsService",function(n){var i=n.$btnHelper,t=!1;return{restrict:"E",replace:!0,templateUrl:"channel-group-setting.tmpl",scope:{channel:"="},controller:["$scope","minLenghtConsts",function(r){function h(){if(e||(e=!0),!o){o=!0;f=_.orderBy(_.map(r.channel.Users,function(n){return n}),["Name"],["asc"]);u.$max=f.length;u.hasUsers=f.length>0;var n=u.users.length;if(u.users=_.take(f,n),e=!1,o=!1,s.length)while(s.length)s.shift()()}}var s,c,l;n.$currentUserInfo.userId!==r.channel.CreatorId&&r.$destroy();var u=this,e=!1,o=!1,f=_.orderBy(_.map(r.channel.Users,function(n){return n}),["Name"],["asc"]);this.users=[];s=[];this.Buttons={updatePassword:i.ButtonsView().ConstructorSizeBtn(3,!0,"updatePassword",function(i,u,f,e,o){t||(t=!0,n.$ucdH.$mdDialog.show({templateUrl:"dialog-channels-group-update-password.tmpl",parent:angular.element(document.body),targetEvent:o,clickOutsideToClose:!1,fullscreen:!1,_locals:{channel:r.channel},bindToController:!0,controller:"dialogChannelsGroupUpdatePasswordCtrl",controllerAs:"pCtrl"}).then(function(n){n.$destroy();h();t=!1},function(n){n.$destroy();t=!1}))}),updateIcon:i.ButtonsView().ConstructorSizeBtn(3,!0,"updateIcon",function(i,u,f,e,o){t||(t=!0,n.$ucdH.$mdDialog.show({parent:angular.element(document.body),_locals:{_request:function(t){return n.$hub.userChannelsGroupUploadIcon(t,r.channel.ChannelId)},_onError:function(i){var r=Errors.GetHubMessage(i);if(r===ErrorMsg.NotPermitted)n.$ucdH.openDialogNotPermitted(o).finally(function(){t=!1});else{t=!1;throw Errors.ClientNotEqualException({errorAnswer:i,msg:r});}},_imageSize:90,_cssDialogContainer:"delete_after_test_cssDialogContainer"},targetEvent:o,clickOutsideToClose:!0,fullscreen:!1,controller:"uploadImageCtrl",bindToController:!0,templateUrl:"dialog-upload-user-image.tmpl",controllerAs:"uploadImageCtrl"}).then(function(){t=!1},function(){t=!1}))}),deleteChannel:i.ButtonsView().ConstructorSizeBtn(3,!0,"deleteChannel",function(i,u,f,e,o){t||(t=!0,n.$ucdH.openDialogConfirmDeleteGroupChannel(o,r.channel.ChannelName).then(function(){n.$deleteGroupChannelByOwner(r.channel.ChannelId,o,function(){t=!1})},function(){t=!1}))})};this.hasUsers=f.length>0;this.$max=f.length;c=3;this.css={read:"fa-eye",notRead:"fa-eye-slash",write:"fa-pencil-square-o",password:"fa-key"};this.loadNextPage=function(){var i,t,n;if(!e&&!o&&this.hasUsers&&!e&&this.users.length!==this.$max){for(e=!0,i=this.users.length,t=i+c,t>f.length-1&&(t=f.length-1),n=i;n<=t;n++){if(o)return;f[n]&&this.users.push(f[n])}e=!1;return}};r.$on("user-channels-group-:user-unsubscribe",function(n,t){if(r.channel.ChannelId===t.channel.ChannelId){var i=t.ChannelConnectionUserOut;h()}});r.$on("user-channels-group-:user-subscribe",function(n,t){if(r.channel.ChannelId===t.channel.ChannelId){var i=t.ChannelConnectionUserOutId,u=t.channel.Users[i];h()}});l=!1;this.updateUser=function(i,f,e){function h(n){n.$destroy();t=!1}l||o||n.$ucdH.$mdDialog.show({templateUrl:"dialog-channels-group-update-user.tmpl",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1,fullscreen:!1,_locals:{$updateUser:i,$onUserUpdated:function(n){function t(){if(u.users[f]&&u.users[f].Id===n.Id)u.users[f]=n;else{var t=_.findIndex(u.users,function(t){return t.Id===n.Id});_.isInteger(t)&&(u.users[f]=n)}}o?s.push(t):t()},$css:u.css,$channelAdminUserId:r.channel.CreatorConnection.UserId},bindToController:!0,controller:"dialogChannelsGroupUpdateUser",controllerAs:"suCtrl"}).then(h,h)}}],controllerAs:"settingCtrl"}}])}(Utils.CoreApp.gameApp);Utils.CoreApp.gameApp.directive("planshet",["planshetService",function(n){function i(i){i.planshetToggle=t;var r={};r.hasPrev=n.hasPrevPlanshetElem;r.hasNext=n.hasNextPlanshetElem;r.OnPrev=function(){n.updateByHistory(-1)};r.OnNext=function(){n.updateByHistory(1)};i.pagination=r}var t={cssActive:"",onclick:n.toggle,opened:!1};return{restrict:"E",templateUrl:"planshet.tmpl",replace:!0,link:i}}]);Utils.CoreApp.gameApp.directive("planshetBodyTabs",["tabService",function(n){function t(t){n.initializeTabs(t.planshetModel)}return{restrict:"E",templateUrl:"planshet-tabs.tmpl",replace:!0,link:t}}]);Utils.CoreApp.gameApp.directive("profileSection",["profileService","allianceService","maxLenghtConsts","baseDialogHelper","mainHelper",function(n,t,i,r,u){function s(n,t){return r.errorOverMaxLength(n,t,i.PersonalInfoDescription)}function c(n,i){t.setAllianceStatsModelInScope(n,i,!0);n.description={};i.AllianceDescription||(i.AllianceDescription="");n.description.text=t.getAllianceItemDescription(i.AllianceDescription)}function o(n,t,i){t.disableEditing=i;t.toolbar=i?!1:{buttons:["bold","italic","underline","strikethrough","subscript","superscript","anchor","image","quote","pre","orderedlist","unorderedlist","indent","outdent","justifyLeft","justifyCenter","justifyRight","justifyFull","h1","h2","h3","h4","h5","h6","removeFormat","html"]};n.$broadcast("mediumEditor:update-option",t)}function l(t,r){n.setUserInfoProfileModelInScope(t,r);t.description={};typeof r.PersonalDescription!="string"&&(r.PersonalDescription="");t.description.text=r.PersonalDescription;t.description.activateEdit=!1;t.description.setActivate=function(n){t.description.activateEdit=n;t.description.mediumBindOptions.disableEditing=!n;o(t,t.description.mediumBindOptions,t.description.mediumBindOptions.disableEditing)};t.description.mediumBindOptions={toolbar:!1,disableEditing:!0,placeholder:!1};r.IsCurrentUser&&(t.description.resetDescription=function(){EM.Audio.GameSounds.defaultButtonClose.play();u.applyTimeout(function(){t.description.text=r.PersonalDescription;t.description.setActivate(!1)})},t.description.sendDescription=function(u,f,e,h,c){if(console.log("scope.description.sendDescription",{params:u,element:f,attrs:e,$scope:h,$event:c}),!GameServices.planshetService.getInProgress()){var l=typeof t.description.text=="string"&&r.PersonalDescription!==t.description.text;l&&(t.description.text.length<=i.PersonalInfoDescription?n.rquestUpdateUserDescription(r,t.description.text,function(n,i){t.description.text=n;o(t,t.description.mediumBindOptions,!1);i===ErrorMsg.OverMaxLength&&s(c,t.description.text.length)}):s(c,t.description.text.length));t.description.setActivate(!1);EM.Audio.GameSounds.defaultButtonClose.play()}},r.Buttons.edit.Method=function(){GameServices.planshetService.getInProgress()||(EM.Audio.GameSounds.defaultButtonClick.play(),u.applyTimeout(function(){t.description.setActivate(!0);o(t,t.description.mediumBindOptions,!1)}))},r.Buttons.send.Method=t.description.sendDescription,r.Buttons.cancel.Method=t.description.resetDescription)}function a(n,t,i){i===f.info?l(n,t):i===f.aliance?(c(n,t),n.$on("$destroy",function(){n.allianceStatsModel=null;n.description=null;delete n.allianceStatsModel;delete n.description})):i===f.achievement||i===f.chest}function e(t,i,r){var u=n[i]();a(t,u,r);t.dataTitle=u.hasOwnProperty("Title")&&u.Title?u.Title[h]:"create title model";t.bodyData=u;t.bodyTemplate=u.Template}function v(n,t,i){e(n,i.method,i.type);n.$on("planshet:update",function(){e(n,i.method,i.type)});i.type===f.info&&n.$on("user:avatar-updated",function(){e(n,i.method,i.type)});i.type===f.aliance&&n.$on("alliance:label-updated",function(){e(n,i.method,i.type)})}var h=_.upperFirst(LANG.toLowerCase()),f={info:"info",aliance:"aliance",achievement:"achievement",chest:"chest"};return{restrict:"E",template:"<div><h2 class=profile-head><span ng-bind=dataTitle><span/><\/h2><div class=profile-section-body ng-include=bodyTemplate><\/div><\/div>",replace:!0,link:v,scope:{}}}]);Utils.CoreApp.gameApp.directive("profileChangeAvatar",[function(){return{restrict:"E",template:"<div class='profile-change-avatar'  ng-click='replaceImage($event)'><i class='fa fa-plus-circle fa-3x'><\/i><\/div>",replace:!0,scope:{},controller:"userAvatarDialogCtrl"}}]).controller("userAvatarDialogCtrl",["$scope","$rootScope","$mdDialog","mainGameHubService","profileService","allianceService",function(n,t,i,r,u,f){n.customFullscreen=!1;n.replaceImage=function(e){EM.Audio.GameSounds.dialogOpen.play();var o=i.show({parent:angular.element(document.body),_locals:{_request:r.personalInfoUpdateAvatar,_onError:function(n){n===ErrorMsg.UploadedImageNotSetInInstance&&i.cancel()}},targetEvent:e,clickOutsideToClose:!0,fullscreen:n.customFullscreen,controller:"uploadImageCtrl",bindToController:!0,templateUrl:"dialog-upload-user-image.tmpl",controllerAs:"uploadImageCtrl"});o.then(function(n){EM.Audio.GameSounds.dialogClose.play();u.updateLocalUserAvatar(n);f.onLocalUserUpdateAvatar(n);t.$broadcast("user:avatar-updated",{data:n});console.log("newAvatar",n)},function(){EM.Audio.GameSounds.dialogClose.play()})}}]);Utils.CoreApp.gameApp.directive("verifyTo",function(){return{require:"ngModel",scope:{verifyTo:"="},link:function(n,t,i,r){r.$validators.verifyTo=function(t){return t===n.verifyTo};n.$watch("verifyTo",function(){r.$validate()})}}});Utils.CoreApp.gameApp.directive("isAvailableNameHub",["$q","mainGameHubService",function(n,t){return{restrict:"A",require:"ngModel",link:function(i,r,u,f){if(!u.isAvailableNameHub||!(t[u.isAvailableNameHub]instanceof Function))throw new Error("$hub method not  exist");var e=t[u.isAvailableNameHub];f.$asyncValidators.isAvailableName=function(t,r){console.log("$ngModel.$asyncValidators.isAvailableName");var f=n.defer();return e(r).then(function(n){var t,r;n?(u.onNameValidate&&(t=Utils.StrToRef(u.onNameValidate,i),t instanceof Function&&t()),f.resolve()):(u.onNameInvalidate&&(r=Utils.StrToRef(u.onNameInvalidate,i),r instanceof Function&&r()),f.reject())},function(){f.reject()}),f.promise}}}}]);Utils.CoreApp.gameApp.directive("skagry",[function(){return{link:function(){},restrict:"A",templateUrl:"skagry.tmpl",replace:!1}}]);_test={hover:function(){console.log("hover")}};Utils.CoreApp.gameApp.directive("userCounter",[function(){return{restrict:"A",templateUrl:"user-counter.tmpl",replace:!0,scope:{},link:function(n){function i(){var n=t.cssLoading,i=t.count;i<t.low.max&&n!==t.low.cssClass?t.cssLoading=t.low.cssClass:i<t.medium.max&&n!==t.medium.cssClass?t.cssLoading=t.medium.cssClass:n!==t.hard.cssClass&&(t.cssLoading=t.hard.cssClass)}var t={count:0,cssLoading:"",low:{max:1,cssClass:""},medium:{max:2,cssClass:"medium"},hard:{max:99999,cssClass:"hard"}};t.cssLoading=t.low.cssClass;n.counter=t;n.$on("user:join-to-game",function(r,u){n.$apply(function(){t.count=u.OnlineTotalCount;i()})});n.$on("user:left-game",function(){n.$apply(function(){t.count--;i()})})}}}]);Utils.CoreApp.gameApp.filter("allianceFilter",function(){return function(n,t){return _.filter(n,function(n){var i=n.Name.toLowerCase(),r=n.LeaderName.toLowerCase();return t===undefined||i.indexOf(t.toLowerCase())!==-1||n.PvpPoint>=t||r.indexOf(t.toLowerCase())!==-1})}});Utils.CoreApp.gameApp.filter("allianceMember",function(){var t=null,n=null,i=null;return function(r,u,f,e){return!e&&n===f&&t===u?i:e?(t="",n=!1,r):(t=u,n=f,typeof f=="boolean"&&(n=f,f&&(i=r=_.filter(r,function(n){return n.OnlineStatus===!0}))),i=_.filter(r,function(n){var t=n.UserName.toLowerCase(),i=n.Role&&n.Role.hasOwnProperty("RoleName")?n.Role.RoleName.toLowerCase():"",r=n.UserPvp;return u===""||u===undefined?!0:Utils.IsNumeric(u)?r>=_.toInteger(u):(u=u.toLowerCase(),t.indexOf(u)!==-1||i.indexOf(u)!==-1)}))}});