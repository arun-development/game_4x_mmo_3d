(function(n){"use strict";n.directive("jsonCombiner",[function(){return{restrict:"A",scope:{saveData:"=",jsonCombiner:"@"},link:function(n){n.saveData(JSON.parse(n.jsonCombiner))}}}]);n.service("compileHelper",["$compile","$rootScope",function(n,t){this.$compileItem=function(i){return n(i)(t.$new())};this.$appendHtml=function(n,t){$(n).append(this.$compileItem(t))};this.$replaceWith=function(n,t){$(n).replaceWith(this.$compileItem(t))}}]);n.service("chestService",["$q",function(n){function i(){this.Account=null;this.Premium=null;this.Booster=null;this.Skins=null;this.Cc=null}var t=this;this.CHEST_KEY="UserChest";this.$userChestData=null;this.getProductType=function(){};this.$defaultError=function(n){var t=Errors.GetMessage(n);console.log("errorAnswer",{errorAnswer:n,msg:t})};this.updateChestFromServer=function(i){var r=n.defer();$.ajax({url:"/api/userChest/init/",headers:Utils.XSRF.HeadersGetApiTokenObj(),method:"GET",type:"json"}).then(r.resolve,r.reject);r.promise.then(function(n){t.$setInitChestData(n);i instanceof Function&&i(t.$userChestData)},t.$defaultError)};this.$rebuildChestData=function(n){return t.$userChestData?Utils.UpdateObjData(t.$userChestData,n):t.$userChestData=n,t.$userChestData};this.cleanChestData=function(){t.$userChestData=null};this.getUserChestData=function(){return t.$userChestData||console.log("!$self.$userChestData chest data nit exist",{$self:t}),t.$userChestData};i.prototype.getKeys=function(){return Object.keys(this)};this.ProductTypes=function(){function f(n,t,i){this.LangSimpleProps=i;_.extend(this,Utils.ModelFactory.INameIdModel(n,t))}function e(){}function s(n,t,i){var r=this;this.NativeName=n;this.LangSimple=t;this.setKVConverter(function(n){var t=i?i(n):n;return Utils.ModelFactory.KeyVal(r.LangSimple.getCurrent(),t)})}function n(n,t,i,r){n[t]=new s(t,i,r)}var r,o,h,c;f.prototype.convertToKv=function(n){return this.LangSimpleProps&&this.LangSimpleProps.convertToKv?this.LangSimpleProps.convertToKv(n):[]};e.prototype.convertToKv=function(n){var t=[];return n?(_.forEach(this,function(i,r){console.log("IPropertyes",{val:i,nativeName:r,properties:n,"properties[nativeName]":n[r],"val.convertToKv":i.convertToKv,"val.convertToKv(properties[nativeName])":i.convertToKv(n[r]),"typeof properties[nativeName]":typeof n[r]});i.convertToKv&&n[r]&&typeof n[r]!="object"&&t.push(i.convertToKv(n[r]))}),t):t};s.prototype.setKVConverter=function(n){this.convertToKv=n};var t=Utils.LangSimple,u=new i,l=new e;return u.Account=new f(1,"Account",l),r=new e,n(r,"Duration",t("EN Duration","ES Duration","RU Duration"),Utils.Time.Seconds2Time),n(r,"PremiumBookmarkMod",t("EN PremiumBookmarkMod","ES PremiumBookmarkMod","RU PremiumBookmarkMod"),function(n){return n}),n(r,"PremiumNavigationMod",t("EN PremiumBookmarkMod","ES PremiumBookmarkMod","RU PremiumBookmarkMod"),function(n){return n}),n(r,"ResourseMaxStorable",t("EN ResourseMaxStorable","ES ResourseMaxStorable","RU ResourseMaxStorable"),function(n){return n}),n(r,"ResourseProduction",t("EN ResourseProduction","ES ResourseProduction","RU ResourseProduction"),function(n){return n}),n(r,"TimeBuildUpdate",t("EN TimeBuildUpdate","ES TimeBuildUpdate","RU TimeBuildUpdate"),function(n){return n}),n(r,"TimeUnitProduction",t("EN TimeUnitProduction","ES TimeUnitProduction","RU TimeUnitProduction"),function(n){return n}),u.Premium=new f(2,"Premium",r,function(n){return n}),o=new e,n(o,"Duration",t("EN Duration","ES Duration","RU Duration"),Utils.Time.Seconds2Time),n(o,"Attack",t("EN Attack","ES Attack","RU Attack"),function(n){return n}),n(o,"Hp",t("EN Hp","ES Hp","RU Hp"),function(n){return n}),u.Booster=new f(3,"Booster",o),h=new e,u.Skins=new f(4,"Skins",h),c=new e,u.Cc=new f(5,"Cc",c),Utils.FreezeDeep(u),u}();this.$getTypeByTypeId=function(n){return _.find(t.ProductTypes,function(t){return t.Id===n})};this.createChestItemKVPropertiesView=function(n){var i=t.$getTypeByTypeId(n.ProductTypeId);return i&&i.convertToKv?i.convertToKv(n.ProductItemProperty.Property):[]};this.getActiveDataByTypeId=function(n){var i=t.getUserChestData();return!i||!i.ActivatedItemsView?null:_.find(i.ActivatedItemsView,function(t){return t.ProductTypeId===n})};this.getBalanceCcModel=function(){var n=t.getActiveDataByTypeId(t.ProductTypes.Cc.Id);return!n||!n.Data?null:n.Data.BalanceCc};this.getPremiumModel=function(){var n=t.getActiveDataByTypeId(t.ProductTypes.Premium.Id);return!n||!n.Data?null:n.Data.Premium}}]);n.service("pageHelper",[function(){console.log("pageHelper",this);this.pageName=$("body").data("page-name");this.pageNames={home:"start-page",store:"store-page",account:"account-page",manage:"manage-page",adminStore:"admin-store-page"};this.isPage=function(n){return this.pageName?this.pageName===n:!1};this.$homeInitialized=!1;this.initHome=function(){!this.$homeInitialized&&this.isPage(this.pageNames.home)&&(HomeScroller.Init(),HomeResaizer(),Utils.Response.HomeVideo.Init(),HomeCarousel(),$("iframe").youtubeControl(),this.$homeInitialized=!0)};this.isOtherPage=function(){var i=this.pageNames,t=this.pageName,n;return t?(n=!0,_.forEach(i,function(i){if(i===t)return n=!1,!1}),n):!0};this.isPage(this.pageNames.home)&&this.initHome()}]);n.service("appVarsSerivce",["$rootScope",function(n){this._data=null;this.save=function(n){return this._data=this._data!==null?_.extend(this._data,n):n,this};this.getVars=function(){var n=this._data;return console.log("getVars",{data:n}),this._data};this.add=function(n,t){return n?(this._data===null&&(this._data={}),this._data[n]=t,this):this};this.remove=function(n){if(this._data&&this._data[n])return this._data[n]=null,delete this._data[n],this};this.update=function(t){return Utils.UpdateObjData(this._data,t),n.$broadcast("appVarsSerivce:update",{appVars:this._data}),this}}]);n.directive("appVars",["appVarsSerivce",function(n){return{restrict:"A",scope:{appVars:"@"},link:function(t,i){n.save(JSON.parse(t.appVars));i.remove();console.log("appVars saved",{$scope:t})}}}])})(angular.module("angularAppCommon",[])),function(n){n.config(["$mdThemingProvider",function(n){n.generateThemesOnDemand(!0)}]);n.service("authUser",["compileHelper","$q","siteChestService",function(n,t,i){var u=Utils.LocalStorage,r=this;this.$delay=6e5;this.$authCookieName="userAutorized";this.isAutorized=Utils.ConvertToBool($.cookie(this.$authCookieName));this.$translateLogInLabel=Utils.LangSimple("enter","entrar","вход");this.loginLabelName=this.$translateLogInLabel.getCurrent();this.getHref=function(){var n=Utils.GetUrl("/Account/Login");return n+Utils.GetReturnUrl()};this._logInData=null;this.getLogInData=function(){return r._logInData?r._logInData:(r._logInData={text:r.loginLabelName,href:r.getHref()},Object.freeze(r._logInData),r._logInData)};this.requestGetStatus=function(){$.ajax({url:"/api/user/IsAuthenticated/",headers:Utils.XSRF.HeadersGetApiTokenObj(),dataType:"json"}).then(function(n){r.setAuthStatus(n.auth)},function(n){r.$resetAuthData();var t=Errors.GetMessage(n);console.log("authUser.requestGetStatus",{errorAnswer:n,msg:t})})};this.$$authTimerId=null;this.$resetAuthData=function(){var t,n,f,e,o;r.$$authTimerId&&(clearTimeout(r.$$authTimerId),r.$$authTimerId=null);r.isAutorized=!1;$.removeCookie(r.$authCookieName);r.$$UserData=null;u.ClearStorageAndCookie();t=r.$$getMenuCtrl();t&&t.$setNoAutorized();n=$("#user-chest");f=$("#logoutForm");f.length&&f.submit();n.length&&(e=n.scope(),e&&e.$destroy(),n.remove());o=$("#my-account");o.length&&o.replaceWith($("<div/>",{id:"menu-personal"}));i.cleanChestData()};this.setAuthStatus=function(n){r.isAutorized=n;n?r.$$authTimerId=setTimeout(function(){r.requestGetStatus()},r.$delay):r.$resetAuthData()};this.initUserDataAndLogInMenu=function(){var u=t.defer();return $.ajax({url:"/"+LANG+"/Home/GetMenuLoginView/",type:"json",data:Utils.XSRF.MakeIPostXsrf(),method:"POST"}).then(function(t){t?(r.$$UserData=JSON.parse(t.Data),i.$setInitChestData(r.$$UserData),$("#link-to-game").removeClass("display-none"),n.$replaceWith("#menu-personal",t.Html),u.resolve()):(r.$resetAuthData(),u.reject())},function(n){n.status===401&&console.log("unauthorized",n);u.reject()}),u.promise};this.$$UserData=null;this.$$checkUserdata=function(){if(!r.$$UserData)throw new Error("!$self.$$UserData");};this.getLogInUserData=function(){return r.$$checkUserdata(),{userName:r.$$UserData.UserName,balanceCc:r.getCc()}};this.getGameUserId=function(){r.$$checkUserdata();var n=i.getBalanceCcModel();return!n||!n.Id?0:n.Id};this.getUserName=function(){return r.$$checkUserdata(),r.$$UserData.UserName};this.getCc=function(){r.$$checkUserdata();var n=i.getBalanceCcModel();return n?n.Quantity:0};this.$$getMenuCtrl=function(){var t=$("#main-menu"),n;return t.length&&(n=t.scope(),n)?n.mCtrl:null};this.updateUserData=function(n){n instanceof Function||(n=angular.noop);r.initUserDataAndLogInMenu().then(function(){var t=r.$$getMenuCtrl();t&&t.$setInitUserData();n(!0)},function(){n(!1);r.$defaultError("error.updateUserData")})};this.$defaultError=Errors.$defaultErrorResponce}]);n.factory("siteChestService",["chestService","$mdSidenav","$mdDialog","$rootScope",function(n,t,i,r){return n.$noActivateIdx=0,n.$activateIdx=1,n.$setInitChestData=function(t){n.$rebuildChestData(t[n.CHEST_KEY]);delete t[n.CHEST_KEY];t.$getChest=function(){return n.$userChestData}},n.setTabsToCtrl=function(t){function i(n){t.tabs=n;t.dataLoaded=!0}n.$userChestData?i(n.$userChestData):n.updateChestFromServer(i)},n.$buildToggler=function(n){return function(){t(n).toggle()}},n.$toggNavLeft=n.$buildToggler("left"),n.openDialogShowChestItemInfo=function(n,t,r){i.show({templateUrl:"dialog-chest-item-info.tmpl",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,fullscreen:!1,locals:{chestItemData:t},controller:"dialogChestItemInfoCtrl",controllerAs:"dchiCtrl"}).then(angular.noop,angular.noop).finally(r)},n.activateChestItem=function(t,r,u){var f=i.confirm().ariaLabel("activateChestItem").title("Confirm").htmlContent("Активировать продут "+r.ProductItemProperty.TranslateText[appL10n.getL10NCurrentLanguage()].Name).ok("Confirm").cancel("Cancel").targetEvent(t);i.show(f).then(function(){var t=$q.defer();$.ajax({url:"/api/user/activateChestItem/",dataType:"json",method:"GET",headers:Utils.XSRF.HeadersGetApiTokenObj(),data:{chestId:r.Id}}).then(t.resolve,t.reject);t.promise.then(function(t){_.remove(n.$userChestData.NoActivate,function(n){return n.Id===r.Id});var i=_.find(n.$userChestData.All,function(n){return n.Id===r.Id});i.Activated=!0;n.ProductTypes.Premium.Name===t.ProductTypeNativeName&&(n.$userChestData.ActivatedItemsView[t.ProductTypeNativeName]=t);u(!0)},function(t){n.$defaultError(t);u(!1)})},u)},n.canBuy=function(n,t){return!n||!n.Quantity?!1:n.Quantity>=t},n.updateCcQuantity=function(n,t){n.Quantity-=t;r.$broadcast("siteChestService:ccUpdated",n)},n}]);n.directive("userChest",[function(){return{templateUrl:"user-chest.tmpl",replace:!0,restrict:"E",scope:{},link:function(){},controller:["$scope","siteChestService",function(n,t){var i=this;this.tabs={selectedIndex:0,inactiveLabelName:"Bought items",activatedLabelName:"Activated"};this.chestData=t.getUserChestData();this.activateChestItemDisabled=!1;this.activateChestItem=function(n,r){i.activateChestItemDisabled||(i.activateChestItemDisabled=!0,t.activateChestItem(n,r,function(){i.activateChestItemDisabled=!1}),console.log("productItem",{chestItem:r,$self:i}))};this.getInfoDisabled=!1;this.getChestItemInfo=function(n,r){i.getInfoDisabled||(i.getInfoDisabled=!0,t.openDialogShowChestItemInfo(n,r,function(){console.log("productItem.finnally",{chestItem:r,$self:i});i.getInfoDisabled=!1}))};this.LangKey=appL10n.getL10NCurrentLanguage()}],controllerAs:"chestCtrl"}}]);n.controller("dialogChestItemInfoCtrl",["$scope","$mdDialog","chestItemData","siteChestService",function(n,t,i,r){function e(n){this.backgroundImage=Utils.CssHelper.SetUrl(i.ProductItemProperty.ImgCollectionImg.Chest);n>u&&(n=u-50);this.width=n;this.height=this.width*(9/16)}var f=appL10n.getL10NCurrentLanguage(),u=$(document).width();this.itemText=i.ProductItemProperty.TranslateText[f];this.itemProperties=r.createChestItemKVPropertiesView(i);this.itemImageStyle=new e(700);this.cancel=function(){t.cancel(n)}}]);n.controller("personalNavMenuCtrl",["$scope","siteChestService","authUser",function(n,t,i){this.toggleLeft=t.$toggNavLeft;this.logOut=function(){i.$resetAuthData()}}]);n.controller("siteMenuCtrl",["$scope","compileHelper","authUser","siteChestService","pageHelper",function(n,t,i,r,u){var f=this;this.showPersonalLogin=!1;this.logInData=i.getLogInData();this.userData={};this.onUserNameClick=r.$toggNavLeft;this.$setInitUserData=function(){f.userData=i.getLogInUserData();f.showPersonalLogin=!0};this.$initUserDataAndLogInMenu=function(){i.initUserDataAndLogInMenu().then(f.$setInitUserData,i.$defaultError)};this.$setNoAutorized=function(){f.showPersonalLogin=!1};n.$on("siteChestService:ccUpdated",function(n,t){e.defaultPrevented||(e.stopPropagation?e.stopPropagation():e.preventDefault(),f.userData.balanceCc=t.Quantity,console.log("siteChestService:ccUpdated",{event:n,data:t}))});u.isOtherPage()||this.$initUserDataAndLogInMenu()}])}(Utils.CoreApp.appSite=angular.module("appSite",["ngMaterial","ngSanitize","ngMessages","svgAssetsCache","lfNgMdFileInput","angularAppCommon"])),function(n){"use strict";n.controller("storeCtrl",["$scope","storeService",function(n,t){var i=this;this.tabs=null;this.langKey=appL10n.getL10NCurrentLanguage();this.showContent=!1;this.saveInitData=function(n){console.log("setIntiData",{saveInitData:n});t.saveInitData(n);angular.element("#store-init-data").remove();i.tabs=t.createStoreTabs();i.showContent=!0};this.buyProduct=t.buyProduct}]);n.controller("buyProductItemForCcDialogCtrl",["$scope","$mdDialog","productItem","balanceCcModel","siteChestService",function(n,t,i,r,u){console.log("buyProductItemForCcDialogCtrl",{$scope:n,balanceCcModel:r,productItem:i,siteChestService:u});this.cancel=function(){t.cancel(n)};this.send=function(){u.updateCcQuantity(r,i.ProductCost);t.hide(n)}}]);n.service("storeService",["$q","$mdDialog","siteChestService",function(n,t,i){function u(n,t){this.TabId=Utils.Guid.CreateGuid();this.LabelData=n;this.BodyData=t}var r=this;this.$storeProducts=null;this.updateProductsFromServer=function(){};this.$filterProducts=function(n,t){return _.filter(n,function(n){return n.ProductTypeId===t})};this.$createTabItem=function(n){var t=_.find(r.$storeProducts.SelectList,function(t){return t.Id===n});return t?new u(t,r.$filterProducts(r.$storeProducts.StoreList,n)):null};this.createStoreTabs=function(){var t=Utils.L10N();t.En.Name="all";t.Es.Name="all";t.Ru.Name="all";var n=i.ProductTypes,e=[n.Account.Id,n.Premium.Id,n.Booster.Id,n.Skins.Id,n.Cc.Id],f=[new u({Id:0,NativeName:"All",TranslateText:t},r.$storeProducts.StoreList)];return _.forEach(e,function(n){var t=r.$createTabItem(n);t&&t.BodyData&&t.BodyData.length&&f.push(t)}),console.log("createStoreTabs",{data:f}),{selectedIndex:0,data:f}};this.buyProduct=function(n,t){console.log("$buyProduct",{$self:r,productItem:t,siteChestService:i});t.ProductCurrencyCode==="CC"?r.$openDialogBuyProductForCc(n,t):t.ProductCurrencyCode==="USD"?r.$openDialogBuyProductForMoney(n,t):i.$defaultError({Method:"buyProduct",Message:"Incorrect currency",productItem:t})};this.saveInitData=function(n){r.$storeProducts=n};this.$openDialogBuyProductForCc=function(n,r){t.show({templateUrl:"buy-product-for-cc-dialog.tmpl",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!1,fullscreen:!1,locals:{productItem:r,balanceCcModel:i.getBalanceCcModel()},controller:"buyProductItemForCcDialogCtrl",controllerAs:"ctrl"}).then(function(n){n.$destroy()},function(n){n.$destroy()})};this.$openDialogBuyProductForMoney=function(n,t){Errors.ClientNotImplementedException({productItem:t},"$openDialogBuyProductForMoney")}}])}(Utils.CoreApp.appSite);